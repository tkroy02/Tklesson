<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tklesson Booking Calendar</title>
<style>
  body { font-family: Arial, sans-serif; background:#0b0b0b; color:#f0e6d2; margin:0; padding:0; }
  .logo { display:flex; justify-content:center; margin:15px 0; }
  .logo img { height:60px; }
  h1 { text-align:center; color:#ffd700; margin:5px 0 15px 0; }
  .legend { display:flex; justify-content:center; gap:20px; margin-bottom:20px; }
  .legend div { padding:5px 15px; border-radius:5px; font-weight:bold; text-align:center; }
  .booked-legend { background:#a00; color:#fff; }
  .available-legend { background:#111; color:#f0e6d2; border:1px solid #fff; }
  .calendar { max-width:700px; margin:0 auto 30px auto; background:#1a1a1a; padding:15px; border-radius:10px; }
  .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .calendar-header button { background:#ffd700; color:#111; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
  .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
  .day { padding:10px; background:#111; text-align:center; border-radius:5px; cursor:pointer; }
  .day.past { background:#222; color:#666; cursor:not-allowed; }
  .day.booked { background:#a00; color:#fff; cursor:not-allowed; }
  .day:hover:not(.past):not(.booked) { background:#ffd700; color:#111; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
  .modal-content { background:#1a1a1a; padding:20px; border-radius:10px; max-width:450px; width:90%; max-height:90vh; overflow-y:auto; }
  .modal-content h2 { color:#ffd700; text-align:center; margin-bottom:10px; }
  .timeslot { padding:8px; margin:5px 0; background:#222; border-radius:5px; cursor:pointer; text-align:center; display:flex; justify-content:space-between; align-items:center; }
  .timeslot.booked { background:#a00 !important; cursor:not-allowed; color:#fff; }
  .timeslot.selected { background:#00a; color:#fff; }
  .timeslot:hover:not(.booked):not(.selected) { background:#ffd700; color:#111; }
  .close { float:right; cursor:pointer; color:#ffd700; font-weight:bold; }
  select.package-select { margin-right:10px; padding:3px 6px; border-radius:4px; border:none; }
  .pay-area { margin-top:12px; }
  .price-summary { text-align:center; margin:6px 0 10px 0; font-weight:bold; }
  .stripe-btn { background:#6772e5; color:#fff; margin-top:8px; width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; display:none; }
  #paypalButtons { display:none; margin-top:8px; }
</style>

<script src="https://js.stripe.com/v3/"></script>
<script id="paypal-sdk" src="https://www.paypal.com/sdk/js?client-id=AQn3tn3wEl7ZO-XBe--qxdJo2MhvTmY8ab-pJxLxFtwbitKN-O2tGabfy6nWE1ylGadZ0PqLQdzXj5eF&currency=USD"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="logo">
  <img src="Tklesson1_transparent.png" alt="Tklesson Logo">
</div>

<h1>Tklesson Booking Calendar</h1>

<div class="legend">
  <div class="booked-legend">Booked</div>
  <div class="available-legend">Available</div>
</div>

<div class="calendar">
  <div class="calendar-header">
    <button id="prevMonth">&lt; Prev</button>
    <h2 id="monthYear"></h2>
    <button id="nextMonth">Next &gt;</button>
  </div>
  <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div class="modal" id="timeModal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2 id="modalDate"></h2>
    <div>
      <label for="packageSelect" style="color:#ffd700;">Select Package:</label>
      <select id="packageSelect" class="package-select">
        <option value="basic">Basic - $45</option>
        <option value="bronze">Bronze - $170</option>
        <option value="silver">Silver - $330</option>
        <option value="gold">Gold - $480</option>
      </select>
      <span id="selectionSummary" style="float:right; opacity:.9;"></span>
    </div>
    <div id="timeSlots" style="margin-top:10px;"></div>
    <div class="pay-area">
      <div id="priceSummary" class="price-summary"></div>
      <button id="stripePay" class="stripe-btn">Pay with Stripe</button>
      <div id="paypalButtons">
        <div id="paypal-button-container"></div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAJmjHubN4I3VQCQOZpifFWHchBF2Dz-Jk",
  authDomain: "tkcalendar-40abb.firebaseapp.com",
  projectId: "tkcalendar-40abb",
  storageBucket: "tkcalendar-40abb.firebasestorage.app",
  messagingSenderId: "843304405219",
  appId: "1:843304405219:web:a0c0498d1d048277b85dd6",
  measurementId: "G-4EQXKHJTJ4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const bookingsRef = db.collection('bookedSessions');

const calendarGrid = document.getElementById('calendarGrid');
const monthYear = document.getElementById('monthYear');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');

const modal = document.getElementById('timeModal');
const closeModal = document.getElementById('closeModal');
const modalDate = document.getElementById('modalDate');
const timeSlotsDiv = document.getElementById('timeSlots');

const packageSelect = document.getElementById('packageSelect');
const selectionSummary = document.getElementById('selectionSummary');

const stripePayBtn = document.getElementById('stripePay');
const paypalButtonsWrapper = document.getElementById('paypalButtons');
const priceSummary = document.getElementById('priceSummary');

let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();
let bookedSessions = [];
const selectedSlotsByDay = {};
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const planLimits = { basic: 1, bronze: 4, silver: 8, gold: 12 };
const planPrices = { basic: 45, bronze: 170, silver: 330, gold: 480 };
const stripePriceIDs = { basic:"price_1S0gVjJHTA6RJOGg88mEOLMW", bronze:"price_1S0j1cJHTA6RJOGgHg8XLo68", silver:"price_IS0j3ZJHTA6RJOGgXrl7icK5", gold:"price_IS0j6dJHTA6RJOGgtjrBr4SG" };

function totalSelectedCount() { return Object.values(selectedSlotsByDay).reduce((sum, arr) => sum + arr.length, 0); }
function updateSelectionSummary() {
  const planKey = packageSelect.value;
  const max = planLimits[planKey];
  selectionSummary.textContent = `Selected ${totalSelectedCount()} / ${max}`;
}
function updatePriceSummary() {
  const planKey = packageSelect.value;
  priceSummary.textContent = `$${planPrices[planKey]} — ${planLimits[planKey]} session${planLimits[planKey]>1?'s':''}`;
}
function updatePaymentVisibility() {
  const planKey = packageSelect.value;
  const max = planLimits[planKey];
  const ready = totalSelectedCount() === max && max>0;
  stripePayBtn.style.display = ready?'block':'none';
  paypalButtonsWrapper.style.display = ready?'block':'none';
}

// Load booked sessions from Firebase
function loadBookedSessions(){
  bookingsRef.get().then(snapshot=>{
    bookedSessions = [];
    snapshot.forEach(doc => bookedSessions.push(doc.id));
    renderCalendar(currentMonth, currentYear);
  });
}

// Save booking to Firebase
function saveBookingToFirebase(day,time){
  const iso = `${day}T${time}`;
  bookingsRef.doc(iso).set({booked:true}).then(()=>loadBookedSessions());
}

// Calendar rendering
function renderCalendar(month, year){
  calendarGrid.innerHTML='';
  const weekdays=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  monthYear.textContent=`${monthNames[month]} ${year}`;
  weekdays.forEach(day=>{ const d=document.createElement('div'); d.textContent=day; d.style.fontWeight='bold'; calendarGrid.appendChild(d); });
  const firstDay = new Date(year,month,1).getDay();
  for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));
  const lastDate=new Date(year,month+1,0).getDate();
  for(let date=1;date<=lastDate;date++){
    const dayDiv=document.createElement('div');
    dayDiv.classList.add('day');
    const dayDate=new Date(year,month,date);
    dayDiv.textContent=date;
    const dayStr=`${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
    if(bookedSessions.some(slot=>slot.startsWith(dayStr))) dayDiv.classList.add('booked');
    if(dayDate < new Date().setHours(0,0,0,0)) dayDiv.classList.add('past');
    dayDiv.addEventListener('click',()=>openModal(dayDate));
    calendarGrid.appendChild(dayDiv);
  }
}

// Open modal with timeslots
function openModal(date){
  modal.style.display='flex';
  modalDate.textContent=`Available Time Slots — ${date.toDateString()}`;
  timeSlotsDiv.innerHTML='';
  updateSelectionSummary();
  updatePriceSummary();
  updatePaymentVisibility();
  const dateStr=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
  if(!selectedSlotsByDay[dateStr]) selectedSlotsByDay[dateStr]=[];

  for(let h=9;h<=21;h++){
    const time=`${h.toString().padStart(2,'0')}:00`;
    const slotDiv=document.createElement('div');
    slotDiv.textContent=time; slotDiv.classList.add('timeslot');
    const slotISO = `${dateStr}T${time}`;
    if(bookedSessions.includes(slotISO)){
      slotDiv.classList.add('booked');
      const hoursDiff = (new Date(slotISO) - new Date())/(1000*60*60);
      if(hoursDiff>=24){
        slotDiv.style.cursor='pointer';
        slotDiv.title='Click to reschedule or cancel';
        slotDiv.addEventListener('click',()=>{
          if(confirm(`Do you want to reschedule or cancel ${time} on ${dateStr}?`)){
            bookingsRef.doc(slotISO).delete().then(()=>loadBookedSessions());
            alert('Session cancelled. You can now select a new slot.');
            openModal(date);
          }
        });
      }
    } else if(selectedSlotsByDay[dateStr].includes(time)) slotDiv.classList.add('selected');

    if(!slotDiv.classList.contains('booked') || (bookedSessions.includes(slotISO) && (new Date(slotISO)-new Date())>=24*60*60*1000)){
      slotDiv.addEventListener('click',()=>{
        const planKey=packageSelect.value;
        const maxSlots=planLimits[planKey];
        if(slotDiv.classList.contains('selected')){
          slotDiv.classList.remove('selected');
          const idx=selectedSlotsByDay[dateStr].indexOf(time);
          if(idx>-1) selectedSlotsByDay[dateStr].splice(idx,1);
        } else {
          if(totalSelectedCount()<maxSlots){
            slotDiv.classList.add('selected');
            selectedSlotsByDay[dateStr].push(time);
          } else alert(`You can only select ${maxSlots} slot${maxSlots>1?'s':''} for the ${planKey} package.`);
        }
        updateSelectionSummary();
        updatePaymentVisibility();
      });
    }
    timeSlotsDiv.appendChild(slotDiv);
  }
}

// Navigation
prevMonth.addEventListener('click',()=>{currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} loadBookedSessions();});
nextMonth.addEventListener('click',()=>{currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} loadBookedSessions();});

closeModal.addEventListener('click',()=>modal.style.display='none');
window.addEventListener('click', e=>{if(e.target===modal) modal.style.display='none';});
packageSelect.addEventListener('change',()=>{updateSelectionSummary(); updatePriceSummary(); updatePaymentVisibility();});

// Stripe Payment
stripePayBtn.addEventListener('click', async ()=>{
  const planKey = packageSelect.value;
  const stripe = Stripe("pk_test_51S0fdeJHTA6RJOGgnRqmX0uM9cVytpImUTRPbLAKZz3hFuQ2aIQqlANcZzP7aAvhdpaldKyugXw0cWvGnd5pbqUW008hVRiqQj");
  const pending = {plan:planKey, selections:selectedSlotsByDay};
  localStorage.setItem('pendingBooking',JSON.stringify(pending));
  const successUrl = `${location.origin}${location.pathname}?paid=stripe`;
  const cancelUrl = `${location.origin}${location.pathname}?paid=cancel`;
  await stripe.redirectToCheckout({lineItems:[{price:stripePriceIDs[planKey],quantity:1}],mode:'payment',successUrl,cancelUrl});
});

// PayPal Buttons
function initPayPalButtons(){
  if(!window.paypal || !paypal.Buttons) return;
  paypal.Buttons({
    style:{layout:'vertical'},
    createOrder:function(data,actions){
      const planKey=packageSelect.value;
      const amount=planPrices[planKey];
      return actions.order.create({purchase_units:[{amount:{value:amount.toFixed(2)}}]});
    },
    onApprove:function(data,actions){
      return actions.order.capture().then(function(details){
        Object.entries(selectedSlotsByDay).forEach(([day,times])=>{
          times.forEach(time=>{
            const iso = `${day}T${time}`;
            bookingsRef.doc(iso).set({booked:true});
          });
        });
        for(const d in selectedSlotsByDay) selectedSlotsByDay[d]=[];
        loadBookedSessions();
        alert("Payment confirmed via PayPal. Your selected slots have been booked.");
        modal.style.display='none';
        updatePaymentVisibility();
      });
    },
    onError:function(err){console.error(err); alert("PayPal error. Please try again or use Stripe.");}
  }).render('#paypal-button-container');
}

(function waitForPayPal(){
  const sdk=document.getElementById('paypal-sdk');
  if(window.paypal){initPayPalButtons(); return;}
  if(sdk) sdk.addEventListener('load',initPayPalButtons);
})();

(function handleStripeReturn(){
  const params=new URLSearchParams(location.search);
  if(params.get('paid')==='stripe'){
    const pending=JSON.parse(localStorage.getItem('pendingBooking')||'null');
    if(pending && pending.selections){
      Object.entries(pending.selections).forEach(([day,times])=>{
        times.forEach(time=>{
          const iso=`${day}T${time}`;
          bookingsRef.doc(iso).set({booked:true});
        });
      });
      localStorage.removeItem('pendingBooking');
      for(const d in selectedSlotsByDay) selectedSlotsByDay[d]=[];
      loadBookedSessions();
      alert("Payment confirmed via Stripe. Your selected slots have been booked.");
      history.replaceState({},document.title,location.pathname);
    }
  }
})();

loadBookedSessions();
</script>

</body>
</html>
