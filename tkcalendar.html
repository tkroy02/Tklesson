<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tklesson Booking Calendar</title>
<style>
  body { font-family: Arial, sans-serif; background:#0b0b0b; color:#f0e6d2; margin:0; padding:0; }
  .logo { display:flex; justify-content:center; margin:15px 0; }
  .logo img { height:60px; }
  h1 { text-align:center; color:#ffd700; margin:5px 0 15px 0; }
  .legend { display:flex; justify-content:center; gap:20px; margin-bottom:20px; }
  .legend div { padding:5px 15px; border-radius:5px; font-weight:bold; text-align:center; }
  .booked-legend { background:#a00; color:#fff; }
  .available-legend { background:#111; color:#f0e6d2; border:1px solid #fff; }
  .calendar { max-width:700px; margin:0 auto 30px auto; background:#1a1a1a; padding:15px; border-radius:10px; }
  .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .calendar-header button { background:#ffd700; color:#111; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
  .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
  .day { padding:10px; background:#111; text-align:center; border-radius:5px; cursor:pointer; }
  .day.past { background:#222; color:#666; cursor:not-allowed; }
  .day.fully-booked { background:#a00; color:#fff; cursor:not-allowed; }
  .day:hover:not(.past):not(.fully-booked) { background:#ffd700; color:#111; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:10; }
  .modal-content { background:#1a1a1a; padding:20px; border-radius:10px; max-width:480px; width:92%; max-height:90vh; overflow-y:auto; }
  .modal-content h2 { color:#ffd700; text-align:center; margin-bottom:10px; }
  .timeslot { padding:8px; margin:5px 0; background:#222; border-radius:5px; cursor:pointer; text-align:center; display:flex; justify-content:space-between; align-items:center; }
  .timeslot.booked { background:#a00 !important; cursor:not-allowed; color:#fff; }
  .timeslot.selected { background:#00a; color:#fff; }
  .timeslot:hover:not(.booked):not(.selected) { background:#ffd700; color:#111; }
  .close { float:right; cursor:pointer; color:#ffd700; font-weight:bold; }
  select.package-select { margin-right:10px; padding:3px 6px; border-radius:4px; border:none; }
  .pay-area { margin-top:12px; }
  .price-summary { text-align:center; margin:6px 0 10px 0; font-weight:bold; }
  .stripe-btn { background:#6772e5; color:#fff; margin-top:8px; width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; display:none; }
  #paypalButtons { display:none; margin-top:8px; }
  .loadingOverlay { text-align:center; color:#f0e6d2; padding:8px 10px; font-size:0.95rem; }
</style>

<script src="https://js.stripe.com/v3/"></script>
<script id="paypal-sdk" src="https://www.paypal.com/sdk/js?client-id=AQn3tn3wEl7ZO-XBe--qxdJo2MhvTmY8ab-pJxLxFtwbitKN-O2tGabfy6nWE1ylGadZ0PqLQdzXj5eF&currency=USD"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="logo"><img src="Tklesson1_transparent.png" alt="Tklesson Logo"></div>
<h1>Tklesson Booking Calendar</h1>

<div class="legend">
  <div class="booked-legend">Booked</div>
  <div class="available-legend">Available</div>
</div>

<div class="calendar">
  <div class="calendar-header">
    <button id="prevMonth">&lt; Prev</button>
    <h2 id="monthYear"></h2>
    <button id="nextMonth">Next &gt;</button>
  </div>

  <div class="loadingOverlay" id="loadingOverlay">Loading bookings…</div>
  <div class="calendar-grid" id="calendarGrid" style="display:none;"></div>
</div>

<div class="modal" id="timeModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <span class="close" id="closeModal" title="Close">&times;</span>
    <h2 id="modalDate"></h2>

    <div>
      <label for="packageSelect" style="color:#ffd700;">Select Package:</label>
      <select id="packageSelect" class="package-select">
        <option value="basic">Basic - $45</option>
        <option value="bronze">Bronze - $170</option>
        <option value="silver">Silver - $330</option>
        <option value="gold">Gold - $480</option>
      </select>
      <span id="selectionSummary" style="float:right; opacity:.9;"></span>
    </div>

    <div id="timeSlots" style="margin-top:10px;"></div>

    <div class="pay-area">
      <div id="priceSummary" class="price-summary"></div>
      <button id="stripePay" class="stripe-btn">Pay with Stripe</button>
      <div id="paypalButtons"><div id="paypal-button-container"></div></div>
    </div>
  </div>
</div>

<script>
/* ====== Firebase config ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAJmjHubN4I3VQCQOZpifFWHchBF2Dz-Jk",
  authDomain: "tkcalendar-40abb.firebaseapp.com",
  projectId: "tkcalendar-40abb",
  storageBucket: "tkcalendar-40abb.firebasestorage.app",
  messagingSenderId: "843304405219",
  appId: "1:843304405219:web:a0c0498d1d048277b85dd6",
  measurementId: "G-4EQXKHJTJ4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const bookingsRef = db.collection('bookedSessions');

/* ====== Elements & state ====== */
const calendarGrid = document.getElementById('calendarGrid');
const monthYear = document.getElementById('monthYear');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const loadingOverlay = document.getElementById('loadingOverlay');

const modal = document.getElementById('timeModal');
const closeModal = document.getElementById('closeModal');
const modalDate = document.getElementById('modalDate');
const timeSlotsDiv = document.getElementById('timeSlots');

const packageSelect = document.getElementById('packageSelect');
const selectionSummary = document.getElementById('selectionSummary');
const stripePayBtn = document.getElementById('stripePay');
const paypalButtonsWrapper = document.getElementById('paypalButtons');
const priceSummary = document.getElementById('priceSummary');

let bookingsLoaded = false;
let bookedSessions = []; // list of ISO strings saved in Firestore (doc IDs)
let selectedSlotsByDay = {}; // will be restored from localStorage after bookings load
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const planLimits = { basic: 1, bronze: 4, silver: 8, gold: 12 };
const planPrices = { basic: 45, bronze: 170, silver: 330, gold: 480 };
const stripePriceIDs = { basic:"price_1S0gVjJHTA6RJOGg88mEOLMW", bronze:"price_1S0j1cJHTA6RJOGgHg8XLo68", silver:"price_IS0j3ZJHTA6RJOGgXrl7icK5", gold:"price_IS0j6dJHTA6RJOGgtjrBr4SG" };

/* ====== Helpers ====== */
function totalSelectedCount(){
  return Object.values(selectedSlotsByDay).reduce((s,arr)=>s+arr.length,0);
}
function updateSelectionSummary(){ const planKey = packageSelect.value; const max = planLimits[planKey]; selectionSummary.textContent = `Selected ${totalSelectedCount()} / ${max}`; }
function updatePriceSummary(){ const planKey = packageSelect.value; priceSummary.textContent = `$${planPrices[planKey]} — ${planLimits[planKey]} session${planLimits[planKey]>1?'s':''}`; }
function updatePaymentVisibility(){ const planKey = packageSelect.value; const max = planLimits[planKey]; const ready = totalSelectedCount()===max && max>0; stripePayBtn.style.display = ready ? 'block' : 'none'; paypalButtonsWrapper.style.display = ready ? 'block' : 'none'; }

/* ====== Load bookings from Firestore (Promise) ====== */
async function loadBookedSessions(){
  // show loading UI
  loadingOverlay.style.display = 'block';
  calendarGrid.style.display = 'none';
  bookingsLoaded = false;

  try{
    const snapshot = await bookingsRef.get();
    bookedSessions = [];
    snapshot.forEach(doc => bookedSessions.push(doc.id));
  } catch(err){
    console.error('Failed to load bookings:', err);
    alert('Unable to load bookings. Check console.');
  } finally {
    bookingsLoaded = true;
    // restore selected slots from localStorage but filter out slots that are now booked
    restoreSelectionsFromLocalStorage();
    renderCalendar(currentMonth, currentYear);
    loadingOverlay.style.display = 'none';
    calendarGrid.style.display = 'grid';
  }
}

/* Restore saved user selections but remove times that are already booked */
function restoreSelectionsFromLocalStorage(){
  const raw = localStorage.getItem('selectedSlots') || '{}';
  let saved = {};
  try { saved = JSON.parse(raw) || {}; } catch(e){ saved = {}; }
  const filtered = {};
  for(const day in saved){
    const times = Array.isArray(saved[day]) ? saved[day] : [];
    const keep = times.filter(t => {
      const iso = `${day}T${t}`;
      return !bookedSessions.includes(iso); // only keep if not already booked
    });
    if(keep.length) filtered[day] = keep;
  }
  selectedSlotsByDay = filtered;
  localStorage.setItem('selectedSlots', JSON.stringify(filtered));
}

/* Save single booking to Firestore */
function saveBookingToFirebase(day, time){
  const iso = `${day}T${time}`;
  return bookingsRef.doc(iso).set({ booked: true }, { merge: true });
}

/* Remove booking (cancellation) from Firestore */
function removeBookingFromFirebase(iso){
  return bookingsRef.doc(iso).delete();
}

/* ====== Calendar render / modal logic ====== */
let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();

function renderCalendar(month, year){
  calendarGrid.innerHTML = '';
  const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  monthYear.textContent = `${monthNames[month]} ${year}`;
  weekdays.forEach(day => { const d = document.createElement('div'); d.textContent = day; d.style.fontWeight = 'bold'; calendarGrid.appendChild(d); });

  const firstDay = new Date(year, month, 1).getDay();
  for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));

  const lastDate = new Date(year, month+1, 0).getDate();
  for(let date=1; date<=lastDate; date++){
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');
    const dayDate = new Date(year, month, date);
    dayDiv.textContent = date;

    const dayStart = new Date(year, month, date); dayStart.setHours(0,0,0,0);
    if(dayStart < new Date().setHours(0,0,0,0)) dayDiv.classList.add('past');

    // Determine if all slots are booked (9..21 inclusive -> 13 slots)
    const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
    const allSlots = [];
    for(let h=9; h<=21; h++) allSlots.push(`${dayStr}T${h.toString().padStart(2,'0')}:00`);
    if(allSlots.every(s => bookedSessions.includes(s))) dayDiv.classList.add('fully-booked');

    dayDiv.addEventListener('click', ()=> openModal(dayDate));
    calendarGrid.appendChild(dayDiv);
  }
}

/* Open modal: if bookings not loaded yet, don't open */
function openModal(date){
  if(!bookingsLoaded){
    alert('Still loading bookings — please wait a moment and try again.');
    return;
  }

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  modalDate.textContent = `Available Time Slots — ${date.toDateString()}`;
  timeSlotsDiv.innerHTML = '';
  updateSelectionSummary();
  updatePriceSummary();
  updatePaymentVisibility();

  const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
  if(!selectedSlotsByDay[dateStr]) selectedSlotsByDay[dateStr] = [];

  for(let h=9; h<=21; h++){
    const time = `${h.toString().padStart(2,'0')}:00`;
    const slotDiv = document.createElement('div');
    slotDiv.textContent = time;
    slotDiv.classList.add('timeslot');
    const slotISO = `${dateStr}T${time}`;

    const isBooked = bookedSessions.includes(slotISO);
    const hoursDiff = (new Date(slotISO) - new Date()) / (1000*60*60);

    if(isBooked){
      slotDiv.classList.add('booked');
      // If cancellable (>24h) offer a separate cancel/reschedule handler
      if(hoursDiff >= 24){
        slotDiv.style.cursor = 'pointer';
        slotDiv.title = 'Click to reschedule or cancel (allowed >24 hours before)';
        slotDiv.addEventListener('click', async (e) => {
          // IMPORTANT: cancel click should not act as "select" — it's a cancel action.
          e.stopPropagation();
          const ok = confirm(`Do you want to CANCEL this session at ${time} on ${dateStr}? (You can reschedule after cancelling)`);
          if(!ok) return;
          try{
            await removeBookingFromFirebase(slotISO);
            // After deletion, refresh bookings (this will also remove any accidental selected-state)
            await loadBookedSessions();
            alert('Session successfully cancelled. You may now select a new slot.');
            // reopen modal for same date (bookings reloaded inside loadBookedSessions)
            openModal(date);
          } catch(err){
            console.error('Cancel failed', err);
            alert('Cancellation failed — check console.');
          }
        });
      }
    } else {
      // only mark selected if user previously saved it and it's not booked
      if(selectedSlotsByDay[dateStr] && selectedSlotsByDay[dateStr].includes(time)) slotDiv.classList.add('selected');

      // attach selection handler only for non-booked slots
      slotDiv.addEventListener('click', () => {
        const planKey = packageSelect.value;
        const maxSlots = planLimits[planKey];
        if(slotDiv.classList.contains('selected')){
          slotDiv.classList.remove('selected');
          const idx = selectedSlotsByDay[dateStr].indexOf(time);
          if(idx > -1) selectedSlotsByDay[dateStr].splice(idx, 1);
        } else {
          if(totalSelectedCount() < maxSlots){
            slotDiv.classList.add('selected');
            selectedSlotsByDay[dateStr].push(time);
          } else {
            alert(`You can only select ${maxSlots} slot${maxSlots>1?'s':''} for the ${planKey} package.`);
          }
        }
        // persist selections (so refresh doesn't lose them)
        localStorage.setItem('selectedSlots', JSON.stringify(selectedSlotsByDay));
        updateSelectionSummary();
        updatePaymentVisibility();
      });
    }

    timeSlotsDiv.appendChild(slotDiv);
  }
}

/* ====== Navigation & modal controls ====== */
prevMonth.addEventListener('click', ()=>{ currentMonth--; if(currentMonth<0){ currentMonth = 11; currentYear--; } loadBookedSessions(); });
nextMonth.addEventListener('click', ()=>{ currentMonth++; if(currentMonth>11){ currentMonth = 0; currentYear++; } loadBookedSessions(); });

closeModal.addEventListener('click', ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
window.addEventListener('click', e => { if(e.target === modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });

packageSelect.addEventListener('change', ()=>{ updateSelectionSummary(); updatePriceSummary(); updatePaymentVisibility(); });

/* ====== Payment flows ====== */
/* Stripe: when user clicks stripePay, we save current selections to localStorage.pending and redirectToCheckout.
   After return (successUrl) we read pending and write them to Firestore, then clear pending & selected. */
stripePayBtn.addEventListener('click', async () => {
  const planKey = packageSelect.value;
  const stripe = Stripe("pk_test_51S0fdeJHTA6RJOGgnRqmX0uM9cVytpImUTRPbLAKZz3hFuQ2aIQqlANcZzP7aAvhdpaldKyugXw0cWvGnd5pbqUW008hVRiqQj");
  // Save temporary pending so we can finalize after redirect
  localStorage.setItem('pendingBooking', JSON.stringify(selectedSlotsByDay));
  const successUrl = `${location.origin}${location.pathname}?paid=stripe`;
  const cancelUrl = `${location.origin}${location.pathname}?paid=cancel`;
  // redirect using client-only Checkout (assumes you enabled it for testing)
  await stripe.redirectToCheckout({
    lineItems: [{ price: stripePriceIDs[planKey], quantity: 1 }],
    mode: 'payment',
    successUrl,
    cancelUrl
  });
});

/* PayPal: create order then onApprove save each selected slot to Firestore */
function initPayPalButtons(){
  if(!window.paypal || !paypal.Buttons) return;
  paypal.Buttons({
    style: { layout: 'vertical' },
    createOrder: function(data, actions){
      const planKey = packageSelect.value;
      const amount = planPrices[planKey];
      return actions.order.create({ purchase_units: [{ amount: { value: amount.toFixed(2) } }] });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(async function(details){
        // persist selections to Firestore
        const entries = Object.entries(selectedSlotsByDay);
        for(const [day, times] of entries){
          for(const time of times){
            await saveBookingToFirebase(day, time);
          }
        }
        // clear selections
        selectedSlotsByDay = {};
        localStorage.removeItem('selectedSlots');
        localStorage.removeItem('pendingBooking');
        await loadBookedSessions();
        alert('Payment confirmed via PayPal. Your selected slots have been booked.');
        modal.style.display = 'none';
        updatePaymentVisibility();
      });
    },
    onError: function(err){
      console.error(err);
      alert('PayPal error — please try again or use Stripe.');
    }
  }).render('#paypal-button-container');
}
(function waitForPayPal(){ const sdk = document.getElementById('paypal-sdk'); if(window.paypal){ initPayPalButtons(); } else if(sdk){ sdk.addEventListener('load', initPayPalButtons); }})();

/* Handle return from Stripe (success) */
(async function handleStripeReturn(){
  const params = new URLSearchParams(location.search);
  if(params.get('paid') === 'stripe'){
    const pendingRaw = localStorage.getItem('pendingBooking') || '{}';
    let pending = {};
    try { pending = JSON.parse(pendingRaw) || {}; } catch(e) { pending = {}; }
    for(const [day, times] of Object.entries(pending)){
      for(const time of times){
        try { await saveBookingToFirebase(day, time); } catch(e){ console.error('Stripe finalize failed', e); }
      }
    }
    localStorage.removeItem('pendingBooking');
    selectedSlotsByDay = {};
    localStorage.removeItem('selectedSlots');
    await loadBookedSessions();
    alert('Payment confirmed via Stripe. Your selected slots have been booked.');
    history.replaceState({}, document.title, location.pathname);
  }
})();

/* ====== Start: load bookings and then show calendar ====== */
loadBookedSessions();
</script>

</body>
</html>
