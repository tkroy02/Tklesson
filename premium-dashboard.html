<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Tklesson Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3/minified.js"></script>
    
    <!-- ✅ MOVE CONFIG BEFORE SCRIPT -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        packages: {'[+]': ['ams']}  // ADD THIS LINE
      },
      loader: {
        load: ['[tex]/ams']  // ADD THIS BLOCK
      },
      svg: {
        fontCache: 'global'
      },
      startup: {
        ready: () => {
          MathJax.startup.defaultReady();
          window.mathJaxReady = true;
          console.log('✅ MathJax is ready');
        }
      }
    };
</script>    
    <!-- ✅ SCRIPT COMES AFTER CONFIG -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- In your HTML head -->
    <script src="https://js.stripe.com/v3/"></script>

    <script src="https://tklesson.com/resources-loader.js"></script>
    <script>loadCommonResources();</script>
        
    <style>
        :root {
            --primary: #0b3d91;
            --primary-dark: #082b6f;
            --primary-light: #1e5bbf;
            --secondary: #ffe066;
            --accent: #ff6b6b;
            --light-bg: #f0f6ff;
            --lighter-bg: #f8fbff;
            --text-dark: #0b3d91;
            --text-light: #ffffff;
            --gray: #6b7280;
            --light-gray: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --border-radius: 20px;
            --border-radius-sm: 12px;
            --border-radius-lg: 24px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.12);
            --shadow-hover: 0 25px 50px rgba(0, 0, 0, 0.15);
            --transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --glass: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
            gap: 0;
        }


/* Cancel Subscription Modal Specific Styles */
#cancel-subscription-modal .modal-content {
    max-width: 500px;
}

#cancel-subscription-modal .tool-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: white;
}

#cancel-subscription-modal ul {
    list-style-type: none;
}

#cancel-subscription-modal ul li {
    margin-bottom: 8px;
    padding-left: 25px;
    position: relative;
}

#cancel-subscription-modal ul li:before {
    content: '✕';
    position: absolute;
    left: 0;
    color: var(--accent);
    font-weight: bold;
}

/* Subscription status improvements */
#active-subscription-details {
    transition: opacity 0.3s ease;
}

#active-subscription-details.fading {
    opacity: 0.5;
}

/* Difficulty Badges for Past Questions */
.difficulty-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.difficulty-badge.easy {
    background: #e0f2fe;
    color: #0369a1;
}

.difficulty-badge.medium {
    background: #fef3c7;
    color: #92400e;
}

.difficulty-badge.challenging,
.difficulty-badge.hard {
    background: #fee2e2;
    color: #991b1b;
}

/* Dark theme support for difficulty badges */
[data-theme="dark"] .difficulty-badge.easy {
    background: #1e3a8a;
    color: #93c5fd;
}

[data-theme="dark"] .difficulty-badge.medium {
    background: #78350f;
    color: #fde68a;
}

[data-theme="dark"] .difficulty-badge.challenging,
[data-theme="dark"] .difficulty-badge.hard {
    background: #7f1d1d;
    color: #fca5a5;
}

.eq { margin: .35rem 0; }
.eq-center { text-align: center; }
.math-callout { 
    border-left: 4px solid var(--primary); 
    background: #eef2ff; 
    padding: 14px 16px; 
    border-radius: 10px; 
    margin: 10px 0;
}

        .step-number {
    display: inline-block;
    background: var(--primary);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    text-align: center;
    line-height: 28px;
    font-weight: bold;
    margin-right: 12px;
}
        
/* ===== COMPLETE DARK THEME - CONSOLIDATED ===== */
[data-theme="dark"] {
    background: #0f172a !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .main-content {
    background: #0f172a !important;
}

[data-theme="dark"] body {
    background: #0f172a !important;
}

/* Main containers - Dark blue */
[data-theme="dark"] .course-card,
[data-theme="dark"] .settings-card,
[data-theme="dark"] .pricing-card,
[data-theme="dark"] .tool-interface,
[data-theme="dark"] .recent-activity,
[data-theme="dark"] .quick-stats,
[data-theme="dark"] .quiz-container,
[data-theme="dark"] .textbook-sidebar,
[data-theme="dark"] .textbook-content,
[data-theme="dark"] .tool-card,
[data-theme="dark"] .formula-category,
[data-theme="dark"] .converter-section,
[data-theme="dark"] .calculator-container,
[data-theme="dark"] .exam-quiz-container .exam-info-section,
[data-theme="dark"] .exam-quiz-container .quiz-grid-container,
[data-theme="dark"] .quiz-unit-container,
[data-theme="dark"] .modal-content {
    background: #1e293b !important;
    color: #f8fafc !important;
    border-color: #334155 !important;
}

/* Inner boxes - Medium gray */
[data-theme="dark"] .key-points,
[data-theme="dark"] .vocabulary,
[data-theme="dark"] .content-section,
[data-theme="dark"] .textbook-section-item,
[data-theme="dark"] .formula-item,
[data-theme="dark"] .vocab-item,
[data-theme="dark"] .flashcard-stats,
[data-theme="dark"] .activity-icon,
[data-theme="dark"] .stat-card,
[data-theme="dark"] .user-info {
    background: #334155 !important;
    color: #f8fafc !important;
    border-color: #475569 !important;
}

/* Highlighted sections - Light gray */
[data-theme="dark"] .key-points,
[data-theme="dark"] .vocabulary {
    background: #475569 !important;
    border-left-color: #3b82f6 !important;
}

[data-theme="dark"] .formula-item {
    background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
    border-left-color: #3b82f6 !important;
}

/* Special content boxes */
[data-theme="dark"] .formula-equation {
    background: #1e293b !important;
    color: #f8fafc !important;
    border-color: #334155 !important;
}

[data-theme="dark"] code {
    background: #475569 !important;
    color: #fbbf24 !important;
    padding: 2px 6px;
    border-radius: 4px;
}

/* Interactive elements */
[data-theme="dark"] .textbook-section-item:hover,
[data-theme="dark"] .unit-btn:hover,
[data-theme="dark"] .activity-item:hover {
    background: #475569 !important;
    border-color: #3b82f6 !important;
}

[data-theme="dark"] .unit-btn.active {
    background: #3b82f6 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .unit-btn {
    background: #334155 !important;
    color: #f8fafc !important;
    border-color: #475569 !important;
}

/* Quiz elements with color coding */
[data-theme="dark"] .quiz-box.easy {
    background: #1e3a8a !important;
    color: #93c5fd !important;
    border-color: #3b82f6 !important;
}

[data-theme="dark"] .quiz-box.medium {
    background: #166534 !important;
    color: #86efac !important;
    border-color: #22c55e !important;
}

[data-theme="dark"] .quiz-box.challenging {
    background: #7f1d1d !important;
    color: #fca5a5 !important;
    border-color: #ef4444 !important;
}

[data-theme="dark"] .quiz-btn {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important;
    color: #93c5fd !important;
    border-color: #3b82f6 !important;
}

[data-theme="dark"] .quiz-btn:hover {
    background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%) !important;
    color: #ffffff !important;
}

/* Buttons */
[data-theme="dark"] .btn {
    background: linear-gradient(135deg, #475569 0%, #64748b 100%) !important;
    color: #ffffff !important;
}

[data-theme="dark"] .btn-outline {
    background: transparent !important;
    border-color: #64748b !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .btn-outline:hover {
    background: #475569 !important;
    border-color: #94a3b8 !important;
}

/* Form elements */
[data-theme="dark"] .form-input,
[data-theme="dark"] .settings-select,
[data-theme="dark"] .converter-input,
[data-theme="dark"] .converter-select,
[data-theme="dark"] .converter-result,
[data-theme="dark"] .calc-display {
    background: #334155 !important;
    border-color: #475569 !important;
    color: #f8fafc !important;
}

/* Calculator */
[data-theme="dark"] .calc-btn {
    background: #475569 !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .calc-btn.operator {
    background: #64748b !important;
}

[data-theme="dark"] .calc-btn.equals {
    background: #059669 !important;
}

[data-theme="dark"] .calc-btn.clear {
    background: #dc2626 !important;
}

/* Progress bars */
[data-theme="dark"] .progress-bar {
    background: #475569 !important;
}

[data-theme="dark"] .progress-fill {
    background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%) !important;
}

/* Quiz options */
[data-theme="dark"] .option {
    background: #334155 !important;
    border-color: #475569 !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .option:hover,
[data-theme="dark"] .option.selected {
    background: #475569 !important;
    border-color: #3b82f6 !important;
}

/* Flashcards */
[data-theme="dark"] .flashcard-front,
[data-theme="dark"] .flashcard-back {
    background: #1e293b !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .flashcard-stat-value {
    color: #60a5fa !important;
}

[data-theme="dark"] .flashcard-stat-label {
    color: #94a3b8 !important;
}

/* Sidebar and gradients */
[data-theme="dark"] .sidebar {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .welcome-section {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
    color: #f8fafc !important;
}

[data-theme="dark"] .sidebar-menu a {
    color: #cbd5e1 !important;
}

[data-theme="dark"] .sidebar-menu a:hover,
[data-theme="dark"] .sidebar-menu a.active {
    background: #475569 !important;
    color: #ffffff !important;
}

/* Text and typography */
[data-theme="dark"] .page-title {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
    background-clip: text !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
}

[data-theme="dark"] .section-title {
    color: #f8fafc !important;
}

[data-theme="dark"] .section-title:before {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
}

[data-theme="dark"] .tool-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important;
}

/* All text elements */
[data-theme="dark"] h1,
[data-theme="dark"] h2,
[data-theme="dark"] h3,
[data-theme="dark"] h4,
[data-theme="dark"] h5,
[data-theme="dark"] h6,
[data-theme="dark"] p,
[data-theme="dark"] span,
[data-theme="dark"] div,
[data-theme="dark"] .course-card h3,
[data-theme="dark"] .course-card p,
[data-theme="dark"] .tool-card h3,
[data-theme="dark"] .tool-card p,
[data-theme="dark"] .formula-name,
[data-theme="dark"] .formula-equation,
[data-theme="dark"] .formula-description,
[data-theme="dark"] .textbook-section .section-title,
[data-theme="dark"] .textbook-section .section-description,
[data-theme="dark"] .content-paragraph,
[data-theme="dark"] .exam-quiz-container .exam-description h4,
[data-theme="dark"] .exam-quiz-container .exam-description p,
[data-theme="dark"] .exam-quiz-container .quiz-grid-title,
[data-theme="dark"] .quiz-unit-title {
    color: #f8fafc !important;
}

[data-theme="dark"] small,
[data-theme="dark"] .stat-label,
[data-theme="dark"] .formula-description,
[data-theme="dark"] .flashcard-stat-label {
    color: #cbd5e1 !important;
}

/* Modal and borders */
[data-theme="dark"] .modal-header,
[data-theme="dark"] .page-header,
[data-theme="dark"] .activity-item,
[data-theme="dark"] .content-section,
[data-theme="dark"] .section-navigation {
    border-color: #475569 !important;
}

[data-theme="dark"] .key-points li:before {
    color: #10b981 !important;
}

[data-theme="dark"] .pricing-card.popular:after {
    background: #3b82f6 !important;
    color: #ffffff !important;
}

/* ===== TEXTBOOK & QUIZ NESTED BOX FIXES ===== */
[data-theme="dark"] .textbook-section .content-section div[style*="background"],
[data-theme="dark"] .textbook-section div[style*="background: white"],
[data-theme="dark"] .textbook-section div[style*="background: #"],
[data-theme="dark"] .textbook-section div[style*="background-color"],
[data-theme="dark"] .quiz-container div[style*="background: white"],
[data-theme="dark"] .quiz-container div[style*="background: #f8f9fa"],
[data-theme="dark"] .quiz-container div[style*="background: #"],
[data-theme="dark"] .question-result div[style*="background"],
[data-theme="dark"] .textbook-section div[style*="background: #f8f9fa"],
[data-theme="dark"] .textbook-section div[style*="background: #e8f4fd"],
[data-theme="dark"] .textbook-section div[style*="background: #fff3cd"],
[data-theme="dark"] .textbook-section div[style*="background: #e8f5e8"],
[data-theme="dark"] .textbook-section div[style*="background: var(--light-bg)"],
[data-theme="dark"] .question-result div[style*="background: white"],
[data-theme="dark"] .quiz-content div[style*="background"],
[data-theme="dark"] .quiz-info div[style*="background"],
[data-theme="dark"] [style*="background: white"],
[data-theme="dark"] [style*="background: #fff"],
[data-theme="dark"] [style*="background: #ffffff"],
[data-theme="dark"] [style*="background-color: white"],
[data-theme="dark"] [style*="background-color: #fff"],
[data-theme="dark"] [style*="background-color: #ffffff"],
[data-theme="dark"] [style*="background: #f8f9fa"],
[data-theme="dark"] [style*="background: #e9ecef"],
[data-theme="dark"] [style*="background: #f0f6ff"],
[data-theme="dark"] [style*="background: #f8fbff"],
[data-theme="dark"] [style*="background: #e8f4fd"],
[data-theme="dark"] [style*="background: #fff3cd"],
[data-theme="dark"] [style*="background: #e8f5e8"] {
    background: #334155 !important;
    color: #f8fafc !important;
    border-color: #475569 !important;
}

[data-theme="dark"] .question-result {
    border-left-color: #3b82f6 !important;
}

[data-theme="dark"] .quiz-info {
    background: #334155 !important;
    color: #f8fafc !important;
    border-color: #475569 !important;
}

[data-theme="dark"] [style*="border-color: var(--light-gray)"],
[data-theme="dark"] [style*="border-color: #e5e7eb"],
[data-theme="dark"] [style*="border-color: #e9ecef"] {
    border-color: #475569 !important;
}

[data-theme="dark"] .textbook-section div[style*="color: var"],
[data-theme="dark"] .quiz-container div[style*="color: var"],
[data-theme="dark"] [style*="color: var(--primary)"],
[data-theme="dark"] [style*="color: var(--primary-dark)"],
[data-theme="dark"] [style*="color: var(--text-dark)"],
[data-theme="dark"] [style*="color: #0b3d91"],
[data-theme="dark"] [style*="color: #082b6f"] {
    color: #f8fafc !important;
}

[data-theme="dark"] [style*="color: var(--gray)"],
[data-theme="dark"] [style*="color: #6c757d"],
[data-theme="dark"] [style*="color: #6b7280"] {
    color: #cbd5e1 !important;
}

[data-theme="dark"] [style*="color: var(--success)"],
[data-theme="dark"] [style*="color: #28a745"] {
    color: #10b981 !important;
}

[data-theme="dark"] [style*="color: var(--warning)"],
[data-theme="dark"] [style*="color: #ffc107"] {
    color: #f59e0b !important;
}

[data-theme="dark"] [style*="color: var(--accent)"],
[data-theme="dark"] [style*="color: #ff6b6b"] {
    color: #ef4444 !important;
}

[data-theme="dark"] [style*="box-shadow"] {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
}

[data-theme="dark"] [style*="border:"] {
    border-color: #475569 !important;
}

[data-theme="dark"] .textbook-section div,
[data-theme="dark"] .quiz-container div,
[data-theme="dark"] .question-result div {
    color: #f8fafc !important;
}

[data-theme="dark"] [style*="background: linear-gradient"] {
    background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
}

[data-theme="dark"] [style*="background: radial-gradient"] {
    background: radial-gradient(circle, #334155 0%, #475569 100%) !important;
}
        
.flashcard-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

.flashcard {
    perspective: 1000px;
    height: 300px;
    margin: 20px 0;
    cursor: pointer;
    position: relative;
}

.flashcard-front, .flashcard-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    background: #ffffff;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.6s;
}

.flashcard-back {
    transform: rotateY(180deg);
}

.flashcard.flipped .flashcard-front {
    transform: rotateY(180deg);
}

.flashcard.flipped .flashcard-back {
    transform: rotateY(0deg);
}

.flashcard-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
}

.flashcard-text {
    font-size: 1.2rem;
    line-height: 1.5;
    margin: 20px 0;
}

.flashcard-hint {
    text-align: center;
    color: #666;
    font-size: 0.9rem;
}

.flashcard-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

.flashcard-stats {
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.flashcard-stat-item {
    text-align: center;
}

.flashcard-stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #2563eb; /* Using explicit color instead of variable */
}

.flashcard-stat-label {
    font-size: 0.9rem;
    color: #6b7280;
}


/* Settings Styles */
.settings-container {
    max-width: 800px;
    margin: 0 auto;
}

.settings-section {
    margin-bottom: 40px;
}

.settings-card {
    background: white;
    border-radius: var(--border-radius-sm);
    padding: 25px;
    box-shadow: var(--shadow);
}

.settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid var(--light-gray);
}

.settings-item:last-child {
    border-bottom: none;
}

.settings-info h4 {
    color: var(--primary-dark);
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.settings-info p {
    color: var(--gray);
    margin: 0;
    font-size: 0.9rem;
}

.settings-badge {
    background: var(--success);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Switch Toggle */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--light-gray);
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

/* Select Inputs */
.settings-select {
    padding: 8px 12px;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    background: white;
    color: var(--primary-dark);
    min-width: 150px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: var(--border-radius);
    width: 90%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid var(--light-gray);
}

.modal-header h3 {
    margin: 0;
    color: var(--primary-dark);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--gray);
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    padding: 20px 25px;
    border-top: 1px solid var(--light-gray);
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

/* Form Styles */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--primary-dark);
}

.form-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    font-size: 1rem;
    transition: var(--transition);
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
}

.form-help {
    color: var(--gray);
    font-size: 0.8rem;
    margin-top: 5px;
    display: block;
}
        
/* Textbook Styles */
.textbook-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 30px;
    min-height: 600px;
}

.textbook-sidebar {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 25px;
    box-shadow: var(--shadow);
    height: 600px;  /* Change from fit-content to fixed height */
    overflow-y: auto;  /* Add this */
    position: relative;  /* Change from sticky to relative */
}

/* Add custom scrollbar styling */
.textbook-sidebar::-webkit-scrollbar {
    width: 8px;
}

.textbook-sidebar::-webkit-scrollbar-track {
    background: transparent;
}

.textbook-sidebar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.textbook-sidebar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.textbook-sidebar h4 {
    color: var(--primary);
    margin-bottom: 20px;
    font-size: 1.2rem;
    border-bottom: 2px solid var(--light-bg);
    padding-bottom: 10px;
}

.textbook-section-item {
    padding: 15px;
    border-radius: var(--border-radius-sm);
    margin-bottom: 10px;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid var(--light-gray);
}

.textbook-section {
    white-space: pre-line;
}

.textbook-section-item:hover {
    background: var(--light-bg);
    border-color: var(--primary);
    transform: translateX(5px);
}

.section-title {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 5px;
    font-size: 0.95rem;
}

.section-description {
    color: var(--gray);
    font-size: 0.85rem;
    line-height: 1.4;
}

.textbook-content {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 30px;
    box-shadow: var(--shadow);
    height: 600px;  /* Add fixed height */
    overflow-y: auto;  /* Add this */
}

.textbook-section .section-header {
    margin-bottom: 30px;
    border-bottom: 2px solid var(--light-bg);
    padding-bottom: 20px;
}

.textbook-section .section-header h2 {
    color: var(--primary);
    margin-bottom: 10px;
}

.section-subtitle {
    color: var(--gray);
    font-size: 1.1rem;
    font-style: italic;
}

.content-paragraph {
    margin-bottom: 20px;
    line-height: 1.7;
    color: var(--text-dark);
}

.content-paragraph:last-child {
    margin-bottom: 0;
}

.key-points, .vocabulary {
    background: var(--light-bg);
    padding: 25px;
    border-radius: var(--border-radius);
    margin: 30px 0;
    border-left: 4px solid var(--primary);
}

.key-points h3, .vocabulary h3 {
    color: var(--primary);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.key-points ul {
    list-style: none;
    padding-left: 0;
}

.key-points li {
    margin-bottom: 10px;
    padding-left: 25px;
    position: relative;
}

.key-points li:before {
    content: '✓';
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

.vocab-grid {
    display: grid;
    gap: 15px;
}

.vocab-item {
    padding: 15px;
    background: white;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--light-gray);
}

.section-navigation {
    margin-top: 40px;
    padding-top: 20px;
    border-top: 2px solid var(--light-bg);
    text-align: center;
}

@media (max-width: 768px) {
    .textbook-container {
        grid-template-columns: 1fr;
    }
    
    .textbook-sidebar {
        position: static;
    }
}
        
/* Examination Quiz Styles - More Specific Selectors */
.exam-quiz-container {
    max-width: 1200px;
    margin: 0 auto;
}

.exam-quiz-container .exam-info-section {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    align-items: center;
}

.exam-quiz-container .exam-description h4 {
    color: var(--primary);
    margin-bottom: 15px;
    font-size: 1.4rem;
}

.exam-quiz-container .exam-description p {
    color: var(--gray);
    line-height: 1.6;
}

.exam-quiz-container .exam-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
}

.exam-quiz-container .stat-item {
    padding: 15px;
}

.exam-quiz-container .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 5px;
}

.exam-quiz-container .stat-label {
    font-size: 0.9rem;
    color: var(--gray);
}

.exam-quiz-container .quiz-grid-container {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 30px;
    box-shadow: var(--shadow);
}

.exam-quiz-container .quiz-grid-title {
    color: var(--primary);
    margin-bottom: 20px;
    font-size: 1.3rem;
    border-bottom: 2px solid var(--light-bg);
    padding-bottom: 10px;
}

.exam-quiz-container .quiz-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    max-height: 600px;
    overflow-y: auto;
    padding: 10px;
}

.exam-quiz-container .quiz-btn {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #8a6d0b;
    border: none;
    border-radius: var(--border-radius-sm);
    padding: 20px 10px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid transparent;
}

.exam-quiz-container .quiz-btn:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, #f4e07a 0%, #f2d860 100%);
    border-color: #e6c440;
}

.exam-quiz-container .quiz-btn:active {
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .exam-quiz-container .exam-info-section {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .exam-quiz-container .exam-stats {
        justify-content: space-between;
    }
    
    .exam-quiz-container .quiz-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
    }
    
/* Add to the existing CSS */
@media (max-width: 768px) {
    /* Prevent horizontal flow in quiz grids */
    .quiz-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        max-height: none;
        overflow-x: hidden;
    }
    
    .quiz-btn {
        padding: 15px 5px;
        font-size: 0.8rem;
        min-height: 60px;
        word-break: break-word;
    }
    
    /* Fix exam quiz container for mobile */
    .exam-quiz-container .quiz-grid {
        grid-template-columns: repeat(4, 1fr); /* Fixed columns instead of auto-fill */
    }
    
    /* Ensure no horizontal scroll in quiz containers */
    .quiz-grid-container,
    .exam-quiz-container,
    .quiz-unit-container {
        overflow-x: hidden;
        width: 100%;
    }
    
    /* Fix quiz difficulty grid for mobile */
    .quiz-difficulty-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
    
    .quiz-box {
        padding: 12px 8px;
        font-size: 0.8rem;
        min-height: 60px;
    }
    
    /* Fix exam info section for mobile */
    .exam-quiz-container .exam-info-section {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px;
    }
    
    .exam-quiz-container .exam-stats {
        justify-content: space-around;
        flex-wrap: wrap;
    }
    
    .exam-quiz-container .stat-item {
        padding: 10px;
        min-width: 80px;
    }
    
    .exam-quiz-container .stat-value {
        font-size: 1.5rem;
    }
    
    .exam-quiz-container .stat-label {
        font-size: 0.8rem;
    }
}

/* Additional mobile fixes for very small screens */
@media (max-width: 480px) {
    .quiz-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .quiz-btn {
        padding: 12px 3px;
        font-size: 0.75rem;
        min-height: 50px;
    }
    
    .quiz-difficulty-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .exam-quiz-container .quiz-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .exam-quiz-container .stat-item {
        min-width: 70px;
        padding: 8px 5px;
    }
    
    .exam-quiz-container .stat-value {
        font-size: 1.3rem;
    }
}

/* Ensure no horizontal scroll on body */
body {
    overflow-x: hidden;
    max-width: 100vw;
}

/* Fix container widths */
.exam-quiz-container,
.quiz-grid-container,
.quiz-unit-container {
    max-width: 100%;
    box-sizing: border-box;
}

    .exam-quiz-container .quiz-btn {
        padding: 15px 8px;
        font-size: 0.9rem;
    }
}

.quiz-unit-container {
    margin-bottom: 40px;
    background: white;
    padding: 25px;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
}

.quiz-unit-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--light-gray);
}

.quiz-difficulty-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
}

.quiz-box {
    padding: 20px;
    border-radius: var(--border-radius-sm);
    text-align: center;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    border: 2px solid transparent;
}

.quiz-box:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.quiz-box.easy {
    background: #e0f2fe;
    color: #0369a1;
    border-color: #0ea5e9;
}

.quiz-box.easy:hover {
    background: #bae6fd;
}

.quiz-box.medium {
    background: #dcfce7;
    color: #15803d;
    border-color: #22c55e;
}

.quiz-box.medium:hover {
    background: #bbf7d0;
}

.quiz-box.challenging {
    background: #fee2e2;
    color: #991b1b;
    border-color: #ef4444;
}

.quiz-box.challenging:hover {
    background: #fecaca;
}

@media (max-width: 768px) {
    .quiz-difficulty-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
    }
    
    .quiz-box {
        padding: 15px;
        font-size: 0.9rem;
    }
}

@media (max-width: 768px) {
    /* existing styles... */
    
    /* All Courses search section */
    div[style*="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px"] {
        flex-direction: column;
        align-items: flex-start;
    }
    
    div[style*="position: relative; width: 300px"] {
        width: 100%;
        margin-top: 15px;
    }
}

/* Unit Selector Styles */
.unit-selector {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--light-bg);
}

.unit-selector h4 {
    color: var(--primary);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.unit-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.unit-btn {
    padding: 12px 15px;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    background: white;
    color: var(--primary);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    text-align: left;
    font-size: 0.9rem;
}

.unit-btn:hover {
    border-color: var(--primary);
    background: var(--light-bg);
}

.unit-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
        
/* Study Materials Cards */
.tool-card {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 30px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.8);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    text-align: center;
}

.tool-card:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
}

.tool-card:hover {
    transform: translateY(-10px);
    box-shadow: var(--shadow-hover);
}

.tool-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto 20px;
    transition: var(--transition);
}

.tool-card:hover .tool-icon {
    transform: scale(1.1) rotate(5deg);
}

/* Tool Interface Styles */
.tool-interface {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 30px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
    display: none;
}

.tool-interface.active {
    display: block;
    animation: fadeInUp 0.6s ease;
}

.tool-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--light-bg);
}

.tool-back {
    background: var(--light-bg);
    border: 2px solid var(--primary);
    padding: 12px 20px;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    color: var(--primary);
    font-weight: 600;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.tool-back:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

/* Unit Converter Styles */
.converter-container {
    max-width: 800px;
    margin: 0 auto;
}

.converter-section {
    background: white;
    padding: 25px;
    border-radius: var(--border-radius-lg);
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

.converter-section h4 {
    color: var(--primary);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.converter-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto 1fr 1fr;
    gap: 15px;
    align-items: center;
}

.converter-input, .converter-result {
    width: 150px; /* Instead of 100% */
    min-width: 60px;
}

.converter-input {
    padding: 12px;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    font-size: 1rem;
    text-align: center;
}

.converter-select {
    padding: 12px;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    font-size: 0.9rem;
    background: white;
}

.converter-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 15px;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: var(--transition);
}

.converter-btn:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
}

.converter-result {
    padding: 12px;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    font-size: 1rem;
    text-align: center;
    background: var(--light-bg);
    color: var(--primary);
    font-weight: 600;
}

/* Calculator Styles */
.calculator-container {
    max-width: 400px;
    margin: 0 auto;
}

.calc-display {
    width: 100%;
    padding: 20px;
    font-size: 1.8rem;
    text-align: right;
    border: 2px solid var(--light-gray);
    border-radius: var(--border-radius-sm);
    margin-bottom: 20px;
    background: var(--lighter-bg);
    font-family: 'Courier New', monospace;
}

.calc-buttons {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
}

.calc-btn {
    padding: 15px 10px;
    border: none;
    border-radius: var(--border-radius-sm);
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    background: var(--light-bg);
    color: var(--primary);
    min-height: 50px;
}

.calc-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.calc-btn.operator {
    background: var(--primary-light);
    color: white;
}

.calc-btn.equals {
    background: var(--success);
    color: white;
    grid-row: span 2;
}

.calc-btn.clear {
    background: var(--accent);
    color: white;
}

.calc-btn.scientific {
    background: var(--primary-dark);
    color: white;
    font-size: 0.9rem;
}

.calc-btn.scientific:hover {
    background: var(--primary-light);
}

/* Formula Cards */
.formula-category {
    margin-bottom: 40px;
    background: white;
    padding: 25px;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
}


.formula-category h4 {
    color: var(--primary);
    font-size: 1.3rem;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--light-bg);
    display: flex;
    align-items: center;
    gap: 10px;
}

.formula-item {
    background: linear-gradient(135deg, #f8fbff 0%, #f0f6ff 100%);
    padding: 20px;
    border-radius: var(--border-radius);
    margin-bottom: 15px;
    border-left: 4px solid var(--primary);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.formula-item:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
}

.formula-item:hover {
    transform: translateX(8px);
    box-shadow: var(--shadow-hover);
}

.formula-name {
    font-weight: 700;
    color: var(--primary-dark);
    margin-bottom: 12px;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.formula-name:before {
    content: '▸';
    color: var(--accent);
}

.formula-equation {
    font-family: 'Cambria Math', 'Latin Modern Math', 'STIX Two Math', serif;
    background: white;
    padding: 12px 15px;
    border-radius: 8px;
    margin: 8px 0;
    border: 1px solid #e1e8ff;
    font-size: 1.1rem;
    color: var(--primary-dark);
    box-shadow: 0 2px 4px rgba(11, 61, 145, 0.1);
    display: inline-block;
    min-width: 200px;
}

.formula-equation sup, .formula-equation sub {
    font-size: 0.8em;
    line-height: 1;
}

.formula-equation .fraction {
    display: inline-block;
    text-align: center;
    vertical-align: middle;
    margin: 0 0.1em;
}

.formula-equation .numerator {
    display: block;
    border-bottom: 1px solid;
    padding: 0 0.1em;
}

.formula-equation .denominator {
    display: block;
    padding: 0 0.1em;
}

.formula-description {
    color: var(--gray);
    font-size: 0.9rem;
    margin-top: 10px;
    line-height: 1.5;
    font-style: italic;
    border-top: 1px dashed var(--light-gray);
    padding-top: 8px;
}

/* Mathematical symbols styling */
.math-symbol {
    font-family: 'Cambria Math', 'Latin Modern Math', serif;
    font-style: italic;
}

.greek {
    font-family: 'Cambria Math', 'Symbol', serif;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .converter-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .converter-input,
    .converter-select,
    .converter-result,
    .converter-btn {
        width: 100%;
    }
    
    .converter-btn {
        padding: 12px;
    }
}
    
    .formula-equation {
        font-size: 1rem;
        min-width: auto;
        display: block;
        overflow-x: auto;
    }
    
    .formula-item {
        padding: 15px;
    }
        /* Enhanced Sidebar */
        .sidebar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 0;
            position: fixed;
            width: 300px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .logo {
            padding: 0 30px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 1.6rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }


        .sidebar-menu {
            list-style: none;
            padding: 0 20px;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .sidebar-menu a:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            border-radius: var(--border-radius-sm);
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            color: white;
            transform: translateX(8px);
        }

        .sidebar-menu a:hover:before, .sidebar-menu a.active:before {
            width: 100%;
        }

        .sidebar-menu i {
            width: 24px;
            text-align: center;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
        }

        .sidebar-menu span {
            position: relative;
            z-index: 1;
        }

        /* Enhanced Main Content */
        .main-content {
            grid-column: 2;
            padding: 40px;
            background: var(--lighter-bg);
            min-height: 100vh;
        }

        .page {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .page.active {
            display: block;
        }

        /* Enhanced Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

.page-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--primary);
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    
    /* ✅ Proper background-clip for all browsers */
    background-clip: text;             /* Standard property */
    -webkit-background-clip: text;     /* For Chrome/Safari/Edge */
    -webkit-text-fill-color: transparent; /* Makes gradient visible through text */
    
    position: relative;
}

        .page-title:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 2px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        /* Enhanced Dashboard */
        .welcome-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--border-radius-lg);
            padding: 50px 40px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .welcome-section:before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .welcome-section h2 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            font-weight: 700;
            position: relative;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 35px;
            position: relative;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary) 0%, var(--accent) 100%);
        }

        .stat-card:hover {
            transform: translateY(-10px);
            background: rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 35px;
        }

        .recent-activity, .quick-stats {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 35px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .recent-activity:hover, .quick-stats:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-5px);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title:before {
            content: '';
            width: 6px;
            height: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 3px;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid var(--light-gray);
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--light-bg);
            margin: 0 -20px;
            padding: 20px;
            border-radius: var(--border-radius-sm);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.3rem;
            flex-shrink: 0;
            transition: var(--transition);
        }

        .activity-item:hover .activity-icon {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
        }

.calc-btn.scientific {
    background: var(--primary-dark);
    color: white;
    font-size: 0.9rem;
}

.calc-btn.scientific:hover {
    background: var(--primary-light);
}

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 16px 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #ffd433 100%);
            color: var(--primary-dark);
        }

        .btn-disabled {
            background: var(--light-gray);
            color: var(--gray);
            cursor: not-allowed;
        }

        .btn-disabled:hover {
            transform: none;
            box-shadow: var(--shadow);
        }

        /* Enhanced Course Cards */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 30px;
        }

        .course-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .course-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .course-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
        }

        .course-card h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 700;
        }

        .course-card p {
            color: var(--gray);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Enhanced Progress Bars */
        .progress-bar {
            height: 12px;
            background: var(--light-gray);
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 6px;
            position: relative;
            transition: width 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .progress-fill:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        /* Enhanced Pricing Cards */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 35px;
        }

        .pricing-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 40px 35px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 2px solid transparent;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .pricing-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .pricing-card.popular {
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .pricing-card.popular:after {
            content: 'MOST POPULAR';
            position: absolute;
            top: 20px;
            right: -35px;
            background: var(--primary);
            color: white;
            padding: 8px 40px;
            font-size: 0.8rem;
            font-weight: 700;
            transform: rotate(45deg);
        }

        .pricing-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
        }

        .pricing-card.popular:hover {
            transform: scale(1.05) translateY(-10px);
        }

        .price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin: 20px 0;
        }

        .price span {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--gray);
        }

        .features-list {
            list-style: none;
            margin: 30px 0;
            text-align: left;
        }

        .features-list li {
            margin-bottom: 15px;
            padding-left: 35px;
            position: relative;
            color: var(--gray);
        }

        .features-list li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Quiz Styles */
        .quiz-container {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .question {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .option:hover {
            border-color: var(--primary);
            background: var(--light-bg);
        }

        .option.selected {
            border-color: var(--primary);
            background: var(--light-bg);
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .option.incorrect {
            border-color: var(--accent);
            background: rgba(255, 107, 107, 0.1);
        }

        .quiz-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
        position: fixed;
        left: -300px;
        width: 300px;
        height: 100vh;
        transition: left 0.3s ease;
        z-index: 999;
    }
            
   .sidebar.open {
        left: 0;
    }

            .main-content {
        padding-top: 80px;
    }
}

.hamburger-menu {
        display: block;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: var(--primary);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
    }


@media (min-width: 1201px) {
    .hamburger-menu {
        display: none;
    }
}

        @media (max-width: 768px) {
            .main-content {
                padding: 25px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .courses-grid, .pricing-grid {
                grid-template-columns: 1fr;
            }
            
            .pricing-card.popular {
                transform: none;
            }
            
            .page-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .page-title:after {
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>

    <!----------------------------------------- HTML SECTION STARTS HERE --------------------------------------->

<button class="hamburger-menu" id="hamburger" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

    <div class="container">
        <!-- Enhanced Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h1>
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    Tklesson Premium
                </h1>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" onclick="showPage('dashboard', this)"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
                <li><a href="#" onclick="showPage('my-courses', this)"><i class="fas fa-book"></i> <span>My Courses</span></a></li>
                <li><a href="#" onclick="showPage('all-courses', this)"><i class="fas fa-list"></i> <span>All Courses</span></a></li>
                <li><a href="#" onclick="showPage('materials', this)"><i class="fas fa-file-alt"></i> <span>Study Materials</span></a></li>
                <li><a href="#" onclick="showPage('progress', this)"><i class="fas fa-chart-line"></i> <span>Progress</span></a></li>
                <li><a href="#" onclick="showPage('subscription', this)"><i class="fas fa-credit-card"></i> <span>Subscription</span></a></li>
                <li><a href="#" onclick="showPage('settings', this)"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Log Out</span></a></li>
            </ul>
        </nav>

        <!-- Enhanced Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="user-info">
    <div class="user-avatar" id="user-avatar">JS</div>
    <span id="user-name">Loading...</span>
</div>
</div>

<div class="welcome-section">
    <h2 id="welcome-message">Welcome! 👋</h2>
    <p>Ready to continue your learning journey? Access your courses and track your progress.</p>
    
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Enrolled Courses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">0%</div>
            <div class="stat-label">Average Grade</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Quizzes Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Study Days</div>
        </div>
    </div>
</div>

                <div class="dashboard-grid">
                    <div class="recent-activity">
                        <h3 class="section-title">Recent Activity</h3>
                        <ul class="activity-list">
                            <li class="activity-item">
                                <div class="activity-icon"><i class="fas fa-book"></i></div>
                                <div>
                                    <div><strong>Started reading</strong> Physics Grade 11 Textbook</div>
                                    <small>2 hours ago</small>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                                <div>
                                    <div><strong>Completed</strong> Algebra 2 Textbook - Chapter 3</div>
                                    <small>Yesterday</small>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon"><i class="fas fa-plus"></i></div>
                                <div>
                                    <div><strong>Enrolled in</strong> AP Physics 1 course</div>
                                    <small>2 days ago</small>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="quick-stats">
                        <h3 class="section-title">Quick Access</h3>
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <a href="#" class="btn btn-secondary" onclick="showPage('my-courses', this)">
                                <i class="fas fa-play-circle"></i>
                                Continue Learning
                            </a>
                            <a href="#" class="btn btn-outline" onclick="showPage('materials', this)">
                                <i class="fas fa-book-open"></i>
                                Study Materials
                            </a>
                            <a href="#" class="btn btn-outline" onclick="showPage('progress', this)">
                                <i class="fas fa-chart-bar"></i>
                                View Progress
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Courses Page -->
            <div id="my-courses" class="page">
                <div class="page-header">
                    <h1 class="page-title">My Courses</h1>
                    <div class="user-info">
                        <div class="user-avatar">JS</div>
                        <span>John Student</span>
                    </div>
                </div>

                <div class="courses-grid" id="my-courses-grid">
                    <!-- Courses will be populated by JavaScript -->
                </div>
            </div>


<div id="course-detail" class="page">
    <div class="page-header">
        <h1 class="page-title" id="detail-course-title">Course Title</h1>
        <div class="user-info">
            <div class="user-avatar">JS</div>
            <span>John Student</span>
        </div>
    </div>

    <div class="course-detail-container">
        <div style="margin-bottom: 30px;">
            <p id="course-description" style="color: var(--gray); font-size: 1.1rem;"></p>
            <a href="#" class="btn btn-outline" style="padding: 10px 16px; font-size: 0.8rem;" onclick="clearQuizData(); showPage('my-courses', document.querySelector('.sidebar-menu li:nth-child(2) a'))">
    <i class="fas fa-arrow-left"></i> Back to My Courses
</a>
        </div>

        <!-- Course Resources Grid -->
        <div class="courses-grid">
            <!-- Textbook Card -->
            <div class="course-card" onclick="openResource('textbook', this)">
                <h3>Textbook</h3>
                <p>Access comprehensive study material and chapters</p>
                <button class="btn" style="margin-top: 20px;">
                    <i class="fas fa-book"></i> Open Textbook
                </button>
            </div>

            <!-- Examination-style Quiz Card -->
            <div class="course-card" onclick="openResource('exam-quiz', this)">
                <h3>Examination Quiz</h3>
                <p>Full-length practice exams in real exam format</p>
                <button class="btn" style="margin-top: 20px;">
                    <i class="fas fa-file-alt"></i> Take Exam
                </button>
            </div>

            <!-- Topic-specific Quiz Card -->
            <div class="course-card" onclick="openResource('topic-quiz', this)">
                <h3>Topic Quiz</h3>
                <p>Quick quizzes focused on specific topics</p>
                <button class="btn" style="margin-top: 20px;">
                    <i class="fas fa-question-circle"></i> Start Quiz
                </button>
            </div>

            <!-- Flashcards Card -->
            <div class="course-card" onclick="openResource('flashcards', this)">
                <h3>Flashcards</h3>
                <p>Interactive flashcards for key concepts</p>
                <button class="btn" style="margin-top: 20px;">
                    <i class="fas fa-layer-group"></i> Study Cards
                </button>
            </div>

            <!-- Video Lessons Card -->
            <div class="course-card" onclick="openResource('videos', this)">
                <h3>Video Lessons</h3>
                <p>Watch video tutorials and explanations</p>
                <button class="btn" style="margin-top: 20px;">
                    <i class="fas fa-play-circle"></i> Watch Videos
                </button>
            </div>

            <!-- Past Questions and Answers Card -->
<div class="course-card" onclick="openResource('past-questions', this)">
    <h3>Past Questions & Answers</h3>
    <p>Access previous exam questions with detailed solutions</p>
    <button class="btn" style="margin-top: 20px;">
        <i class="fas fa-archive"></i> View Past Papers
    </button>
</div>
            
        </div>

        <!-- Resource Content Sections -->
        <div id="resource-content" style="margin-top: 40px;"></div>
    </div>
</div>

<!-- Add this section to the course-detail page, inside the resource-content div -->
<div id="exam-quiz-section" class="tool-interface" style="display: none;">
    <div class="tool-header">
        <h3 class="section-title">Examination Quiz - Full Exam Simulation</h3>
        <button class="tool-back" onclick="closeExamQuiz()">
            <i class="fas fa-arrow-left"></i> Back to Course
        </button>
    </div>
    
    <div class="exam-quiz-container">
        <div class="exam-info-section">
            <div class="exam-description">
                <h4>AP Physics 1 Premium Quizzes – Exam Simulation</h4>
                <p>Select from 100 exam-style practice quizzes to simulate the actual exam experience. Each quiz contains carefully crafted questions that mirror the format and difficulty of the real AP Physics 1 examination.</p>
            </div>
            
            <div class="exam-stats">
                <div class="stat-item">
                    <div class="stat-value">100</div>
                    <div class="stat-label">Full Quizzes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">50</div>
                    <div class="stat-label">Questions Each</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">90min</div>
                    <div class="stat-label">Time Limit</div>
                </div>
            </div>
        </div>
        
        <div class="quiz-grid-container">
            <h4 class="quiz-grid-title">Select a Quiz</h4>
            <div class="quiz-grid" id="exam-quiz-grid">
                <!-- Quiz buttons will be generated here -->
            </div>
        </div>
    </div>
</div>

            <!-- All Courses Page -->
            <div id="all-courses" class="page">
                <div class="page-header">
                    <h1 class="page-title">All Available Courses</h1>
                    <div class="user-info">
                        <div class="user-avatar">JS</div>
                        <span>John Student</span>
                    </div>
                </div>

                <!-- Search Box Section -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px;">
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 5px;"><span id="courseCount">24</span> Courses Available</h3>
                        <p style="color: var(--gray);">Browse and enroll in your desired courses</p>
                    </div>
                    <div style="position: relative; width: 300px;">
                        <input type="text" id="courseSearch" placeholder="Search courses..." 
                               style="width: 100%; padding: 12px 45px 12px 15px; border: 1px solid var(--light-gray); border-radius: var(--border-radius-sm); font-size: 1rem;">
                        <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--gray);"></i>
                    </div>
                </div>

                <div class="courses-grid">
                    <!-- General Exam Style Quizzes -->
                    <div class="course-card">
                        <h3>AP Physics 1</h3>
                        <p>College-level physics course covering Newtonian mechanics, work, energy, and more.</p>
                        <button class="btn" onclick="enrollCourse('ap-physics-1', 'AP Physics 1', 'College-level physics course covering Newtonian mechanics, work, energy, and more.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Physics 2</h3>
                        <p>Advanced physics topics including fluids, thermodynamics, electricity, and magnetism.</p>
                        <button class="btn" onclick="enrollCourse('ap-physics-2', 'AP Physics 2', 'Advanced physics topics including fluids, thermodynamics, electricity, and magnetism.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Physics C (Mechanics)</h3>
                        <p>Calculus-based physics focusing on mechanics with differential equations.</p>
                        <button class="btn" onclick="enrollCourse('ap-physics-c-mechanics', 'AP Physics C (Mechanics)', 'Calculus-based physics focusing on mechanics with differential equations.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Physics C (Electricity & Magnetism)</h3>
                        <p>Advanced E&M topics with calculus applications and circuit analysis.</p>
                        <button class="btn" onclick="enrollCourse('ap-physics-c-em', 'AP Physics C (Electricity & Magnetism)', 'Advanced E&M topics with calculus applications and circuit analysis.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Physics Grade 9</h3>
                        <p>Foundational physics concepts for beginners including motion, forces, and energy.</p>
                        <button class="btn" onclick="enrollCourse('physics-grade-9', 'Physics Grade 9', 'Foundational physics concepts for beginners including motion, forces, and energy.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Physics Grade 10</h3>
                        <p>Intermediate physics covering waves, sound, light, and basic thermodynamics.</p>
                        <button class="btn" onclick="enrollCourse('physics-grade-10', 'Physics Grade 10', 'Intermediate physics covering waves, sound, light, and basic thermodynamics.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Physics Grade 11</h3>
                        <p>Comprehensive physics course covering mechanics, waves, and thermodynamics.</p>
                        <button class="btn" onclick="enrollCourse('physics-grade-11', 'Physics Grade 11', 'Comprehensive physics course covering mechanics, waves, and thermodynamics.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Physics Grade 12</h3>
                        <p>Advanced physics including modern physics, relativity, and quantum mechanics.</p>
                        <button class="btn" onclick="enrollCourse('physics-grade-12', 'Physics Grade 12', 'Advanced physics including modern physics, relativity, and quantum mechanics.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Algebra 1</h3>
                        <p>Introduction to algebraic concepts, equations, functions, and graphing.</p>
                        <button class="btn" onclick="enrollCourse('algebra-1', 'Algebra 1', 'Introduction to algebraic concepts, equations, functions, and graphing.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Algebra 2</h3>
                        <p>Advanced algebra concepts including quadratic equations, functions, and complex numbers.</p>
                        <button class="btn" onclick="enrollCourse('algebra-2', 'Algebra 2', 'Advanced algebra concepts including quadratic equations, functions, and complex numbers.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Geometry</h3>
                        <p>Comprehensive geometry course covering shapes, proofs, and spatial reasoning.</p>
                        <button class="btn" onclick="enrollCourse('geometry', 'Geometry', 'Comprehensive geometry course covering shapes, proofs, and spatial reasoning.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Pre-Calculus</h3>
                        <p>Preparation for calculus with trigonometry, functions, and analytical geometry.</p>
                        <button class="btn" onclick="enrollCourse('pre-calculus', 'Pre-Calculus', 'Preparation for calculus with trigonometry, functions, and analytical geometry.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Calculus</h3>
                        <p>College-level calculus covering limits, derivatives, integrals, and applications.</p>
                        <button class="btn" onclick="enrollCourse('ap-calculus', 'AP Calculus', 'College-level calculus covering limits, derivatives, integrals, and applications.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Chemistry Grade 10</h3>
                        <p>Introduction to chemistry covering atomic structure, chemical reactions, and periodic table.</p>
                        <button class="btn" onclick="enrollCourse('chemistry-grade-10', 'Chemistry Grade 10', 'Introduction to chemistry covering atomic structure, chemical reactions, and periodic table.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Chemistry Grade 11</h3>
                        <p>Intermediate chemistry with stoichiometry, bonding, and reaction kinetics.</p>
                        <button class="btn" onclick="enrollCourse('chemistry-grade-11', 'Chemistry Grade 11', 'Intermediate chemistry with stoichiometry, bonding, and reaction kinetics.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Chemistry Grade 12</h3>
                        <p>Advanced chemistry including organic chemistry, thermodynamics, and electrochemistry.</p>
                        <button class="btn" onclick="enrollCourse('chemistry-grade-12', 'Chemistry Grade 12', 'Advanced chemistry including organic chemistry, thermodynamics, and electrochemistry.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Biology Grade 9</h3>
                        <p>Introduction to biology covering cells, genetics, and basic organism classification.</p>
                        <button class="btn" onclick="enrollCourse('biology-grade-9', 'Biology Grade 9', 'Introduction to biology covering cells, genetics, and basic organism classification.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Biology Grade 10</h3>
                        <p>Intermediate biology with ecology, evolution, and human body systems.</p>
                        <button class="btn" onclick="enrollCourse('biology-grade-10', 'Biology Grade 10', 'Intermediate biology with ecology, evolution, and human body systems.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Biology Grade 11</h3>
                        <p>Advanced biology covering molecular biology, genetics, and cellular processes.</p>
                        <button class="btn" onclick="enrollCourse('biology-grade-11', 'Biology Grade 11', 'Advanced biology covering molecular biology, genetics, and cellular processes.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Biology Grade 12</h3>
                        <p>Comprehensive biology including anatomy, physiology, and biotechnology.</p>
                        <button class="btn" onclick="enrollCourse('biology-grade-12', 'Biology Grade 12', 'Comprehensive biology including anatomy, physiology, and biotechnology.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Biology</h3>
                        <p>College-level biology with advanced topics in genetics, evolution, and ecology.</p>
                        <button class="btn" onclick="enrollCourse('ap-biology', 'AP Biology', 'College-level biology with advanced topics in genetics, evolution, and ecology.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>Economics</h3>
                        <p>Introduction to economic principles, markets, and basic macroeconomic concepts.</p>
                        <button class="btn" onclick="enrollCourse('economics', 'Economics', 'Introduction to economic principles, markets, and basic macroeconomic concepts.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Macroeconomics</h3>
                        <p>Advanced study of national economies, fiscal policy, and economic indicators.</p>
                        <button class="btn" onclick="enrollCourse('ap-macroeconomics', 'AP Macroeconomics', 'Advanced study of national economies, fiscal policy, and economic indicators.')">Enroll Now</button>
                    </div>
                    <div class="course-card">
                        <h3>AP Microeconomics</h3>
                        <p>Focus on individual markets, consumer behavior, and firm decision-making.</p>
                        <button class="btn" onclick="enrollCourse('ap-microeconomics', 'AP Microeconomics', 'Focus on individual markets, consumer behavior, and firm decision-making.')">Enroll Now</button>
                    </div>
                </div>
            </div>

            <!-- Progress Page -->
            <div id="progress" class="page">
                <div class="page-header">
                    <h1 class="page-title">Progress Tracking</h1>
                    <div class="user-info">
                        <div class="user-avatar">JS</div>
                        <span>John Student</span>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="course-card">
                        <h3 class="section-title">Course Progress</h3>
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; justify-content: between; margin-bottom: 8px;">
                                <span>Physics Grade 11</span>
                                <span style="font-weight: 600; color: var(--primary);">65% • B+</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 65%"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; justify-content: between; margin-bottom: 8px;">
                                <span>Algebra 2</span>
                                <span style="font-weight: 600; color: var(--primary);">42% • A-</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 42%"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 25px;">
                            <div style="display: flex; justify-content: between; margin-bottom: 8px;">
                                <span>Chemistry Grade 10</span>
                                <span style="font-weight: 600; color: var(--primary);">78% • A</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 78%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="course-card">
                        <h3 class="section-title">Overall Performance</h3>
                        <div style="text-align: center; padding: 30px 20px;">
                            <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin-bottom: 10px;">87%</div>
                            <div style="color: var(--gray); font-size: 1.1rem; margin-bottom: 30px;">Average Grade</div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                                <div>
                                    <div style="font-size: 0.9rem; color: var(--gray);">Quizzes Completed</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">24</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: var(--gray);">Study Hours</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">36h</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: var(--gray);">Current Streak</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">5 days</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: var(--gray);">Enrolled Courses</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">8</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Page -->
            <div id="subscription" class="page">
    <div class="page-header">
    <h1 class="page-title">Premium Subscription</h1>
    <div class="user-info">
        <div class="user-avatar" id="subscription-avatar">JS</div>
        <span id="subscription-user-name">Loading...</span>
    </div>
</div>

    <!-- Subscription Status Card -->
    <!-- Subscription Status Card - Updated Version -->
<div class="course-card" style="margin-bottom: 30px;">
    <h3 class="section-title">Your Subscription Status</h3>
    <div id="subscription-status-display" style="padding: 20px; text-align: center;">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

    <!-- Single Pricing Card -->
    <!-- Single Pricing Card -->
<div class="pricing-grid">
    <div class="pricing-card popular" style="max-width: 500px; margin: 0 auto;">
        <div style="position: absolute; top: 20px; right: -35px; background: var(--primary); color: white; padding: 8px 40px; font-size: 0.8rem; font-weight: 700; transform: rotate(45deg);">
            RECOMMENDED
        </div>
        
        <h3>Premium Monthly Access</h3>
        <div class="price">$9.99 <span>/month</span></div>
        
        <ul class="features-list">
            <li>Full access to all courses</li>
            <li>Unlimited textbook access</li>
            <li>All exam-style quizzes</li>
            <li>Interactive flashcards</li>
            <li>Progress tracking</li>
            <li>Study materials & tools</li>
            <li>Email support</li>
            <li>Cancel anytime</li>
        </ul>
        
        <button id="subscribe-monthly-button" class="btn" style="background: var(--success);">
            <i class="fas fa-credit-card"></i> Subscribe Now - $9.99/month
        </button>
        
        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--gray);">
            <i class="fas fa-lock"></i> Secure payment via Stripe
        </div>
    </div>
</div>

<!-- Yearly Subscription Option -->
<div class="pricing-grid" style="margin-top: 40px;">
    <div class="pricing-card" style="max-width: 500px; margin: 0 auto; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        <div style="position: absolute; top: 20px; right: -35px; background: var(--success); color: white; padding: 8px 40px; font-size: 0.8rem; font-weight: 700; transform: rotate(45deg);">
            SAVE 16%
        </div>
        
        <h3>Premium Yearly Access</h3>
        <div class="price">$99.99 <span>/year</span></div>
        <div style="color: var(--success); font-weight: 600; margin-bottom: 15px;">
            <i class="fas fa-percentage"></i> Save $19.89 compared to monthly
        </div>
        
        <ul class="features-list">
            <li>Everything in Monthly plan</li>
            <li>12 months of full access</li>
            <li>Priority support</li>
            <li>Early access to new features</li>
            <li>Homework Assistance</li>
            <li>Personalized study plans</li>
            <li>Advanced analytics</li>
            <li>Cancel anytime</li>
        </ul>
        
        <button id="subscribe-yearly-button" class="btn" style="background: var(--primary);">
            <i class="fas fa-calendar-alt"></i> Subscribe Now - $99.99/year
        </button>
        
        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--gray);">
            <i class="fas fa-gem"></i> Best value - Equivalent to $8.33/month
        </div>
    </div>
</div>

    <!-- Current Subscription Details (for active subscribers) -->
<div id="active-subscription-details" class="course-card" style="margin-top: 30px; display: none;">
    <h3 class="section-title">Current Subscription Details</h3>
    <div style="padding: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <h4 style="color: var(--primary); margin-bottom: 5px;">Plan</h4>
                <p id="current-plan-display">Loading...</p>
            </div>
            <div>
                <h4 style="color: var(--primary); margin-bottom: 5px;">Status</h4>
                <p><span id="subscription-active-status" style="color: var(--success); font-weight: 600;">Active</span></p>
            </div>
            <div>
                <h4 style="color: var(--primary); margin-bottom: 5px;">Started</h4>
                <p id="subscription-start-date">Loading...</p>
            </div>
            <div>
                <h4 style="color: var(--primary); margin-bottom: 5px;">
                    <span id="renews-label">Renews</span>
                </h4>
                <p id="subscription-expiry-date">Loading...</p>
                <p id="subscription-savings" style="font-size: 0.85rem; color: var(--success); margin-top: 5px; display: none;">
                    <i class="fas fa-piggy-bank"></i> You're saving $19.89/year!
                </p>
            </div>
        </div>
        
        <!-- Additional info for yearly plans -->
        <div id="yearly-plan-benefits" style="background: #f0fff4; padding: 15px; border-radius: var(--border-radius-sm); margin-bottom: 20px; border-left: 4px solid var(--success); display: none;">
            <h5 style="color: var(--success); margin-bottom: 8px;">
                <i class="fas fa-gem"></i> Yearly Plan Benefits
            </h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                <div>
                    <i class="fas fa-check-circle" style="color: var(--success);"></i> Priority support
                </div>
                <div>
                    <i class="fas fa-check-circle" style="color: var(--success);"></i> Early feature access
                </div>
                <div>
                    <i class="fas fa-check-circle" style="color: var(--success);"></i> Download materials
                </div>
                <div>
                    <i class="fas fa-check-circle" style="color: var(--success);"></i> Advanced analytics
                </div>
            </div>
        </div>
        
        <div style="border-top: 1px solid var(--light-gray); padding-top: 20px;">
            <button id="cancel-subscription-button" class="btn" style="background: var(--accent);">
                <i class="fas fa-times-circle"></i> Cancel Subscription
            </button>
            <p style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;">
                You can cancel anytime. Access continues until the end of your billing period.
            </p>
        </div>
    </div>
</div>
    
    <!-- FAQ Section -->
    <div class="course-card" style="margin-top: 30px;">
        <h3 class="section-title">Frequently Asked Questions</h3>
        <div style="padding: 20px;">
            <div class="faq-item" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray);">
                <h4 style="color: var(--primary); margin-bottom: 5px;">What do I get with the subscription?</h4>
                <p style="color: var(--gray);">Full access to all courses, textbooks, quizzes, flashcards, and study tools. Everything on the platform.</p>
            </div>
            <div class="faq-item" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray);">
                <h4 style="color: var(--primary); margin-bottom: 5px;">Can I cancel anytime?</h4>
                <p style="color: var(--gray);">Yes! You can cancel your subscription at any time. You'll keep access until the end of your billing period.</p>
            </div>
            <div class="faq-item" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray);">
    <h4 style="color: var(--primary); margin-bottom: 5px;">
        <i class="fas fa-balance-scale" style="margin-right: 8px;"></i>
        Monthly vs Yearly - Which is better?
    </h4>
    <div style="color: var(--gray);">
        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px;">
            <div style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 0.8rem;">
                M
            </div>
            <div>
                <strong style="color: var(--primary);">Monthly:</strong> $9.99/month
                <div style="font-size: 0.9rem; margin-top: 2px;">
                    <i class="fas fa-sync-alt" style="color: var(--gray); margin-right: 4px;"></i>
                    More flexibility, cancel anytime
                </div>
            </div>
        </div>
        
        <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: #f0fff4; border-radius: 6px; border-left: 3px solid var(--success);">
            <div style="background: var(--success); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 0.8rem;">
                Y
            </div>
            <div>
                <strong style="color: var(--primary);">Yearly:</strong> $99.99/year
                <div style="font-size: 0.9rem; margin-top: 2px;">
                    <i class="fas fa-piggy-bank" style="color: var(--success); margin-right: 4px;"></i>
                    <strong style="color: var(--success);">Save 16%</strong>
                </div>
            </div>
        </div>
        
        <div style="background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); color: white; padding: 12px 15px; border-radius: 8px; margin-top: 10px; text-align: center;">
            <i class="fas fa-calculator" style="margin-right: 5px;"></i>
            <strong>Yearly = $8.33/month</strong> - Perfect for dedicated learners!
        </div>
    </div>
</div>
            <div class="faq-item">
                <h4 style="color: var(--primary); margin-bottom: 5px;">Do you offer refunds?</h4>
                <p style="color: var(--gray);">
                    We only offer refunds for <strong>accidental auto-renewals</strong> within 3 days of the charge.<br><br>
                    First-time subscriptions are non-refundable. Please use our free trial to evaluate the platform before purchasing.
                </p>
            </div>
        </div>
    </div>
</div>

                        <!-- Settings Page -->
            <div id="settings" class="page">
    <div class="page-header">
        <h1 class="page-title">Settings</h1>
        <div class="user-info">
            <div class="user-avatar" id="settings-avatar">JS</div>
            <span id="settings-name">Loading...</span>
        </div>
    </div>
    
    <div class="settings-container">
        <!-- Profile Settings -->
        <div class="settings-section">
            <h3 class="section-title">
                <i class="fas fa-user"></i> Profile Settings
            </h3>
            <div class="settings-card">
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Display Name</h4>
                        <p id="current-display-name">Loading...</p>
                    </div>
                    <button class="btn btn-outline" onclick="openEditProfile()">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
                
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Email Address</h4>
                        <p id="current-email">Loading...</p>
                    </div>
                    <span class="settings-badge">Verified</span>
                </div>
                
<div class="settings-item">
    <div class="settings-info">
        <h4>Subscription Plan</h4>
        <p>Current membership level</p>
    </div>
    <span id="subscription-status" style="font-weight: 600; color: var(--accent);">Loading...</span>
</div>

                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Account Created</h4>
                        <p id="account-created">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="settings-section">
            <h3 class="section-title">
                <i class="fas fa-shield-alt"></i> Security
            </h3>
            <div class="settings-card">
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Password</h4>
                        <p>Last changed: <span id="password-last-changed">Never</span></p>
                    </div>
                    <button class="btn btn-outline" onclick="openChangePassword()">
                        <i class="fas fa-key"></i> Change
                    </button>
                </div>
                
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Two-Factor Authentication</h4>
                        <p>Add an extra layer of security</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="two-factor-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="settings-section">
            <h3 class="section-title">
                <i class="fas fa-bell"></i> Notifications
            </h3>
            <div class="settings-card">
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Email Notifications</h4>
                        <p>Course updates and progress reports</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="email-notifications" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Quiz Reminders</h4>
                        <p>Remind me about incomplete quizzes</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="quiz-reminders" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Study Goals</h4>
                        <p>Daily and weekly progress updates</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="study-goals" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Preferences -->
        <div class="settings-section">
            <h3 class="section-title">
                <i class="fas fa-cog"></i> Preferences
            </h3>
            <div class="settings-card">
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Theme</h4>
                        <p>Interface appearance</p>
                    </div>
                    <select class="settings-select" id="theme-selector">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Default Page</h4>
                        <p>Page to show when app loads</p>
                    </div>
                    <select class="settings-select" id="default-page">
                        <option value="dashboard">Dashboard</option>
                        <option value="my-courses">My Courses</option>
                        <option value="progress">Progress</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-section">
            <h3 class="section-title" style="color: var(--accent);">
                <i class="fas fa-exclamation-triangle"></i> Danger Zone
            </h3>
            <div class="settings-card" style="border-color: var(--accent);">
                <div class="settings-item">
                    <div class="settings-info">
                        <h4>Delete Account</h4>
                        <p>Permanently delete your account and all data</p>
                    </div>
                    <button class="btn" style="background: var(--accent);" onclick="openDeleteAccount()">
                        <i class="fas fa-trash"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Profile</h3>
            <button class="modal-close" onclick="closeEditProfile()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="edit-display-name">Display Name</label>
                <input type="text" id="edit-display-name" class="form-input" placeholder="Enter your display name">
            </div>
            <div class="form-group">
                <label for="edit-avatar-initials">Avatar Initials (2 letters)</label>
                <input type="text" id="edit-avatar-initials" class="form-input" maxlength="2" placeholder="JS">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeEditProfile()">Cancel</button>
            <button class="btn" onclick="saveProfile()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="change-password-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Password</h3>
            <button class="modal-close" onclick="closeChangePassword()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" class="form-input" placeholder="Enter current password">
            </div>
            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" class="form-input" placeholder="Enter new password">
                <small class="form-help">Minimum 8 characters with letters and numbers</small>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" class="form-input" placeholder="Confirm new password">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeChangePassword()">Cancel</button>
            <button class="btn" onclick="changePassword()">Update Password</button>
        </div>
    </div>
</div>

<div id="password-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Password</h3>
            <button class="modal-close" onclick="closePasswordModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="confirm-password-input">Enter your password to confirm account deletion:</label>
                <input type="password" id="confirm-password-input" class="form-input" placeholder="Your password" autocomplete="current-password">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closePasswordModal()">Cancel</button>
            <button class="btn" style="background: var(--accent);" onclick="submitPasswordForDeletion()">
                Confirm Deletion
            </button>
        </div>
    </div>
</div>

            <!-- STUDY MATERIALS PAGE GOES RIGHT HERE -->
            <!-- Study Materials Page -->
            <div id="materials" class="page">
                <div class="page-header">
                    <h1 class="page-title">Study Materials & Tools</h1>
                    <div class="user-info">
                        <div class="user-avatar">JS</div>
                        <span>John Student</span>
                    </div>
                </div>

                <!-- Tools Grid -->
                <div id="tools-grid" class="courses-grid">
                    <!-- Calculator Card -->
                    <div class="tool-card" onclick="openTool('calculator')">
                        <div class="tool-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <h3>Scientific Calculator</h3>
                        <p>Advanced calculator for complex mathematical operations</p>
                    </div>

                    <!-- Geometry Formulas Card -->
                    <div class="tool-card" onclick="openTool('geometry-formulas')">
                        <div class="tool-icon">
                            <i class="fas fa-shapes"></i>
                        </div>
                        <h3>Geometry Formulas</h3>
                        <p>Complete reference for shapes, areas, volumes, and theorems</p>
                    </div>

                    <!-- Physics Formulas Card -->
                    <div class="tool-card" onclick="openTool('physics-formulas')">
                        <div class="tool-icon">
                            <i class="fas fa-atom"></i>
                        </div>
                        <h3>Physics Formulas</h3>
                        <p>Kinematics, dynamics, energy, electricity, and more</p>
                    </div>

                    <!-- Chemistry Formulas Card -->
                    <div class="tool-card" onclick="openTool('chemistry-formulas')">
                        <div class="tool-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <h3>Chemistry Formulas</h3>
                        <p>Periodic table, reactions, stoichiometry, and bonding</p>
                    </div>

                    <!-- Algebra Formulas Card -->
                    <div class="tool-card" onclick="openTool('algebra-formulas')">
                        <div class="tool-icon">
                            <i class="fas fa-square-root-alt"></i>
                        </div>
                        <h3>Algebra Formulas</h3>
                        <p>Equations, functions, graphs, and algebraic identities</p>
                    </div>

                    <!-- Unit Converter Card -->
                    <div class="tool-card" onclick="openTool('unit-converter')">
                        <div class="tool-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <h3>Unit Converter</h3>
                        <p>Convert between different measurement systems</p>
                    </div>
                </div>

                <!-- Tool Interfaces -->
                
                <!-- Calculator Interface -->
                <div id="calculator-interface" class="tool-interface">
                    <div class="tool-header">
                        <h3 class="section-title">Scientific Calculator</h3>
                        <button class="tool-back" onclick="closeTool()">
                            <i class="fas fa-arrow-left"></i> Back to Tools
                        </button>
                    </div>
                    <div class="calculator-container">
                        <input type="text" id="calc-display" class="calc-display" readonly value="0">
                        <div class="calc-buttons">
                            <!-- Row 1: Scientific Functions -->
                            <button class="calc-btn scientific" onclick="calculateFunction('sin')">sin</button>
                            <button class="calc-btn scientific" onclick="calculateFunction('cos')">cos</button>
                            <button class="calc-btn scientific" onclick="calculateFunction('tan')">tan</button>
                            <button class="calc-btn scientific" onclick="calculateFunction('sqrt')">√</button>
                            <button class="calc-btn scientific" onclick="calculateFunction('pow')">x^y</button>
                            
                            <!-- Row 2: Clear and Basic Operations -->
                            <button class="calc-btn clear" onclick="clearCalculator()">C</button>
                            <button class="calc-btn clear" onclick="backspace()">⌫</button>
                            <button class="calc-btn operator" onclick="appendToCalc('%')">%</button>
                            <button class="calc-btn operator" onclick="appendToCalc('/')">/</button>
                            <button class="calc-btn scientific" onclick="appendToCalc('Math.PI')">π</button>
                            
                            <!-- Row 3: Numbers 7-9 and Multiply -->
                            <button class="calc-btn" onclick="appendToCalc('7')">7</button>
                            <button class="calc-btn" onclick="appendToCalc('8')">8</button>
                            <button class="calc-btn" onclick="appendToCalc('9')">9</button>
                            <button class="calc-btn operator" onclick="appendToCalc('*')">×</button>
                            <button class="calc-btn scientific" onclick="appendToCalc('(')">(</button>
                            
                            <!-- Row 4: Numbers 4-6 and Subtract -->
                            <button class="calc-btn" onclick="appendToCalc('4')">4</button>
                            <button class="calc-btn" onclick="appendToCalc('5')">5</button>
                            <button class="calc-btn" onclick="appendToCalc('6')">6</button>
                            <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
                            <button class="calc-btn scientific" onclick="appendToCalc(')')">)</button>
                            
                            <!-- Row 5: Numbers 1-3 and Add -->
                            <button class="calc-btn" onclick="appendToCalc('1')">1</button>
                            <button class="calc-btn" onclick="appendToCalc('2')">2</button>
                            <button class="calc-btn" onclick="appendToCalc('3')">3</button>
                            <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
                            <button class="calc-btn equals" onclick="calculate()">=</button>
                            
                            <!-- Row 6: Zero and Decimal -->
                            <button class="calc-btn" onclick="appendToCalc('0')" style="grid-column: span 2;">0</button>
                            <button class="calc-btn" onclick="appendToCalc('.')">.</button>
                            <button class="calc-btn scientific" onclick="calculateFunction('log')">log</button>
                            <button class="calc-btn scientific" onclick="calculateFunction('ln')">ln</button>
                        </div>
                    </div>
                </div>

                <!-- Geometry Formulas Interface -->
                <div id="geometry-formulas-interface" class="tool-interface">
                    <div class="tool-header">
                        <h3 class="section-title">Geometry Formulas</h3>
                        <button class="tool-back" onclick="closeTool()">
                            <i class="fas fa-arrow-left"></i> Back to Tools
                        </button>
                    </div>
                    
                    <div class="formula-category">
                        <h4><i class="fas fa-shapes"></i> 2D Shapes</h4>
                        
                        <div class="formula-item">
                            <div class="formula-name">Square</div>
                            <div class="formula-equation">Area = s²</div>
                            <div class="formula-equation">Perimeter = 4s</div>
                            <div class="formula-description">Where s is side length</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Rectangle</div>
                            <div class="formula-equation">Area = l × w</div>
                            <div class="formula-equation">Perimeter = 2(l + w)</div>
                            <div class="formula-description">Where l is length, w is width</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Triangle</div>
                            <div class="formula-equation">Area = ½ × b × h</div>
                            <div class="formula-equation">Pythagorean: a² + b² = c²</div>
                            <div class="formula-description">Where b is base, h is height</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Circle</div>
                            <div class="formula-equation">Area = πr²</div>
                            <div class="formula-equation">Circumference = 2πr</div>
                            <div class="formula-equation">Diameter = 2r</div>
                            <div class="formula-description">Where r is the radius</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Parallelogram</div>
                            <div class="formula-equation">Area = b × h</div>
                            <div class="formula-equation">Perimeter = 2(a + b)</div>
                            <div class="formula-description">Where b is base, h is height, a is side</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Rhombus</div>
                            <div class="formula-equation">Area = ½ × d₁ × d₂</div>
                            <div class="formula-equation">Area = b × h</div>
                            <div class="formula-equation">Perimeter = 4s</div>
                            <div class="formula-description">Where d₁, d₂ are diagonals, b is base, h is height</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Trapezium (Trapezoid)</div>
                            <div class="formula-equation">Area = ½ × (a + b) × h</div>
                            <div class="formula-equation">Perimeter = a + b + c + d</div>
                            <div class="formula-description">Where a, b are parallel sides, h is height</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Kite</div>
                            <div class="formula-equation">Area = ½ × d₁ × d₂</div>
                            <div class="formula-equation">Perimeter = 2(a + b)</div>
                            <div class="formula-description">Where d₁, d₂ are diagonals, a, b are sides</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4><i class="fas fa-cube"></i> 3D Shapes</h4>
                        
                        <div class="formula-item">
                            <div class="formula-name">Cube</div>
                            <div class="formula-equation">Volume = s³</div>
                            <div class="formula-equation">Surface Area = 6s²</div>
                            <div class="formula-description">Where s is side length</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Cuboid (Rectangular Prism)</div>
                            <div class="formula-equation">Volume = l × w × h</div>
                            <div class="formula-equation">Surface Area = 2(lw + lh + wh)</div>
                            <div class="formula-description">Where l is length, w is width, h is height</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Sphere</div>
                            <div class="formula-equation">Volume = ⁴⁄₃πr³</div>
                            <div class="formula-equation">Surface Area = 4πr²</div>
                            <div class="formula-description">Where r is the radius</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Cylinder</div>
                            <div class="formula-equation">Volume = πr²h</div>
                            <div class="formula-equation">Surface Area = 2πr(h + r)</div>
                            <div class="formula-description">Where r is radius, h is height</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Cone</div>
                            <div class="formula-equation">Volume = ⅓πr²h</div>
                            <div class="formula-equation">Surface Area = πr(r + l)</div>
                            <div class="formula-equation">Slant Height: l = √(r² + h²)</div>
                            <div class="formula-description">Where r is radius, h is height, l is slant height</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Pyramid</div>
                            <div class="formula-equation">Volume = ⅓ × base area × h</div>
                            <div class="formula-equation">Surface Area = base area + ½ × P × l</div>
                            <div class="formula-description">Where P is base perimeter, l is slant height</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4><i class="fas fa-ruler-combined"></i> Geometric Theorems</h4>
                        
                        <div class="formula-item">
                            <div class="formula-name">Pythagorean Theorem</div>
                            <div class="formula-equation">a² + b² = c²</div>
                            <div class="formula-description">For right-angled triangles</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Area of Triangle (Heron's Formula)</div>
                            <div class="formula-equation">Area = √[s(s-a)(s-b)(s-c)]</div>
                            <div class="formula-equation">s = ½(a + b + c)</div>
                            <div class="formula-description">Where a, b, c are sides, s is semi-perimeter</div>
                        </div>
                        
                        <div class="formula-item">
                            <div class="formula-name">Circle Theorems</div>
                            <div class="formula-equation">Arc Length = (θ/360) × 2πr</div>
                            <div class="formula-equation">Sector Area = (θ/360) × πr²</div>
                            <div class="formula-description">Where θ is angle in degrees, r is radius</div>
                        </div>
                    </div>
                </div>

                <!-- Physics Formulas Interface -->
                <div id="physics-formulas-interface" class="tool-interface">
                    <div class="tool-header">
                        <h3 class="section-title">Physics Formulas</h3>
                        <button class="tool-back" onclick="closeTool()">
                            <i class="fas fa-arrow-left"></i> Back to Tools
                        </button>
                    </div>
                    
                    <div class="formula-category">
                        <h4>Kinematics</h4>
                        <div class="formula-item">
                            <div class="formula-name">Average Velocity (Definition)</div>
                            <div class="formula-equation">v<sub>avg</sub> = Δx / Δt</div>
                            <div class="formula-description">Where Δx is displacement, Δt is time interval</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Average Velocity (Constant Acceleration)</div>
                            <div class="formula-equation">v<sub>avg</sub> = (v + u) / 2</div>
                            <div class="formula-description">Where v is final velocity, u is initial velocity</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Velocity</div>
                            <div class="formula-equation">v = u + at</div>
                            <div class="formula-description">Final velocity = initial velocity + acceleration × time</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Displacement</div>
                            <div class="formula-equation">s = ut + ½at²</div>
                            <div class="formula-description">Displacement with constant acceleration</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Final Velocity</div>
                            <div class="formula-equation">v² = u² + 2as</div>
                            <div class="formula-description">Velocity squared relationship</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Dynamics</h4>
                        <div class="formula-item">
                            <div class="formula-name">Newton's Second Law</div>
                            <div class="formula-equation">F = ma</div>
                            <div class="formula-description">Force = mass × acceleration</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Weight</div>
                            <div class="formula-equation">W = mg</div>
                            <div class="formula-description">Weight = mass × gravity</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Momentum</div>
                            <div class="formula-equation">p = mv</div>
                            <div class="formula-description">Where p is momentum, m is mass, v is velocity</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Change in Momentum</div>
                            <div class="formula-equation">Δp = m(v - u)</div>
                            <div class="formula-description">Where Δp is change in momentum, u is initial velocity, v is final velocity</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Impulse</div>
                            <div class="formula-equation">J = Ft</div>
                            <div class="formula-description">Where J is impulse, F is force, t is time</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Impulse-Momentum Theorem</div>
                            <div class="formula-equation">J = Δp</div>
                            <div class="formula-description">Impulse equals change in momentum</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Centripetal Force</div>
                            <div class="formula-equation">F<sub>c</sub> = mv²/r</div>
                            <div class="formula-description">Where F<sub>c</sub> is centripetal force, m is mass, v is velocity, r is radius</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Energy</h4>
                        <div class="formula-item">
                            <div class="formula-name">Kinetic Energy</div>
                            <div class="formula-equation">KE = ½mv²</div>
                            <div class="formula-description">Where m is mass, v is velocity</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Potential Energy (Gravitational)</div>
                            <div class="formula-equation">PE = mgh</div>
                            <div class="formula-description">Where m is mass, g is gravity, h is height</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Strain Energy (Elastic Potential)</div>
                            <div class="formula-equation">E = ½kx²</div>
                            <div class="formula-equation">E = ½Fx</div>
                            <div class="formula-description">Where k is spring constant, x is extension, F is force</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Power</div>
                            <div class="formula-equation">P = E/t</div>
                            <div class="formula-equation">P = W/t</div>
                            <div class="formula-equation">P = Fv</div>
                            <div class="formula-description">Where P is power, E is energy, W is work, t is time, F is force, v is velocity</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Total Mechanical Energy</div>
                            <div class="formula-equation">E<sub>total</sub> = KE + PE</div>
                            <div class="formula-description">Conservation of mechanical energy (in conservative systems)</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Work</div>
                            <div class="formula-equation">W = F × d × cosθ</div>
                            <div class="formula-description">Where θ is angle between force and displacement</div>
                        </div>
                    </div>
<div class="formula-category">
                        <h4>Electricity</h4>
                        <div class="formula-item">
                            <div class="formula-name">Ohm's Law</div>
                            <div class="formula-equation">V = IR</div>
                            <div class="formula-description">Where V is voltage, I is current, R is resistance</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Electrical Power</div>
                            <div class="formula-equation">P = IV</div>
                            <div class="formula-equation">P = I²R</div>
                            <div class="formula-equation">P = V²/R</div>
                            <div class="formula-description">Three equivalent formulas for electrical power</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Electrical Energy</div>
                            <div class="formula-equation">E = Pt</div>
                            <div class="formula-equation">E = IVt</div>
                            <div class="formula-equation">E = I²Rt</div>
                            <div class="formula-equation">E = (V²/R)t</div>
                            <div class="formula-description">Where E is energy, P is power, t is time</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Coulomb's Law</div>
                            <div class="formula-equation">F = k(q₁q₂/r²)</div>
                            <div class="formula-equation">k = 1/(4πε₀)</div>
                            <div class="formula-description">Where F is electrostatic force, q₁ and q₂ are charges, r is distance, k is Coulomb's constant</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Resistors in Series</div>
                            <div class="formula-equation">R<sub>total</sub> = R₁ + R₂ + R₃ + ...</div>
                            <div class="formula-description">Total resistance is the sum of individual resistances</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Resistors in Parallel</div>
                            <div class="formula-equation">1/R<sub>total</sub> = 1/R₁ + 1/R₂ + 1/R₃ + ...</div>
                            <div class="formula-equation">R<sub>total</sub> = (R₁R₂)/(R₁ + R₂) [for two resistors]</div>
                            <div class="formula-description">Reciprocal of total resistance equals sum of reciprocals</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Electric Current</div>
                            <div class="formula-equation">I = Q/t</div>
                            <div class="formula-description">Where I is current, Q is charge, t is time</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Resistance</div>
                            <div class="formula-equation">R = ρL/A</div>
                            <div class="formula-description">Where ρ is resistivity, L is length, A is cross-sectional area</div>
                        </div>
                    </div>
<div class="formula-item">
                            <div class="formula-name">Capacitance</div>
                            <div class="formula-equation">C = Q/V</div>
                            <div class="formula-description">Where C is capacitance, Q is charge, V is voltage</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Parallel Plate Capacitor</div>
                            <div class="formula-equation">C = εA/d</div>
                            <div class="formula-description">Where ε is permittivity, A is area, d is distance</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Energy Stored in Capacitor</div>
                            <div class="formula-equation">E = ½CV²</div>
                            <div class="formula-equation">E = ½QV</div>
                            <div class="formula-equation">E = Q²/2C</div>
                            <div class="formula-description">Three equivalent formulas for energy stored</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Capacitors in Parallel</div>
                            <div class="formula-equation">C<sub>total</sub> = C₁ + C₂ + C₃ + ...</div>
                            <div class="formula-description">Total capacitance is the sum of individual capacitances</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Capacitors in Series</div>
                            <div class="formula-equation">1/C<sub>total</sub> = 1/C₁ + 1/C₂ + 1/C₃ + ...</div>
                            <div class="formula-description">Reciprocal of total capacitance equals sum of reciprocals</div>
                        </div>
<div class="formula-category">
                        <h4>Heat</h4>
                        <div class="formula-item">
                            <div class="formula-name">Heat Capacity</div>
                            <div class="formula-equation">C = Q/ΔT</div>
                            <div class="formula-description">Where C is heat capacity, Q is heat energy, ΔT is temperature change</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Specific Heat Capacity</div>
                            <div class="formula-equation">c = Q/(mΔT)</div>
                            <div class="formula-equation">Q = mcΔT</div>
                            <div class="formula-description">Where c is specific heat capacity, m is mass</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Latent Heat</div>
                            <div class="formula-equation">Q = mL</div>
                            <div class="formula-description">Where L is latent heat, m is mass</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Linear Expansion</div>
                            <div class="formula-equation">ΔL = αL₀ΔT</div>
                            <div class="formula-description">Where α is coefficient of linear expansion, L₀ is original length</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Ideal Gas Law</div>
                            <div class="formula-equation">PV = nRT</div>
                            <div class="formula-description">Where P is pressure, V is volume, n is moles, R is gas constant, T is temperature</div>
                        </div>
                    </div>
                    <div class="formula-category">
                        <h4>Waves</h4>
                        <div class="formula-item">
                            <div class="formula-name">Wave Speed</div>
                            <div class="formula-equation">v = fλ</div>
                            <div class="formula-description">Where v is wave speed, f is frequency, λ is wavelength</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Frequency and Period</div>
                            <div class="formula-equation">f = 1/T</div>
                            <div class="formula-equation">T = 1/f</div>
                            <div class="formula-description">Where f is frequency, T is period</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Angular Frequency</div>
                            <div class="formula-equation">ω = 2πf</div>
                            <div class="formula-description">Where ω is angular frequency</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Wave Equation</div>
                            <div class="formula-equation">y = A sin(ωt ± kx)</div>
                            <div class="formula-description">Where A is amplitude, k is wave number</div>
                        </div>
                    </div>
                <!-- Other tool interfaces... -->
            </div>
                <!-- Chemistry Formulas Interface -->
                <div id="chemistry-formulas-interface" class="tool-interface">
                    <div class="tool-header">
                        <h3 class="section-title">Chemistry Formulas</h3>
                        <button class="tool-back" onclick="closeTool()">
                            <i class="fas fa-arrow-left"></i> Back to Tools
                        </button>
                    </div>
                    
                    <div class="formula-category">
                        <h4>Stoichiometry</h4>
                        <div class="formula-item">
                            <div class="formula-name">Moles</div>
                            <div class="formula-equation">n = m/M</div>
                            <div class="formula-description">Where n is moles, m is mass, M is molar mass</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Molarity</div>
                            <div class="formula-equation">M = n/V</div>
                            <div class="formula-description">Where M is molarity, n is moles, V is volume in liters</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Dilution Formula</div>
                            <div class="formula-equation">M₁V₁ = M₂V₂</div>
                            <div class="formula-description">For dilution calculations</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Percentage Yield</div>
                            <div class="formula-equation">% Yield = (Actual/Theoretical) × 100%</div>
                            <div class="formula-description">Efficiency of a chemical reaction</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Gas Laws</h4>
                        <div class="formula-item">
                            <div class="formula-name">Ideal Gas Law</div>
                            <div class="formula-equation">PV = nRT</div>
                            <div class="formula-description">Where R = 8.314 J/mol·K</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Boyle's Law</div>
                            <div class="formula-equation">P₁V₁ = P₂V₂</div>
                            <div class="formula-description">Constant temperature</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Charles's Law</div>
                            <div class="formula-equation">V₁/T₁ = V₂/T₂</div>
                            <div class="formula-description">Constant pressure</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Avogadro's Law</div>
                            <div class="formula-equation">V₁/n₁ = V₂/n₂</div>
                            <div class="formula-description">Constant temperature and pressure</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Thermochemistry</h4>
                        <div class="formula-item">
                            <div class="formula-name">Enthalpy Change</div>
                            <div class="formula-equation">ΔH = H<sub>products</sub> - H<sub>reactants</sub></div>
                            <div class="formula-description">Heat change at constant pressure</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Hess's Law</div>
                            <div class="formula-equation">ΔH<sub>reaction</sub> = ΣΔH<sub>f products</sub> - ΣΔH<sub>f reactants</sub></div>
                            <div class="formula-description">Using standard enthalpies of formation</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Calorimetry</div>
                            <div class="formula-equation">q = mcΔT</div>
                            <div class="formula-description">Where q is heat, m is mass, c is specific heat capacity</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Acids and Bases</h4>
                        <div class="formula-item">
                            <div class="formula-name">pH Scale</div>
                            <div class="formula-equation">pH = -log[H⁺]</div>
                            <div class="formula-equation">[H⁺] = 10<sup>-pH</sup></div>
                            <div class="formula-description">Acidity measurement</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">pOH Scale</div>
                            <div class="formula-equation">pOH = -log[OH⁻]</div>
                            <div class="formula-equation">pH + pOH = 14</div>
                            <div class="formula-description">Basicity measurement</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Acid Dissociation Constant</div>
                            <div class="formula-equation">K<sub>a</sub> = [H⁺][A⁻]/[HA]</div>
                            <div class="formula-description">For weak acids</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Base Dissociation Constant</div>
                            <div class="formula-equation">K<sub>b</sub> = [OH⁻][BH⁺]/[B]</div>
                            <div class="formula-description">For weak bases</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Kinetics</h4>
                        <div class="formula-item">
                            <div class="formula-name">Rate of Reaction</div>
                            <div class="formula-equation">Rate = -Δ[Reactant]/Δt = +Δ[Product]/Δt</div>
                            <div class="formula-description">Change in concentration over time</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Rate Law</div>
                            <div class="formula-equation">Rate = k[A]<sup>m</sup>[B]<sup>n</sup></div>
                            <div class="formula-description">Where k is rate constant, m and n are orders</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Arrhenius Equation</div>
                            <div class="formula-equation">k = Ae<sup>-Ea/RT</sup></div>
                            <div class="formula-description">Where A is pre-exponential factor, Ea is activation energy</div>
                        </div>
                    </div>
                </div>
                <!-- Algebra Formulas Interface -->
                <div id="algebra-formulas-interface" class="tool-interface">
                    <div class="tool-header">
                        <h3 class="section-title">Algebra Formulas</h3>
                        <button class="tool-back" onclick="closeTool()">
                            <i class="fas fa-arrow-left"></i> Back to Tools
                        </button>
                    </div>
                    
                    <div class="formula-category">
                        <h4>Quadratic Equations</h4>
                        <div class="formula-item">
                            <div class="formula-name">Quadratic Formula</div>
                            <div class="formula-equation">x = [-b ± √(b² - 4ac)] / 2a</div>
                            <div class="formula-description">For equation ax² + bx + c = 0</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Discriminant</div>
                            <div class="formula-equation">D = b² - 4ac</div>
                            <div class="formula-description">D > 0: two real roots, D = 0: one real root, D < 0: complex roots</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Sum and Product of Roots</div>
                            <div class="formula-equation">α + β = -b/a</div>
                            <div class="formula-equation">αβ = c/a</div>
                            <div class="formula-description">Where α and β are roots</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Exponents and Logarithms</h4>
                        <div class="formula-item">
                            <div class="formula-name">Exponent Rules</div>
                            <div class="formula-equation">aᵐ × aⁿ = aᵐ⁺ⁿ</div>
                            <div class="formula-equation">aᵐ ÷ aⁿ = aᵐ⁻ⁿ</div>
                            <div class="formula-equation">(aᵐ)ⁿ = aᵐⁿ</div>
                            <div class="formula-description">Basic exponent operations</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Logarithm Rules</div>
                            <div class="formula-equation">logₐ(mn) = logₐm + logₐn</div>
                            <div class="formula-equation">logₐ(m/n) = logₐm - logₐn</div>
                            <div class="formula-equation">logₐmⁿ = n logₐm</div>
                            <div class="formula-description">Basic logarithm operations</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Change of Base</div>
                            <div class="formula-equation">logₐb = logₓb / logₓa</div>
                            <div class="formula-description">Convert between logarithm bases</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Sequences and Series</h4>
                        <div class="formula-item">
                            <div class="formula-name">Arithmetic Sequence</div>
                            <div class="formula-equation">aₙ = a₁ + (n-1)d</div>
                            <div class="formula-equation">Sₙ = n/2 [2a₁ + (n-1)d]</div>
                            <div class="formula-description">Where a₁ is first term, d is common difference</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Geometric Sequence</div>
                            <div class="formula-equation">aₙ = a₁ × rⁿ⁻¹</div>
                            <div class="formula-equation">Sₙ = a₁(1 - rⁿ)/(1 - r)</div>
                            <div class="formula-description">Where a₁ is first term, r is common ratio</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Infinite Geometric Series</div>
                            <div class="formula-equation">S = a₁/(1 - r)</div>
                            <div class="formula-description">For |r| < 1</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Algebraic Identities</h4>
                        <div class="formula-item">
                            <div class="formula-name">Square Identities</div>
                            <div class="formula-equation">(a + b)² = a² + 2ab + b²</div>
                            <div class="formula-equation">(a - b)² = a² - 2ab + b²</div>
                            <div class="formula-equation">a² - b² = (a + b)(a - b)</div>
                            <div class="formula-description">Common square identities</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Cube Identities</div>
                            <div class="formula-equation">(a + b)³ = a³ + 3a²b + 3ab² + b³</div>
                            <div class="formula-equation">(a - b)³ = a³ - 3a²b + 3ab² - b³</div>
                            <div class="formula-equation">a³ + b³ = (a + b)(a² - ab + b²)</div>
                            <div class="formula-equation">a³ - b³ = (a - b)(a² + ab + b²)</div>
                            <div class="formula-description">Common cube identities</div>
                        </div>
                    </div>

                    <div class="formula-category">
                        <h4>Functions</h4>
                        <div class="formula-item">
                            <div class="formula-name">Function Composition</div>
                            <div class="formula-equation">(f ∘ g)(x) = f(g(x))</div>
                            <div class="formula-description">Composite function</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Inverse Function</div>
                            <div class="formula-equation">f(f⁻¹(x)) = x</div>
                            <div class="formula-equation">f⁻¹(f(x)) = x</div>
                            <div class="formula-description">Properties of inverse functions</div>
                        </div>
                        <div class="formula-item">
                            <div class="formula-name">Distance Formula</div>
                            <div class="formula-equation">d = √[(x₂ - x₁)² + (y₂ - y₁)²]</div>
                            <div class="formula-description">Distance between two points</div>
                        </div>
                    </div>
                </div>

                <!-- Unit Converter Interface -->
                <div id="unit-converter-interface" class="tool-interface">
                    <div class="tool-header">
                        <h3 class="section-title">Unit Converter</h3>
                        <button class="tool-back" onclick="closeTool()">
                            <i class="fas fa-arrow-left"></i> Back to Tools
                        </button>
                    </div>
                    
                    <div class="converter-container">
                        <!-- Length Converter -->
                        <div class="converter-section">
                            <h4><i class="fas fa-ruler"></i> Length</h4>
                            <div class="converter-row">
                                <input type="number" id="length-value" value="1" class="converter-input">
                                <select id="length-from" class="converter-select">
                                    <option value="millimeter">Millimeters</option>
                                    <option value="centimeter">Centimeters</option>
                                    <option value="meter" selected>Meters</option>
                                    <option value="kilometer">Kilometers</option>
                                    <option value="inch">Inches</option>
                                    <option value="foot">Feet</option>
                                    <option value="yard">Yards</option>
                                    <option value="mile">Miles</option>
                                </select>
                                <button class="converter-btn" onclick="convertLength()">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <input type="text" id="length-result" readonly class="converter-result">
                                <select id="length-to" class="converter-select">
                                    <option value="millimeter">Millimeters</option>
                                    <option value="centimeter">Centimeters</option>
                                    <option value="meter">Meters</option>
                                    <option value="kilometer" selected>Kilometers</option>
                                    <option value="inch">Inches</option>
                                    <option value="foot">Feet</option>
                                    <option value="yard">Yards</option>
                                    <option value="mile">Miles</option>
                                </select>
                            </div>
                        </div>

                        <!-- Time Converter -->
                        <div class="converter-section">
                            <h4><i class="fas fa-clock"></i> Time</h4>
                            <div class="converter-row">
                                <input type="number" id="time-value" value="1" class="converter-input">
                                <select id="time-from" class="converter-select">
                                    <option value="second">Seconds</option>
                                    <option value="minute" selected>Minutes</option>
                                    <option value="hour">Hours</option>
                                    <option value="day">Days</option>
                                    <option value="week">Weeks</option>
                                    <option value="month">Months (30 days)</option>
                                    <option value="year">Years (365 days)</option>
                                </select>
                                <button class="converter-btn" onclick="convertTime()">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <input type="text" id="time-result" readonly class="converter-result">
                                <select id="time-to" class="converter-select">
                                    <option value="second" selected>Seconds</option>
                                    <option value="minute">Minutes</option>
                                    <option value="hour">Hours</option>
                                    <option value="day">Days</option>
                                    <option value="week">Weeks</option>
                                    <option value="month">Months (30 days)</option>
                                    <option value="year">Years (365 days)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Mass Converter -->
                        <div class="converter-section">
                            <h4><i class="fas fa-weight"></i> Mass</h4>
                            <div class="converter-row">
                                <input type="number" id="mass-value" value="1" class="converter-input">
                                <select id="mass-from" class="converter-select">
                                    <option value="milligram">Milligrams</option>
                                    <option value="gram">Grams</option>
                                    <option value="kilogram" selected>Kilograms</option>
                                    <option value="ounce">Ounces</option>
                                    <option value="pound">Pounds</option>
                                    <option value="ton">Tons</option>
                                </select>
                                <button class="converter-btn" onclick="convertMass()">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <input type="text" id="mass-result" readonly class="converter-result">
                                <select id="mass-to" class="converter-select">
                                    <option value="milligram">Milligrams</option>
                                    <option value="gram" selected>Grams</option>
                                    <option value="kilogram">Kilograms</option>
                                    <option value="ounce">Ounces</option>
                                    <option value="pound">Pounds</option>
                                    <option value="ton">Tons</option>
                                </select>
                            </div>
                        </div>

                        <!-- Temperature Converter -->
                        <div class="converter-section">
                            <h4><i class="fas fa-thermometer-half"></i> Temperature</h4>
                            <div class="converter-row">
                                <input type="number" id="temp-value" value="0" class="converter-input">
                                <select id="temp-from" class="converter-select">
                                    <option value="celsius" selected>°Celsius</option>
                                    <option value="fahrenheit">°Fahrenheit</option>
                                    <option value="kelvin">Kelvin</option>
                                </select>
                                <button class="converter-btn" onclick="convertTemperature()">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <input type="text" id="temp-result" readonly class="converter-result">
                                <select id="temp-to" class="converter-select">
                                    <option value="celsius">°Celsius</option>
                                    <option value="fahrenheit" selected>°Fahrenheit</option>
                                    <option value="kelvin">Kelvin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

        </main>
    </div>

<!----------------------------------------- HTML SECTION ENDS HERE --------------------------------------->

<!-- Firebase SDK and Main App Logic -->
<script type="module">

import { 
    getFunctions, 
    httpsCallable  // ← Add this
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut,
    updateProfile,
    updatePassword,
    updateEmail,
    EmailAuthProvider,
    reauthenticateWithCredential,
    deleteUser
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore,
    collection,
    doc,
    getDoc,
    getDocs,
    setDoc,
    deleteDoc,
    updateDoc,
    addDoc,
    query,
    orderBy,
    limit
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
  // Your variables...
  let currentTextbookUnit = 'unit1';
  let currentFlashcardData = null;
  let currentCourseId = null;
  let currentTopicIndex = 0;
  let currentCardIndex = 0;
  let currentDeck = [];
    
  // Your Firebase config...
  const firebaseConfig = {
    apiKey: "AIzaSyDq9F28x6D4ivUJoT3ycHRlU_c-YNctFtE",
    authDomain: "email-notifications-1c77b.firebaseapp.com",
    projectId: "email-notifications-1c77b",
    storageBucket: "email-notifications-1c77b.firebasestorage.app",
    messagingSenderId: "272046681025",
    appId: "1:272046681025:web:e0aff95e41caa65c6d1d40",
    measurementId: "G-B3VJ7R5R8H"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

// Initialize in your module
const functions = getFunctions(app);

// Make httpsCallable globally available
window.functions = functions;  // ← ADD THIS LINE
window.httpsCallable = httpsCallable;  // ← ADD THIS LINE

  // ✅ ADD checkSubscriptionStatus function HERE, inside the module
  async function checkSubscriptionStatus(user) {
    try {
        const userRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            
            // Initialize subscription field if doesn't exist
            if (userData.subscription === undefined) {
                await updateDoc(userRef, {
                    subscription: false,
                    subscriptionPlan: 'none',
                    subscriptionPrice: 0,
                    subscriptionStart: null,
                    subscriptionExpiry: null,
                    lastBillingDate: null
                });
                return false;
            }
            
            // Check if subscription is active
            if (userData.subscription === true) {
                // Check expiry date
                if (userData.subscriptionExpiry) {
                    const expiryDate = new Date(userData.subscriptionExpiry);
                    const currentDate = new Date();
                    if (currentDate > expiryDate) {
                        // Subscription expired
                        await updateDoc(userRef, { 
                            subscription: false,
                            subscriptionPlan: 'expired'
                        });
                        return false;
                    }
                }
                return true;
            }
            return false;
        } else {
            // Create user document
            await setDoc(userRef, {
                email: user.email,
                displayName: user.displayName || user.email,
                subscription: false,
                subscriptionPlan: 'none',
                subscriptionPrice: 0,
                subscriptionStart: null,
                subscriptionExpiry: null,
                lastBillingDate: null,
                createdAt: new Date().toISOString()
            });
            return false;
        }
    } catch (error) {
        console.error("Error checking subscription:", error);
        return false;
    }
  }

  // Make it globally available
  window.checkSubscriptionStatus = checkSubscriptionStatus;
  window.auth = auth;
  window.db = db;
  window.doc = doc;
  window.getDoc = getDoc;
  window.updateDoc = updateDoc;
  window.setDoc = setDoc;

  // Make auth functions globally available
  window.updateProfile = updateProfile;
  window.updatePassword = updatePassword;
  window.updateEmail = updateEmail;
  window.EmailAuthProvider = EmailAuthProvider;
  window.reauthenticateWithCredential = reauthenticateWithCredential;
  window.deleteUser = deleteUser;

// Make settings functions globally available
window.openEditProfile = openEditProfile;
window.closeEditProfile = closeEditProfile;
window.saveProfile = saveProfile;
window.openChangePassword = openChangePassword;
window.closeChangePassword = closeChangePassword;
window.changePassword = changePassword;
window.openDeleteAccount = openDeleteAccount;
window.initializeSettings = initializeSettings;
    
// Make password modal functions globally available
window.submitPasswordForDeletion = submitPasswordForDeletion;
window.closePasswordModal = closePasswordModal;
window.openPasswordModal = openPasswordModal;

// Make subscription functions globally available
window.activateMonthlySubscription = activateMonthlySubscription;
window.activateYearlySubscription = activateYearlySubscription;
window.cancelSubscription = cancelSubscription;

  // Make auth and db globally available
  window.auth = auth;
  window.db = db;

  // Make logout function globally available
  window.logout = function() {
    if (confirm('Are you sure you want to log out?')) {
      signOut(auth)
        .then(() => {
          window.location.href = "premium.html";
        })
        .catch((error) => {
          console.error("Logout failed:", error);
          alert("Logout failed. Please try again.");
        });
    }
  };

// Sync user profile to Firestore
async function syncUserProfileToFirestore(user) {
    try {
        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, {
            displayName: user.displayName,
            email: user.email,
            lastUpdated: new Date().toISOString()
        }, { merge: true });
        console.log("User profile synced to Firestore");
    } catch (error) {
        console.error("Error syncing user profile:", error);
    }
}
    
// Settings Management
let userSettings = JSON.parse(localStorage.getItem('userSettings')) || {
    notifications: {
        email: true,
        quizReminders: true,
        studyGoals: true
    },
    preferences: {
        theme: 'light',
        defaultPage: 'dashboard'
    },
    security: {
        twoFactor: false,
        passwordLastChanged: null
    }
};

let settingsInitialized = false;
    
// Initialize Settings Page
function initializeSettings() {
    if (settingsInitialized) return; // Prevent multiple initializations
    settingsInitialized = true;
    
    loadUserProfile();
    loadSettings();
    setupEventListeners();
}

// Reset when leaving settings page
function showPage(pageId, element = null) {
    if (pageId !== 'settings') {
        settingsInitialized = false; // Allow re-initialization next time
    }
}

// Apply saved theme when page loads - MOVE THIS OUTSIDE
document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = userSettings.preferences.theme || 'light';
    applyTheme(savedTheme);
});
    
async function loadUserProfile() {
    const user = auth.currentUser;
    if (user) {
        document.getElementById('settings-avatar').textContent = getInitials(user.displayName || 'User');
        document.getElementById('settings-name').textContent = user.displayName || 'User';
        document.getElementById('current-display-name').textContent = user.displayName || 'Not set';
        document.getElementById('current-email').textContent = user.email;
        document.getElementById('account-created').textContent = user.metadata.creationTime ? 
            new Date(user.metadata.creationTime).toLocaleDateString() : 'Unknown';
        
        // Load subscription status
        const subscriptionActive = await checkSubscriptionStatus(user);
        const statusElement = document.getElementById('subscription-status');
        if (statusElement) {
            // Change from 'Free' to 'Unsubscribed'
            statusElement.textContent = subscriptionActive ? 'Premium ($9.99/month)' : 'Unsubscribed';
            statusElement.style.color = subscriptionActive ? 'var(--success)' : 'var(--accent)';
        }
    }
}

function loadSettings() {
    // Notifications
    document.getElementById('email-notifications').checked = userSettings.notifications.email;
    document.getElementById('quiz-reminders').checked = userSettings.notifications.quizReminders;
    document.getElementById('study-goals').checked = userSettings.notifications.studyGoals;
    
    // Preferences
    document.getElementById('theme-selector').value = userSettings.preferences.theme;
    document.getElementById('default-page').value = userSettings.preferences.defaultPage;
    
    // Security
    document.getElementById('two-factor-toggle').checked = userSettings.security.twoFactor;
    
    if (userSettings.security.passwordLastChanged) {
        document.getElementById('password-last-changed').textContent = 
            new Date(userSettings.security.passwordLastChanged).toLocaleDateString();
    }
}

function setupEventListeners() {
    // Notification toggles
    document.getElementById('email-notifications').addEventListener('change', (e) => {
        userSettings.notifications.email = e.target.checked;
        saveSettings();
    });
    
    document.getElementById('quiz-reminders').addEventListener('change', (e) => {
        userSettings.notifications.quizReminders = e.target.checked;
        saveSettings();
    });
    
    document.getElementById('study-goals').addEventListener('change', (e) => {
        userSettings.notifications.studyGoals = e.target.checked;
        saveSettings();
    });
    
    // Preference selects
    document.getElementById('theme-selector').addEventListener('change', (e) => {
        userSettings.preferences.theme = e.target.value;
        applyTheme(e.target.value);
        saveSettings();
    });
    
    document.getElementById('default-page').addEventListener('change', (e) => {
        userSettings.preferences.defaultPage = e.target.value;
        saveSettings();
    });
    
    // Security toggle
    document.getElementById('two-factor-toggle').addEventListener('change', (e) => {
        userSettings.security.twoFactor = e.target.checked;
        saveSettings();
        if (e.target.checked) {
            showToast('Two-factor authentication enabled', 'success');
        }
    });
}

function saveSettings() {
    localStorage.setItem('userSettings', JSON.stringify(userSettings));
}

function applyTheme(theme) {
    if (theme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
    } else {
        document.body.removeAttribute('data-theme');
    }
    
    // Save to settings
    userSettings.preferences.theme = theme;
    saveSettings();
}
    
// Profile Management
function openEditProfile() {
    const user = auth.currentUser;
    if (user) {
        document.getElementById('edit-display-name').value = user.displayName || '';
        document.getElementById('edit-avatar-initials').value = getInitials(user.displayName || 'User');
    }
    document.getElementById('edit-profile-modal').style.display = 'block';
}

function closeEditProfile() {
    document.getElementById('edit-profile-modal').style.display = 'none';
}

async function saveProfile() {
    const displayName = document.getElementById('edit-display-name').value.trim();
    const avatarInitials = document.getElementById('edit-avatar-initials').value.trim();
    
    if (!displayName) {
        showToast('Please enter a display name', 'error');
        return;
    }
    
    if (!avatarInitials || avatarInitials.length !== 2) {
        showToast('Please enter exactly 2 letters for avatar initials', 'error');
        return;
    }
    
    const user = auth.currentUser;
    if (user) {
        try {
            await updateProfile(user, {
                displayName: displayName
            });
            
            // ✅ ADDED: Sync to Firestore after profile update
            await syncUserProfileToFirestore(user);
            
            // Update UI
            document.getElementById('settings-avatar').textContent = avatarInitials.toUpperCase();
            document.getElementById('settings-name').textContent = displayName;
            document.getElementById('current-display-name').textContent = displayName;
            
            // Also update other places in the app
            document.getElementById('user-avatar').textContent = avatarInitials.toUpperCase();
            document.getElementById('user-name').textContent = displayName;
            document.getElementById('welcome-message').textContent = `Welcome back, ${displayName.split(' ')[0]}! 👋`;
            
            closeEditProfile();
            showToast('Profile updated successfully', 'success');
            
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast('Error updating profile', 'error');
        }
    }
}

// Password Management
function openChangePassword() {
    document.getElementById('change-password-modal').style.display = 'block';
    // Clear form
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
}

function closeChangePassword() {
    document.getElementById('change-password-modal').style.display = 'none';
}

async function changePassword() {
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('Please fill in all password fields', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showToast('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 8) {
        showToast('Password must be at least 8 characters long', 'error');
        return;
    }
    
    const user = auth.currentUser;
    if (user && user.email) {
        try {
            // Reauthenticate user
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            
            // Update password
            await updatePassword(user, newPassword);
            
            // Update settings
            userSettings.security.passwordLastChanged = new Date().toISOString();
            saveSettings();
            document.getElementById('password-last-changed').textContent = new Date().toLocaleDateString();
            
            closeChangePassword();
            showToast('Password updated successfully', 'success');
            
        } catch (error) {
            console.error('Error changing password:', error);
            if (error.code === 'auth/wrong-password') {
                showToast('Current password is incorrect', 'error');
            } else if (error.code === 'auth/weak-password') {
                showToast('Password is too weak', 'error');
            } else {
                showToast('Error changing password', 'error');
            }
        }
    }
}

// Account Deletion
function openDeleteAccount() {
    // Show confirmation FIRST (not password first)
    const confirmation = prompt('⚠️ DANGER ZONE ⚠️\n\nType "DELETE MY ACCOUNT" to permanently delete all your data:');
    
    if (confirmation !== 'DELETE MY ACCOUNT') {
        showToast('Account deletion cancelled', 'info');
        return;
    }
    
    // THEN ask for password confirmation
    if (confirm('⚠️ FINAL CONFIRMATION ⚠️\n\nThis will permanently:\n• Delete all your courses and progress\n• Remove your quiz scores and study data\n• Erase your subscription history\n• Delete your profile\n\nThis action CANNOT be undone!')) {
        openPasswordModal();
    } else {
        showToast('Account deletion cancelled', 'info');
    }
}

async function deleteAccountWithPassword(password) {
    const user = auth.currentUser;
    if (!user || !user.email) return;
    
    try {
        // 1. Re-authenticate user FIRST
        const credential = EmailAuthProvider.credential(user.email, password);
        await reauthenticateWithCredential(user, credential);
        
        // 2. Ask for final confirmation AFTER password is verified
        const finalConfirmation = confirm('⚠️ LAST CHANCE ⚠️\n\nClick OK to PERMANENTLY DELETE your account and all data.\n\nTHIS CANNOT BE UNDONE!');
        
        if (!finalConfirmation) {
            showToast('Account deletion cancelled', 'info');
            return;
        }
        
        // 3. Delete user data from Firestore first
        try {
            const userRef = doc(db, 'users', user.uid);
            await deleteDoc(userRef);
            
            // Also delete enrolled courses
            const enrolledCoursesRef = collection(db, 'users', user.uid, 'enrolledCourses');
            const snapshot = await getDocs(enrolledCoursesRef);
            const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            
            console.log('User data deleted from Firestore');
        } catch (firestoreError) {
            console.warn('Firestore cleanup error (proceeding anyway):', firestoreError);
        }
        
        // 4. Delete user from Firebase Authentication
        await deleteUser(user);
        
        // 5. Clear local storage
        localStorage.clear();
        sessionStorage.clear();
        
        // 6. Show success and redirect
        showToast('Account and all data permanently deleted', 'success');
        setTimeout(() => {
            window.location.href = 'premium.html';
        }, 2000);
        
    } catch (error) {
        console.error('Error deleting account:', error);
        
        // Better error handling
        if (error.code === 'auth/wrong-password') {
            showToast('❌ Incorrect password. Please try again.', 'error');
        } else if (error.code === 'auth/invalid-credential') {
            showToast('❌ Invalid password. Please check your password and try again.', 'error');
        } else if (error.code === 'auth/requires-recent-login') {
            showToast('⚠️ Session expired. Please log in again and try deleting your account.', 'error');
        } else if (error.code === 'auth/too-many-requests') {
            showToast('⚠️ Too many attempts. Please try again later.', 'error');
        } else if (error.code === 'auth/user-mismatch') {
            showToast('❌ Authentication error. Please log in again.', 'error');
        } else if (error.code === 'auth/user-not-found') {
            showToast('❌ User not found.', 'error');
        } else if (error.code === 'auth/network-request-failed') {
            showToast('🌐 Network error. Please check your connection.', 'error');
        } else {
            showToast('❌ Error deleting account: ' + error.message, 'error');
        }
        
        // Close the modal on error
        closePasswordModal();
    }
}

function resetPasswordModal() {
    document.getElementById('confirm-password-input').value = '';
    const submitBtn = document.querySelector('#password-confirm-modal .modal-footer .btn[onclick="submitPasswordForDeletion()"]');
    if (submitBtn) {
        submitBtn.innerHTML = 'Confirm Deletion';
        submitBtn.disabled = false;
    }
}

let pendingDeletion = false;

function openPasswordModal() {
    document.getElementById('confirm-password-input').value = '';
    document.getElementById('password-confirm-modal').style.display = 'block';
    pendingDeletion = true;
}

function closePasswordModal() {
    document.getElementById('password-confirm-modal').style.display = 'none';
    pendingDeletion = false;
}

async function submitPasswordForDeletion() {
    const password = document.getElementById('confirm-password-input').value;
    closePasswordModal();
    
    if (!password) {
        showToast('Password is required', 'error');
        return;
    }
    
    await deleteAccountWithPassword(password);
}


// Utility Functions
function showToast(message, type = 'info') {
    // You can implement a toast notification system here
    alert(`${type.toUpperCase()}: ${message}`);
}

function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

// Initialize settings when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('settings').classList.contains('active')) {
        initializeSettings();
    }
});
    
  // Add this function to update user profile display
  function updateUserProfileDisplay(user) {
    if (!user) return;
    
    // Get user data
    const displayName = user.displayName || user.email.split('@')[0];
    const avatar = user.displayName ? 
        user.displayName.split(' ').map(n => n[0]).join('').toUpperCase() : 
        user.email[0].toUpperCase();
    const firstName = displayName.split(' ')[0];
    
    console.log("Updating profile for:", displayName, "Avatar:", avatar);
    
    // Update avatar element
    const avatarElement = document.getElementById('user-avatar');
    if (avatarElement) {
        avatarElement.textContent = avatar;
    }
    
    // Update name element
    const nameElement = document.getElementById('user-name');
    if (nameElement) {
        nameElement.textContent = displayName;
    }
    
    // Update welcome message
    const welcomeMessage = document.getElementById('welcome-message');
    if (welcomeMessage) {
        welcomeMessage.textContent = `Welcome back, ${firstName}! 👋`;
    }
    
    // Also update other instances of user info throughout the app
    document.querySelectorAll('.user-avatar:not(#user-avatar)').forEach(el => {
        el.textContent = avatar;
    });
    
    document.querySelectorAll('.user-info span:not(#user-name)').forEach(el => {
        el.textContent = displayName;
    });
  }

async function updateDashboardStats() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const enrolledCourses = await getEnrolledCourses(user);
        const subscriptionActive = await checkSubscriptionStatus(user);
        
        // Calculate all original stats PLUS subscription status
        const enrolledCount = enrolledCourses.length;
        const coursesWithScores = enrolledCourses.filter(course => course.averageScore);
        const averageGrade = coursesWithScores.length > 0 
            ? Math.round(coursesWithScores.reduce((sum, course) => sum + course.averageScore, 0) / coursesWithScores.length)
            : 0;
        
        const quizzesCompleted = enrolledCourses.reduce((sum, course) => sum + (course.completedQuizzes || 0), 0);
        const studyDays = calculateCurrentStreak(enrolledCourses);
        
        // Update dashboard display - Keep ALL 5 stats in a grid
        const statsContainer = document.querySelector('.stats-container');
if (statsContainer) {
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${enrolledCount}</div>
            <div class="stat-label">Enrolled Courses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${averageGrade}%</div>
            <div class="stat-label">Average Grade</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${quizzesCompleted}</div>
            <div class="stat-label">Quizzes Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${studyDays}</div>
            <div class="stat-label">Study Days</div>
        </div>
    `;
}
        
        // Update welcome message - FIXED: Show personalized greeting
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) {
            // Get user's first name or display name
            let userName = 'Student';
            if (user.displayName) {
                userName = user.displayName.split(' ')[0];
            } else if (user.email) {
                userName = user.email.split('@')[0];
                // Capitalize first letter
                userName = userName.charAt(0).toUpperCase() + userName.slice(1);
            }
            
            if (subscriptionActive) {
                welcomeMessage.innerHTML = `Welcome back, ${userName}! 👑`;
                const performanceText = averageGrade >= 80 ? 'Excellent' : averageGrade >= 60 ? 'Good' : 'Keep going';
                const welcomeText = document.querySelector('.welcome-section p');
                if (welcomeText && enrolledCount > 0) {
                    welcomeText.innerHTML = `You're making progress! <strong>${averageGrade}% average</strong> across ${enrolledCount} courses. ${performanceText} work!`;
                }
            } else {
                welcomeMessage.innerHTML = `Welcome back, ${userName}! <span style="color: var(--accent);">🔒 Upgrade to Premium</span>`;
                const welcomeText = document.querySelector('.welcome-section p');
                if (welcomeText) {
                    welcomeText.innerHTML = `Ready to continue your learning journey? <a href="#" onclick="showPage('subscription')" style="color: var(--secondary); text-decoration: underline;">Subscribe now</a> to access all courses and track your progress.`;
                }
            }
        }
        
        updateRecentActivity(enrolledCourses);
        
    } catch (error) {
        console.error("Error updating dashboard stats:", error);
    }
}

function calculateStudyDays(courses) {
    // Simple streak calculation - count days with recent activity
    const today = new Date();
    const recentDays = new Set();
    
    courses.forEach(course => {
        if (course.lastAccessed) {
            const lastAccess = new Date(course.lastAccessed);
            const diffTime = Math.abs(today - lastAccess);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays <= 7) { // Activity in last 7 days
                recentDays.add(lastAccess.toDateString());
            }
        }
    });
    
    return recentDays.size;
}

function updateDashboardDisplay(stats) {
    // Update stat cards
    const statCards = document.querySelectorAll('.stat-card .stat-value');
    if (statCards.length >= 4) {
        statCards[0].textContent = stats.enrolledCourses;
        statCards[1].textContent = stats.averageGrade + '%';
        statCards[2].textContent = stats.quizzesCompleted;
        statCards[3].textContent = stats.studyDays;
    }
    
    // Update welcome message with personalized stats
    const welcomeMessage = document.querySelector('.welcome-section p');
    if (welcomeMessage && stats.enrolledCourses > 0) {
        const performanceText = stats.averageGrade >= 80 ? 'Great' : stats.averageGrade >= 60 ? 'Good' : 'Keep going';
        welcomeMessage.innerHTML = `You're making progress! <strong>${stats.averageGrade}% average</strong> across ${stats.enrolledCourses} courses. ${performanceText} work!`;
    }
}

async function updateRecentActivity() {
    const user = auth.currentUser;
    if (!user) return;
    
    const activityList = document.querySelector('.activity-list');
    if (!activityList) return;
    
    try {
        const activitiesRef = collection(db, 'users', user.uid, 'activities');
        const q = query(activitiesRef, orderBy('timestamp', 'desc'), limit(5));
        const snapshot = await getDocs(q);
        
        const activities = [];
        snapshot.forEach(doc => {
            activities.push(doc.data());
        });
        
        if (activities.length > 0) {
            activityList.innerHTML = activities.map(activity => `
                <li class="activity-item">
                    <div class="activity-icon"><i class="${getActivityIcon(activity.type)}"></i></div>
                    <div>
                        <div><strong>${getActivityDescription(activity)}</strong></div>
                        <small>${getTimeAgo(new Date(activity.timestamp))}</small>
                    </div>
                </li>
            `).join('');
        } else {
            activityList.innerHTML = `
                <li class="activity-item">
                    <div class="activity-icon"><i class="fas fa-info-circle"></i></div>
                    <div>
                        <div><strong>No recent activity</strong></div>
                        <small>Start learning to see your activity here</small>
                    </div>
                </li>
            `;
        }
    } catch (error) {
        console.error("Error loading activities:", error);
        // Fallback to empty state if error
        activityList.innerHTML = `
            <li class="activity-item">
                <div class="activity-icon"><i class="fas fa-info-circle"></i></div>
                <div>
                    <div><strong>No recent activity</strong></div>
                    <small>Start learning to see your activity here</small>
                </div>
            </li>
        `;
    }
}

function getActivityIcon(type) {
    switch(type) {
        case 'study': return 'fas fa-book';
        case 'quiz': return 'fas fa-check-circle';
        case 'flashcard': return 'fas fa-layer-group';
        default: return 'fas fa-info-circle';
    }
}

function getActivityDescription(activity) {
    switch(activity.type) {
        case 'study':
            return `Studied ${activity.courseTitle}`;
        case 'quiz':
            return `Completed quiz in ${activity.courseTitle}`;
        case 'flashcard':
            return `Practiced flashcards in ${activity.courseTitle}`;
        default:
            return `Activity in ${activity.courseTitle}`;
    }
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const diffMs = now - timestamp;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return timestamp.toLocaleDateString();
}

// Add this function to log activities
async function logActivity(courseId, courseTitle, activityType) {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const activityRef = collection(db, 'users', user.uid, 'activities');
        await addDoc(activityRef, {
            courseId: courseId,
            courseTitle: courseTitle,
            type: activityType, // 'study', 'quiz', 'flashcard', etc.
            timestamp: new Date().toISOString()
        });
        console.log(`Activity logged: ${activityType} in ${courseTitle}`);
    } catch (error) {
        console.error("Error logging activity:", error);
    }
}

 // Add these Firestore functions:
  async function getEnrolledCourses(user) {
    try {
        const enrolledRef = collection(db, 'users', user.uid, 'enrolledCourses');
        const snapshot = await getDocs(enrolledRef);
        const courses = [];
        
        snapshot.forEach(doc => {
            courses.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        console.log("Loaded enrolled courses:", courses);
        return courses;
    } catch (error) {
        console.error("Error loading enrolled courses:", error);
        return [];
    }
  }

  async function enrollCourseInFirestore(user, courseId, courseTitle, courseDescription) {
    try {
        const courseRef = doc(db, 'users', user.uid, 'enrolledCourses', courseId);
        await setDoc(courseRef, {
            title: courseTitle,
            description: courseDescription,
            enrolledAt: new Date().toISOString(),
            progress: 0,
            lastAccessed: new Date().toISOString()
        });
        console.log("Course enrolled in Firestore:", courseId);
        
        // Log the enrollment activity
        await logActivity(courseId, courseTitle, 'enrolled');
        
        return true;
    } catch (error) {
        console.error("Error enrolling course:", error);
        return false;
    }
  }

  async function unenrollCourseFromFirestore(user, courseId) {
    try {
        const courseRef = doc(db, 'users', user.uid, 'enrolledCourses', courseId);
        await deleteDoc(courseRef);
        console.log("Course unenrolled from Firestore:", courseId);
        return true;
    } catch (error) {
        console.error("Error unenrolling course:", error);
        return false;
    }
  }

  // Function to get all courses from Firestore
  async function getAllCoursesFromFirestore() {
    try {
        const coursesRef = collection(db, 'courses');
        const snapshot = await getDocs(coursesRef);
        const courses = [];
        
        snapshot.forEach(doc => {
            courses.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        console.log("Loaded courses from Firestore:", courses.length);
        return courses;
    } catch (error) {
        console.error("Error loading courses from Firestore:", error);
        return [];
    }
  }

  // courseInitializer.js
async function initializeCoursesInFirestore() {
    try {
        // Fetch courses from JSON file
        const response = await fetch('./courses.json');
        const coursesData = await response.json();
        
        // Flatten all courses from all categories
        const allCourses = Object.values(coursesData).flat();
        
        const coursesRef = collection(db, 'courses');
        
        for (const course of allCourses) {
            const courseRef = doc(coursesRef, course.id);
            await setDoc(courseRef, {
                title: course.title,
                description: course.description,
                category: course.category,
                level: course.level,
                createdAt: new Date().toISOString(),
                isActive: true
            });
        }
        console.log("Courses initialized in Firestore");
    } catch (error) {
        console.error("Error initializing courses:", error);
    }
}

async function updateCourseProgress(courseId, progress, activityType = 'study', courseTitle = '') {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const courseRef = doc(db, 'users', user.uid, 'enrolledCourses', courseId);
        
        // Get current progress data
        const courseDoc = await getDoc(courseRef);
        const currentData = courseDoc.exists() ? courseDoc.data() : {};
        
        const updateData = {
            progress: progress,
            lastAccessed: new Date().toISOString()
        };
        
        // Track specific activities with our new logic
        if (activityType === 'quiz') {
            // Use our quiz-based progress calculation
            const newCompletedQuizzes = (currentData.completedQuizzes || 0) + 1;
            const quizBasedProgress = Math.min(newCompletedQuizzes * 0.5, 100);
            
            updateData.completedQuizzes = newCompletedQuizzes;
            updateData.progress = quizBasedProgress;
            
            // Store individual quiz scores for average calculation
            const currentScores = currentData.quizScores || [];
            currentScores.push(progress); // Using progress as score
            updateData.quizScores = currentScores;
            updateData.averageScore = calculateAverage(currentScores);
            
            // Log quiz activity
            await logActivity(courseId, courseTitle || currentData.title, 'quiz');
            
        } else if (activityType === 'study') {
            updateData.studyHours = (currentData.studyHours || 0) + 0.5;
            
            // Log study activity
            await logActivity(courseId, courseTitle || currentData.title, 'study');
        }
        
        await updateDoc(courseRef, updateData);
        console.log(`Progress updated for ${courseId}: ${updateData.progress}%`);
        
        // Refresh displays
        if (document.getElementById('progress')?.classList.contains('active')) {
            updateProgressDisplay();
        }
        if (document.getElementById('dashboard')?.classList.contains('active')) {
            updateDashboardStats();
            updateRecentActivity();
        }
    } catch (error) {
        console.error("Error updating progress:", error);
    }
}

function calculateAverage(scores) {
    if (scores.length === 0) return 0;
    return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
}

  // Run this once to migrate your courses to Firestore
  async function migrateCoursesToFirestore() {
    if (confirm('This will initialize all courses in Firestore. Continue?')) {
        await initializeCoursesInFirestore();
        alert('Courses migrated to Firestore!');
    }
  }

window.isSubscriptionActive = false;

 // Also update when the dashboard page is shown
// Also update when the dashboard page is shown
const originalShowPage = window.showPage;
window.showPage = async function(pageId, element = null) {
    const user = auth.currentUser;
    
    // Define which pages require subscription (all except dashboard, subscription, settings)
    const freePages = ['dashboard', 'subscription', 'settings'];
    
    // Check if page requires subscription
    if (!freePages.includes(pageId) && user) {
        // Check subscription status
        if (!isSubscriptionActive) {
            isSubscriptionActive = await checkSubscriptionStatus(user);
        }
        
        if (!isSubscriptionActive) {
            // Redirect to subscription page with message
            alert('🔒 Premium Feature\n\nThis section requires an active subscription.\n\nSubscribe now for only $9.99/month to access:\n• All courses & textbooks\n• Exam-style quizzes\n• Interactive flashcards\n• Study tools & materials');
            showPage('subscription');
            return;
        }
    }
    
    // Call original function
    originalShowPage.call(this, pageId, element);
    
    // Update subscription UI when subscription page is shown
    if (pageId === 'subscription' && user) {
        setTimeout(() => {
            updateSubscriptionUserName();
            displaySubscriptionStatus();
            
            // Add event listeners to buttons
            const subscribeBtn = document.getElementById('subscribe-monthly-button');
            const subscribeYearlyBtn = document.getElementById('subscribe-yearly-button');
            const cancelBtn = document.getElementById('cancel-subscription-button');
            
            if (subscribeBtn) {
                subscribeBtn.onclick = activateMonthlySubscription;
            }
            
            if (subscribeYearlyBtn) {
                subscribeYearlyBtn.onclick = activateYearlySubscription;
            }
            
            if (cancelBtn) {
                cancelBtn.onclick = cancelSubscription;
            }
        }, 50);
    }
    
    // Update profile when dashboard is shown
    if (pageId === 'dashboard') {
        if (user) {
            setTimeout(() => updateUserProfileDisplay(user), 50);
        }
    }
    
    // Initialize settings when settings page is shown
    if (pageId === 'settings') {
        setTimeout(() => initializeSettings(), 50);
    }
    
    // Update dashboard stats when dashboard is shown
    if (pageId === 'dashboard') {
        setTimeout(async () => {
            await updateDashboardStats();
            await updateRecentActivity();
        }, 50);
    }
    
    // Update progress when progress page is shown
    if (pageId === 'progress') {
        setTimeout(() => updateProgressDisplay(), 50);
    }
};

  // Track login state
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log("User signed in:", user.email);

        await trackPageVisit();
        
        // Check subscription status
        window.isSubscriptionActive = await checkSubscriptionStatus(user);
        
        // Update profile display immediately
        updateUserProfileDisplay(user);
        
        // Initialize dashboard with real data
        setTimeout(async () => {
            showPage('dashboard');
            await updateDashboardStats();
            await updateMyCoursesDisplay();
            await updateAllCoursesDisplay();
            await updateRecentActivity();
            setupCourseSearch();
            
            // Animate progress bars
            setTimeout(() => {
                document.querySelectorAll('.progress-fill').forEach(bar => {
                    const width = bar.style.width;
                    bar.style.width = '0';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, 100);
                });
            }, 500);
        }, 100);
    } else {
        console.log("No user signed in.");
        window.location.href = "premium.html";
    }
});

 // Make functions globally available
  window.getEnrolledCourses = getEnrolledCourses;
  window.getAllCoursesFromFirestore = getAllCoursesFromFirestore;
  window.enrollCourseInFirestore = enrollCourseInFirestore;
  window.unenrollCourseFromFirestore = unenrollCourseFromFirestore;
  window.updateUserProfileDisplay = updateUserProfileDisplay;
  window.updateProgressDisplay = updateProgressDisplay;
  window.updateCourseProgress = updateCourseProgress;
  window.updateDashboardStats = updateDashboardStats;
  window.logActivity = logActivity;
  window.currentTextbookUnit = window.currentTextbookUnit || 'unit1';
  window.correctAnswers = window.correctAnswers || 0;

  // Add this function to your Firebase module
async function updateProgressDisplay() {
    const user = auth.currentUser;
    if (!user) return;

    try {
        const enrolledCourses = await getEnrolledCourses(user);
        
        // Calculate enhanced statistics
        const totalCourses = enrolledCourses.length;
        const totalProgress = enrolledCourses.reduce((sum, course) => sum + (course.progress || 0), 0);
        const averageProgress = totalCourses > 0 ? Math.round(totalProgress / totalCourses) : 0;
        
        const completedQuizzes = enrolledCourses.reduce((sum, course) => sum + (course.completedQuizzes || 0), 0);
        
        // Calculate overall average score
        const coursesWithScores = enrolledCourses.filter(course => course.averageScore);
        const totalAverageScore = coursesWithScores.reduce((sum, course) => sum + course.averageScore, 0);
        const averageScore = coursesWithScores.length > 0 ? Math.round(totalAverageScore / coursesWithScores.length) : 0;
        
        const studyHours = enrolledCourses.reduce((sum, course) => sum + (course.studyHours || 0), 0);
        
        updateProgressPage(enrolledCourses, {
            totalCourses,
            averageProgress,
            averageScore,
            completedQuizzes,
            studyHours
        });
        
    } catch (error) {
        console.error("Error updating progress display:", error);
    }
}

function updateProgressPage(courses, stats) {
    const progressGrid = document.querySelector('#progress .dashboard-grid');
    if (!progressGrid) return;
    
    progressGrid.innerHTML = `
        <div class="course-card">
            <h3 class="section-title">Course Progress</h3>
            ${courses.map(course => {
                const progress = course.progress || 0;
                const averageScore = course.averageScore || 0;
                const completedQuizzes = course.completedQuizzes || 0;
                const totalQuizzes = 200; // Your fixed number
                
                return `
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${course.title}</span>
                        <span style="font-weight: 600; color: var(--primary);">
                            ${progress}% • ${averageScore}% • ${getGradeFromScore(averageScore)}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                        ${completedQuizzes}/${totalQuizzes} quizzes completed • Last: ${course.lastAccessed ? new Date(course.lastAccessed).toLocaleDateString() : 'Never'}
                    </div>
                </div>
                `;
            }).join('')}
            
            ${courses.length === 0 ? `
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h4>No Progress Data</h4>
                    <p>Start learning to track your progress!</p>
                </div>
            ` : ''}
        </div>
        
        <div class="course-card">
            <h3 class="section-title">Overall Performance</h3>
            <div style="text-align: center; padding: 30px 20px;">
                <div style="font-size: 4rem; font-weight: 800; color: var(--primary); margin-bottom: 10px;">
                    ${stats.averageScore || 0}%
                </div>
                <div style="color: var(--gray); font-size: 1.1rem; margin-bottom: 30px;">Average Score</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Enrolled Courses</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${stats.totalCourses}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Quizzes Completed</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${stats.completedQuizzes}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Overall Progress</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${stats.averageProgress || 0}%</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Current Streak</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${calculateCurrentStreak(courses)} days</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Animate progress bars
    setTimeout(() => {
        document.querySelectorAll('.progress-fill').forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 500);
}

// Updated grade calculation based on average score
function getGradeFromScore(score) {
    if (score >= 90) return 'A';
    if (score >= 80) return 'B';
    if (score >= 70) return 'C';
    if (score >= 60) return 'D';
    return 'F';
}

function calculateCurrentStreak(courses) {
    if (courses.length === 0) return 0;
    
    // Collect all unique access dates
    const accessDates = new Set();
    courses.forEach(course => {
        if (course.lastAccessed) {
            const date = new Date(course.lastAccessed);
            accessDates.add(date.toDateString());
        }
    });
    
    // Sort dates
    const sortedDates = Array.from(accessDates)
        .map(d => new Date(d))
        .sort((a, b) => b - a);
    
    if (sortedDates.length === 0) return 0;
    
    // Calculate consecutive days from today backwards
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let streak = 0;
    let checkDate = new Date(today);
    
    for (let accessDate of sortedDates) {
        accessDate.setHours(0, 0, 0, 0);
        const diffDays = Math.floor((checkDate - accessDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays === streak) {
            streak++;
            checkDate.setDate(checkDate.getDate() - 1);
        } else if (diffDays > streak) {
            break;
        }
    }
    
    return streak;
}

// Add a function to track page visits
async function trackPageVisit() {
    const user = auth.currentUser;
    if (!user) return;
    
    const enrolledCourses = await getEnrolledCourses(user);
    
    // Update lastAccessed for all enrolled courses
    for (const course of enrolledCourses) {
        const courseRef = doc(db, 'users', user.uid, 'enrolledCourses', course.id);
        await updateDoc(courseRef, {
            lastAccessed: new Date().toISOString()
        });
    }
}
    
</script>

    <script>

// Course Data Loader - Replace your courseData object with this

let courseData = {};
let courseDataLoaded = false;

// Load all course content from JSON
async function loadCourseData() {
    if (courseDataLoaded) return courseData;
    
    try {
        const response = await fetch('./courseContent.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        courseData = await response.json();
        courseDataLoaded = true;
        console.log('✅ Course content loaded:', Object.keys(courseData).length, 'courses');
        return courseData;
    } catch (error) {
        console.error('❌ Error loading course content:', error);
        // Return empty object as fallback
        return {};
    }
}

// Get a specific course's data
function getCourseData(courseId) {
    if (!courseDataLoaded) {
        console.warn('Course data not loaded yet. Call loadCourseData() first.');
        return null;
    }
    return courseData[courseId] || null;
}

// Get chapters for a course
function getCourseChapters(courseId) {
    const course = getCourseData(courseId);
    return course ? course.chapters : [];
}

// Get quizzes for a course
function getCourseQuizzes(courseId) {
    const course = getCourseData(courseId);
    return course ? course.quizzes : [];
}

// Get all courses by category
function getCoursesByCategory(category) {
    if (!courseDataLoaded) return [];
    
    return Object.values(courseData).filter(course => 
        course.category === category
    );
}

// Get all courses by level
function getCoursesByLevel(level) {
    if (!courseDataLoaded) return [];
    
    return Object.values(courseData).filter(course => 
        course.level === level
    );
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadCourseData();
});

// Export functions for global use
window.loadCourseData = loadCourseData;
window.getCourseData = getCourseData;
window.getCourseChapters = getCourseChapters;
window.getCourseQuizzes = getCourseQuizzes;
window.getCoursesByCategory = getCoursesByCategory;
window.getCoursesByLevel = getCoursesByLevel;

// Enrollment System - Refactored to use JSON and Firestore

let allCourses = [];
let coursesLoaded = false;

// Load all courses from JSON
async function loadAllCourses() {
    if (coursesLoaded) return allCourses;
    
    try {
        const response = await fetch('./courses.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const coursesData = await response.json();
        
        // Flatten all categories into single array
        allCourses = Object.values(coursesData).flat();
        
        coursesLoaded = true;
        console.log('✅ All courses loaded:', allCourses.length);
        return allCourses;
    } catch (error) {
        console.error('❌ Error loading courses:', error);
        return [];
    }
}

// Get enrolled courses from Firestore (not localStorage)
async function getEnrolledCoursesForDisplay() {
    const user = auth.currentUser;
    if (!user) {
        console.log('No user logged in');
        return [];
    }
    
    try {
        // Use your existing Firestore function
        const enrolledCourses = await getEnrolledCourses(user);
        console.log('✅ Enrolled courses loaded:', enrolledCourses.length);
        return enrolledCourses;
    } catch (error) {
        console.error('❌ Error loading enrolled courses:', error);
        return [];
    }
}

// Get courses available for enrollment (not already enrolled)
async function getAvailableCourses() {
    const user = auth.currentUser;
    if (!user) return [];
    
    const [allCoursesData, enrolledCoursesData] = await Promise.all([
        loadAllCourses(),
        getEnrolledCoursesForDisplay()
    ]);
    
    const enrolledIds = new Set(enrolledCoursesData.map(c => c.id));
    
    return allCoursesData.filter(course => !enrolledIds.has(course.id));
}

// Enroll in a course
async function enrollInCourse(courseId) {
    const user = auth.currentUser;
    if (!user) {
        alert('Please log in to enroll in courses');
        return false;
    }
    
    const course = allCourses.find(c => c.id === courseId);
    if (!course) {
        console.error('Course not found:', courseId);
        return false;
    }
    
    // Use your existing Firestore function
    const success = await enrollCourseInFirestore(
        user,
        course.id,
        course.title,
        course.description
    );
    
    if (success) {
        console.log('✅ Enrolled in:', course.title);
        // Refresh displays
        await updateMyCoursesDisplay();
        await updateAllCoursesDisplay();
    }
    
    return success;
}

// Unenroll from a course
async function unenrollFromCourse(courseId) {
    const user = auth.currentUser;
    if (!user) return false;
    
    if (!confirm('Are you sure you want to unenroll from this course?')) {
        return false;
    }
    
    // Use your existing Firestore function
    const success = await unenrollCourseFromFirestore(user, courseId);
    
    if (success) {
        console.log('✅ Unenrolled from course');
        // Refresh displays
        await updateMyCoursesDisplay();
        await updateAllCoursesDisplay();
    }
    
    return success;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadAllCourses();
});

// Export functions globally
window.loadAllCourses = loadAllCourses;
window.getEnrolledCoursesForDisplay = getEnrolledCoursesForDisplay;
window.getAvailableCourses = getAvailableCourses;
window.enrollInCourse = enrollInCourse;
window.unenrollFromCourse = unenrollFromCourse;

        // Page navigation
        function showPage(pageId, element = null) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Set active menu item if element provided
            if (element) {
                element.classList.add('active');
            }
            
            // Refresh displays when navigating to those pages
    if (pageId === 'my-courses') {
        updateMyCoursesDisplay();
    } else if (pageId === 'all-courses') {
        updateAllCoursesDisplay();
    } else if (pageId === 'progress') {
        updateProgressDisplay();
    } else if (pageId === 'dashboard') {
        updateDashboardStats(); // Add this line
    }
}

function showCourseDetail(courseId, courseTitle, courseDescription) {
            currentCourseId = courseId;
            document.getElementById('course-title').textContent = courseTitle;
            document.getElementById('detail-course-title').textContent = courseTitle;
            document.getElementById('course-description').textContent = courseDescription;
            
            // Reset to textbook section
            showCourseSection('textbook');
            
            // Load course content
            loadCourseContent(courseId);
            
            showPage('course-detail');
        }

        function showCourseSection(section) {
            // Hide all sections
            document.querySelectorAll('.course-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(`${section}-section`).style.display = 'block';
        }

        function loadCourseContent(courseId) {
            const course = courseData[courseId];
            if (!course) return;
            
            // Load chapters
            const chapterList = document.getElementById('chapter-list');
            chapterList.innerHTML = '';
            
            course.chapters.forEach((chapter, index) => {
                const li = document.createElement('li');
                li.style.marginBottom = '10px';
                li.innerHTML = `
                    <a href="#" style="display: block; padding: 12px 15px; background: white; border-radius: var(--border-radius-sm); color: var(--primary); text-decoration: none; transition: var(--transition);" 
                       onclick="showChapter(${index}, '${courseId}')">
                        ${chapter.title}
                    </a>
                `;
                chapterList.appendChild(li);
            });
            
            // Show first chapter by default
            if (course.chapters.length > 0) {
                showChapter(0, courseId);
            }
        }

function showChapter(index, courseId) {
    const course = courseData[courseId];
    if (!course || !course.chapters[index]) return;
    
    const chapter = course.chapters[index];
    const chapterContent = document.getElementById('chapter-content');
    chapterContent.innerHTML = `
        <h4 style="color: var(--primary); margin-bottom: 15px;">${chapter.title}</h4>
        <p style="color: var(--gray); line-height: 1.6;">${chapter.content}</p>
        <div style="margin-top: 30px; display: flex; gap: 15px;">
            <button class="btn btn-outline" onclick="markAsRead('${courseId}', ${index})">
                <i class="fas fa-check"></i> Mark as Read
            </button>
            <button class="btn" onclick="showCourseSection('quizzes')">
                <i class="fas fa-question-circle"></i> Take Quiz
            </button>
        </div>
    `;
}

function markAsRead(courseId, chapterIndex) {
    // Update progress for reading
    const progressIncrease = 5; // 5% per chapter read
    updateCourseProgress(courseId, progressIncrease, 'study');
    alert(`Chapter ${chapterIndex + 1} marked as read! Progress updated.`);

     // Refresh Progress page if it's currently visible
    if (document.getElementById('progress').classList.contains('active')) {
        updateProgressDisplay();
    }
}

// Quiz functionality
let currentQuiz = null;
let currentQuestionIndex = 0;
let userAnswers = [];
        
        function startQuiz() {
    if (!currentCourseId) return;
    
    const course = getCourseData(currentCourseId);
    if (!course || !course.quizzes || course.quizzes.length === 0) return;
    
    currentQuiz = course.quizzes[0]; // Use first quiz for demo
    currentQuestionIndex = 0;
    userAnswers = [];
    
    // ✅ LOG QUIZ START ACTIVITY
    if (currentCourseId) {
        const courseTitle = getTextbookTitle(currentCourseId);
        logActivity(currentCourseId, courseTitle, 'quiz');
        console.log(`📝 Logged quiz activity: ${courseTitle}`);
    }
    
    displayQuestion();
}

function displayQuestion() {
    if (!currentQuiz || currentQuestionIndex >= currentQuiz.questions.length) {
        finishQuiz();
        return;
    }
    
    const question = currentQuiz.questions[currentQuestionIndex];
    const quizContent = document.getElementById('quiz-content');
    
    let optionsHtml = '';
    question.options.forEach((option, index) => {
        optionsHtml += `
            <div class="option" onclick="selectOption(${index})">
                ${option}
            </div>
        `;
    });
    
    quizContent.innerHTML = `
        <h4 style="color: var(--primary); margin-bottom: 20px;">${currentQuiz.title}</h4>
        <div class="question">
            <div class="question-text">${question.text}</div>
            <div class="options">
                ${optionsHtml}
            </div>
        </div>
        <div class="quiz-actions">
            <button class="btn btn-outline" onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button class="btn" onclick="nextQuestion()">
                ${currentQuestionIndex === currentQuiz.questions.length - 1 ? 'Finish Quiz' : 'Next Question'} <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    `;
}

function selectOption(optionIndex) {
    // Remove selected class from all options
    document.querySelectorAll('.option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    document.querySelectorAll('.option')[optionIndex].classList.add('selected');
    
    // Store user's answer
    userAnswers[currentQuestionIndex] = optionIndex;
}

function nextQuestion() {
    if (currentQuestionIndex < currentQuiz.questions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
    } else {
        finishQuiz();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
    }
}

let correctAnswers = 0;

function finishQuiz() {
    if (!currentQuiz) return;
    
    // Calculate score
    correctAnswers = 0; // Reset counter
    currentQuiz.questions.forEach((question, index) => {
        if (userAnswers[index] === question.correct) {
            correctAnswers++;
        }
    });
    
    const score = Math.round((correctAnswers / currentQuiz.questions.length) * 100);
    
    // Update progress with the actual score
    const courseTitle = getTextbookTitle(currentCourseId);
    updateCourseProgress(currentCourseId, score, 'quiz', courseTitle);

    // Refresh Progress page if it's currently visible
    if (document.getElementById('progress').classList.contains('active')) {
        updateProgressDisplay();
    }
    
    // ✅ REFRESH DASHBOARD STATS AND RECENT ACTIVITY
    if (document.getElementById('dashboard').classList.contains('active')) {
        updateDashboardStats();
        updateRecentActivity();
    }
    
    const quizContent = document.getElementById('quiz-content');
    quizContent.innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">Quiz Complete!</h3>
            <div style="font-size: 3rem; font-weight: 800; color: ${score >= 70 ? 'var(--success)' : 'var(--accent)'}; margin-bottom: 20px;">
                ${score}%
            </div>
            <p style="color: var(--gray); margin-bottom: 30px;">
                You answered ${correctAnswers} out of ${currentQuiz.questions.length} questions correctly.
            </p>
            <button class="btn" onclick="startQuiz()">
                <i class="fas fa-redo"></i> Try Again
            </button>
            <button class="btn btn-outline" onclick="showCourseSection('textbook')">
                <i class="fas fa-book"></i> Back to Textbook
            </button>
        </div>
    `;
}

         // Enrollment System
        async function enrollCourse(courseId, courseTitle, courseDescription) {
    const user = auth.currentUser;
    if (!user) {
        alert('Please log in to enroll in courses');
        return;
    }

    // Check subscription
    if (!isSubscriptionActive) {
        const subscribe = confirm('🔒 Premium Course\n\nThis course requires a subscription.\n\nSubscribe now for $9.99/month to access all courses and features.\n\nGo to subscription page?');
        if (subscribe) {
            showPage('subscription');
        }
        return;
    }
    
    // Check if already enrolled
    const currentEnrolled = await getEnrolledCourses(user);
    if (currentEnrolled.find(course => course.id === courseId)) {
        alert('You are already enrolled in this course!');
        return;
    }
    
    const success = await enrollCourseInFirestore(user, courseId, courseTitle, courseDescription);
    if (success) {
        updateMyCoursesDisplay();
        showEnrollmentSuccess(courseTitle);
    } else {
        alert('Failed to enroll in course. Please try again.');
    }
}

async function unenrollCourse(courseId) {
    const user = auth.currentUser;
    if (!user) {
        alert('Please log in to manage courses');
        return;
    }
    
    if (confirm('Are you sure you want to unenroll from this course?')) {
        const success = await unenrollCourseFromFirestore(user, courseId);
        if (success) {
            updateMyCoursesDisplay();
        } else {
            alert('Failed to unenroll from course. Please try again.');
        }
    }
}

async function updateMyCoursesDisplay() {
    const user = auth.currentUser;
    const myCoursesGrid = document.getElementById('my-courses-grid');
    
    if (!myCoursesGrid) return;
    if (!user) {
        myCoursesGrid.innerHTML = '<p>Please log in to view your courses</p>';
        return;
    }
    
    // Show loading state
    myCoursesGrid.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="tool-icon" style="margin: 0 auto 20px;">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p>Loading your courses...</p>
        </div>
    `;
    
    try {
        const enrolledCourses = await getEnrolledCourses(user);
        
        if (enrolledCourses.length === 0) {
            myCoursesGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-book" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>No Courses Enrolled</h3>
                    <p>Browse available courses and enroll to get started!</p>
                    <button class="btn" onclick="showPage('all-courses')">
                        <i class="fas fa-search"></i> Browse Courses
                    </button>
                </div>
            `;
            return;
        }
        
        myCoursesGrid.innerHTML = enrolledCourses.map(course => `
            <div class="course-card">
                <h3>${course.title}</h3>
                <p>${course.description}</p>
                <div style="margin-top: 15px; font-size: 0.9rem; color: var(--gray);">
                    <i class="fas fa-calendar"></i> Enrolled: ${new Date(course.enrolledAt).toLocaleDateString()}
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="showCourseDetail('${course.id}', '${course.title.replace(/'/g, "\\'")}', '${course.description.replace(/'/g, "\\'")}')">
                        Open Course
                    </button>
                    <button class="btn btn-outline" onclick="unenrollCourse('${course.id}')" style="padding: 16px 20px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error("Error displaying courses:", error);
        myCoursesGrid.innerHTML = '<p>Error loading courses. Please try again.</p>';
    }
}

async function updateAllCoursesDisplay() {
    const allCoursesGrid = document.getElementById('all-courses-grid');
    if (!allCoursesGrid) return;
    
    // Show loading state
    allCoursesGrid.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div class="tool-icon" style="margin: 0 auto 20px;">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p>Loading available courses...</p>
        </div>
    `;
    
    try {
        const user = auth.currentUser;
        const [allCourses, enrolledCourses] = await Promise.all([
            getAllCoursesFromFirestore(),
            user ? getEnrolledCourses(user) : []
        ]);
        
        // Update course count
        document.getElementById('courseCount').textContent = allCourses.length;
        
        if (allCourses.length === 0) {
            allCoursesGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--gray); grid-column: 1 / -1;">
                    <i class="fas fa-book" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h3>No Courses Available</h3>
                    <p>Courses will be available soon!</p>
                </div>
            `;
            return;
        }
        
        allCoursesGrid.innerHTML = allCourses.map(course => {
            const isEnrolled = enrolledCourses.some(ec => ec.id === course.id);
            const categoryIcon = getCategoryIcon(course.category);
            const levelBadge = getLevelBadge(course.level);
            
            return `
                <div class="course-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h3>${course.title}</h3>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="font-size: 1.2rem;">${categoryIcon}</span>
                            ${levelBadge}
                        </div>
                    </div>
                    <p style="color: var(--gray); margin-bottom: 15px;">${course.description}</p>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
                        <div style="font-size: 0.8rem; color: var(--gray);">
                            <i class="fas fa-layer-group"></i> ${course.category} • ${course.level}
                        </div>
                        ${isEnrolled ? 
                            `<button class="btn" onclick="showCourseDetail('${course.id}', '${course.title.replace(/'/g, "\\'")}', '${course.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-play"></i> Continue
                            </button>` :
                            `<button class="btn" onclick="enrollCourse('${course.id}', '${course.title.replace(/'/g, "\\'")}', '${course.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-plus"></i> Enroll
                            </button>`
                        }
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error("Error displaying courses:", error);
        allCoursesGrid.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--accent); grid-column: 1 / -1;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h3>Error Loading Courses</h3>
                <p>Please try refreshing the page.</p>
                <button class="btn" onclick="updateAllCoursesDisplay()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

// Helper functions for icons and badges
function getCategoryIcon(category) {
    const icons = {
        'physics': '⚛️',
        'math': '🧮',
        'chemistry': '🧪',
        'biology': '🧬',
        'economics': '💹'
    };
    return icons[category] || '📚';
}

// Category and Level Helper Functions - Loads from JSON

let categoryConfig = null;

// Load category configuration
async function loadCategoryConfig() {
    if (categoryConfig) return categoryConfig;
    
    try {
        const response = await fetch('./categoryConfig.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        categoryConfig = await response.json();
        console.log('✅ Category config loaded');
        return categoryConfig;
    } catch (error) {
        console.error('❌ Error loading category config:', error);
        // Return minimal fallback
        return {
            categories: {},
            defaultCategory: { icon: '📚', label: 'General', color: '#6b7280' },
            levels: {}
        };
    }
}

// Get category icon
function getCategoryIcon(category) {
    if (!categoryConfig) {
        console.warn('Category config not loaded. Call loadCategoryConfig() first.');
        return '📚';
    }
    
    const cat = categoryConfig.categories[category];
    return cat ? cat.icon : categoryConfig.defaultCategory.icon;
}

// Get category label
function getCategoryLabel(category) {
    if (!categoryConfig) return category;
    const cat = categoryConfig.categories[category];
    return cat ? cat.label : categoryConfig.defaultCategory.label;
}

// Get category color
function getCategoryColor(category) {
    if (!categoryConfig) return '#6b7280';
    const cat = categoryConfig.categories[category];
    return cat ? cat.color : categoryConfig.defaultCategory.color;
}

// Get category description
function getCategoryDescription(category) {
    if (!categoryConfig) return '';
    const cat = categoryConfig.categories[category];
    return cat ? cat.description : '';
}

// Get level badge HTML
function getLevelBadge(level) {
    if (!categoryConfig) return '';
    
    const lvl = categoryConfig.levels[level];
    if (!lvl) return '';
    
    return `<span style="
        background: ${lvl.color}; 
        color: white; 
        padding: 4px 10px; 
        border-radius: 12px; 
        font-size: 0.75rem; 
        font-weight: 600;
    ">${lvl.badge}</span>`;
}

// Get level color
function getLevelColor(level) {
    if (!categoryConfig) return '#6b7280';
    const lvl = categoryConfig.levels[level];
    return lvl ? lvl.color : '#6b7280';
}

// Get all categories (for filters/dropdowns)
function getAllCategories() {
    if (!categoryConfig) return [];
    return Object.entries(categoryConfig.categories).map(([key, value]) => ({
        id: key,
        ...value
    }));
}

// Get all levels sorted by order
function getAllLevels() {
    if (!categoryConfig) return [];
    return Object.entries(categoryConfig.levels)
        .map(([key, value]) => ({
            id: key,
            ...value
        }))
        .sort((a, b) => a.order - b.order);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadCategoryConfig();
});

// Export functions globally
window.loadCategoryConfig = loadCategoryConfig;
window.getCategoryIcon = getCategoryIcon;
window.getCategoryLabel = getCategoryLabel;
window.getCategoryColor = getCategoryColor;
window.getCategoryDescription = getCategoryDescription;
window.getLevelBadge = getLevelBadge;
window.getLevelColor = getLevelColor;
window.getAllCategories = getAllCategories;
window.getAllLevels = getAllLevels;

function showEnrollmentSuccess(courseTitle) {
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 15px 25px;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                font-weight: 600;
            `;
            successMsg.innerHTML = `<i class="fas fa-check-circle"></i> Enrolled in ${courseTitle}`;
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentNode) {
                    document.body.removeChild(successMsg);
                }
            }, 3000);
        }

        // Course search functionality
        function setupCourseSearch() {
    const searchInput = document.getElementById('courseSearch');
    if (!searchInput) return;
    
    let allCoursesCache = [];
    
    // Load courses for search functionality
    getAllCoursesFromFirestore().then(courses => {
        allCoursesCache = courses;
    });
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const courseCards = document.querySelectorAll('#all-courses .course-card');
        
        courseCards.forEach(card => {
            const courseName = card.querySelector('h3').textContent.toLowerCase();
            const courseDescription = card.querySelector('p').textContent.toLowerCase();
            const courseCategory = card.querySelector('.fa-layer-group')?.parentElement?.textContent.toLowerCase() || '';
            
            if (courseName.includes(searchTerm) || courseDescription.includes(searchTerm) || courseCategory.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Update visible course count
        const visibleCount = document.querySelectorAll('#all-courses .course-card[style="display: block"]').length;
        const totalCount = allCoursesCache.length;
        document.getElementById('courseCount').textContent = searchTerm ? 
            `${visibleCount} of ${totalCount}` : totalCount;
    });
}

//...........................................................................................................................//
//.............................................STUDY MATERIALS SECTION STARTS HERE...........................................//
//...........................................................................................................................//

// Study Materials Tools Navigation
let currentTool = null;

function openTool(toolName) {
    // Hide tools grid
    document.getElementById('tools-grid').style.display = 'none';
    
    // Hide all tool interfaces
    document.querySelectorAll('.tool-interface').forEach(tool => {
        tool.classList.remove('active');
    });
    
    // Show selected tool interface
    const toolInterface = document.getElementById(`${toolName}-interface`);
    if (toolInterface) {
        toolInterface.classList.add('active');
        currentTool = toolName;
    }
}

function closeTool() {
    // Hide all tool interfaces
    document.querySelectorAll('.tool-interface').forEach(tool => {
        tool.classList.remove('active');
    });
    
    // Show tools grid
    document.getElementById('tools-grid').style.display = 'grid';
    currentTool = null;
}

// Calculator Functions
let calcDisplay = document.getElementById('calc-display');
let currentCalculation = '0';
let shouldClearOnNextInput = false;

function appendToCalc(value) {
    if (shouldClearOnNextInput && /[0-9]/.test(value)) {
        // Start fresh with new number after a result
        currentCalculation = value;
        shouldClearOnNextInput = false;
    } 
    else if (currentCalculation === '0' && value !== '.' && value !== 'Math.PI') {
        // Replace the initial zero
        currentCalculation = value;
    }
    else if (value === 'Math.PI') {
        if (currentCalculation === '0' || shouldClearOnNextInput) {
            currentCalculation = Math.PI.toString();
            shouldClearOnNextInput = false;
        } else {
            currentCalculation += Math.PI.toString();
        }
    } else {
        // Continue the current calculation
        currentCalculation += value;
        shouldClearOnNextInput = false;
    }
    
    calcDisplay.value = currentCalculation;
}

function clearCalculator() {
    currentCalculation = '0';
    shouldClearOnNextInput = false;
    calcDisplay.value = currentCalculation;
}

function backspace() {
    if (currentCalculation.length > 1) {
        currentCalculation = currentCalculation.slice(0, -1);
    } else {
        currentCalculation = '0';
    }
    shouldClearOnNextInput = false;
    calcDisplay.value = currentCalculation;
}

function calculateFunction(func) {
    try {
        let result;
        const currentValue = parseFloat(currentCalculation) || 0;
        
        switch(func) {
            case 'sin':
                result = Math.sin(currentValue * Math.PI / 180);
                break;
            case 'cos':
                result = Math.cos(currentValue * Math.PI / 180);
                break;
            case 'tan':
                const radians = currentValue * Math.PI / 180;
                // Check for undefined tangent values (90°, 270°, etc.)
                if (Math.abs(Math.cos(radians)) < 1e-10) {
                    currentCalculation = 'Error: Undefined';
                    calcDisplay.value = currentCalculation;
                    shouldClearOnNextInput = true;
                    return;
                }
                result = Math.tan(radians);
                break;
            case 'sqrt':
                if (currentValue < 0) {
                    currentCalculation = 'Error: Imaginary';
                    calcDisplay.value = currentCalculation;
                    shouldClearOnNextInput = true;
                    return;
                }
                result = Math.sqrt(currentValue);
                break;
            case 'pow':
                currentCalculation += '^';
                calcDisplay.value = currentCalculation;
                shouldClearOnNextInput = false;
                return;
            case 'log':
                if (currentValue <= 0) {
                    currentCalculation = 'Error: Domain';
                    calcDisplay.value = currentCalculation;
                    shouldClearOnNextInput = true;
                    return;
                }
                result = Math.log10(currentValue);
                break;
            case 'ln':
                if (currentValue <= 0) {
                    currentCalculation = 'Error: Domain';
                    calcDisplay.value = currentCalculation;
                    shouldClearOnNextInput = true;
                    return;
                }
                result = Math.log(currentValue);
                break;
        }
        
        // Handle very small results (near zero)
        if (Math.abs(result) < 1e-10) result = 0;
        
        currentCalculation = result.toString();
        calcDisplay.value = currentCalculation;
        shouldClearOnNextInput = true;
        
    } catch (error) {
        calcDisplay.value = 'Error';
        currentCalculation = '0';
        shouldClearOnNextInput = true;
    }
}

function calculate() {
    try {
        // Replace caret (^) with JavaScript exponentiation operator (**)
        let expression = currentCalculation.replace(/\^/g, '**');
        
        // Handle percentage calculations
        expression = expression.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
        
        // Evaluate the expression
        let result = eval(expression);
        
        // Handle division by zero and other mathematical errors
        if (!isFinite(result)) {
            if (isNaN(result)) {
                currentCalculation = 'Error: NaN';
            } else {
                currentCalculation = 'Error: Division by zero';
            }
        } else {
            // Round to avoid floating point precision issues
            result = Math.round(result * 1e12) / 1e12;
            currentCalculation = result.toString();
        }
        
        calcDisplay.value = currentCalculation;
        shouldClearOnNextInput = true;
        
    } catch (error) {
        calcDisplay.value = 'Error';
        currentCalculation = '0';
        shouldClearOnNextInput = true;
    }
}
        
// Add keyboard support
document.addEventListener('keydown', function(event) {
    if (currentTool === 'calculator') {
        const key = event.key;
        if ('0123456789+-*/.()'.includes(key)) {
            event.preventDefault();
            appendToCalc(key);
        } else if (key === 'Enter') {
            event.preventDefault();
            calculate();
        } else if (key === 'Escape') {
            event.preventDefault();
            clearCalculator();
        } else if (key === 'Backspace') {
            event.preventDefault();
            backspace();
        }
    }
});

// Unit Converter Functions
function convertLength() {
    const value = parseFloat(document.getElementById('length-value').value);
    const fromUnit = document.getElementById('length-from').value;
    const toUnit = document.getElementById('length-to').value;
    
    const conversionRates = {
        millimeter: 0.001,
        centimeter: 0.01,
        meter: 1,
        kilometer: 1000,
        inch: 0.0254,
        foot: 0.3048,
        yard: 0.9144,
        mile: 1609.34
    };
    
    const valueInMeters = value * conversionRates[fromUnit];
    const result = valueInMeters / conversionRates[toUnit];
    document.getElementById('length-result').value = result.toFixed(6);
}

function convertTime() {
    const value = parseFloat(document.getElementById('time-value').value);
    const fromUnit = document.getElementById('time-from').value;
    const toUnit = document.getElementById('time-to').value;
    
    const conversionRates = {
        second: 1,
        minute: 60,
        hour: 3600,
        day: 86400,
        week: 604800,
        month: 2592000, // 30 days
        year: 31536000  // 365 days
    };
    
    const valueInSeconds = value * conversionRates[fromUnit];
    const result = valueInSeconds / conversionRates[toUnit];
    document.getElementById('time-result').value = result.toFixed(6);
}

function convertMass() {
    const value = parseFloat(document.getElementById('mass-value').value);
    const fromUnit = document.getElementById('mass-from').value;
    const toUnit = document.getElementById('mass-to').value;
    
    const conversionRates = {
        milligram: 0.000001,
        gram: 0.001,
        kilogram: 1,
        ounce: 0.0283495,
        pound: 0.453592,
        ton: 1000
    };
    
    const valueInKg = value * conversionRates[fromUnit];
    const result = valueInKg / conversionRates[toUnit];
    document.getElementById('mass-result').value = result.toFixed(6);
}

function convertTemperature() {
    const value = parseFloat(document.getElementById('temp-value').value);
    const fromUnit = document.getElementById('temp-from').value;
    const toUnit = document.getElementById('temp-to').value;
    
    let result;
    
    // Convert to Celsius first
    let celsius;
    if (fromUnit === 'celsius') celsius = value;
    else if (fromUnit === 'fahrenheit') celsius = (value - 32) * 5/9;
    else if (fromUnit === 'kelvin') celsius = value - 273.15;
    
    // Convert from Celsius to target unit
    if (toUnit === 'celsius') result = celsius;
    else if (toUnit === 'fahrenheit') result = (celsius * 9/5) + 32;
    else if (toUnit === 'kelvin') result = celsius + 273.15;
    
    document.getElementById('temp-result').value = result.toFixed(2);
}

function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('open');
}

// Close sidebar when a menu item is clicked
document.querySelectorAll('.sidebar-menu a').forEach(link => {
    link.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.remove('open');
    });
});

// Close sidebar when clicking outside of it
document.addEventListener('click', (e) => {
    const sidebar = document.querySelector('.sidebar');
    const hamburger = document.getElementById('hamburger');
    if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
        sidebar.classList.remove('open');
    }
});

//---------------------------------MY COUSES SECTION STARTS HERE------------------------------------//

function showCourseDetail(courseId, courseTitle, courseDescription) {
    currentCourseId = courseId;
    document.getElementById('detail-course-title').textContent = courseTitle;
    document.getElementById('course-description').textContent = courseDescription;
    
    showPage('course-detail');
}

function openResource(resourceType, element) {
    const resourceContent = document.getElementById('resource-content');
    
    switch(resourceType) {
        case 'textbook':
    // Make sure currentCourseId is properly set
    console.log("Opening textbook for course:", currentCourseId);
    console.log("Current textbook unit:", currentTextbookUnit);
    loadTextbookContent();
    break;
            
        case 'exam-quiz':
            // Show loading state first
            resourceContent.innerHTML = `
                <div class="course-card">
                    <h3 class="section-title">Examination Quiz</h3>
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="tool-icon" style="margin: 0 auto 20px;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Exam Quizzes</h4>
                        <p style="color: var(--gray);">Preparing course-specific examination content...</p>
                    </div>
                </div>
            `;
            
            // Small delay to show loading state, then load exam quizzes
            setTimeout(() => {
                openExamQuiz();
            }, 500);
            break;
            
        case 'topic-quiz':
            resourceContent.innerHTML = `
                <div class="quiz-container">
                    <h3 class="section-title">Topic-Specific Quiz</h3>
                    <p style="color: var(--gray); margin-bottom: 20px;">Select a topic and test your knowledge</p>
                    <div id="topic-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
            `;
            loadTopicQuizzes();
            break;
            
        case 'flashcards':
            resourceContent.innerHTML = `
                <div class="course-card">
                    <h3 class="section-title">Flashcards</h3>
                    <p style="color: var(--gray); margin-bottom: 20px;">Study with interactive flashcards</p>
                    <button class="btn" onclick="startFlashcards()">
                        <i class="fas fa-layer-group"></i> Begin Study Session
                    </button>
                </div>
            `;
            break;
            
        case 'videos':
            resourceContent.innerHTML = `
                <div class="course-card">
                    <h3 class="section-title">Video Lessons</h3>
                    <p style="color: var(--gray); margin-bottom: 20px;">Watch video tutorials</p>
                    <div id="video-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
            `;
            loadVideoLessons();
            break;

            // ✅ NEW: Past Questions & Answers
        case 'past-questions':
            resourceContent.innerHTML = `
                <div class="tool-interface active">
                    <div class="tool-header">
                        <h3 class="section-title">Loading Past Questions...</h3>
                        <button class="tool-back" onclick="closePastQuestions()">
                            <i class="fas fa-arrow-left"></i> Back to Course
                        </button>
                    </div>
                    <div style="text-align: center; padding: 60px 20px;">
                        <div class="tool-icon" style="margin: 0 auto 20px;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Past Questions</h4>
                        <p style="color: var(--gray);">Preparing available topics...</p>
                    </div>
                </div>
            `;
            loadPastQuestionsTopics();
            break;
    }
    
    // Scroll to content
    resourceContent.scrollIntoView({ behavior: 'smooth' });
    } 

// Also update the showCourseDetail function to ensure currentCourseId is properly set
function showCourseDetail(courseId, courseTitle, courseDescription) {
    // Reset current course ID
    currentCourseId = courseId;
    
    // Update UI elements
    document.getElementById('detail-course-title').textContent = courseTitle;
    document.getElementById('course-description').textContent = courseDescription;
    
    // Clear any existing resource content
    document.getElementById('resource-content').innerHTML = '';
    
    showPage('course-detail');
}

// Add a function to clear all quiz data when switching courses
function clearQuizData() {
    const resourceContent = document.getElementById('resource-content');
    if (resourceContent) {
        resourceContent.innerHTML = '';
    }
    
    // Reset any quiz-related variables
    currentQuiz = null;
    currentQuestionIndex = 0;
    userAnswers = [];
}

// Textbook Content Loader - Replaces hardcoded unit lists

let textbookUnits = null;

// Load textbook units configuration
async function loadTextbookUnits() {
    if (textbookUnits) return textbookUnits;
    
    try {
        const response = await fetch('./textbookUnits.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        textbookUnits = await response.json();
        console.log('✅ Textbook units loaded for', Object.keys(textbookUnits).length, 'courses');
        return textbookUnits;
    } catch (error) {
        console.error('❌ Error loading textbook units:', error);
        return {};
    }
}

// Get textbook title for a course
function getTextbookTitle(courseId) {
    if (!textbookUnits || !textbookUnits[courseId]) {
        return 'Course Textbook';
    }
    return textbookUnits[courseId].textbookTitle;
}

// Get units for a course
function getTextbookUnits(courseId) {
    if (!textbookUnits || !textbookUnits[courseId]) {
        return [];
    }
    return textbookUnits[courseId].units;
}

// Generate unit buttons HTML
function generateUnitButtons(courseId, currentUnit) {
    const units = getTextbookUnits(courseId);
    
    if (units.length === 0) {
        return `<p style="color: var(--gray); padding: 20px; text-align: center;">No units available for this course yet.</p>`;
    }
    
    return units.map(unit => `
        <button class="unit-btn ${currentUnit === unit.id ? 'active' : ''}" onclick="switchTextbookUnit('${unit.id}')">
            ${unit.title}
        </button>
    `).join('\n');
}

// REFACTORED loadTextbookContent function
function loadTextbookContent() {
    console.log("🔍 DEBUG loadTextbookContent:");
    console.log("currentCourseId:", currentCourseId);
    console.log("currentTextbookUnit:", currentTextbookUnit);
    
    if (!currentCourseId) {
        console.error("❌ No currentCourseId set!");
        alert("Please select a course first.");
        return;
    }
    
    const resourceContent = document.getElementById('resource-content');
    if (!resourceContent) {
        console.error("❌ Resource content element not found!");
        return;
    }
    
    const textbookTitle = getTextbookTitle(currentCourseId);
    console.log("Textbook title:", textbookTitle);
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${textbookTitle}</h3>
                <button class="tool-back" onclick="openResource('textbook', this)">
                    <i class="fas fa-arrow-left"></i> Back to Resources
                </button>
            </div>
            
            <div class="textbook-container">
                <div class="textbook-sidebar">
                    <div class="unit-selector">
                        <h4>Select Unit</h4>
                        <div class="unit-buttons">
                            ${generateUnitButtons(currentCourseId, currentTextbookUnit)}
                        </div>
                    </div>
                    <h4>${getCurrentUnitName()} Sections</h4>
                    <div class="textbook-sections" id="textbook-sections">
                        <!-- Sections will be loaded here -->
                    </div>
                </div>
                
                <div class="textbook-content" id="textbook-content">
                    <div style="text-align: center; padding: 60px 20px; color: var(--gray);">
                        <div class="tool-icon" style="margin: 0 auto 20px;">
                            <i class="fas fa-book"></i>
                        </div>
                        <h4 style="color: var(--primary); margin-bottom: 10px;">${textbookTitle}</h4>
                        <p>Select a section from the sidebar to start reading.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Load sections after DOM is ready
    setTimeout(() => {
    loadTextbookSections();
    // Typeset the sidebar sections after they load
    setTimeout(() => typesetMath(document.getElementById('textbook-sections')), 150);
}, 100);
}

// Helper: Get unit name by ID
function getUnitNameById(courseId, unitId) {
    const units = getTextbookUnits(courseId);
    const unit = units.find(u => u.id === unitId);
    return unit ? unit.title : 'Unit';
}

// Helper: Get current unit name (for your existing getCurrentUnitName function)
function getCurrentUnitName() {
    if (!currentTextbookUnit || !currentCourseId) {
        return 'Current Unit';
    }
    return getUnitNameById(currentCourseId, currentTextbookUnit);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadTextbookUnits();
});

// Export functions globally
window.loadTextbookUnits = loadTextbookUnits;
window.getTextbookTitle = getTextbookTitle;
window.getTextbookUnits = getTextbookUnits;
window.generateUnitButtons = generateUnitButtons;
window.getUnitNameById = getUnitNameById;
window.getCurrentUnitName = getCurrentUnitName;
window.loadTextbookContent = loadTextbookContent;

// ✅ KEEP - This is navigation logic
function switchTextbookUnit(unit) {
    currentTextbookUnit = unit;
    loadTextbookContent();
}

// Textbook Sections Loader - Loads section data from JSON files

let textbookSectionsCache = {};

// Load sections for a specific course
async function loadTextbookSectionsData(courseId) {
    // Return from cache if already loaded
    if (textbookSectionsCache[courseId]) {
        return textbookSectionsCache[courseId];
    }
    
    try {
        const response = await fetch(`./textbookSections/${courseId}.json`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const sectionsData = await response.json();
        textbookSectionsCache[courseId] = sectionsData;
        console.log(`✅ Loaded textbook sections for ${courseId}`);
        return sectionsData;
        
    } catch (error) {
        console.error(`❌ Error loading sections for ${courseId}:`, error);
        return {};
    }
}

// REFACTORED: Load and display sections for current unit
async function loadTextbookSections() {
    console.log("🔍 DEBUG loadTextbookSections:");
    console.log("currentCourseId:", currentCourseId);
    console.log("currentTextbookUnit:", currentTextbookUnit);

    const sectionsContainer = document.getElementById('textbook-sections');
    
    if (!sectionsContainer) {
        console.error('Sections container not found');
        return;
    }
    
    // Show loading state
    sectionsContainer.innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--gray);">
            <i class="fas fa-spinner fa-spin"></i>
            <p style="margin-top: 10px;">Loading sections...</p>
        </div>
    `;
    
    try {
        const courseSections = await loadTextbookSectionsData(currentCourseId);
        const currentSections = courseSections[currentTextbookUnit];
        
        if (!currentSections || currentSections.length === 0) {
            sectionsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-book-open"></i>
                    <p style="margin-top: 10px;">No sections available for this unit yet.</p>
                </div>
            `;
            return;
        }
        
        // Render sections
sectionsContainer.innerHTML = '';

// Create elements properly
currentSections.forEach(section => {
    const div = document.createElement('div');
    div.className = 'textbook-section-item';
    
    // Use dataset to store values safely (no escaping needed!)
    div.dataset.path = section.path;
    div.dataset.title = section.title;
    
    // Add click handler properly
    div.addEventListener('click', function() {
        loadTextbookSection(this.dataset.path, this.dataset.title);
    });
    
    // Set inner HTML for the display parts
    div.innerHTML = `
        <div class="section-title">${section.title}</div>
        <div class="section-description">${section.description}</div>
    `;
    
    sectionsContainer.appendChild(div);
});
        
        // ✅ IMPROVED: Wait for DOM, then typeset
        await new Promise(resolve => setTimeout(resolve, 50));
        typesetMath(sectionsContainer);
        
    } catch (error) {
        console.error('Error loading textbook sections:', error);
        sectionsContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--accent);">
                <i class="fas fa-exclamation-triangle"></i>
                <p style="margin-top: 10px;">Error loading sections. Please try again.</p>
            </div>
        `;
    }
}

// Load individual section content (keep as-is, it already loads from JSON)
// Helper function to safely typeset MathJax
function typesetMath(element, retries = 0, maxRetries = 50) {
    // Check if MathJax is ready
    if (window.mathJaxReady && window.MathJax && MathJax.typesetPromise) {
        // MathJax is ready, typeset immediately
        MathJax.typesetPromise(element ? [element] : undefined)
            .then(() => {
                console.log('✅ MathJax typeset completed');
            })
            .catch((err) => {
                console.error('MathJax typeset error:', err);
                // Retry once on error
                if (retries < 3) {
                    setTimeout(() => typesetMath(element, retries + 1, maxRetries), 200);
                }
            });
    } 
    // MathJax not ready yet - retry
    else if (retries < maxRetries) {
        setTimeout(() => typesetMath(element, retries + 1, maxRetries), 100);
    } 
    // Failed after max retries
    else {
        console.warn('⚠️ MathJax not ready after', maxRetries * 100, 'ms');
    }
}

// Use in your function:
async function loadTextbookSection(sectionPath, sectionTitle) {
    try {
        const contentArea = document.getElementById('textbook-content');
        
        // Show loading state
        contentArea.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div class="tool-icon" style="margin: 0 auto 20px;">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Content</h4>
                <p style="color: var(--gray);">Loading ${sectionTitle}...</p>
            </div>
        `;
        
        const response = await fetch(sectionPath);
        if (!response.ok) {
            throw new Error(`Failed to load section: ${response.status}`);
        }
        
        const sectionData = await response.json();
        
        // Display the section content
        displayTextbookSection(sectionData, sectionTitle);
        
        // ✅ LOG THE STUDY ACTIVITY HERE
        if (currentCourseId) {
            const courseTitle = getTextbookTitle(currentCourseId);
            await logActivity(currentCourseId, courseTitle, 'study');
            console.log(`📚 Logged study activity: ${courseTitle} - ${sectionTitle}`);
        }
        
        // ✅ IMPROVED: Wait a bit for DOM to settle, then typeset
        await new Promise(resolve => setTimeout(resolve, 50));
        typesetMath(contentArea);

        
    } catch (error) {
        console.error('Error loading textbook section:', error);
        const contentArea = document.getElementById('textbook-content');
        contentArea.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--accent);">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h4>Content Not Available</h4>
                <p>Unable to load the textbook section. Please try again later.</p>
                <button class="btn btn-outline" onclick="loadTextbookContent()">
                    <i class="fas fa-arrow-left"></i> Back to Sections
                </button>
            </div>
        `;
    }
}


// Helper: Get all sections for a unit
async function getSectionsForUnit(courseId, unitId) {
    const courseSections = await loadTextbookSectionsData(courseId);
    return courseSections[unitId] || [];
}

// Helper: Clear cache (useful if you want to force reload)
function clearTextbookSectionsCache() {
    textbookSectionsCache = {};
}

// Export functions globally
window.loadTextbookSections = loadTextbookSections;
window.loadTextbookSection = loadTextbookSection;
window.loadTextbookSectionsData = loadTextbookSectionsData;
window.getSectionsForUnit = getSectionsForUnit;
window.clearTextbookSectionsCache = clearTextbookSectionsCache;

function displayTextbookSection(sectionData, sectionTitle) {
    console.log('🔍 DEBUG: sectionData:', sectionData);
    console.log('🔍 DEBUG: sectionTitle:', sectionTitle);
    
    const contentArea = document.getElementById('textbook-content');
    
    // Build HTML content from the new structured JSON
    let htmlContent = `
        <div class="textbook-section">
            <div class="section-header">
                <h2>${sectionTitle}</h2>
                ${sectionData.expanded_description ? `<p class="section-subtitle">${sectionData.expanded_description}</p>` : ''}
                ${sectionData.core_concept ? `
                    <div style="background: var(--light-bg); padding: 20px; border-radius: var(--border-radius-sm); margin-top: 20px; border-left: 4px solid var(--primary);">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Core Concept</h4>
                        <p style="font-weight: 600; margin-bottom: 10px;">${sectionData.core_concept.principle}</p>
                        <p style="color: var(--gray);">${sectionData.core_concept.explanation}</p>
                        ${sectionData.core_concept.image ? `
                            <div style="margin: 15px 0; text-align: center;">
                                <img src="${sectionData.core_concept.image.src}" 
                                     alt="${sectionData.core_concept.image.alt || 'Concept diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--light-gray);"
                                     onerror="this.style.display='none'">
                                ${sectionData.core_concept.image.caption ? `
                                    <div style="margin-top: 8px; font-style: italic; color: var(--gray); font-size: 0.9rem;">
                                        ${sectionData.core_concept.image.caption}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
            
            <div class="section-content">
    `;

    // Process each section
    if (sectionData.sections && Array.isArray(sectionData.sections)) {
        sectionData.sections.forEach((section, index) => {
            htmlContent += `
                <div class="content-section" style="margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--light-gray);">
                    <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.4rem; border-left: 4px solid var(--primary-light); padding-left: 15px;">
                        ${section.section_title || `Section ${index + 1}`}
                    </h3>
            `;

            // Add section image if present
            if (section.image) {
                htmlContent += `
                    <div style="margin: 15px 0 20px 0; text-align: center;">
                        <img src="${section.image.src}" 
                             alt="${section.image.alt || 'Section diagram'}"
                             style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--light-gray); box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                             onerror="this.style.display='none'">
                `;
                if (section.image.caption) {
                    htmlContent += `
                        <div style="margin-top: 8px; font-style: italic; color: var(--gray); font-size: 0.9rem;">
                            ${section.image.caption}
                        </div>
                    `;
                }
                htmlContent += `</div>`;
            }

            // Add introduction if present
            if (section.introduction) {
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-style: italic;">
                        ${section.introduction}
                `;
                
                if (section.introduction_image) {
                    htmlContent += `
                        <div style="margin-top: 15px; text-align: center;">
                            <img src="${section.introduction_image.src}" 
                                 alt="${section.introduction_image.alt || 'Introduction diagram'}"
                                 style="max-width: 100%; height: auto; border-radius: 6px;"
                                 onerror="this.style.display='none'">
                    `;
                    if (section.introduction_image.caption) {
                        htmlContent += `
                            <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                ${section.introduction_image.caption}
                            </div>
                        `;
                    }
                    htmlContent += `</div>`;
                }
                
                htmlContent += `</div>`;
            }

            // Add key concept if present
            if (section.key_concept) {
                if (typeof section.key_concept === 'object' && section.key_concept.definition) {
                    // Handle object format
                    htmlContent += `
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong style="color: var(--primary);">Key Concept:</strong> ${section.key_concept.definition}
                    `;
                    
                    if (section.key_concept.context) {
                        htmlContent += `
                            <div style="margin-top: 8px;"><strong>Context:</strong> ${section.key_concept.context}</div>
                        `;
                    }
                    
                    if (section.key_concept.image) {
                        htmlContent += `
                            <div style="margin-top: 12px; text-align: center;">
                                <img src="${section.key_concept.image.src}" 
                                     alt="${section.key_concept.image.alt || 'Concept diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px; border: 1px solid #b3e5fc;"
                                     onerror="this.style.display='none'">
                        `;
                        if (section.key_concept.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${section.key_concept.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `</div>`;
                } else {
                    // Handle string format
                    htmlContent += `
                        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong style="color: var(--primary);">Key Concept:</strong> ${section.key_concept}
                        </div>
                    `;
                }
            }

            // ===== REORDERED: CLASSIFICATIONS FIRST (What things are) =====
            if (section.classifications) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Methods:</h4>`;
                section.classifications.forEach(classification => {
                    htmlContent += `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--light-gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">${classification.type}</h5>
                            <p style="margin-bottom: 8px;"><strong>When to use:</strong> ${classification.value}</p>
                            <p style="margin-bottom: 8px;"><strong>Characteristics:</strong> ${classification.characteristics.join(', ')}</p>
                            <p style="margin-bottom: 8px;"><strong>How it works:</strong> ${classification.behavior}</p>
                    `;
                    
                    if (classification.examples && classification.examples.length > 0) {
                        htmlContent += `
                            <div style="margin-top: 15px;">
                                <strong>Examples:</strong>
                                ${classification.examples.map(example => `
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 8px;">
                                        <strong>${example.process}:</strong> ${example.explanation}
                                        ${example.image ? `
                                            <div style="margin-top: 8px; text-align: center;">
                                                <img src="${example.image.src}" 
                                                     alt="${example.image.alt || 'Example diagram'}"
                                                     style="max-width: 90%; height: auto; border-radius: 4px;"
                                                     onerror="this.style.display='none'">
                                                ${example.image.caption ? `
                                                    <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                                        ${example.image.caption}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    htmlContent += `</div>`;
                });
            }

            // ===== PRINCIPLES SECOND (Theory/How things work) =====
            if (section.principles) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Fundamental Principles:</h4>`;
                section.principles.forEach(principle => {
                    htmlContent += `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--light-gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">${principle.principle}</h5>
                    `;
                    
                    if (principle.image) {
                        htmlContent += `
                            <div style="margin-bottom: 15px; text-align: center;">
                                <img src="${principle.image.src}" 
                                     alt="${principle.image.alt || 'Principle diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px;"
                                     onerror="this.style.display='none'">
                        `;
                        if (principle.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${principle.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `
                            <p style="margin-bottom: 8px;"><strong>Principle:</strong> ${principle.principle}</p>
                            <p style="margin-bottom: 8px;"><strong>Statement:</strong> ${principle.statement}</p>
                            <p style="margin-bottom: 8px;"><strong>Application:</strong> ${principle.application}</p>
                    `;
                    
                    if (principle.example) {
                        htmlContent += `<p style="margin-bottom: 8px;"><strong>Example:</strong> ${principle.example}</p>`;
                    }
                    
                    if (principle.analogy) {
                        htmlContent += `<div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #ffc107;"><strong>Analogy:</strong> ${principle.analogy}</div>`;
                    }
                    
                    htmlContent += `</div>`;
                });
            }

            // ===== COMPONENTS THIRD (Building blocks) =====
            if (section.components) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Key Components:</h4>`;
                const components = section.components;
                htmlContent += `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--light-gray);">
                        <p style="margin-bottom: 10px;"><strong>Definition:</strong> ${components.definition}</p>
                `;
                
                if (components.equation) {
                    htmlContent += `<p style="margin-bottom: 10px;"><strong>Equation:</strong> ${components.equation}</p>`;
                }
                
                if (components.interpretation) {
                    htmlContent += `<p style="margin-bottom: 15px;"><strong>Interpretation:</strong> ${components.interpretation}</p>`;
                }
                
                if (components.image) {
                    htmlContent += `
                        <div style="margin: 15px 0; text-align: center;">
                            <img src="${components.image.src}" 
                                 alt="${components.image.alt || 'Components diagram'}"
                                 style="max-width: 100%; height: auto; border-radius: 6px;"
                                 onerror="this.style.display='none'">
                    `;
                    if (components.image.caption) {
                        htmlContent += `
                            <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                ${components.image.caption}
                            </div>
                        `;
                    }
                    htmlContent += `</div>`;
                }
                
                htmlContent += `</div>`;

                if (section.classifications) {
                    htmlContent += `<h5 style="color: var(--primary); margin: 20px 0 10px 0;">Classifications:</h5>`;
                    section.classifications.forEach(classification => {
                        htmlContent += `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                                <h6 style="color: var(--primary-dark); margin-bottom: 8px;">${classification.type}: ${classification.value}</h6>
                                <p style="margin-bottom: 8px;"><strong>Characteristics:</strong> ${classification.characteristics.join(', ')}</p>
                                <p style="margin-bottom: 8px;"><strong>Behavior:</strong> ${classification.behavior}</p>
                        `;
                        
                        if (classification.example) {
                            htmlContent += `
                                <div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                    <strong>Example - ${classification.example.process}:</strong><br>
                            `;
                            
                            if (classification.example.equation) {
                                htmlContent += `<div style="font-family: 'Cambria Math', serif; margin: 5px 0;">${classification.example.equation}</div>`;
                            }
                            
                            if (classification.example.value) {
                                htmlContent += `<div><strong>Value:</strong> ${classification.example.value}</div>`;
                            }
                            
                            htmlContent += `<div style="margin-top: 5px;">${classification.example.explanation}</div>`;
                            
                            if (classification.example.image) {
                                htmlContent += `
                                    <div style="margin-top: 8px; text-align: center;">
                                        <img src="${classification.example.image.src}" 
                                             alt="${classification.example.image.alt || 'Example diagram'}"
                                             style="max-width: 90%; height: auto; border-radius: 4px;"
                                             onerror="this.style.display='none'">
                                `;
                                if (classification.example.image.caption) {
                                    htmlContent += `
                                        <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                            ${classification.example.image.caption}
                                        </div>
                                    `;
                                }
                                htmlContent += `</div>`;
                            }
                            
                            htmlContent += `</div>`;
                        }
                        
                        if (classification.note) {
                            htmlContent += `<div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.9em;"><strong>Note:</strong> ${classification.note}</div>`;
                        }
                        
                        htmlContent += `</div>`;
                    });
                }
            }

            // ===== CATEGORIES/PROCESS TYPES FOURTH (Types/Variations) =====
            if (section.categories) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Categories:</h4>`;
                section.categories.forEach(category => {
                    htmlContent += `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--light-gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">${category.type}</h5>
                    `;
                    
                    if (category.image) {
                        htmlContent += `
                            <div style="margin-bottom: 15px; text-align: center;">
                                <img src="${category.image.src}" 
                                     alt="${category.image.alt || 'Category diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px;"
                                     onerror="this.style.display='none'">
                        `;
                        if (category.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${category.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `
                            <p style="margin-bottom: 10px;"><strong>Description:</strong> ${category.description}</p>
                    `;
                    
                    if (category.detailed_mechanism) {
                        htmlContent += `<p style="margin-bottom: 10px;"><strong>Mechanism:</strong> ${category.detailed_mechanism}</p>`;
                    }
                    
                    if (category.examples && category.examples.length > 0) {
                        htmlContent += `
                            <div style="margin-top: 15px;">
                                <strong>Examples:</strong>
                                ${category.examples.map(example => {
                                    let exampleHtml = `
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 8px;">
                                            <strong>${example.process}:</strong> ${example.explanation}
                                    `;
                                    
                                    if (example.image) {
                                        exampleHtml += `
                                            <div style="margin-top: 8px; text-align: center;">
                                                <img src="${example.image.src}" 
                                                     alt="${example.image.alt || 'Example diagram'}"
                                                     style="max-width: 90%; height: auto; border-radius: 4px;"
                                                     onerror="this.style.display='none'">
                                        `;
                                        if (example.image.caption) {
                                            exampleHtml += `
                                                <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                                    ${example.image.caption}
                                                </div>
                                            `;
                                        }
                                        exampleHtml += `</div>`;
                                    }
                                    
                                    exampleHtml += `</div>`;
                                    return exampleHtml;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    htmlContent += `</div>`;
                });
            }

            // ===== WORKED EXAMPLES FIFTH (Application of theory) =====
            if (section.worked_examples) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Worked Examples:</h4>`;
                section.worked_examples.forEach((example, exampleIndex) => {
                    htmlContent += `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid var(--light-gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem;">
                                <i class="fas fa-calculator" style="margin-right: 8px;"></i>
                                Example ${exampleIndex + 1}: ${example.title}
                            </h5>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <strong style="color: var(--primary-dark);">Problem:</strong> ${example.problem}
                            </div>
                    `;

                    // Step by step solution
                    if (example.step_by_step && example.step_by_step.length > 0) {
                        htmlContent += `<h6 style="color: var(--primary); margin: 15px 0 10px 0;">Step-by-Step Solution:</h6>`;
                        example.step_by_step.forEach((step, stepIndex) => {
                            htmlContent += `
                                <div style="background: #f0f7ff; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary-light);">
                                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                                        <div style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; flex-shrink: 0;">
                                            ${stepIndex + 1}
                                        </div>
                                        <div style="flex: 1;">
                                            <strong>${step.step}:</strong> ${step.explanation}
                                            ${step.calculation ? `
                                                <div style="background: white; padding: 8px; border-radius: 4px; margin-top: 5px; font-family: 'Courier New', monospace;">
                                                    ${step.calculation}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // Final answer
                    if (example.final_answer) {
                        htmlContent += `
                            <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #4caf50;">
                                <strong style="color: #2e7d32;">Final Answer:</strong> ${example.final_answer}
                            </div>
                        `;
                    }

                    // Concept applied
                    if (example.concept_applied) {
                        htmlContent += `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffc107;">
                                <strong style="color: #856404;">Concept Applied:</strong> ${example.concept_applied}
                            </div>
                        `;
                    }

                    // Example image
                    if (example.image) {
                        htmlContent += `
                            <div style="margin: 15px 0; text-align: center;">
                                <img src="${example.image.src}" 
                                     alt="${example.image.alt || 'Example diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px; border: 1px solid var(--light-gray);"
                                     onerror="this.style.display='none'">
                        `;
                        if (example.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${example.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }

                    htmlContent += `</div>`;
                });
            }

            // ===== STRUCTURE/FUNCTION SIXTH (Big picture) =====
            if (section.concept) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">${section.concept} - ${section.role || 'Structure and Function'}</h4>`;
                
                if (section.structure) {
                    htmlContent += `<h5 style="color: var(--primary); margin: 15px 0 10px 0;">Structure:</h5>`;
                    section.structure.components.forEach(component => {
                        htmlContent += `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>${component.part}:</strong> ${component.composition}
                        `;
                        
                        if (component.function) {
                            htmlContent += `<div style="margin-top: 5px;"><em>Function:</em> ${component.function}</div>`;
                        }
                        
                        if (component.key_feature) {
                            htmlContent += `<div style="margin-top: 5px;"><strong>Key Feature:</strong> ${component.key_feature}</div>`;
                        }
                        
                        if (component.image) {
                            htmlContent += `
                                <div style="margin-top: 8px; text-align: center;">
                                    <img src="${component.image.src}" 
                                         alt="${component.image.alt || 'Component diagram'}"
                                         style="max-width: 90%; height: auto; border-radius: 4px;"
                                         onerror="this.style.display='none'">
                            `;
                            if (component.image.caption) {
                                htmlContent += `
                                    <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                        ${component.image.caption}
                                    </div>
                                `;
                            }
                            htmlContent += `</div>`;
                        }
                        
                        htmlContent += `</div>`;
                    });
                }

                if (section.function) {
                    htmlContent += `<h5 style="color: var(--primary); margin: 15px 0 10px 0;">Function:</h5>`;
                    const func = section.function;
                    htmlContent += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    `;
                    
                    if (func.operation) {
                        htmlContent += `<p><strong>Operation:</strong> ${func.operation}</p>`;
                    }
                    
                    if (func.energy) {
                        htmlContent += `<p><strong>Energy:</strong> ${func.energy}</p>`;
                    }
                    
                    if (func.mechanism) {
                        htmlContent += `<p><strong>Mechanism:</strong> ${func.mechanism}</p>`;
                    }
                    
                    if (func.image) {
                        htmlContent += `
                            <div style="margin: 12px 0; text-align: center;">
                                <img src="${func.image.src}" 
                                     alt="${func.image.alt || 'Function diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px;"
                                     onerror="this.style.display='none'">
                        `;
                        if (func.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${func.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    if (func.cycle) {
                        htmlContent += `
                            <div style="margin-top: 15px;">
                                <strong>Cycle:</strong>
                                ${func.cycle.map(cycle => {
                                    let cycleHtml = `
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 8px;">
                                            <strong>${cycle.process}:</strong> ${cycle.operation}<br>
                                            <em>Purpose:</em> ${cycle.purpose}
                                    `;
                                    
                                    if (cycle.image) {
                                        cycleHtml += `
                                            <div style="margin-top: 8px; text-align: center;">
                                                <img src="${cycle.image.src}" 
                                                     alt="${cycle.image.alt || 'Cycle diagram'}"
                                                     style="max-width: 90%; height: auto; border-radius: 4px;"
                                                     onerror="this.style.display='none'">
                                        `;
                                        if (cycle.image.caption) {
                                            cycleHtml += `
                                                <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                                    ${cycle.image.caption}
                                                </div>
                                            `;
                                        }
                                        cycleHtml += `</div>`;
                                    }
                                    
                                    cycleHtml += `</div>`;
                                    return cycleHtml;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    htmlContent += `</div>`;
                }
            }

            // ===== PROCESS FLOW SEVENTH (Step-by-step execution) =====
            if (section.process_flow) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Process Flow:</h4>`;
                if (section.introduction) {
                    htmlContent += `<p style="margin-bottom: 15px;">${section.introduction}</p>`;
                }
                
                section.process_flow.forEach(step => {
                    htmlContent += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary-light);">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="background: var(--primary); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                    ${step.step}
                                </div>
                                <div style="flex: 1;">
                                    <h6 style="color: var(--primary-dark); margin-bottom: 5px; font-size: 1.1rem;">${step.process}</h6>
                                    <p style="margin-bottom: 5px;">${step.description}</p>
                    `;
                    
                    if (step.mechanism) {
                        htmlContent += `<p style="margin-bottom: 5px;"><em>Mechanism:</em> ${step.mechanism}</p>`;
                    }
                    
                    if (step.result) {
                        htmlContent += `<p style="margin-bottom: 5px;"><strong>Result:</strong> ${step.result}</p>`;
                    }
                    
                    if (step.applications) {
                        htmlContent += `<p style="margin-bottom: 5px;"><strong>Applications:</strong> ${step.applications.join(', ')}</p>`;
                    }
                    
                    if (step.organization) {
                        htmlContent += `<p style="margin-bottom: 5px;"><strong>Organization:</strong> ${step.organization}</p>`;
                    }
                    
                    if (step.image) {
                        htmlContent += `
                            <div style="margin-top: 10px; text-align: center;">
                                <img src="${step.image.src}" 
                                     alt="${step.image.alt || 'Step diagram'}"
                                     style="max-width: 90%; height: auto; border-radius: 4px; border: 1px solid var(--light-gray);"
                                     onerror="this.style.display='none'">
                        `;
                        if (step.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                    ${step.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // ===== PROCESS TYPES EIGHTH (Variations/Advanced) =====
            if (section.process_types) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Process Types:</h4>`;
                htmlContent += `<p style="margin-bottom: 15px;"><strong>Definition:</strong> ${section.definition}</p>`;
                
                section.process_types.forEach(process => {
                    htmlContent += `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--light-gray);">
                            <h5 style="color: var(--primary); margin-bottom: 10px;">${process.type}</h5>
                    `;
                    
                    if (process.image) {
                        htmlContent += `
                            <div style="margin-bottom: 15px; text-align: center;">
                                <img src="${process.image.src}" 
                                     alt="${process.image.alt || 'Process diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px;"
                                     onerror="this.style.display='none'">
                        `;
                        if (process.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${process.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `
                            <p><strong>Energy Profile:</strong> ${process.energy_profile} (${process.direction})</p>
                            <p><strong>Function:</strong> ${process.function}</p>
                    `;
                    
                    if (process.goals) {
                        htmlContent += `<p><strong>Goals:</strong> ${process.goals.join('; ')}</p>`;
                    }
                    
                    if (process.energy_source) {
                        htmlContent += `<p><strong>Energy Source:</strong> ${process.energy_source}</p>`;
                    }
                    
                    if (process.primary_example) {
                        htmlContent += `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <strong>Primary Example - ${process.primary_example.process}:</strong><br>
                                ${process.primary_example.explanation}
                        `;
                        
                        if (process.primary_example.image) {
                            htmlContent += `
                                <div style="margin-top: 8px; text-align: center;">
                                    <img src="${process.primary_example.image.src}" 
                                         alt="${process.primary_example.image.alt || 'Primary example diagram'}"
                                         style="max-width: 90%; height: auto; border-radius: 4px;"
                                         onerror="this.style.display='none'">
                            `;
                            if (process.primary_example.image.caption) {
                                htmlContent += `
                                    <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                        ${process.primary_example.image.caption}
                                    </div>
                                `;
                            }
                            htmlContent += `</div>`;
                        }
                        
                        htmlContent += `</div>`;
                    }
                    
                    if (process.examples) {
                        htmlContent += `
                            <div style="margin-top: 10px;">
                                <strong>Examples:</strong>
                                ${process.examples.map(example => {
                                    let exampleHtml = `
                                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-top: 5px;">
                                            <strong>${example.process}:</strong> ${example.explanation}
                                    `;
                                    
                                    if (example.image) {
                                        exampleHtml += `
                                            <div style="margin-top: 6px; text-align: center;">
                                                <img src="${example.image.src}" 
                                                     alt="${example.image.alt || 'Example diagram'}"
                                                     style="max-width: 85%; height: auto; border-radius: 3px;"
                                                     onerror="this.style.display='none'">
                                        `;
                                        if (example.image.caption) {
                                            exampleHtml += `
                                                <div style="margin-top: 3px; font-style: italic; color: var(--gray); font-size: 0.75rem;">
                                                    ${example.image.caption}
                                                </div>
                                            `;
                                        }
                                        exampleHtml += `</div>`;
                                    }
                                    
                                    exampleHtml += `</div>`;
                                    return exampleHtml;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    htmlContent += `</div>`;
                });
                
                if (section.relationship) {
                    htmlContent += `
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                            <strong>Relationship:</strong> ${section.relationship}
                        </div>
                    `;
                }
            }

            // ===== MECHANISMS NINTH (Underlying mechanisms) =====
            if (section.purpose) {
                htmlContent += `<h4 style="color: var(--primary-dark); margin: 25px 0 15px 0;">Mechanisms:</h4>`;
                htmlContent += `<p style="margin-bottom: 15px;"><strong>Purpose:</strong> ${section.purpose}</p>`;
                
                if (section.activation) {
                    htmlContent += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="color: var(--primary); margin-bottom: 10px;">Activation</h5>
                            <p><strong>Definition:</strong> ${section.activation.definition}</p>
                            <p><strong>Effect:</strong> ${section.activation.effect}</p>
                    `;
                    
                    if (section.activation.image) {
                        htmlContent += `
                            <div style="margin-top: 12px; text-align: center;">
                                <img src="${section.activation.image.src}" 
                                     alt="${section.activation.image.alt || 'Activation diagram'}"
                                     style="max-width: 100%; height: auto; border-radius: 6px;"
                                     onerror="this.style.display='none'">
                        `;
                        if (section.activation.image.caption) {
                            htmlContent += `
                                <div style="margin-top: 6px; font-style: italic; color: var(--gray); font-size: 0.85rem;">
                                    ${section.activation.image.caption}
                                </div>
                            `;
                        }
                        htmlContent += `</div>`;
                    }
                    
                    htmlContent += `</div>`;
                }

                if (section.key_properties) {
                    htmlContent += `<h5 style="color: var(--primary); margin: 15px 0 10px 0;">Key Properties:</h5>`;
                    section.key_properties.forEach(property => {
                        htmlContent += `
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                <strong>${property.property}:</strong> ${property.explanation}
                        `;
                        
                        if (property.image) {
                            htmlContent += `
                                <div style="margin-top: 8px; text-align: center;">
                                    <img src="${property.image.src}" 
                                         alt="${property.image.alt || 'Property diagram'}"
                                         style="max-width: 90%; height: auto; border-radius: 4px;"
                                         onerror="this.style.display='none'">
                            `;
                            if (property.image.caption) {
                                htmlContent += `
                                    <div style="margin-top: 4px; font-style: italic; color: var(--gray); font-size: 0.8rem;">
                                        ${property.image.caption}
                                    </div>
                                `;
                            }
                            htmlContent += `</div>`;
                        }
                        
                        htmlContent += `</div>`;
                    });
                }
            }

            htmlContent += `</div>`; // Close content-section
        });
    }

    htmlContent += `</div>`; // Close section-content

    // Add key terms section
    if (sectionData.key_terms && sectionData.key_terms.length > 0) {
        htmlContent += `
            <div class="key-points">
                <h3><i class="fas fa-key"></i> Key Terms</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${sectionData.key_terms.map(term => `
                        <span style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem;">
                            ${term}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Add summary
    if (sectionData.summary) {
        htmlContent += `
            <div class="vocabulary">
                <h3><i class="fas fa-file-alt"></i> Summary</h3>
                <div class="vocab-grid">
                    <div class="vocab-item" style="font-style: italic; line-height: 1.6;">
                        ${sectionData.summary}
                    </div>
                </div>
            </div>
        `;
    }

    htmlContent += `
            <div class="section-navigation">
                <button class="btn btn-outline" onclick="loadTextbookContent()">
                    <i class="fas fa-list"></i> Back to Sections
                </button>
            </div>
        </div>
    `;

    contentArea.innerHTML = htmlContent;
    
    // Render MathJax for the content
    setTimeout(() => {
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise([contentArea]).catch(err => {
                console.warn('MathJax typeset failed:', err);
            });
        }
    }, 100);
}

        
// Add math-specific rendering
function renderMathStep(step, equation, explanation = '') {
    return `
        <div class="math-step">
            <div class="step-label">${step}</div>
            <div class="eq eq-center">${equation}</div>
            ${explanation ? `<div class="step-explanation">${explanation}</div>` : ''}
        </div>
    `;
}

        
function renderTextbookContent(content) {
    if (Array.isArray(content)) {
        return content.map(paragraph => `
            <div class="content-paragraph">
                ${renderMarkdown(paragraph)}
            </div>
        `).join('');
    }
    return renderMarkdown(content);
}

// Load topics list from index.json
async function loadPastQuestionsTopics() {
    try {
        const courseTitle = document.getElementById('detail-course-title').textContent;
        const indexPath = `past-questions/${currentCourseId}/index.json`;
        
        console.log('📚 Loading past questions index from:', indexPath);
        
        const response = await fetch(indexPath);
        if (!response.ok) {
            throw new Error(`Failed to load index: ${response.status}`);
        }
        
        const indexData = await response.json();
        displayPastQuestionsTopics(indexData);
        
    } catch (error) {
        console.error('❌ Error loading past questions topics:', error);
        showNoPastQuestionsMessage();
    }
}

// Display topics as clickable cards
function displayPastQuestionsTopics(indexData) {
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${indexData.course} - Past Questions & Answers</h3>
                <button class="tool-back" onclick="closePastQuestions()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            
            <div style="padding: 0 0 20px 0;">
                <p style="color: var(--gray); font-size: 1.1rem; margin-bottom: 30px;">
                    ${indexData.description || 'Select a topic to view past exam questions with detailed step-by-step solutions.'}
                </p>
                
                <div class="courses-grid">
                    ${indexData.topics.map(topic => `
                        <div class="course-card" onclick="loadPastQuestionsTopic('${topic.id}', '${topic.name}')">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div class="tool-icon" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                    <i class="fas ${topic.icon || 'fa-file-alt'}"></i>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 5px 0;">${topic.name}</h3>
                                    <p style="margin: 0; color: var(--gray); font-size: 0.9rem;">${topic.description || ''}</p>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid var(--light-gray);">
                                <div style="display: flex; gap: 15px; font-size: 0.9rem; color: var(--gray);">
                                    <span><i class="fas fa-question-circle"></i> ${topic.questionCount || 0} Problems</span>
                                    ${topic.difficulty ? `
                                        <span class="difficulty-badge ${topic.difficulty}">
                                            ${topic.difficulty}
                                        </span>
                                    ` : ''}
                                </div>
                                <button class="btn" style="padding: 10px 20px;">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

// Load specific topic's problems and solutions
async function loadPastQuestionsTopic(topicId, topicName) {
    try {
        const resourceContent = document.getElementById('resource-content');
        
        // Show loading state
        resourceContent.innerHTML = `
            <div class="tool-interface active">
                <div class="tool-header">
                    <h3 class="section-title">Loading ${topicName}...</h3>
                    <button class="tool-back" onclick="loadPastQuestionsTopics()">
                        <i class="fas fa-arrow-left"></i> Back to Topics
                    </button>
                </div>
                <div style="text-align: center; padding: 60px 20px;">
                    <div class="tool-icon" style="margin: 0 auto 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Problems</h4>
                    <p style="color: var(--gray);">Preparing ${topicName} questions and solutions...</p>
                </div>
            </div>
        `;
        
        const topicPath = `past-questions/${currentCourseId}/${topicId}.json`;
        console.log('📖 Loading topic from:', topicPath);
        
        const response = await fetch(topicPath);
        if (!response.ok) {
            throw new Error(`Failed to load topic: ${response.status}`);
        }
        
        const topicData = await response.json();
        displayPastQuestionsSolutions(topicData);
        
    } catch (error) {
        console.error('❌ Error loading topic:', error);
        showPastQuestionsError(topicName);
    }
}

// Display problems and solutions
function displayPastQuestionsSolutions(topicData) {
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${topicData.course} - ${topicData.topic}</h3>
                <button class="tool-back" onclick="loadPastQuestionsTopics()">
                    <i class="fas fa-arrow-left"></i> Back to Topics
                </button>
            </div>
            
            <div class="textbook-content" style="height: auto;">
                <div class="textbook-section">
                    <div class="section-header">
                        <h2>${topicData.topic}</h2>
                        <p class="section-subtitle">Past Exam Questions with Detailed Solutions</p>
                    </div>
                    
                    <div class="section-content">
                        ${topicData.problems.map((problem, index) => `
                            <div class="content-section" style="margin-bottom: 50px; padding: 30px; background: white; border-radius: var(--border-radius-lg); box-shadow: var(--shadow); border-left: 4px solid var(--primary);">
                                
                                <!-- Problem Number Header -->
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--light-bg);">
                                    <div style="background: var(--primary); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; flex-shrink: 0;">
                                        ${problem.number}
                                    </div>
                                    <h3 style="color: var(--primary); margin: 0; font-size: 1.4rem;">
                                        Problem ${problem.number}
                                    </h3>
                                </div>
                                
                                <!-- Problem Statement -->
                                <div style="background: #f8fbff; padding: 20px; border-radius: var(--border-radius-sm); margin-bottom: 20px; border-left: 4px solid var(--primary-light);">
                                    <h4 style="color: var(--primary-dark); margin-bottom: 10px; font-size: 1.1rem;">
                                        <i class="fas fa-question-circle"></i> Problem Statement
                                    </h4>
                                    <div style="line-height: 1.8; font-size: 1.05rem;">
                                        ${renderMarkdown(problem.problem)}
                                    </div>
                                </div>
                                
                                <!-- Image (if present) -->
                                ${problem.image ? `
                                    <div style="margin: 25px 0; text-align: center; background: white; padding: 20px; border-radius: var(--border-radius-sm); border: 1px solid var(--light-gray);">
                                        <img src="${problem.image}" 
                                             alt="Problem ${problem.number} diagram" 
                                             style="max-width: 100%; height: auto; border-radius: 8px;"
                                             onerror="this.parentElement.style.display='none'; console.warn('Image failed to load: ${problem.image}')">
                                        <div style="margin-top: 10px; font-style: italic; color: var(--gray); font-size: 0.9rem;">
                                            Figure ${problem.number}: Problem diagram
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Solution Section -->
                                <div style="margin-top: 30px;">
                                    <h4 style="color: var(--success); margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-lightbulb"></i> Solution
                                    </h4>
                                    
                                    <!-- Step-by-Step Solution -->
                                    ${problem.step_by_step && problem.step_by_step.length > 0 ? `
                                        <div style="margin-bottom: 20px;">
                                            ${problem.step_by_step.map((step, stepIndex) => `
                                                <div style="background: #f0f7ff; padding: 15px; border-radius: var(--border-radius-sm); margin-bottom: 12px; border-left: 3px solid var(--primary-light);">
                                                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                                                        <div style="background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0;">
                                                            ${stepIndex + 1}
                                                        </div>
                                                        <div style="flex: 1;">
                                                            <strong style="color: var(--primary-dark);">${step.step}:</strong>
                                                            <div style="margin-top: 5px; line-height: 1.7;">
                                                                ${renderMarkdown(step.explanation)}
                                                            </div>
                                                            ${step.calculation ? `
                                                                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 10px; font-family: 'Courier New', monospace; border: 1px solid var(--light-gray);">
                                                                    ${renderMarkdown(step.calculation)}
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Final Answer -->
                                    ${problem.final_answer ? `
                                        <div style="background: #e8f5e8; padding: 20px; border-radius: var(--border-radius-sm); border-left: 4px solid var(--success); margin-top: 20px;">
                                            <h5 style="color: var(--success); margin-bottom: 10px; font-size: 1.1rem;">
                                                <i class="fas fa-check-circle"></i> Final Answer
                                            </h5>
                                            <div style="font-size: 1.1rem; font-weight: 600; line-height: 1.6;">
                                                ${renderMarkdown(problem.final_answer)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Navigation Footer -->
                    <div class="section-navigation">
                        <button class="btn btn-outline" onclick="loadPastQuestionsTopics()">
                            <i class="fas fa-list"></i> Back to Topics
                        </button>
                        <button class="btn btn-outline" onclick="closePastQuestions()">
                            <i class="fas fa-home"></i> Back to Course
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Render MathJax after content loads
    setTimeout(() => {
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise([document.getElementById('resource-content')]).catch(err => {
                console.warn('MathJax typeset failed:', err);
            });
        }
    }, 100);
}

// Error handling functions
function showNoPastQuestionsMessage() {
    const resourceContent = document.getElementById('resource-content');
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">Past Questions & Answers</h3>
                <button class="tool-back" onclick="closePastQuestions()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            <div style="text-align: center; padding: 60px 20px;">
                <div class="tool-icon" style="background: var(--warning); margin: 0 auto 20px;">
                    <i class="fas fa-archive"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">No Past Questions Available</h4>
                <p style="color: var(--gray); margin-bottom: 30px;">
                    Past questions for this course are coming soon! Check back later.
                </p>
                <button class="btn" onclick="closePastQuestions()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
        </div>
    `;
}

function showPastQuestionsError(topicName) {
    const resourceContent = document.getElementById('resource-content');
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${topicName || 'Past Questions'}</h3>
                <button class="tool-back" onclick="loadPastQuestionsTopics()">
                    <i class="fas fa-arrow-left"></i> Back to Topics
                </button>
            </div>
            <div style="text-align: center; padding: 60px 20px;">
                <div class="tool-icon" style="background: var(--accent); margin: 0 auto 20px;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Error</h4>
                <p style="color: var(--gray); margin-bottom: 30px;">
                    There was an error loading the questions. Please try again later.
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn" onclick="loadPastQuestionsTopics()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="btn btn-outline" onclick="closePastQuestions()">
                        <i class="fas fa-home"></i> Back to Course
                    </button>
                </div>
            </div>
        </div>
    `;
}

function closePastQuestions() {
    const resourceContent = document.getElementById('resource-content');
    resourceContent.innerHTML = '';
}

async function loadTopicQuizzes() {
    const topicList = document.getElementById('topic-list');
    const units = await getCourseUnits(currentCourseId);
    
    if (!units || !Array.isArray(units)) {
        console.error('No units found for course:', currentCourseId);
        topicList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--gray);">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h4>No quizzes available</h4>
                <p>Quiz content for this course is coming soon!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // ✅ Load from config instead of hardcoded array
    const usesSemesterStructure = categoryConfig?.courseStructures?.semester?.includes(currentCourseId) || false;
    
    if (usesSemesterStructure) {
        // If it's a semester course, check the actual structure
        console.log('Units structure for semester course:', units);
        
        // Check if the first item has a 'units' property (nested structure)
        const hasNestedUnits = units.length > 0 && units[0].units;
        
        if (hasNestedUnits) {
            // Enhanced semester structure (nested: semester -> units)
            units.forEach(semester => {
                html += `
                    <div class="semester-section" style="margin-bottom: 40px;">
                        <h3 style="color: var(--primary); font-size: 1.4rem; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 15px;">
                            ${semester.name}
                        </h3>
                        ${semester.units.map(unit => `
                            <div class="quiz-unit-container">
                                <div class="quiz-unit-title">${unit.name}</div>
                                ${unit.resources ? `
                                <div class="unit-resources" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                                    ${unit.resources.map(resource => `
                                        <span class="resource-tag" style="padding: 5px 12px; background: var(--light-bg); border-radius: 15px; font-size: 0.9rem; color: var(--primary);">
                                            ${resource}
                                        </span>
                                    `).join('')}
                                </div>
                                ` : ''}
                                <div class="quiz-difficulty-grid">
                                    ${unit.quizzes.map(quiz => `
                                        <div class="quiz-box ${quiz.difficulty}" onclick="startTopicQuiz('${unit.id}', ${quiz.num}, '${quiz.difficulty}')">
                                            Quiz ${quiz.num}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
        } else {
            // Standard structure even for semester courses
            html = units.map(unit => `
                <div class="quiz-unit-container">
                    <div class="quiz-unit-title">${unit.name}</div>
                    <div class="quiz-difficulty-grid">
                        ${unit.quizzes.map(quiz => `
                            <div class="quiz-box ${quiz.difficulty}" onclick="startTopicQuiz('${unit.id}', ${quiz.num}, '${quiz.difficulty}')">
                                Quiz ${quiz.num}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
    } else {
        // Standard unit structure for non-semester courses
        html = units.map(unit => `
            <div class="quiz-unit-container">
                <div class="quiz-unit-title">${unit.name}</div>
                <div class="quiz-difficulty-grid">
                    ${unit.quizzes.map(quiz => `
                        <div class="quiz-box ${quiz.difficulty}" onclick="startTopicQuiz('${unit.id}', ${quiz.num}, '${quiz.difficulty}')">
                            Quiz ${quiz.num}
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    
    topicList.innerHTML = html;
}

let quizUnitsCache = {};



// Load quiz units for a specific course
async function loadQuizUnitsData(courseId) {
    if (quizUnitsCache[courseId]) {
        return quizUnitsCache[courseId];
    }
    
    try {
        const response = await fetch(`./quizUnits/${courseId}.json`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Get the raw text first to check for BOM
        const text = await response.text();
        
        // Remove BOM if present
        const cleanText = text.replace(/^\uFEFF/, '');
        
        // Try to parse the JSON
        let unitsData;
        try {
            unitsData = JSON.parse(cleanText);
        } catch (parseError) {
            console.error(`❌ JSON parse error for ${courseId}:`, parseError);
            console.error('Raw text (first 500 chars):', cleanText.substring(0, 500));
            
            // Return fallback data
            return getFallbackUnits(courseId);
        }
        
        // Validate the parsed data
        if (!Array.isArray(unitsData)) {
            console.warn(`⚠️ Expected array for ${courseId}, got:`, typeof unitsData);
            unitsData = [];
        }
        
        const unitsWithQuizzes = unitsData.map(unit => ({
            ...unit,
            quizzes: generateQuizzes(unit.quizCount || 12)
        }));
        
        quizUnitsCache[courseId] = unitsWithQuizzes;
        return unitsWithQuizzes;
        
    } catch (error) {
        console.error(`❌ Error loading quiz units for ${courseId}:`, error);
        return getFallbackUnits(courseId);
    }
}

// Fallback function
function getFallbackUnits(courseId) {
    return [
        {
            id: 'unit-1',
            name: `${courseId.toUpperCase()} - Unit 1`,
            quizCount: 12,
            quizzes: generateQuizzes(12)
        }
    ];
}

// REFACTORED: Get course units (replaces switch statement)
async function getCourseUnits(courseId) {
    const units = await loadQuizUnitsData(courseId);
    
    // Fallback if no units loaded
    if (!units || units.length === 0) {
        return [
            {
                id: 'placeholder-unit',
                name: 'Course Content Coming Soon',
                quizzes: [
                    { num: 1, difficulty: 'easy' },
                    { num: 2, difficulty: 'medium' },
                    { num: 3, difficulty: 'challenging' }
                ]
            }
        ];
    }
    
    return units;
}

// Helper function to generate quiz metadata
function generateQuizzes(count) {
    const difficulties = ['easy', 'medium', 'hard'];
    const quizzes = [];
    
    for (let i = 1; i <= count; i++) {
        quizzes.push({
            num: i,
            difficulty: difficulties[Math.floor((i - 1) / (count / 3))] || 'medium'
        });
    }
    
    return quizzes;
}

// Export functions globally
window.loadQuizUnitsData = loadQuizUnitsData;
window.getCourseUnits = getCourseUnits;
window.generateQuizzes = generateQuizzes;

function generateQuizzes(count) {
    const quizzes = [];
    for (let i = 1; i <= count; i++) {
        let difficulty = 'medium';
        if (i <= 4) difficulty = 'easy';
        if (i >= 9) difficulty = 'challenging';
        
        quizzes.push({ num: i, difficulty: difficulty });
    }
    return quizzes;
}

// GLOBAL QUIZ STATE - ADD THIS AT THE TOP OF YOUR SCRIPT
window.quizState = {
    currentQuestions: [],
    userAnswers: [],
    currentQuestionIndex: 0,
    isQuizComplete: false,
    showResults: false,
    quizTitle: '',
    quizDifficulty: ''
};

async function startTopicQuiz(unitId, quizNumber, difficulty) {
    try {
        // Show loading state
        const resourceContent = document.getElementById('resource-content');
        resourceContent.innerHTML = `
            <div class="tool-interface active">
                <div class="tool-header">
                    <h3 class="section-title">Loading Quiz...</h3>
                    <button class="tool-back" onclick="openResource('topic-quiz', this)">
                        <i class="fas fa-arrow-left"></i> Back to Topics
                    </button>
                </div>
                <div style="text-align: center; padding: 60px 20px;">
                    <div class="tool-icon" style="margin: 0 auto 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Quiz ${quizNumber}</h4>
                    <p style="color: var(--gray);">Preparing ${difficulty} quiz...</p>
                </div>
            </div>
        `;

        // Determine the quiz path
        const quizPath = getQuizPath(currentCourseId, unitId, quizNumber);
        
        if (quizPath) {
            console.log('🔍 Looking for quiz at:', quizPath);
            const quizData = await loadQuizData(quizPath);
            
            if (quizData && quizData.questions && quizData.questions.length > 0) {
                console.log('✅ Successfully loaded quiz:', quizData.title);
                console.log('📊 Questions found:', quizData.questions.length);
                
                // Use the processed data directly
                displayQuizWithData(quizData, unitId, quizNumber, difficulty);
                return;
            } else {
                console.log('❌ No valid quiz data found at:', quizPath);
            }
        } else {
            console.log('❌ No quiz path generated');
        }

        // Fallback to default quiz
        console.log('🔄 Using default quiz as fallback');
        displayDefaultTopicQuiz(unitId, quizNumber, difficulty);
        
    } catch (error) {
        console.error('❌ Error starting topic quiz:', error);
        // Still show the default quiz even if there's an error
        displayDefaultTopicQuiz(unitId, quizNumber, difficulty);
    }
}

function getQuizPath(courseId, unitId, quizNumber) {
    if (!courseId || !unitId) return null;
    const courseFolder = courseId.toLowerCase().replace(/\s+/g, '-');
    
    const fileUnitId = unitId.replace('-', '');
    
    return `quizzes/${courseFolder}/${fileUnitId}_quiz${quizNumber}.json`;
}

// SINGLE CORRECTED displayQuizWithData function
function displayQuizWithData(quizData, unitId, quizNumber, difficulty) {
    console.log('📝 Starting quiz with data:', quizData);
    
    // Process questions to shuffle options while preserving correct answers
    const processedQuestions = (quizData.questions || []).map(question => {
        // Create array of options with their original indices
        const optionsWithIndices = question.options.map((option, index) => ({
            text: option,
            originalIndex: index
        }));
        
        // Shuffle the options
        const shuffledOptions = shuffleArray(optionsWithIndices);
        
        // VERSATILE: Handle both single answers and multiple response answers
        let correctAnswerIndices = [];

        if (question.type === 'multiple_response' && Array.isArray(question.answer)) {
            // Multiple response: Convert array of letters to indices ["A", "D"] → [0, 3]
            correctAnswerIndices = question.answer.map(letter => {
                return typeof letter === 'string' ? letter.charCodeAt(0) - 65 : -1;
            }).filter(index => index >= 0);
        } else {
            // Single answer: Convert single letter to array for consistency "C" → [2]
            const answerLetter = question.answer;
            if (answerLetter && typeof answerLetter === 'string') {
                correctAnswerIndices = [answerLetter.charCodeAt(0) - 65];
            }
        }

        // Find new indices in shuffled array for ALL correct answers
        const newCorrectIndices = correctAnswerIndices.map(originalIndex => {
            return shuffledOptions.findIndex(opt => opt.originalIndex === originalIndex);
        }).filter(index => index >= 0);
        
        return {
            ...question,
            options: shuffledOptions.map(opt => opt.text),
            originalOptions: question.options,
            correctAnswerIndices: newCorrectIndices,
            originalCorrectIndices: correctAnswerIndices,
            isMultipleResponse: question.type === 'multiple_response'
        };
    });
    
    // PROPERLY initialize quiz state
    window.quizState = {
        currentQuestions: processedQuestions,
        userAnswers: new Array(processedQuestions.length).fill(null),
        currentQuestionIndex: 0,
        isQuizComplete: false,
        showResults: false,
        quizTitle: quizData.title || `Quiz ${quizNumber}`,
        quizDifficulty: difficulty
    };
    
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${window.quizState.quizTitle} - ${difficulty}</h3>
                <button class="tool-back" onclick="openResource('topic-quiz', this)">
                    <i class="fas fa-arrow-left"></i> Back to Topics
                </button>
            </div>
            
            <div class="quiz-container">
                <div class="quiz-info" style="background: var(--light-bg); padding: 20px; border-radius: var(--border-radius-sm); margin-bottom: 25px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">${window.quizState.quizTitle}</h4>
                    <p style="color: var(--gray); margin-bottom: 0;">${quizData.subtitle || quizData.description || 'Test your knowledge on this topic.'}</p>
                    ${quizData.duration ? `<div style="margin-top: 10px;"><strong>Duration:</strong> ${quizData.duration} minutes</div>` : ''}
                    <div style="margin-top: 10px; font-size: 0.9rem; color: var(--primary);">
                        <i class="fas fa-random"></i> Options are randomized for each attempt
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9rem; color: var(--warning);">
                        <strong>Questions:</strong> ${window.quizState.currentQuestions.length}
                    </div>
                </div>
                
                <div id="quiz-questions-container">
                    <!-- Questions will be loaded here -->
                </div>
                
                <div class="quiz-actions" style="margin-top: 30px; justify-content: center;">
                    <button class="btn" onclick="submitTopicQuiz()" style="background: var(--success);">
                        <i class="fas fa-check-circle"></i> Submit Quiz
                    </button>
                </div>
            </div>
        </div>
    `;

    // Load the questions if they exist
    if (window.quizState.currentQuestions.length > 0) {
        displayQuizQuestions(window.quizState.currentQuestions);
    } else {
        document.getElementById('quiz-questions-container').innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h4>No Questions Available</h4>
                <p>This quiz doesn't contain any questions yet.</p>
            </div>
        `;
    }
}

// Fisher-Yates shuffle algorithm
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}
        
// SINGLE CORRECTED displayQuizQuestions function
function displayQuizQuestions(questions) {
    const container = document.getElementById('quiz-questions-container');
    
    // CLEAR CONTAINER FIRST to prevent nesting
    container.innerHTML = '';
    
    container.innerHTML = questions.map((question, index) => `
        <div class="question" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: var(--border-radius-sm); box-shadow: var(--shadow);">
            <div class="question-text" style="font-weight: 600; color: var(--primary); margin-bottom: 15px;">
                <strong>Question ${index + 1}:</strong> <span id="question-text-${index}">${renderMarkdown(question.question)}</span>
            </div>
            
            ${question.image ? `
                <!-- IMAGE CONTAINER - Added safely -->
                <div class="question-image" style="text-align: center; margin: 15px 0; max-width: 100%;">
                    <img src="${question.image}" 
                         alt="Question diagram" 
                         style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;"
                         onerror="this.style.display='none'; console.warn('Quiz image failed to load: ${question.image}')">
                </div>
            ` : ''}
            
            <div class="options" style="display: flex; flex-direction: column; gap: 10px;">
                ${question.options.map((option, optionIndex) => `
                    <div class="option" onclick="selectQuizOption(${index}, ${optionIndex})" 
                         style="padding: 12px 15px; border: 2px solid var(--light-gray); border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition);"
                         id="option-${index}-${optionIndex}">
                         <span>${renderMarkdown(option)}</span>
                    </div>
                `).join('')}
            </div>
            <div class="selection-status" style="margin-top: 10px; font-size: 0.9rem; color: var(--gray); display: none;" id="status-${index}">
                <i class="fas fa-check"></i> Selected
            </div>
        </div>
    `).join('');

    // Render MathJax after the questions are loaded
    setTimeout(() => {
        if (window.MathJax) {
            MathJax.typesetPromise().catch(console.error);
        }
    }, 100);
}

function debugQuizRendering() {
    console.log("🔍 Debug Quiz Rendering:");
    const container = document.getElementById('quiz-questions-container');
    const questions = container.querySelectorAll('.question');
    
    console.log(`Total questions rendered: ${questions.length}`);
    
    questions.forEach((q, i) => {
        const nestedQuestions = q.querySelectorAll('.question');
        console.log(`Question ${i+1}: ${nestedQuestions.length} nested questions`);
        
        if (nestedQuestions.length > 0) {
            console.warn(`❌ NESTING DETECTED in question ${i+1}`);
        }
    });
}

// Call this after displayQuizQuestions
// setTimeout(debugQuizRendering, 200);
      
// SINGLE CORRECTED selectQuizOption function
function selectQuizOption(questionIndex, optionIndex) {
    console.log(`📝 Selecting option ${optionIndex} for question ${questionIndex}`);
    
    const question = window.quizState.currentQuestions[questionIndex];
    
    if (question.isMultipleResponse) {
        // MULTIPLE RESPONSE: Toggle selection
        if (!window.quizState.userAnswers[questionIndex]) {
            window.quizState.userAnswers[questionIndex] = [];
        }
        
        const currentAnswers = window.quizState.userAnswers[questionIndex];
        const answerIndex = currentAnswers.indexOf(optionIndex);
        
        if (answerIndex === -1) {
            // Add to selection
            currentAnswers.push(optionIndex);
        } else {
            // Remove from selection
            currentAnswers.splice(answerIndex, 1);
        }
    } else {
        // SINGLE ANSWER: Replace selection
        window.quizState.userAnswers[questionIndex] = optionIndex;
    }
    
    // Update UI
    const questionElement = document.querySelectorAll('.question')[questionIndex];
    const options = questionElement.querySelectorAll('.option');
    const statusElement = document.getElementById(`status-${questionIndex}`);
    
    if (question.isMultipleResponse) {
        // Multiple response: toggle visual selection for this specific option
        const optionElement = document.getElementById(`option-${questionIndex}-${optionIndex}`);
        const isSelected = Array.isArray(window.quizState.userAnswers[questionIndex]) && 
                          window.quizState.userAnswers[questionIndex].includes(optionIndex);
        
        optionElement.classList.toggle('selected', isSelected);
        optionElement.style.borderColor = isSelected ? 'var(--primary)' : 'var(--light-gray)';
        optionElement.style.background = isSelected ? 'var(--light-bg)' : 'white';
        
        // Update status
        if (statusElement) {
            const selectedCount = Array.isArray(window.quizState.userAnswers[questionIndex]) ? window.quizState.userAnswers[questionIndex].length : 0;
            statusElement.textContent = selectedCount > 0 ? `Selected: ${selectedCount}` : '';
            statusElement.style.display = selectedCount > 0 ? 'block' : 'none';
        }
    } else {
        // Single answer: replace selection (clear all others)
        options.forEach(opt => {
            opt.classList.remove('selected');
            opt.style.borderColor = 'var(--light-gray)';
            opt.style.background = 'white';
        });
        
        options[optionIndex].classList.add('selected');
        options[optionIndex].style.borderColor = 'var(--primary)';
        options[optionIndex].style.background = 'var(--light-bg)';
        
        // Show selection status
        if (statusElement) {
            statusElement.style.display = 'block';
        }
    }
    
    console.log('📝 Current answers:', window.quizState.userAnswers);
}

// FIXED submit function with proper validation
function submitTopicQuiz() {
    console.log('📝 Submitting quiz...');
    console.log('📝 Current state:', window.quizState);
    console.log('📝 User answers:', window.quizState.userAnswers);
    
    if (!window.quizState.currentQuestions || window.quizState.currentQuestions.length === 0) {
        alert('No quiz questions available to submit.');
        return;
    }
    
    // Check if all questions are answered
    const unansweredQuestions = window.quizState.userAnswers.map((answer, index) => {
        const question = window.quizState.currentQuestions[index];
        if (question.isMultipleResponse) {
            return (!Array.isArray(answer) || answer.length === 0) ? index + 1 : null;
        } else {
            return answer === null ? index + 1 : null;
        }
    }).filter(index => index !== null);
    
    if (unansweredQuestions.length > 0) {
        const confirmSubmit = confirm(`You haven't answered questions: ${unansweredQuestions.join(', ')}. Submit anyway?`);
        if (!confirmSubmit) {
            return;
        }
    }
    
    // Calculate score with proper multiple response handling
    let correctAnswers = 0;
    const results = [];

    window.quizState.currentQuestions.forEach((question, index) => {
        const userAnswer = window.quizState.userAnswers[index];
        
        let isCorrect = false;
        let wasAnswered = false;

        if (question.isMultipleResponse) {
            // MULTIPLE RESPONSE: Check if arrays match (order doesn't matter)
            wasAnswered = Array.isArray(userAnswer) && userAnswer.length > 0;
            if (wasAnswered) {
                const userAnswersSorted = [...userAnswer].sort().join(',');
                const correctAnswersSorted = question.correctAnswerIndices.sort().join(',');
                isCorrect = userAnswersSorted === correctAnswersSorted;
            }
        } else {
            // SINGLE ANSWER: Direct comparison
            wasAnswered = userAnswer !== null;
            isCorrect = wasAnswered && userAnswer === question.correctAnswerIndices[0];
        }
        
        console.log(`🔍 Question ${index}:`, {
            userAnswer: userAnswer,
            correctAnswerIndices: question.correctAnswerIndices,
            isCorrect: isCorrect,
            wasAnswered: wasAnswered,
            isMultipleResponse: question.isMultipleResponse
        });
        
        if (isCorrect && wasAnswered) {
            correctAnswers++;
        }
        
        results.push({
            question: question.question,
            userAnswer: userAnswer,
            correctAnswerIndices: question.correctAnswerIndices,
            correctAnswerLetters: question.correctAnswerIndices.map(idx => String.fromCharCode(65 + idx)),
            isMultipleResponse: question.isMultipleResponse,
            isCorrect: isCorrect,
            explanation: question.explanation,
            options: question.options,
            originalOptions: question.originalOptions,
            wasAnswered: wasAnswered
        });
    });
    
    const score = Math.round((correctAnswers / window.quizState.currentQuestions.length) * 100);
    window.quizState.isQuizComplete = true;
    window.quizState.showResults = true;
    
    console.log('📝 Quiz results:', { 
        score, 
        correctAnswers, 
        total: window.quizState.currentQuestions.length,
        detailed: results 
    });
    
    // Save progress to Firebase
    updateCourseProgress(currentCourseId, score, 'quiz');
    updateDashboardStats();
    
    // Display results
    displayQuizResults(score, correctAnswers, results);
}
        
// FIXED results display function
function displayQuizResults(score, correctAnswers, results) {
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">Quiz Results - ${window.quizState.quizTitle}</h3>
                <button class="tool-back" onclick="openResource('topic-quiz', this)">
                    <i class="fas fa-arrow-left"></i> Back to Topics
                </button>
            </div>
            
            <div class="quiz-container">
                <div style="text-align: center; padding: 30px; background: var(--light-bg); border-radius: var(--border-radius-sm); margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Quiz Complete!</h3>
                    <div style="font-size: 3rem; font-weight: 800; color: ${score >= 70 ? 'var(--success)' : 'var(--accent)'}; margin-bottom: 10px;">
                        ${score}%
                    </div>
                    <p style="color: var(--gray); margin-bottom: 10px;">
                        You answered ${correctAnswers} out of ${results.length} questions correctly.
                    </p>
                    <p style="color: var(--gray); font-size: 0.9rem;">
                        ${results.filter(r => !r.wasAnswered).length} questions were not answered.
                    </p>
                </div>
                
                <div id="quiz-results-detailed">
                    ${results.map((result, index) => {
                        // SAFELY get the user's answer text - HANDLE BOTH SINGLE AND MULTIPLE ANSWERS
                        let userAnswerText = 'Not answered';
                        let userAnswerLetters = '';
                        
                        if (result.isMultipleResponse) {
                            // MULTIPLE RESPONSE: Handle array of answers
                            if (Array.isArray(result.userAnswer) && result.userAnswer.length > 0) {
                                const userAnswerTexts = result.userAnswer.map(idx => {
                                    return result.options && result.options[idx] ? 
                                        `${String.fromCharCode(65 + idx)}. ${renderMarkdown(result.options[idx])}` : 
                                        `Option ${String.fromCharCode(65 + idx)}`;
                                });
                                userAnswerText = userAnswerTexts.join('<br>');
                                userAnswerLetters = result.userAnswer.map(idx => String.fromCharCode(65 + idx)).join(', ');
                            }
                        } else {
                            // SINGLE ANSWER: Handle single answer
                            if (result.userAnswer !== null && result.options && result.options[result.userAnswer]) {
                                userAnswerText = renderMarkdown(result.options[result.userAnswer]);
                                userAnswerLetters = String.fromCharCode(65 + result.userAnswer);
                            }
                        }
                        
                        // SAFELY get the correct answer text - HANDLE BOTH SINGLE AND MULTIPLE ANSWERS
                        let correctAnswerText = '';
                        let correctAnswerLetters = '';
                        
                        if (result.isMultipleResponse) {
                            // MULTIPLE RESPONSE: Handle array of correct answers
                            if (Array.isArray(result.correctAnswerIndices) && result.correctAnswerIndices.length > 0) {
                                const correctAnswerTexts = result.correctAnswerIndices.map(idx => {
                                    return result.options && result.options[idx] ? 
                                        `${String.fromCharCode(65 + idx)}. ${renderMarkdown(result.options[idx])}` : 
                                        `Option ${String.fromCharCode(65 + idx)}`;
                                });
                                correctAnswerText = correctAnswerTexts.join('<br>');
                                correctAnswerLetters = result.correctAnswerLetters.join(', ');
                            }
                        } else {
                            // SINGLE ANSWER: Handle single correct answer
                            if (result.correctAnswerIndices && result.correctAnswerIndices.length > 0 && result.options && result.options[result.correctAnswerIndices[0]] !== undefined) {
                                correctAnswerText = renderMarkdown(result.options[result.correctAnswerIndices[0]]);
                                correctAnswerLetters = result.correctAnswerLetters ? result.correctAnswerLetters[0] : String.fromCharCode(65 + result.correctAnswerIndices[0]);
                            } else {
                                console.warn(`❌ No correct answer found for question ${index}:`, result);
                                correctAnswerText = 'Correct answer not available';
                            }
                        }
                        
                        return `
                        <div class="question-result" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: var(--border-radius-sm); box-shadow: var(--shadow); border-left: 4px solid ${result.isCorrect && result.wasAnswered ? 'var(--success)' : result.wasAnswered ? 'var(--accent)' : 'var(--warning)'}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <h4 style="color: var(--primary); margin: 0;">Question ${index + 1}</h4>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    ${!result.wasAnswered ? `
                                        <span style="background: var(--warning); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                            Not Answered
                                        </span>
                                    ` : `
                                        <span style="background: ${result.isCorrect ? 'var(--success)' : 'var(--accent)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                            ${result.isCorrect ? 'Correct' : 'Incorrect'}
                                        </span>
                                    `}
                                </div>
                            </div>
                            
                            <div class="question-text" style="margin-bottom: 15px;">
                                ${renderMarkdown(result.question)}
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Your answer:</strong> 
                                <span style="color: ${result.wasAnswered ? (result.isCorrect ? 'var(--success)' : 'var(--accent)') : 'var(--warning)'}">
                                    ${userAnswerLetters ? `<strong>${userAnswerLetters}</strong><br>` : ''}${userAnswerText}
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Correct answer:</strong> 
                                <span style="color: var(--success)">
                                    ${correctAnswerLetters ? `<strong>${correctAnswerLetters}</strong><br>` : ''}${correctAnswerText}
                                </span>
                            </div>
                            
                            ${result.explanation ? `
                                <div class="question-explanation" style="padding: 15px; background: var(--light-bg); border-radius: var(--border-radius-sm); margin-top: 15px;">
                                    <strong>Explanation:</strong> ${renderMarkdown(result.explanation)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    }).join('')}
                </div>
                
                <div class="quiz-actions" style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                    <button class="btn" onclick="retakeQuiz()">
                        <i class="fas fa-redo"></i> Retake Quiz
                    </button>
                    <button class="btn btn-outline" onclick="openResource('topic-quiz', this)">
                        <i class="fas fa-list"></i> Back to Topics
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Render MathJax for results
    setTimeout(() => {
        if (window.MathJax) {
            MathJax.typesetPromise().catch(console.error);
        }
    }, 100);
}
        
// Fixed retake function
function retakeQuiz() {
    console.log('🔄 Retaking quiz...');
    
    // Reset quiz state but keep the same questions
    window.quizState.userAnswers = new Array(window.quizState.currentQuestions.length).fill(null);
    window.quizState.isQuizComplete = false;
    window.quizState.showResults = false;
    
    // Reload the current quiz
    displayQuizWithData({
        title: window.quizState.quizTitle,
        questions: window.quizState.currentQuestions
    }, '', '', window.quizState.quizDifficulty);
}

// FIXED default quiz function
function displayDefaultTopicQuiz(unitId, quizNumber, difficulty) {
    console.log('🔄 Loading default quiz as fallback');
    
    // Create proper quiz data structure
    const defaultQuizData = {
        title: `Quiz ${quizNumber} - ${difficulty}`,
        questions: [
            {
                question: "This is a sample question for demonstration. The actual quiz content for this topic is coming soon!",
                options: [
                    "Sample Option A",
                    "Sample Option B", 
                    "Sample Option C",
                    "Sample Option D"
                ],
                correct: 0, // First option is correct
                explanation: "This is a sample explanation. In a real quiz, this would provide detailed reasoning for the correct answer."
            },
            {
                question: "Another sample question to demonstrate the quiz functionality.",
                options: [
                    "First option",
                    "Second option",
                    "Third option",
                    "Fourth option"
                ],
                correct: 1, // Second option is correct
                explanation: "Sample explanation for the second question."
            }
        ]
    };
    
    // Use the same function to display the quiz
    displayQuizWithData(defaultQuizData, unitId, quizNumber, difficulty);
}

async function startFlashcards() {
    console.log("ACTUAL COURSE ID:", currentCourseId);
    try {
        // Show loading state
        const resourceContent = document.getElementById('resource-content');
        resourceContent.innerHTML = `
            <div class="tool-interface active">
                <div class="tool-header">
                    <h3 class="section-title">Loading Flashcards...</h3>
                    <button class="tool-back" onclick="closeFlashcards()">
                        <i class="fas fa-arrow-left"></i> Back to Course
                    </button>
                </div>
                <div style="text-align: center; padding: 60px 20px;">
                    <div class="tool-icon" style="margin: 0 auto 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Flashcard Content</h4>
                    <p style="color: var(--gray);">Preparing your study session...</p>
                </div>
            </div>
        `;

        // Load flashcards based on current course
        const flashcardData = await loadFlashcards(currentCourseId);
        
        if (flashcardData && flashcardData.availableTopics) {
            // NEW: Show topic selection instead of directly loading dynamics
            showTopicSelection(flashcardData);
        } else {
            showNoFlashcardsMessage();
        }
    } catch (error) {
        console.error('Error starting flashcards:', error);
        showFlashcardError();
    }
}

let flashcardPathsCache = null;

async function loadFlashcardPaths() {
    if (flashcardPathsCache) return flashcardPathsCache;
    
    try {
        const response = await fetch('./flashcardPaths.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        flashcardPathsCache = await response.json();
        console.log('✅ Flashcard paths loaded');
        return flashcardPathsCache;
    } catch (error) {
        console.error('❌ Error loading flashcard paths:', error);
        return {};
    }
}

async function loadFlashcards(courseId) {
    try {
        console.log('🔍 Loading flashcards for:', courseId);
        
        const flashcardPaths = await loadFlashcardPaths();
        const coursePaths = flashcardPaths[courseId];
        
        if (!coursePaths) {
            console.warn(`No flashcard paths found for ${courseId}`);
            return null;
        }
        
        // Return available topics
        const courseName = await getCourseDisplayName(courseId);

        return {
            course: courseName,    // ✅ Now it's the actual string
            availableTopics: Object.keys(coursePaths.topics).map(topicId => ({
                id: topicId,
                name: topicId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                path: coursePaths.topics[topicId]
            })),
            topicPaths: coursePaths.topics
        };
        
    } catch (error) {
        console.error('Error loading flashcards:', error);
        return null;
    }
}

let courseDisplayNamesCache = null;

async function loadCourseDisplayNames() {
    if (courseDisplayNamesCache) return courseDisplayNamesCache;
    
    try {
        const response = await fetch('./courseDisplayNames.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        courseDisplayNamesCache = await response.json();
        console.log('✅ Course display names loaded');
        return courseDisplayNamesCache;
    } catch (error) {
        console.error('❌ Error loading course display names:', error);
        return {};
    }
}

async function getCourseDisplayName(courseId) {
    const displayNames = await loadCourseDisplayNames();
    return displayNames[courseId] || courseId;
}

function renderMarkdown(text) {
    if (!text) return ''; // This will handle undefined, null, empty string
    
    console.log('🔍 Original text:', text);
    
    // First, protect math content from markdown processing
    const mathBlocks = [];
    let mathIndex = 0;
    
    // Temporarily replace math blocks with placeholders
    text = text.replace(/\$\$.*?\$\$/g, (match) => {
        const placeholder = `@@MATH${mathIndex}@@`;
        mathBlocks[mathIndex] = match;
        console.log('🔍 Found math block:', match, '->', placeholder);
        mathIndex++;
        return placeholder;
    });
    
    console.log('🔍 After math protection:', text);
    
    // Now process markdown on the non-math content
    text = text
        // Convert **bold** to <strong>bold</strong>
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Convert *italic* to <em>italic</em>  
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Convert `code` to <code>code</code>
        .replace(/`([^`]+)`/g, '<code>$1</code>');
    
    console.log('🔍 After markdown processing:', text);
    
    // Restore math blocks - FIXED: use the correct index
    mathBlocks.forEach((mathBlock, index) => {
        text = text.replace(`@@MATH${index}@@`, mathBlock);
    });
    
    console.log('🔍 Final result:', text);
    return text;
}
        
        
function initializeFlashcardUI(flashcardData) {
    console.log('🎨 Initializing UI with data:', flashcardData);
    
    let topics = [];
    
    if (flashcardData.cards && Array.isArray(flashcardData.cards)) {
        // Your structure: {course: "...", topic: "...", cards: [...]}
        console.log('📚 Using your custom structure');
        topics = [{
            topic_name: flashcardData.topic || 'Flashcards',
            cards: flashcardData.cards
        }];
    } else if (flashcardData.topics) {
        topics = flashcardData.topics;
    } else if (flashcardData.flashcards) {
        topics = flashcardData.flashcards.map(item => ({
            topic_name: item.category,
            cards: item.cards
        }));
    }
    
    console.log('🃏 Final topics:', topics);
    
    if (topics.length > 0 && topics[0].cards.length > 0) {
        currentFlashcardData = { topics: topics };
        currentTopicIndex = 0;
        startTopicStudy(0);
    } else {
        console.log('❌ No flashcards found');
        showNoFlashcardsMessage();
    }
}
        
function showTopicSelection(flashcardData) {
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${flashcardData.course} - Select Topic</h3>
                <button class="tool-back" onclick="closeFlashcards()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            
            <div class="courses-grid" style="padding: 20px;">
                ${flashcardData.availableTopics.map((topic, index) => `
                    <div class="course-card" onclick="loadSpecificTopic('${topic.id}', '${topic.path}')">
                        <h3>${topic.name}</h3>
                        <p style="color: var(--gray); margin: 15px 0;">
                            Select to study ${topic.name.toLowerCase()} flashcards
                        </p>
                        <button class="btn" style="margin-top: 10px; pointer-events: none;">
                            <i class="fas fa-layer-group"></i> Study Now
                        </button>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Render MathJax after loading topics
    setTimeout(() => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
    }, 100);
}

// NEW FUNCTION: Load a specific topic
async function loadSpecificTopic(topicName, topicPath) {
    try {
        console.log('🔍 Loading specific topic:', topicName, 'from:', topicPath);
        
        const response = await fetch(topicPath);
        if (!response.ok) {
            throw new Error(`Failed to load topic: ${response.status}`);
        }
        const topicData = await response.json();
        
        // ✅ LOG FLASHCARD ACTIVITY WHEN TOPIC IS LOADED
        if (currentCourseId) {
            const courseTitle = await getCourseDisplayName(currentCourseId);
            await logActivity(currentCourseId, courseTitle, 'flashcard');
            console.log(`🃏 Logged flashcard activity: ${courseTitle} - ${topicName}`);
        }
        
        // Initialize the flashcard UI with the loaded topic data
        initializeFlashcardUI(topicData);
        
    } catch (error) {
        console.error('❌ Error loading topic:', error);
        showFlashcardError();
    }
}
        
function startTopicStudy(topicIndex) {
    currentTopicIndex = topicIndex;
    currentCardIndex = 0;
    const topic = currentFlashcardData.topics[topicIndex];
    currentDeck = [...topic.cards];
    
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">${currentFlashcardData.course || 'Flashcards'} - ${topic.topic_name}</h3>
                <button class="tool-back" onclick="${currentFlashcardData.topics.length > 1 ? 'showTopicSelection(currentFlashcardData)' : 'closeFlashcards()'}">
                    <i class="fas fa-arrow-left"></i> ${currentFlashcardData.topics.length > 1 ? 'Back to Topics' : 'Back to Course'}
                </button>
            </div>
            
            <div class="flashcard-container">
                <div class="flashcard-progress">
                    <div class="progress-info">
                        <span>Card ${currentCardIndex + 1} of ${currentDeck.length}</span>
                        <span>Topic: ${topic.topic_name}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${((currentCardIndex + 1) / currentDeck.length) * 100}%"></div>
                    </div>
                </div>
                
                <div class="flashcard" id="current-flashcard">
                    <div class="flashcard-front">
                        <div class="flashcard-content">
                            <h4>Question</h4>
                            <div class="flashcard-text" id="flashcard-front-text">${currentDeck[currentCardIndex].front}</div>
                        </div>
                        <div class="flashcard-hint">
                            <i class="fas fa-lightbulb"></i> Click to reveal answer
                        </div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-content">
                            <h4>Answer</h4>
                            <div class="flashcard-text" id="flashcard-back-text">${currentDeck[currentCardIndex].back}</div>
                        </div>
                        <div class="flashcard-hint">
                            <i class="fas fa-lightbulb"></i> Click to see question
                        </div>
                    </div>
                </div>
                
                <div class="flashcard-controls">
                    <button class="btn btn-outline" id="prev-card" ${currentCardIndex === 0 ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    
                    <div class="card-actions">
                        <button class="btn btn-outline" id="mark-difficult">
                            <i class="fas fa-exclamation-circle"></i> Difficult
                        </button>
                        <button class="btn" id="next-card">
                            ${currentCardIndex === currentDeck.length - 1 ? 'Finish' : 'Next'} 
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flashcard-stats">
                    <div class="flashcard-stat-item">
                        <span class="flashcard-stat-value">${currentCardIndex + 1}</span>
                        <span class="flashcard-stat-label">Current</span>
                    </div>
                    <div class="flashcard-stat-item">
                        <span class="flashcard-stat-value">${currentDeck.length}</span>
                        <span class="flashcard-stat-label">Total</span>
                    </div>
                    <div class="flashcard-stat-item">
                        <span class="flashcard-stat-value">${Math.round(((currentCardIndex + 1) / currentDeck.length) * 100)}%</span>
                        <span class="flashcard-stat-label">Progress</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Add event listeners after the HTML is rendered
    const flashcardElement = document.getElementById('current-flashcard');
    const prevButton = document.getElementById('prev-card');
    const nextButton = document.getElementById('next-card');
    const difficultButton = document.getElementById('mark-difficult');

    if (flashcardElement) {
        flashcardElement.addEventListener('click', () => flipCard(flashcardElement));
    }
    
    if (prevButton) {
        prevButton.addEventListener('click', previousCard);
    }
    
    if (nextButton) {
        nextButton.addEventListener('click', nextCard);
    }
    
    if (difficultButton) {
        difficultButton.addEventListener('click', markCardDifficult);
    }
    // Call updateFlashcardView directly - the DOM should be ready now
    updateFlashcardView();
}

        
function flipCard(cardElement) {
    cardElement.classList.toggle('flipped');
    
    // Re-render MathJax after flip animation completes
    setTimeout(() => {
        const frontText = document.getElementById('flashcard-front-text');
        const backText = document.getElementById('flashcard-back-text');
        
        if (window.MathJax && frontText && backText) {
            MathJax.typesetPromise([frontText, backText]).catch(console.error);
        }
    }, 300); // Match this to your CSS transition time
}
        
function nextCard() {
    if (currentCardIndex < currentDeck.length - 1) {
        currentCardIndex++;
        updateFlashcardView(); // Update the view without full re-render
    } else {
        showDeckComplete();
    }
}

function previousCard() {
    if (currentCardIndex > 0) {
        currentCardIndex--;
        updateFlashcardView(); // Update the view without full re-render
    }
}

function updateFlashcardView() {
    // Update progress bar
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        progressFill.style.width = `${((currentCardIndex + 1) / currentDeck.length) * 100}%`;
    }
    
    // Update card number display
    const progressInfo = document.querySelector('.progress-info span:first-child');
    if (progressInfo) {
        progressInfo.textContent = `Card ${currentCardIndex + 1} of ${currentDeck.length}`;
    }
    
    // Update flashcard content
    const frontText = document.getElementById('flashcard-front-text');
    const backText = document.getElementById('flashcard-back-text');
    
    if (frontText && backText) {
        console.log('🔄 Before markdown - Front:', currentDeck[currentCardIndex].front);
        console.log('🔄 Before markdown - Back:', currentDeck[currentCardIndex].back);
        
        // Convert Markdown to HTML first
        frontText.innerHTML = renderMarkdown(currentDeck[currentCardIndex].front);
        backText.innerHTML = renderMarkdown(currentDeck[currentCardIndex].back);
        
        console.log('🔄 After markdown - Front HTML:', frontText.innerHTML);
        console.log('🔄 After markdown - Back HTML:', backText.innerHTML);
        
        // Then render MathJax
        setTimeout(() => {
            if (window.MathJax) {
                MathJax.typesetPromise([frontText, backText]).catch(console.error);
            }
        }, 50);
    }
    
    // Reset card to front side
    const flashcard = document.getElementById('current-flashcard');
    if (flashcard) {
        flashcard.classList.remove('flipped');
    }
    
    // Update buttons state
    const prevButton = document.getElementById('prev-card');
    const nextButton = document.getElementById('next-card');
    
    if (prevButton) {
        prevButton.disabled = currentCardIndex === 0;
    }
    
    if (nextButton) {
        nextButton.innerHTML = currentCardIndex === currentDeck.length - 1 ? 
            'Finish <i class="fas fa-arrow-right"></i>' : 
            'Next <i class="fas fa-arrow-right"></i>';
    }
    
    // Update stats
    const statValues = document.querySelectorAll('.flashcard-stat-value');
    if (statValues.length >= 3) {
        statValues[0].textContent = currentCardIndex + 1;
        statValues[2].textContent = `${Math.round(((currentCardIndex + 1) / currentDeck.length) * 100)}%`;
    }
}

let difficultCards = JSON.parse(localStorage.getItem('difficultCards')) || {};
        
function markCardDifficult() {
    const currentCard = currentDeck[currentCardIndex];
    const cardId = `${currentCourseId}-${currentTopicIndex}-${currentCardIndex}`;
    
    // Toggle difficult status
    if (difficultCards[cardId]) {
        // Remove from difficult list
        delete difficultCards[cardId];
        console.log('✅ Removed from difficult cards:', currentCard.front);
    } else {
        // Add to difficult list with timestamp
        difficultCards[cardId] = {
            card: currentCard,
            topic: currentFlashcardData.topics[currentTopicIndex].topic_name,
            markedAt: new Date().toISOString(),
            reviewCount: 0
        };
        console.log('🔴 Marked as difficult:', currentCard.front);
    }
    
    // Save to localStorage
    localStorage.setItem('difficultCards', JSON.stringify(difficultCards));
    
    // Update the button state immediately
    updateFlashcardView();
}
    
// Update difficult button state - FIXED VERSION
const difficultBtn = document.getElementById('mark-difficult');
if (difficultBtn) {
    const cardId = `${currentCourseId}-${currentTopicIndex}-${currentCardIndex}`;
    const isDifficult = difficultCards[cardId];
    
    if (isDifficult) {
        difficultBtn.innerHTML = '<i class="fas fa-check"></i> Marked';
        difficultBtn.style.background = 'var(--accent)';
        difficultBtn.style.color = 'white';
    } else {
        difficultBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Difficult';
        difficultBtn.style.background = '';
        difficultBtn.style.color = '';
    }
    
    // Re-attach the click event handler
    difficultBtn.onclick = markCardDifficult;
}

function showDeckComplete() {
    const difficultCount = Object.keys(difficultCards).length;
    const resourceContent = document.getElementById('resource-content');
    
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">Study Session Complete! 🎉</h3>
                <button class="tool-back" onclick="closeFlashcards()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            
            <div style="text-align: center; padding: 60px 20px;">
                <div class="tool-icon" style="background: var(--success); margin: 0 auto 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">Great Job!</h4>
                <p style="color: var(--gray); margin-bottom: 30px;">
                    You've completed ${currentDeck.length} flashcards in 
                    ${currentFlashcardData.topics[currentTopicIndex].topic_name}.
                    ${difficultCount > 0 ? `<br>You have ${difficultCount} difficult cards to review.` : ''}
                </p>
                
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn" onclick="startTopicStudy(currentTopicIndex)">
                        <i class="fas fa-redo"></i> Study Again
                    </button>
                    ${difficultCount > 0 ? `
                    <button class="btn btn-outline" onclick="showDifficultCardsReview()">
                        <i class="fas fa-fire"></i> Review Difficult (${difficultCount})
                    </button>
                    ` : ''}
                    <button class="btn btn-outline" onclick="loadTopicSelection()">
                        <i class="fas fa-list"></i> Choose Another Topic
                    </button>
                    <button class="btn btn-outline" onclick="closeFlashcards()">
                        <i class="fas fa-home"></i> Back to Course
                    </button>
                </div>
            </div>
        </div>
    `;
}

// NEW FUNCTION: Reload the topic selection
async function loadTopicSelection() {
    try {
        console.log('🔄 Loading topic selection for:', currentCourseId);
        
        // Show loading state
        const resourceContent = document.getElementById('resource-content');
        resourceContent.innerHTML = `
            <div class="tool-interface active">
                <div class="tool-header">
                    <h3 class="section-title">Loading Topics...</h3>
                    <button class="tool-back" onclick="closeFlashcards()">
                        <i class="fas fa-arrow-left"></i> Back to Course
                    </button>
                </div>
                <div style="text-align: center; padding: 60px 20px;">
                    <div class="tool-icon" style="margin: 0 auto 20px;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Available Topics</h4>
                    <p style="color: var(--gray);">Preparing topic selection...</p>
                </div>
            </div>
        `;

        // Load the topic mapping data
        const flashcardData = await loadFlashcards(currentCourseId);
        
        if (flashcardData && flashcardData.availableTopics) {
            showTopicSelection(flashcardData);
        } else {
            showNoFlashcardsMessage();
        }
    } catch (error) {
        console.error('Error loading topic selection:', error);
        showFlashcardError();
    }
}
        
function closeFlashcards() {
    const resourceContent = document.getElementById('resource-content');
    resourceContent.innerHTML = '';
    currentFlashcardData = null;
    currentDeck = [];
}

function showNoFlashcardsMessage() {
    const resourceContent = document.getElementById('resource-content');
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">Flashcards</h3>
                <button class="tool-back" onclick="closeFlashcards()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            <div style="text-align: center; padding: 60px 20px;">
                <div class="tool-icon" style="background: var(--warning); margin: 0 auto 20px;">
                    <i class="fas fa-book"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">No Flashcards Available</h4>
                <p style="color: var(--gray); margin-bottom: 30px;">
                    Flashcards for this course are coming soon! Check back later.
                </p>
                <button class="btn" onclick="closeFlashcards()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
        </div>
    `;
}

function showFlashcardError() {
    const resourceContent = document.getElementById('resource-content');
    resourceContent.innerHTML = `
        <div class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">Flashcards</h3>
                <button class="tool-back" onclick="closeFlashcards()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            <div style="text-align: center; padding: 60px 20px;">
                <div class="tool-icon" style="background: var(--accent); margin: 0 auto 20px;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">Loading Error</h4>
                <p style="color: var(--gray); margin-bottom: 30px;">
                    There was an error loading the flashcards. Please try again later.
                </p>
                <button class="btn" onclick="startFlashcards()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        </div>
    `;
}

function showDifficultCardsReview() {
    const difficultCardsList = Object.values(difficultCards);
    
    if (difficultCardsList.length === 0) {
        alert('No difficult cards to review! 🎉');
        return;
    }
    
    // Create a special deck from difficult cards
    currentFlashcardData = {
        topics: [{
            topic_name: 'Difficult Cards Review',
            cards: difficultCardsList.map(item => item.card)
        }]
    };
    
    currentTopicIndex = 0;
    currentCardIndex = 0;
    startTopicStudy(0);
}

function loadVideoLessons() {
    const videoList = document.getElementById('video-list');
    const videos = [
        { title: 'Introduction Video', duration: '12:30' },
        { title: 'Main Concepts', duration: '18:45' },
        { title: 'Problem Solving', duration: '22:15' },
        { title: 'Summary & Review', duration: '10:20' }
    ];
    
    videoList.innerHTML = videos.map(video => `
        <div style="padding: 15px; background: var(--light-bg); border-radius: var(--border-radius-sm); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 600; color: var(--primary);">${video.title}</div>
                <div style="color: var(--gray); font-size: 0.9rem;">${video.duration}</div>
            </div>
            <button class="btn" onclick="watchVideo('${video.title}')">
                <i class="fas fa-play"></i>
            </button>
        </div>
    `).join('');
}

function watchVideo(videoTitle) {
    alert(`Now playing: ${videoTitle}`);
    // Add your video player logic here
}
    

// Update timer function to be course-specific
function startQuizTimer(courseId) {
    const timeLimit = getTimeLimitForCourse(courseId);
    let totalMinutes = parseInt(timeLimit);
    let minutes = totalMinutes - 1; // Start counting down from (limit-1):00
    let seconds = 0;
    
    const timerElement = document.getElementById('quiz-timer');
    if (!timerElement) return;
    
    // Initial display
    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const timer = setInterval(() => {
        if (seconds === 0) {
            if (minutes === 0) {
                clearInterval(timer);
                alert("Time's up! Submitting your quiz.");
                return;
            }
            minutes--;
            seconds = 59;
        } else {
            seconds--;
        }
        
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}


function selectOption(optionElement) {
    // Remove selected class from all options in this question
    const options = optionElement.parentElement.querySelectorAll('.option');
    options.forEach(opt => opt.classList.remove('selected'));
    
    // Add selected class to clicked option
    optionElement.classList.add('selected');
}

// Add this function to load quiz data from JSON files
async function loadQuizData(quizPath) {
    try {
        console.log('📂 Loading quiz from:', quizPath);
        const response = await fetch(quizPath);
        
        if (!response.ok) {
            console.error(`❌ HTTP error! status: ${response.status}`);
            return null;
        }
        
        // Get raw text to check for BOM
        const text = await response.text();
        const cleanText = text.replace(/^\uFEFF/, '');
        
        let quizData;
        try {
            quizData = JSON.parse(cleanText);
        } catch (parseError) {
            console.error('❌ JSON parse error:', parseError);
            console.error('First 500 chars:', cleanText.substring(0, 500));
            return null;
        }
        
        // FIX: Extract the "quiz" object or use the whole object
        const processedData = quizData.quiz || quizData;
        
        console.log('✅ Quiz loaded:', {
            title: processedData.title,
            questions: processedData.questions ? processedData.questions.length : 0,
            settings: processedData.settings
        });
        
        // Shuffle questions if enabled
        if (processedData.settings?.shuffleQuestions) {
            processedData.questions = shuffleArray(processedData.questions);
        }
        
        // Shuffle options for each question if enabled
        if (processedData.settings?.shuffleOptions) {
            processedData.questions.forEach(question => {
                if (question.type === 'mcq') {
                    shuffleQuestionOptions(question);
                }
            });
        }
        
        return processedData;
        
    } catch (error) {
        console.error('❌ Error loading quiz data:', error);
        return null;
    }
}

// Helper function to shuffle question options and update answer
function shuffleQuestionOptions(question) {
    // Create array of objects with original index and option
    const optionsWithIndex = question.options.map((option, index) => ({
        option,
        originalIndex: index
    }));
    
    // Shuffle the options with their original indices
    const shuffledOptionsWithIndex = shuffleArray(optionsWithIndex);
    
    // Extract just the option texts for the question
    question.options = shuffledOptionsWithIndex.map(item => item.option);
    
    // Update the answer by finding its new position
    const originalAnswerIndex = question.answer.charCodeAt(0) - 65; // Convert 'A','B','C' to 0,1,2
    
    // Find where the original answer moved to
    const newAnswerIndex = shuffledOptionsWithIndex.findIndex(
        item => item.originalIndex === originalAnswerIndex
    );
    
    // Convert back to letter (0->'A', 1->'B', etc.)
    question.answer = String.fromCharCode(65 + newAnswerIndex);
}

// ============================================
// EXAM QUIZ SYSTEM - COMPLETE
// ============================================

// EXAM QUIZ CONFIG LOADER
let examQuizConfigCache = null;

async function loadExamQuizConfig() {
    if (examQuizConfigCache) return examQuizConfigCache;
    
    try {
        const response = await fetch('./examQuizConfig.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        examQuizConfigCache = await response.json();
        console.log('✅ Exam quiz config loaded');
        return examQuizConfigCache;
    } catch (error) {
        console.error('❌ Error loading exam quiz config:', error);
        return {};
    }
}

// OPEN EXAM QUIZ SELECTION
async function openExamQuiz() {
    const courseTitle = document.getElementById('detail-course-title').textContent;
    
    const config = await loadExamQuizConfig();
    const courseConfig = config[currentCourseId] || { quizCount: 50 };
    
    document.getElementById('resource-content').innerHTML = `
        <div id="exam-quiz-section" class="tool-interface active">
            <div class="tool-header">
                <h3 class="section-title">Examination Quiz - ${courseTitle}</h3>
                <button class="tool-back" onclick="closeExamQuiz()">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
            
            <div class="exam-quiz-container">
                <div class="exam-info-section">
                    <div class="exam-description">
                        <h4>${courseTitle} - Exam Practice</h4>
                        <p>Select from ${courseConfig.quizCount} exam-style practice quizzes. Each quiz simulates real exam conditions.</p>
                    </div>
                </div>
                
                <div class="quiz-grid-container">
                    <h4 class="quiz-grid-title">Select a Quiz</h4>
                    <div class="quiz-grid" id="exam-quiz-grid"></div>
                </div>
            </div>
        </div>
    `;
    
    generateExamQuizButtons(currentCourseId);
}

// GENERATE QUIZ BUTTONS
async function generateExamQuizButtons(courseId) {
    const quizGrid = document.getElementById('exam-quiz-grid');
    quizGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Loading quizzes...</div>';
    
    const config = await loadExamQuizConfig();
    const courseConfig = config[courseId] || { quizCount: 50 };
    
    quizGrid.innerHTML = '';
    for (let i = 1; i <= courseConfig.quizCount; i++) {
        const btn = document.createElement('button');
        btn.className = 'quiz-btn';
        btn.textContent = `Quiz ${i}`;
        btn.onclick = () => startExamQuiz(i, courseId);
        quizGrid.appendChild(btn);
    }
}

// START EXAM QUIZ
async function startExamQuiz(quizNumber, courseId) {
    const quizPath = `quizzes/${courseId.toLowerCase()}/exam_quiz${quizNumber}.json`;
    
    // Show loading
    document.getElementById('exam-quiz-section').innerHTML = `
        <div class="tool-header">
            <h3 class="section-title">Loading Quiz ${quizNumber}...</h3>
            <button class="tool-back" onclick="openExamQuiz()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
        <div style="text-align: center; padding: 60px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
        </div>
    `;
    
    try {
        const response = await fetch(quizPath);
        if (!response.ok) throw new Error('Quiz not found');
        
        const data = await response.json();
        const quizData = data.quiz || data;
        
        // SHUFFLE QUESTIONS if enabled
        let questions = quizData.questions;
        if (quizData.settings?.shuffleQuestions) {
            questions = shuffleArray([...questions]); // Create copy and shuffle
        }
        
        // Initialize exam quiz state
        window.examQuizState = {
            quizNumber: quizNumber,
            courseId: courseId,
            title: quizData.title,
            timeLimit: quizData.settings?.timeLimit || '90min',
            questions: processExamQuestions(questions, quizData.settings?.shuffleOptions), // Pass shuffle setting
            userAnswers: new Array(questions.length).fill(null),
            startTime: Date.now()
        };
        
        displayExamQuiz();
        
    } catch (error) {
        console.error('Error loading exam quiz:', error);
        showExamQuizError();
    }
}

// PROCESS EXAM QUESTIONS
function processExamQuestions(questions, shuffleOptions = true) {
    return questions.map(q => {
        // Shuffle options if single choice AND shuffleOptions is enabled
        if (q.type === 'mcq' && shuffleOptions) {
            const optionsWithIndex = q.options.map((opt, idx) => ({ opt, idx }));
            const shuffled = shuffleArray(optionsWithIndex);
            
            const originalAnswerIdx = q.answer.charCodeAt(0) - 65;
            const newAnswerIdx = shuffled.findIndex(item => item.idx === originalAnswerIdx);
            
            return {
                ...q,
                options: shuffled.map(item => item.opt),
                correctAnswer: String.fromCharCode(65 + newAnswerIdx),
                correctIndex: newAnswerIdx
            };
        }
        
        // Multiple response - keep original order (no shuffling for multiple choice)
        if (q.type === 'multiple_response') {
            const correctIndices = q.answer.map(letter => letter.charCodeAt(0) - 65);
            return {
                ...q,
                correctAnswer: q.answer,
                correctIndices: correctIndices
            };
        }
        
        // If shuffleOptions is false, return as-is
        if (q.type === 'mcq' && !shuffleOptions) {
            const correctIndex = q.answer.charCodeAt(0) - 65;
            return {
                ...q,
                correctAnswer: q.answer,
                correctIndex: correctIndex
            };
        }
        
        return q;
    });
}

// DISPLAY EXAM QUIZ
function displayExamQuiz() {
    const state = window.examQuizState;
    
    document.getElementById('exam-quiz-section').innerHTML = `
        <div class="tool-header">
            <h3 class="section-title">${state.title}</h3>
            <div style="display: flex; gap: 15px;">
                <div style="background: var(--light-bg); padding: 8px 15px; border-radius: var(--border-radius-sm); color: var(--primary); font-weight: 600;">
                    <i class="fas fa-clock"></i> <span id="exam-timer">${state.timeLimit}</span>
                </div>
                <button class="tool-back" onclick="exitExamQuiz()">
                    <i class="fas fa-times"></i> Exit
                </button>
            </div>
        </div>
        
        <div class="quiz-container">
            <div id="exam-questions-container"></div>
            
            <div class="quiz-actions" style="margin-top: 30px; justify-content: center;">
                <button class="btn" onclick="submitExamQuiz()" style="background: var(--success);">
                    <i class="fas fa-check-circle"></i> Submit Quiz
                </button>
            </div>
        </div>
    `;
    
    displayExamQuestions();
    startExamTimer();
}

// DISPLAY EXAM QUESTIONS
function displayExamQuestions() {
    const state = window.examQuizState;
    const container = document.getElementById('exam-questions-container');
    
    container.innerHTML = state.questions.map((q, idx) => `
        <div class="question" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: var(--border-radius-sm); box-shadow: var(--shadow);">
            <div class="question-text" style="font-weight: 600; color: var(--primary); margin-bottom: 15px;">
                <strong>Question ${idx + 1}:</strong> ${renderMarkdown(q.question)}
                ${q.type === 'multiple_response' ? '<div style="color: var(--accent); font-size: 0.9rem; margin-top: 5px;"><i class="fas fa-info-circle"></i> Select ALL that apply</div>' : ''}
            </div>
            
            ${q.image ? `
                <div style="text-align: center; margin: 15px 0;">
                    <img src="${q.image}" alt="Question diagram" style="max-width: 100%; height: auto; border-radius: 4px;" onerror="this.style.display='none'">
                </div>
            ` : ''}
            
            <div class="options">
                ${q.options.map((opt, optIdx) => `
                    <div class="option" onclick="selectExamOption(${idx}, ${optIdx}, '${q.type}')" 
                         id="exam-opt-${idx}-${optIdx}"
                         style="padding: 12px 15px; border: 2px solid var(--light-gray); border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition); margin-bottom: 8px;">
                        <strong>${String.fromCharCode(65 + optIdx)}.</strong> ${renderMarkdown(opt)}
                    </div>
                `).join('')}
            </div>
            
            <div id="exam-status-${idx}" style="margin-top: 10px; font-size: 0.9rem; color: var(--gray); display: none;">
                <i class="fas fa-check"></i> <span id="exam-status-text-${idx}">Selected</span>
            </div>
        </div>
    `).join('');
    
    setTimeout(() => {
        if (window.MathJax) MathJax.typesetPromise().catch(console.error);
    }, 100);
}

// SELECT EXAM OPTION
function selectExamOption(questionIdx, optionIdx, questionType) {
    const state = window.examQuizState;
    
    if (questionType === 'multiple_response') {
        // Initialize as array if needed
        if (!Array.isArray(state.userAnswers[questionIdx])) {
            state.userAnswers[questionIdx] = [];
        }
        
        const answers = state.userAnswers[questionIdx];
        const idx = answers.indexOf(optionIdx);
        
        if (idx === -1) {
            answers.push(optionIdx);
        } else {
            answers.splice(idx, 1);
        }
        
        // Update UI for this option only
        const optElement = document.getElementById(`exam-opt-${questionIdx}-${optionIdx}`);
        const isSelected = answers.includes(optionIdx);
        
        optElement.style.borderColor = isSelected ? 'var(--primary)' : 'var(--light-gray)';
        optElement.style.background = isSelected ? 'var(--light-bg)' : 'white';
        
        // Update status
        const statusDiv = document.getElementById(`exam-status-${questionIdx}`);
        const statusText = document.getElementById(`exam-status-text-${questionIdx}`);
        if (answers.length > 0) {
            statusDiv.style.display = 'block';
            statusText.textContent = `Selected: ${answers.length}`;
        } else {
            statusDiv.style.display = 'none';
        }
        
    } else {
        // Single answer - clear others
        state.userAnswers[questionIdx] = optionIdx;
        
        const question = document.querySelectorAll('.question')[questionIdx];
        const options = question.querySelectorAll('.option');
        
        options.forEach(opt => {
            opt.style.borderColor = 'var(--light-gray)';
            opt.style.background = 'white';
        });
        
        options[optionIdx].style.borderColor = 'var(--primary)';
        options[optionIdx].style.background = 'var(--light-bg)';
        
        const statusDiv = document.getElementById(`exam-status-${questionIdx}`);
        statusDiv.style.display = 'block';
    }
}

// START EXAM TIMER
function startExamTimer() {
    const timeLimit = window.examQuizState.timeLimit;
    let totalMinutes = parseInt(timeLimit);
    let seconds = totalMinutes * 60;
    
    const timerElement = document.getElementById('exam-timer');
    if (!timerElement) return;
    
    const timer = setInterval(() => {
        if (seconds <= 0) {
            clearInterval(timer);
            alert("Time's up!");
            submitExamQuiz();
            return;
        }
        
        seconds--;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
    
    window.examQuizTimer = timer;
}

// SUBMIT EXAM QUIZ
function submitExamQuiz() {
    const state = window.examQuizState;
    
    // Stop timer
    if (window.examQuizTimer) clearInterval(window.examQuizTimer);
    
    // Check unanswered
    const unanswered = [];
    state.userAnswers.forEach((ans, idx) => {
        const q = state.questions[idx];
        if (q.type === 'multiple_response') {
            if (!Array.isArray(ans) || ans.length === 0) unanswered.push(idx + 1);
        } else {
            if (ans === null) unanswered.push(idx + 1);
        }
    });
    
    if (unanswered.length > 0) {
        const confirm = window.confirm(`Unanswered: ${unanswered.join(', ')}. Submit anyway?`);
        if (!confirm) return;
    }
    
    // Calculate score
    let correct = 0;
    const results = state.questions.map((q, idx) => {
        const userAns = state.userAnswers[idx];
        let isCorrect = false;
        
        if (q.type === 'multiple_response') {
            if (Array.isArray(userAns) && userAns.length > 0) {
                const userSorted = [...userAns].sort().join(',');
                const correctSorted = [...q.correctIndices].sort().join(',');
                isCorrect = userSorted === correctSorted;
            }
        } else {
            isCorrect = userAns === q.correctIndex;
        }
        
        if (isCorrect) correct++;
        
        return {
            question: q.question,
            userAnswer: userAns,
            correctAnswer: q.type === 'multiple_response' ? q.correctAnswer : q.correctAnswer,
            correctIndices: q.type === 'multiple_response' ? q.correctIndices : [q.correctIndex],
            isCorrect: isCorrect,
            type: q.type,
            options: q.options,
            explanation: q.explanation,
            image: q.image
        };
    });
    
    const score = Math.round((correct / state.questions.length) * 100);
    
    // Save progress
    updateCourseProgress(currentCourseId, score, 'quiz');
    updateDashboardStats();
    
    displayExamResults(score, correct, results);
}

// DISPLAY EXAM RESULTS
function displayExamResults(score, correct, results) {
    document.getElementById('exam-quiz-section').innerHTML = `
        <div class="tool-header">
            <h3 class="section-title">Quiz Complete</h3>
            <button class="tool-back" onclick="openExamQuiz()">
                <i class="fas fa-arrow-left"></i> Back to Quizzes
            </button>
        </div>
        
        <div class="quiz-container">
            <div style="text-align: center; padding: 30px; background: var(--light-bg); border-radius: var(--border-radius-sm); margin-bottom: 30px;">
                <div style="font-size: 3rem; font-weight: 800; color: ${score >= 70 ? 'var(--success)' : 'var(--accent)'};">
                    ${score}%
                </div>
                <p style="color: var(--gray);">
                    ${correct} / ${results.length} correct
                </p>
            </div>
            
            <div id="exam-results-detailed">
                ${results.map((r, idx) => {
                    let userAnswerText = 'Not answered';
                    let correctAnswerText = '';
                    
                    if (r.type === 'multiple_response') {
                        if (Array.isArray(r.userAnswer) && r.userAnswer.length > 0) {
                            userAnswerText = r.userAnswer.map(i => 
                                `${String.fromCharCode(65 + i)}. ${r.options[i]}`
                            ).join('<br>');
                        }
                        correctAnswerText = r.correctIndices.map(i => 
                            `${String.fromCharCode(65 + i)}. ${r.options[i]}`
                        ).join('<br>');
                    } else {
                        if (r.userAnswer !== null) {
                            userAnswerText = `${String.fromCharCode(65 + r.userAnswer)}. ${r.options[r.userAnswer]}`;
                        }
                        correctAnswerText = `${r.correctAnswer}. ${r.options[r.correctIndices[0]]}`;
                    }
                    
                    return `
                        <div class="question-result" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: var(--border-radius-sm); box-shadow: var(--shadow); border-left: 4px solid ${r.isCorrect ? 'var(--success)' : 'var(--accent)'};">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <h4 style="color: var(--primary);">Question ${idx + 1}</h4>
                                <span style="background: ${r.isCorrect ? 'var(--success)' : 'var(--accent)'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem;">
                                    ${r.isCorrect ? 'Correct' : 'Incorrect'}
                                </span>
                            </div>
                            
                            <div class="question-text" style="margin-bottom: 15px;">
                                ${renderMarkdown(r.question)}
                            </div>
                            
                            ${r.image ? `
                                <div style="text-align: center; margin: 15px 0;">
                                    <img src="${r.image}" alt="Question diagram" style="max-width: 100%; height: auto; border-radius: 4px;">
                                </div>
                            ` : ''}
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Your answer:</strong><br>
                                <span style="color: ${r.isCorrect ? 'var(--success)' : 'var(--accent)'}">
                                    ${userAnswerText}
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Correct answer:</strong><br>
                                <span style="color: var(--success)">
                                    ${correctAnswerText}
                                </span>
                            </div>
                            
                            ${r.explanation ? `
                                <div style="padding: 15px; background: var(--light-bg); border-radius: var(--border-radius-sm); margin-top: 15px;">
                                    <strong>Explanation:</strong> ${renderMarkdown(r.explanation)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button class="btn" onclick="startExamQuiz(window.examQuizState.quizNumber, window.examQuizState.courseId)">
                    <i class="fas fa-redo"></i> Retake
                </button>
                <button class="btn btn-outline" onclick="openExamQuiz()">
                    <i class="fas fa-list"></i> Back to Quizzes
                </button>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        if (window.MathJax) MathJax.typesetPromise().catch(console.error);
    }, 100);
}

// HELPER FUNCTIONS
function exitExamQuiz() {
    if (window.examQuizTimer) clearInterval(window.examQuizTimer);
    if (confirm('Exit quiz? Progress will be lost.')) {
        openExamQuiz();
    }
}

function closeExamQuiz() {
    if (window.examQuizTimer) clearInterval(window.examQuizTimer);
    showPage('my-courses', document.querySelector('.sidebar-menu li:nth-child(2) a'));
}

function showExamQuizError() {
    document.getElementById('exam-quiz-section').innerHTML = `
        <div class="tool-header">
            <h3 class="section-title">Error</h3>
            <button class="tool-back" onclick="openExamQuiz()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
        <div style="text-align: center; padding: 60px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h4>Quiz Not Available</h4>
            <p style="color: var(--gray);">This quiz is coming soon.</p>
            <button class="btn" onclick="openExamQuiz()" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i> Back to Quizzes
            </button>
        </div>
    `;
}

// Export exam quiz functions globally
window.loadExamQuizConfig = loadExamQuizConfig;
window.openExamQuiz = openExamQuiz;
window.generateExamQuizButtons = generateExamQuizButtons;
window.startExamQuiz = startExamQuiz;
window.displayExamQuiz = displayExamQuiz;
window.selectExamOption = selectExamOption;
window.submitExamQuiz = submitExamQuiz;
window.exitExamQuiz = exitExamQuiz;
window.closeExamQuiz = closeExamQuiz;

// ============================================
// END EXAM QUIZ SYSTEM
// ============================================

// ============================================
// SUBSCRIPTION SYSTEM STARTS HERE
// ============================================

// Add this to your Firebase module section

async function checkSubscriptionStatus(user) {
    try {
        const userRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            
            // Initialize subscription field if doesn't exist
            if (userData.subscription === undefined) {
                await updateDoc(userRef, {
                    subscription: false,
                    subscriptionPlan: 'none',
                    subscriptionPrice: 0,
                    subscriptionStart: null,
                    subscriptionExpiry: null,
                    lastBillingDate: null
                });
                return false;
            }
            
            // Check if subscription is active
            if (userData.subscription === true) {
                // Check expiry date
                if (userData.subscriptionExpiry) {
                    const expiryDate = new Date(userData.subscriptionExpiry);
                    const currentDate = new Date();
                    if (currentDate > expiryDate) {
                        // Subscription expired
                        await updateDoc(userRef, { 
                            subscription: false,
                            subscriptionPlan: 'expired'
                        });
                        return false;
                    }
                }
                return true;
            }
            return false;
        } else {
            // Create user document
            await setDoc(userRef, {
                email: user.email,
                displayName: user.displayName || user.email,
                subscription: false,
                subscriptionPlan: 'none',
                subscriptionPrice: 0,
                subscriptionStart: null,
                subscriptionExpiry: null,
                lastBillingDate: null,
                createdAt: new Date().toISOString()
            });
            return false;
        }
    } catch (error) {
        console.error("Error checking subscription:", error);
        return false;
    }
}

// Activate subscription (for $9.99/month)
async function activateMonthlySubscription() {
    const user = auth.currentUser;
    
    console.log('🔍 Current user:', user);
    console.log('🔍 User email:', user?.email);
    console.log('🔍 User UID:', user?.uid);
    
    if (!user) {
        alert('Please log in to subscribe');
        return false;
    }
    
    try {
        // Force token refresh
        console.log('🔄 Refreshing token...');
        const token = await user.getIdToken(true);
        console.log('✅ Token refreshed:', token ? 'Success' : 'Failed');
        
        console.log('📞 Calling Cloud Function...');
        const createCheckoutSession = httpsCallable(functions, 'createCheckoutSession');
        const result = await createCheckoutSession({ plan: 'monthly' });
        
        console.log('✅ Function response:', result);
        
        // Redirect to Stripe Checkout
        window.location.href = result.data.url;
        
    } catch (error) {
        console.error('❌ Full error:', error);
        console.error('❌ Error code:', error.code);
        console.error('❌ Error message:', error.message);
        console.error('❌ Error details:', error.details);
        alert('Error starting checkout: ' + error.message);
    }
}

async function activateYearlySubscription() {
    const user = auth.currentUser;
    if (!user) {
        alert('Please log in to subscribe');
        return false;
    }
    
    try {
        // Force token refresh to ensure we have a valid auth token
        await user.getIdToken(true);
        
        const createCheckoutSession = httpsCallable(functions, 'createCheckoutSession');
        const result = await createCheckoutSession({ plan: 'yearly' });
        
        // Redirect to Stripe Checkout
        window.location.href = result.data.url;
        
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Error starting checkout: ' + error.message);
    }
}


// Update subscription UI
// Load subscription details
async function loadSubscriptionDetails() {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const userRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userRef);
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            console.log("User subscription data:", userData); // Debug
            
            // Determine plan type
            const isYearlyPlan = userData.subscriptionPlan === 'premium_yearly';
            const isMonthlyPlan = userData.subscriptionPlan === 'premium_monthly';
            
            // Update plan display
            const planDisplayElement = document.getElementById('current-plan-display');
if (planDisplayElement) {
    if (isYearlyPlan) {
        planDisplayElement.textContent = 'Premium Yearly - $99.99/year';
    } else if (isMonthlyPlan) {
        planDisplayElement.textContent = 'Premium Monthly - $9.99/month';
    } else {
        // Fallback: try to make it readable
        const planName = userData.subscriptionPlan || 'Unknown Plan';
        const readableName = planName
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
        planDisplayElement.textContent = readableName;
    }
}
            
            // Update savings display
            const savingsDisplay = document.getElementById('subscription-savings');
            if (savingsDisplay) {
                if (isYearlyPlan) {
                    savingsDisplay.style.display = 'block';
                    savingsDisplay.innerHTML = `<i class="fas fa-piggy-bank"></i> You're saving $19.89/year!`;
                } else {
                    savingsDisplay.style.display = 'none';
                }
            }
            
            // Update renews label
            const renewsLabel = document.getElementById('renews-label');
            if (renewsLabel) {
                if (isYearlyPlan) {
                    renewsLabel.textContent = 'Renews (Yearly)';
                } else if (isMonthlyPlan) {
                    renewsLabel.textContent = 'Renews (Monthly)';
                } else {
                    renewsLabel.textContent = 'Renews';
                }
            }
            
            // Show/hide yearly benefits
            const yearlyBenefits = document.getElementById('yearly-plan-benefits');
            if (yearlyBenefits) {
                yearlyBenefits.style.display = isYearlyPlan ? 'block' : 'none';
            }
            
            // Update status
            const statusElement = document.getElementById('subscription-active-status');
            if (statusElement) {
                if (userData.subscription === true) {
                    statusElement.textContent = 'Active';
                    statusElement.style.color = 'var(--success)';
                } else if (userData.subscription === false) {
                    statusElement.textContent = 'Inactive';
                    statusElement.style.color = 'var(--gray)';
                } else {
                    statusElement.textContent = 'Unknown';
                    statusElement.style.color = 'var(--gray)';
                }
            }
            
            // Helper function to format dates safely
            function formatDate(dateString) {
    if (!dateString) return 'Not Set';
    try {
        // Handle both ISO string and Firestore timestamp formats
        let date;
        
        // Check if it's a Firestore timestamp object
        if (dateString && typeof dateString === 'object' && dateString.seconds) {
            date = new Date(dateString.seconds * 1000);
        } else {
            // It's an ISO string
            date = new Date(dateString);
        }
        
        if (isNaN(date.getTime())) return 'Invalid Date';
        
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    } catch (error) {
        console.error('Date formatting error:', error, 'Input:', dateString);
        return 'Invalid Date';
    }
}
            
            // Update dates
            const startDateElement = document.getElementById('subscription-start-date');
            if (startDateElement) {
                startDateElement.textContent = formatDate(userData.subscriptionStart);
            }
            
            const expiryDateElement = document.getElementById('subscription-expiry-date');
            if (expiryDateElement) {
                expiryDateElement.textContent = formatDate(userData.subscriptionExpiry);
                
                // Check if subscription is expiring soon
                if (userData.subscriptionExpiry) {
                    try {
                        const expiryDate = new Date(userData.subscriptionExpiry);
                        const currentDate = new Date();
                        
                        if (!isNaN(expiryDate.getTime())) {
                            const daysUntilExpiry = Math.ceil((expiryDate - currentDate) / (1000 * 60 * 60 * 24));
                            
                            if (daysUntilExpiry <= 7 && statusElement) {
                                statusElement.textContent = `Active (${daysUntilExpiry} days left)`;
                                statusElement.style.color = 'var(--warning)';
                            }
                        }
                    } catch (error) {
                        console.error('Error calculating expiry:', error);
                    }
                }
            }
            
            // Add next billing info for monthly plans
            if (isMonthlyPlan && userData.subscriptionExpiry) {
                try {
                    const nextBilling = new Date(userData.subscriptionExpiry);
                    const currentDate = new Date();
                    const daysUntilBilling = Math.ceil((nextBilling - currentDate) / (1000 * 60 * 60 * 24));
                    
                    // Remove existing billing info
                    const existingBillingInfo = document.getElementById('monthly-billing-info');
                    if (existingBillingInfo) {
                        existingBillingInfo.remove();
                    }
                    
                    if (!isNaN(nextBilling.getTime()) && daysUntilBilling >= 0) {
                        const billingInfo = document.createElement('div');
                        billingInfo.id = 'monthly-billing-info';
                        billingInfo.style.cssText = `
                            background: #e8f5e8;
                            color: #2e7d32;
                            padding: 10px 15px;
                            border-radius: var(--border-radius-sm);
                            margin-top: 10px;
                            border-left: 4px solid #4caf50;
                            font-size: 0.9rem;
                        `;
                        billingInfo.innerHTML = `
                            <i class="fas fa-calendar-check" style="margin-right: 5px;"></i>
                            <strong>Next billing:</strong> ${nextBilling.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric' 
                            })} (in ${daysUntilBilling} days)
                        `;
                        
                        const expiryDateElement = document.getElementById('subscription-expiry-date');
                        if (expiryDateElement && expiryDateElement.parentNode) {
                            expiryDateElement.parentNode.insertBefore(billingInfo, expiryDateElement.nextSibling);
                        }
                    }
                } catch (error) {
                    console.error('Error creating billing info:', error);
                }
            }
            
        } else {
            console.log("No user document found");
        }
    } catch (error) {
        console.error("Error loading subscription details:", error);
        showToast('Could not load subscription details. Please refresh the page.', 'error');
    }
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    const monthlyBtn = document.getElementById('subscribe-monthly-button');
    const yearlyBtn = document.getElementById('subscribe-yearly-button');
    const cancelBtn = document.getElementById('cancel-subscription-button');
    
    if (monthlyBtn) {
        monthlyBtn.onclick = activateMonthlySubscription;
    }
    
    if (yearlyBtn) {
        yearlyBtn.onclick = activateYearlySubscription;
    }
    
    if (cancelBtn) {
        cancelBtn.onclick = openCancelModal;
    }
});

// Add these functions for subscription management
async function activateSubscription(planId) {
    const user = auth.currentUser;
    if (!user) {
        alert('Please log in to subscribe');
        return false;
    }
    
    // This is where you'll integrate with Stripe
    // For now, we'll simulate subscription activation
    const durationMap = {
        'monthly': 1,
        '3-month': 3,
        '6-month': 6,
        '12-month': 12
    };
    
    const duration = durationMap[planId] || 1;
    const success = await updateSubscriptionStatus(user.uid, true, duration);
    
    if (success) {
        isSubscriptionActive = true;
        alert('Subscription activated! You now have access to all premium content.');
        showPage('dashboard');
        return true;
    } else {
        alert('Failed to activate subscription. Please try again.');
        return false;
    }
}

async function cancelSubscription() {
    const user = auth.currentUser;
    if (!user) return false;
    
    if (confirm('Are you sure you want to cancel your subscription? You will lose access to premium content.')) {
        const success = await updateSubscriptionStatus(user.uid, false);
        if (success) {
            isSubscriptionActive = false;
            alert('Subscription cancelled. You still have access until your current period ends.');
            showPage('dashboard');
            return true;
        }
    }
    return false;
}

// Toast notification function
function showToast(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.custom-toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `custom-toast ${type}`;
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
              type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : 
              type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : 
              '<i class="fas fa-info-circle"></i>'}
            <span>${message}</span>
        </div>
    `;
    
    // Add styles
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success)' : 
                    type === 'error' ? 'var(--accent)' : 
                    type === 'warning' ? 'var(--warning)' : 'var(--primary)'};
        color: white;
        padding: 16px 24px;
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        font-weight: 500;
        max-width: 400px;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Simple function to display subscription status
function displaySubscriptionStatus() {
    const user = auth.currentUser;
    if (!user) return;
    
    const statusDisplay = document.getElementById('subscription-status-display');
    const activeSubscriptionDetails = document.getElementById('active-subscription-details');
    
    if (!statusDisplay) return;
    
    checkSubscriptionStatus(user).then(isActive => {
        const userName = user.displayName || user.email.split('@')[0];
        
        if (isActive) {
            // User is subscribed - show both status AND details
            statusDisplay.innerHTML = `
                <div class="tool-icon" style="margin: 0 auto 20px; background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);">
                    <i class="fas fa-crown"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">Premium Subscriber</h4>
                <p style="color: var(--gray); margin-bottom: 20px;">
                    <strong>Premium Member</strong> • Full Access
                </p>
                <div style="color: var(--success); font-weight: 600;">
                    <i class="fas fa-check-circle"></i> Full access to all premium content
                </div>
            `;
            
            // SHOW the active subscription details
            if (activeSubscriptionDetails) {
                activeSubscriptionDetails.style.display = 'block';
            }
            
            // Load subscription details
            setTimeout(() => loadSubscriptionDetails(), 100);
        } else {
            // User is not subscribed - hide details
            statusDisplay.innerHTML = `
                <div class="tool-icon" style="margin: 0 auto 20px; background: var(--light-gray);">
                    <i class="fas fa-lock"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 10px;">Not Subscribed</h4>
                <p style="color: var(--gray); margin-bottom: 20px;">
                    Upgrade to Premium to unlock all features and courses
                </p>
                <div style="color: var(--accent); font-weight: 600; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-circle"></i> Limited access to free content only
                </div>
            `;
            
            // HIDE the active subscription details
            if (activeSubscriptionDetails) {
                activeSubscriptionDetails.style.display = 'none';
            }
        }
    }).catch(error => {
        console.error("Error checking subscription:", error);
        statusDisplay.innerHTML = `
            <div class="tool-icon" style="margin: 0 auto 20px; background: var(--accent);">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h4 style="color: var(--primary); margin-bottom: 10px;">Status Unavailable</h4>
            <p style="color: var(--gray); margin-bottom: 20px;">
                Could not load subscription status. Please try again.
            </p>
        `;
    });
}

// Update the user name display
function updateSubscriptionUserName() {
    const user = auth.currentUser;
    if (!user) return;
    
    const userName = user.displayName || user.email.split('@')[0];
    const avatarElement = document.getElementById('subscription-avatar');
    const nameElement = document.getElementById('subscription-user-name');
    
    if (avatarElement) {
        avatarElement.textContent = user.displayName ? 
            user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 
            userName.substring(0, 2).toUpperCase();
    }
    
    if (nameElement) {
        nameElement.textContent = userName;
    }
}

// Cancel Subscription Modal Functions
function openCancelModal() {
    document.getElementById('cancel-subscription-modal').style.display = 'block';
    
    // Show/hide other reason field
    const reasonSelect = document.getElementById('cancellation-reason');
    const otherContainer = document.getElementById('other-reason-container');
    
    reasonSelect.addEventListener('change', function() {
        otherContainer.style.display = this.value === 'other' ? 'block' : 'none';
    });
}

function closeCancelModal() {
    document.getElementById('cancel-subscription-modal').style.display = 'none';
    // Reset form
    document.getElementById('cancellation-reason').value = '';
    document.getElementById('other-reason').value = '';
    document.getElementById('other-reason-container').style.display = 'none';
    document.getElementById('keep-account').checked = true;
}

async function confirmCancellation() {
    const reason = document.getElementById('cancellation-reason').value;
    const otherReason = document.getElementById('other-reason').value;
    const keepAccount = document.getElementById('keep-account').checked;
    
    // Show loading state
    const confirmBtn = document.querySelector('#cancel-subscription-modal .modal-footer .btn[onclick="confirmCancellation()"]');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelling...';
    confirmBtn.disabled = true;
    
    try {
        // Call your existing cancelSubscription function
        const success = await cancelSubscription();
        
        if (success) {
            // Close modal
            closeCancelModal();
            
            // Show success message
            showToast('Subscription cancelled successfully. You have access until the end of your billing period.', 'info');
            
            // Refresh subscription display
            setTimeout(() => {
                displaySubscriptionStatus();
                updateDashboardStats(); // Update dashboard if needed
            }, 1000);
        } else {
            throw new Error('Cancellation failed');
        }
    } catch (error) {
        console.error('Cancellation error:', error);
        showToast('Failed to cancel subscription. Please try again or contact support.', 'error');
        
        // Reset button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

    </script>

<!-- Cancel Subscription Modal -->
<div id="cancel-subscription-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cancel Subscription</h3>
            <button class="modal-close" onclick="closeCancelModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="tool-icon" style="background: var(--accent); margin: 0 auto 20px; width: 80px; height: 80px;">
                    <i class="fas fa-times-circle" style="font-size: 2.5rem;"></i>
                </div>
                <h4 style="color: var(--accent); margin-bottom: 15px;">Are you sure?</h4>
                <p style="color: var(--gray); margin-bottom: 10px;">
                    Cancelling your subscription will:
                </p>
                <ul style="text-align: left; color: var(--gray); padding-left: 20px; margin-bottom: 20px;">
                    <li>Remove access to premium courses</li>
                    <li>Hide exam-style quizzes</li>
                    <li>Disable interactive flashcards</li>
                    <li>Limit your progress tracking</li>
                </ul>
                <p style="color: var(--accent); font-weight: 600;">
                    You will still have access until the end of your billing period.
                </p>
            </div>
            
            <div class="form-group">
                <label for="cancellation-reason">Reason for cancelling (optional):</label>
                <select id="cancellation-reason" class="form-input">
                    <option value="">Select a reason</option>
                    <option value="too_expensive">Too expensive</option>
                    <option value="not_using">Not using it enough</option>
                    <option value="missing_features">Missing features I need</option>
                    <option value="technical_issues">Technical issues</option>
                    <option value="found_alternative">Found an alternative</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group" id="other-reason-container" style="display: none;">
                <label for="other-reason">Please specify:</label>
                <textarea id="other-reason" class="form-input" rows="3" placeholder="Tell us more..."></textarea>
            </div>
            
            <div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="keep-account" style="margin-top: 3px;">
                    <span style="color: var(--gray); font-size: 0.9rem;">
                        Keep my account and study progress. I can resubscribe anytime.
                    </span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeCancelModal()" style="padding: 12px 24px;">
                <i class="fas fa-arrow-left"></i> Go Back
            </button>
            <button class="btn" onclick="confirmCancellation()" style="background: var(--accent); padding: 12px 24px;">
                <i class="fas fa-times-circle"></i> Cancel Subscription
            </button>
        </div>
    </div>
</div>

</body>
</html>
