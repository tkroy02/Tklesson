<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tklesson - Tutor Employment Contract</title>
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* [KEEP ALL YOUR EXISTING CSS STYLES - NO CHANGES NEEDED] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .contract-container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
        }
        
        /* ... ALL YOUR EXISTING CSS STYLES ... */
        
        @media (max-width: 768px) {
            .contract-container {
                padding: 20px;
            }
            
            .form-row,
            .signature-box,
            .steps-container {
                grid-template-columns: 1fr;
            }
            
            .logo {
                font-size: 2em;
            }
            
            .payment-toggle {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- [KEEP ALL YOUR EXISTING HTML - NO CHANGES NEEDED] -->
    <div class="contract-container">
        <div class="header">
            <div class="logo">TK<span>LESSON</span></div>
            <div class="subtitle">Educational Tutoring Platform</div>
            <h1>TUTOR INDEPENDENT CONTRACTOR AGREEMENT</h1>
            <p>Effective Date: <span id="current-date"></span></p>
        </div>
        
        <!-- Data Entry Form -->
        <div class="form-section">
            <h2 class="section-title">CONTRACTOR INFORMATION</h2>
            <!-- ... ALL YOUR EXISTING HTML FORM FIELDS ... -->
        </div>
        
        <!-- ... ALL YOUR EXISTING HTML SECTIONS ... -->
        
        <!-- FINAL SUBMISSION STEPS -->
        <div class="final-step-section" id="final-step-section" style="display: none;">
            <!-- ... ALL YOUR EXISTING FINAL STEP HTML ... -->
        </div>
        
        <!-- Completion Button -->
        <div id="completion-button-container" style="text-align: center; margin-top: 40px; padding-top: 30px; border-top: 2px solid #eee;">
            <div class="status-message" id="status-message"></div>
            
            <button class="print-button" id="complete-contract-button" style="padding: 18px 50px; font-size: 1.2em;">
                ‚úÖ Complete & Prepare for Submission
            </button>
            
            <p style="margin-top: 20px; color: #7f8c8d; font-size: 0.9em;">
                By clicking above, you confirm all information is correct and are ready to sign as the second party.
            </p>
        </div>
    </div>

    <script>
// ============================================
// SECURITY CHECK (Keep this as is)
// ============================================

(function() {
    'use strict';
    
    const LOGIN_PAGE = 'https://www.tklesson.com/testing/contract-login.html';
    const SESSION_TIMEOUT = 8 * 60 * 60 * 1000; // 8 hours
    
    // Function to block access and redirect
    function blockAccess(message) {
        document.body.innerHTML = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
            ">
                <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                <h1 style="color: #e74c3c; font-size: 28px; margin-bottom: 15px;">Access Denied</h1>
                <p style="color: #555; font-size: 16px; margin-bottom: 20px;">${message}</p>
                <p style="color: #7f8c8d; font-size: 14px;">Redirecting to login page...</p>
            </div>
        `;
        
        sessionStorage.clear();
        
        setTimeout(() => {
            window.location.replace(LOGIN_PAGE);
        }, 2000);
        
        throw new Error('Unauthorized access blocked');
    }
    
    // Check if user is authenticated
    function checkAuthentication() {
        // 1. Check if authenticated
        const isAuth = sessionStorage.getItem('tk_auth') === 'true';
        const email = sessionStorage.getItem('tk_email');
        const uid = sessionStorage.getItem('tk_uid');
        
        if (!isAuth || !email || !uid) {
            blockAccess('You must be logged in to access this page.');
            return;
        }
        
        // 2. Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            blockAccess('Invalid session data.');
            return;
        }
        
        // 3. Check session expiration
        const loginTime = sessionStorage.getItem('tk_login_time');
        if (loginTime) {
            const sessionAge = Date.now() - parseInt(loginTime);
            if (sessionAge > SESSION_TIMEOUT) {
                blockAccess('Your session has expired. Please login again.');
                return;
            }
        }
        
        // 4. Session valid - allow access
        console.log('‚úÖ Authentication verified - Access granted');
        
        // Update last activity
        sessionStorage.setItem('tk_last_activity', Date.now().toString());
    }
    
    // Run authentication check
    checkAuthentication();
    
    // Prevent access via back button after logout
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            checkAuthentication();
        }
    });
})();

// ============================================
// FIXED CONTRACT FORM WITH GUARANTEED UNIQUE IDs
// ============================================

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBjo5LY4EsFlX8j_8NbLUObooUsCqJM8KM",
    authDomain: "tk-scheduler.firebaseapp.com",
    projectId: "tk-scheduler",
    storageBucket: "tk-scheduler.appspot.com",
    messagingSenderId: "746606755052",
    appId: "1:746606755052:web:d7eae92976cb2f2fa9f9c9",
    measurementId: "G-Q5L607R3N7"
};

// Initialize Firebase
let db;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase initialized successfully");
} catch (error) {
    console.error("Firebase initialization error:", error);
}

// ============================================
// GLOBAL VARIABLES
// ============================================

let contractId = '';
let signatureDate = '';

// ============================================
// GUARANTEED UNIQUE CONTRACT ID GENERATION
// ============================================

async function generateGuaranteedUniqueContractId(tutorEmail = '') {
    try {
        if (!db) {
            throw new Error("Firestore not initialized");
        }
        
        // Reference to our counter document
        const counterRef = db.collection('system').doc('contractIdCounter');
        
        // ATOMIC TRANSACTION - Prevents duplicates even with concurrent users
        const newId = await db.runTransaction(async (transaction) => {
            // Get current counter
            const counterDoc = await transaction.get(counterRef);
            let currentNumber;
            
            if (!counterDoc.exists) {
                // First contract ever - start from 10001
                currentNumber = 10001;
                transaction.set(counterRef, { 
                    lastId: currentNumber,
                    totalContracts: 1,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Increment the counter
                const data = counterDoc.data();
                currentNumber = data.lastId + 1;
                
                transaction.update(counterRef, { 
                    lastId: currentNumber,
                    totalContracts: (data.totalContracts || 1) + 1,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            // Create readable ID: TKL-YYYY-NNNNN (5 digits)
            const year = new Date().getFullYear();
            const paddedNumber = currentNumber.toString().padStart(5, '0');
            return `TKL-${year}-${paddedNumber}`;
        });
        
        console.log("‚úÖ Generated unique contract ID:", newId);
        return newId;
        
    } catch (error) {
        console.error("‚ùå Error generating contract ID:", error);
        
        // EMERGENCY FALLBACK - Still unique but less pretty
        try {
            // Use Firebase's auto-generated document ID as base
            const emergencyRef = db.collection('_emergencyIds').doc();
            const emergencyId = `TKL-EMG-${Date.now().toString(36).toUpperCase()}-${emergencyRef.id.substr(0, 6)}`;
            
            console.log("‚ö†Ô∏è Using emergency fallback ID:", emergencyId);
            return emergencyId;
            
        } catch (fallbackError) {
            // Last resort - timestamp with high precision
            const lastResortId = `TKL-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            console.log("üî• Using last resort ID:", lastResortId);
            return lastResortId;
        }
    }
}

// ============================================
// VALIDATE CONTRACT ID IS UNIQUE (Safety check)
// ============================================

async function validateContractIdUniqueness(contractId) {
    try {
        const query = await db.collection('contracts')
            .where('contractId', '==', contractId)
            .limit(1)
            .get();
        
        if (!query.empty) {
            console.error("üö® DUPLICATE CONTRACT ID DETECTED:", contractId);
            throw new Error(`Contract ID ${contractId} already exists in the system. This should never happen!`);
        }
        
        return true;
    } catch (error) {
        console.error("Error validating contract ID:", error);
        throw error;
    }
}

// ============================================
// INITIALIZATION FUNCTIONS
// ============================================

// Set current date for BOTH signatures
function updateSignatureDate() {
    const now = new Date();
    signatureDate = now.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Set current date display
    document.getElementById('current-date').textContent = signatureDate;
    
    // Set company signature date (FIRST SIGNER - always today)
    document.getElementById('company-date').textContent = signatureDate;
    
    // Also set contractor date (will be same when they sign)
    document.getElementById('contractor-date').textContent = signatureDate;
    
    return signatureDate;
}

// Initialize company signature (FIRST SIGNER - always signed)
function initializeCompanySignature() {
    const date = updateSignatureDate();
    
    document.getElementById('company-signature').innerHTML = `
        <div style="text-align: center;">
            <div style="display: inline-block; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 5px;">
                <div style="font-size: 1.2em; font-weight: bold; color: #2c3e50;">
                    Tklesson Management
                </div>
            </div>
            <div style="font-family: 'Georgia', serif; font-size: 1.3em; color: #000; margin: 15px 0;">
                <i>Digitally Signed</i>
            </div>
            <div style="color: #666; font-size: 0.95em;">
                <strong>Date:</strong> ${date}
            </div>
            <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 0.85em;">
                <strong>First Signatory</strong> - Offer Extended
            </div>
        </div>
    `;
    
    // Make company signature NOT clickable
    document.getElementById('company-signature').onclick = null;
    document.getElementById('company-signature').style.cursor = 'default';
}

// ============================================
// FORM VALIDATION & UPDATES (Keep as is)
// ============================================

// Update display name when name is entered
document.getElementById('contractor-name').addEventListener('input', function() {
    const name = this.value.trim();
    document.getElementById('display-name').textContent = name || '[Contractor Name]';
    document.getElementById('display-signature-name').textContent = name || '[Your Name Will Appear Here]';
    checkFormCompletion();
});

// Payment method toggle
function setupPaymentToggle() {
    const paymentBtns = document.querySelectorAll('.payment-option-btn');
    const paymentSections = document.querySelectorAll('.payment-section');
    
    paymentBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update button states
            paymentBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update section visibility
            const paymentType = this.dataset.payment;
            paymentSections.forEach(section => {
                section.classList.remove('active');
                if (section.id === `payment-${paymentType}`) {
                    section.classList.add('active');
                }
            });
            
            checkFormCompletion();
        });
    });
}

// Update payment options based on country
function updatePaymentOptions() {
    const country = document.getElementById('country-residence').value;
    const canadianBtn = document.getElementById('btn-canadian');
    const paypalBtn = document.getElementById('btn-paypal');
    
    if (country === 'CA') {
        // Canada - show Canadian banking by default
        canadianBtn.click();
        canadianBtn.style.display = 'block';
        paypalBtn.style.display = 'block';
    } else if (country === 'US' || country === 'other') {
        // US or International - show PayPal by default
        paypalBtn.click();
        canadianBtn.style.display = 'none';
        paypalBtn.style.display = 'block';
    } else {
        // No country selected
        canadianBtn.style.display = 'block';
        paypalBtn.style.display = 'block';
    }
    
    checkFormCompletion();
}

// Bank number auto-generation
function updateBankNumber() {
    const institution = document.getElementById('institution-number')?.value || '';
    const transit = document.getElementById('transit-number')?.value || '';
    const account = document.getElementById('account-number')?.value || '';
    
    if (institution && transit && account) {
        document.getElementById('full-bank-number').value = 
            `${institution}-${transit}-${account}`;
    } else {
        document.getElementById('full-bank-number').value = '';
    }
    
    checkFormCompletion();
}

// ============================================
// CONTRACTOR SIGNATURE (SECOND SIGNER)
// ============================================

// Contractor signs as second signer
document.getElementById('contractor-signature').addEventListener('click', function() {
    const name = document.getElementById('contractor-name').value.trim();
    if (!name) {
        alert('Please enter your name in the form first.');
        document.getElementById('contractor-name').focus();
        return;
    }
    
    // Ensure date is current
    updateSignatureDate();
    
    // Show contractor signature
    this.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                ${name}
            </div>
            <div style="font-family: 'Dancing Script', cursive; font-size: 1.5em; color: #27ae60;">
               ‚úçÔ∏è Countersigned
            </div>
            <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">
                ${signatureDate}
            </div>
            <div style="margin-top: 15px; padding: 5px 10px; background: #e8f5e9; border-radius: 4px; font-size: 0.85em;">
                <strong>Second Signatory</strong> - Offer Accepted
            </div>
        </div>
    `;
    this.classList.add('signed');
    
    // Update status
    document.getElementById('contractor-status').textContent = 'Signed - Offer Accepted';
    document.getElementById('contractor-status').style.color = '#27ae60';
    document.getElementById('contractor-status').style.fontWeight = 'bold';
    
    checkFormCompletion();
});

// ============================================
// FORM COMPLETION CHECK
// ============================================

function checkFormCompletion() {
    let allCompleted = true;
    
    // Required fields
    const requiredFields = [
        'contractor-name',
        'contractor-email',
        'contractor-phone',
        'contractor-address',
        'country-residence',
        'primary-subjects',
        'education-level'
    ];
    
    // Check required fields
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        if (field.type === 'select-one' || field.type === 'select') {
            if (!field.value) {
                allCompleted = false;
            }
        } else if (!field.value.trim()) {
            allCompleted = false;
        }
    });
    
    // Check checkboxes
    const ageCheck = document.getElementById('age-verification');
    const privacyCheck = document.getElementById('privacy-consent');
    const finalAgreement = document.getElementById('final-agreement');
    
    if (!ageCheck || !ageCheck.checked) {
        allCompleted = false;
    }
    
    if (!privacyCheck || !privacyCheck.checked) {
        allCompleted = false;
    }
    
    if (!finalAgreement || !finalAgreement.checked) {
        allCompleted = false;
    }
    
    // Check contractor signature
    const contractorSigned = document.getElementById('contractor-signature').classList.contains('signed');
    
    if (!contractorSigned) {
        allCompleted = false;
    }
    
    // Update completion button
    const completeButton = document.getElementById('complete-contract-button');
    if (allCompleted) {
        completeButton.disabled = false;
        completeButton.style.opacity = '1';
        completeButton.style.cursor = 'pointer';
    } else {
        completeButton.disabled = true;
        completeButton.style.opacity = '0.7';
        completeButton.style.cursor = 'not-allowed';
    }
    
    return allCompleted;
}

// ============================================
// FIREBASE FUNCTIONS - Save ALL data to contracts collection
// ============================================

// Save ALL contract and payment details to contracts collection in Firestore
async function saveAllDataToFirestore(formData) {
    try {
        if (!db) {
            throw new Error("Firestore not initialized");
        }
        
        // Create comprehensive document for contracts collection
        const allData = {
            contractId: contractId,
            
            // Contractor Information
            contractorDetails: {
                fullName: formData.contractorName,
                email: formData.contractorEmail,
                phone: formData.contractorPhone,
                address: formData.contractorAddress,
                emergencyContact: formData.emergencyContact,
                taxId: formData.contractorTaxId,
                countryResidence: formData.countryResidence,
                primarySubjects: formData.primarySubjects,
                educationLevel: formData.educationLevel,
                ageVerified: formData.ageVerification
            },
            
            // Contract Information
            contractInfo: {
                signatureDate: signatureDate,
                status: 'signed',
                signedBy: 'contractor',
                termsAccepted: true,
                privacyConsent: true,
                finalAgreement: true,
                generatedAt: new Date().toISOString()
            },
            
            // Payment Information
            paymentDetails: {
                method: formData.paymentMethod,
                country: formData.countryResidence
            },
            
            // Timestamps
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add Canadian banking details if applicable
        if (formData.paymentMethod === 'canadian') {
            allData.paymentMethodDetails = {
                bankName: formData.bankName,
                accountHolder: formData.accountHolder,
                institutionNumber: formData.institutionNumber,
                transitNumber: formData.transitNumber,
                accountNumber: formData.accountNumber,
                accountType: formData.accountType,
                fullBankNumber: formData.fullBankNumber,
                type: 'canadian_bank'
            };
        }
        
        // Add PayPal details if applicable
        if (formData.paymentMethod === 'paypal') {
            allData.paymentMethodDetails = {
                paypalEmail: formData.paypalEmail,
                currencyPreference: formData.paypalCurrency,
                feeAcknowledgment: formData.paypalFeeAcknowledgment,
                type: 'paypal'
            };
        }
        
        // Validate the contract ID is unique (safety check)
        await validateContractIdUniqueness(contractId);
        
        // Save ALL data to contracts collection
        const docRef = await db.collection('contracts').add(allData);
        
        console.log("‚úÖ All data saved to contracts collection with ID:", docRef.id);
        
        // Also update the counter collection with contract info
        await db.collection('contractLogs').add({
            contractId: contractId,
            firestoreDocId: docRef.id,
            tutorEmail: formData.contractorEmail,
            tutorName: formData.contractorName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            action: 'contract_created'
        });
        
        return docRef.id;
        
    } catch (error) {
        console.error("‚ùå Error saving data to Firestore:", error);
        throw error;
    }
}

// ============================================
// FINAL SUBMISSION FUNCTIONS (UPDATED)
// ============================================

// Collect all form data
function collectFormData() {
    const paymentMethod = document.querySelector('.payment-option-btn.active').dataset.payment;
    
    const data = {
        contractorName: document.getElementById('contractor-name').value.trim(),
        contractorEmail: document.getElementById('contractor-email').value.trim(),
        contractorPhone: document.getElementById('contractor-phone').value.trim(),
        contractorAddress: document.getElementById('contractor-address').value.trim(),
        countryResidence: document.getElementById('country-residence').value,
        emergencyContact: document.getElementById('emergency-contact').value.trim(),
        contractorTaxId: document.getElementById('contractor-tax-id').value.trim(),
        primarySubjects: document.getElementById('primary-subjects').value.trim(),
        educationLevel: document.getElementById('education-level').value,
        ageVerification: document.getElementById('age-verification').checked,
        paymentMethod: paymentMethod,
        signatureDate: signatureDate,
        privacyConsent: document.getElementById('privacy-consent').checked,
        finalAgreement: document.getElementById('final-agreement').checked
    };
    
    // Add payment-specific data
    if (paymentMethod === 'canadian') {
        data.bankName = document.getElementById('bank-name').value;
        data.accountHolder = document.getElementById('account-holder').value.trim();
        data.institutionNumber = document.getElementById('institution-number').value.trim();
        data.transitNumber = document.getElementById('transit-number').value.trim();
        data.accountNumber = document.getElementById('account-number').value.trim();
        data.accountType = document.getElementById('account-type').value;
        data.fullBankNumber = document.getElementById('full-bank-number').value;
    } else if (paymentMethod === 'paypal') {
        data.paypalEmail = document.getElementById('paypal-email').value.trim();
        data.paypalCurrency = document.getElementById('paypal-currency').value;
        data.paypalFeeAcknowledgment = document.getElementById('paypal-fee-acknowledgment').checked;
    }
    
    return data;
}

// Show final submission steps (UPDATED WITH FIXED CONTRACT ID GENERATION)
document.getElementById('complete-contract-button').addEventListener('click', async function() {
    if (!checkFormCompletion()) {
        alert('Please complete all required fields, check all boxes, and sign as the contractor.');
        return;
    }
    
    // Show loading state
    const button = this;
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Generating Contract ID...';
    button.disabled = true;
    
    // Show loading message
    document.getElementById('status-message').innerHTML = `
        <div class="status-loading" style="display: block;">
            <strong>Step 1/3:</strong> Generating guaranteed unique contract identifier...
        </div>
    `;
    document.getElementById('status-message').style.display = 'block';
    
    try {
        // STEP 1: Generate GUARANTEED UNIQUE contract ID
        contractId = await generateGuaranteedUniqueContractId(
            document.getElementById('contractor-email').value
        );
        
        // STEP 2: Validate it's actually unique (safety check)
        document.getElementById('status-message').innerHTML = `
            <div class="status-loading" style="display: block;">
                <strong>Step 2/3:</strong> Validating contract ID uniqueness...
            </div>
        `;
        
        await validateContractIdUniqueness(contractId);
        
        // STEP 3: Update all displays with the new ID
        document.getElementById('contract-id-display').textContent = contractId;
        document.getElementById('final-contract-id').textContent = contractId;
        
        // Update loading message
        document.getElementById('status-message').innerHTML = `
            <div class="status-loading" style="display: block;">
                <strong>Step 3/3:</strong> Saving contract to secure database...
            </div>
        `;
        
        // Collect form data
        const formData = collectFormData();
        formData.contractId = contractId;
        
        // Save ALL data to contracts collection in Firestore
        const documentId = await saveAllDataToFirestore(formData);
        
        // Show final steps
        document.getElementById('final-step-section').style.display = 'block';
        
        // Update email template with actual data
        updateEmailTemplate();
        
        // Show success message
        document.getElementById('status-message').innerHTML = `
            <div class="status-success" style="display: block; text-align: left;">
                <strong style="font-size: 1.1em;">üéâ Congratulations! Your tutor contract has been submitted.</strong><br><br>
                <strong>Your guaranteed unique contract ID:</strong> ${contractId}<br>
                <strong>Generation method:</strong> Firestore atomic counter (no duplicates possible)<br><br>
                <strong>Next steps:</strong><br>
                1. Save/print your contract<br>
                2. Email it to us<br>
                3. We'll review and activate your account within 48 hours
            </div>
        `;
        document.getElementById('status-message').style.display = 'block';
        
        // Store contract ID for photo upload page
        sessionStorage.setItem('tk_contract_id', contractId);
        sessionStorage.setItem('tk_contract_email', formData.contractorEmail);
        
        // Scroll to final steps
        document.getElementById('final-step-section').scrollIntoView({ 
            behavior: 'smooth' 
        });
        
        // Hide completion button
        button.style.display = 'none';
        
        // Add photo upload prompt
        setTimeout(() => {
            const photoPrompt = document.createElement('div');
            photoPrompt.className = 'important-note';
            photoPrompt.style.marginTop = '30px';
            photoPrompt.innerHTML = `
                <h4>üì∏ Ready for the next step?</h4>
                <p>Your contract is saved! Now upload your profile photo to complete your tutor profile.</p>
                <button onclick="window.open('photo-upload.html?contractId=${contractId}&email=${encodeURIComponent(formData.contractorEmail)}', '_blank')" 
                        style="background: #3498db; color: white; border: none; padding: 12px 24px; 
                               border-radius: 6px; cursor: pointer; margin-top: 10px;">
                    üì∑ Upload Profile Photo
                </button>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    You can also upload later using your contract ID: <strong>${contractId}</strong>
                </p>
            `;
            document.getElementById('final-step-section').appendChild(photoPrompt);
        }, 2000);
        
    } catch (error) {
        console.error("‚ùå Error during contract submission:", error);
        
        // Show error message
        document.getElementById('status-message').innerHTML = `
            <div class="status-error" style="display: block;">
                <strong>‚ùå Contract Submission Failed:</strong><br>
                ${error.message || 'Unknown error occurred'}<br><br>
                <strong>Please try again or contact support with this information.</strong>
            </div>
        `;
        document.getElementById('status-message').style.display = 'block';
        
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
    }
});

// Update email template with actual data
function updateEmailTemplate() {
    const name = document.getElementById('contractor-name').value;
    const email = document.getElementById('contractor-email').value;
    const phone = document.getElementById('contractor-phone').value;
    
    const template = `Subject: Tklesson Tutor Contract Submission - ${name}

Dear Tklesson Team,

Please find attached my completed and signed Tutor Independent Contractor Agreement.

Contract Details:
- Name: ${name}
- Email: ${email}
- Phone: ${phone}
- Contract ID: ${contractId}
- Date Signed: ${signatureDate}
- Signing Order: Second Signatory (Accepted Tklesson's offer)

I have reviewed and agreed to all terms and conditions outlined in the contract.

Please confirm receipt and next steps.

Sincerely,

${name}`;
    
    document.getElementById('email-template').textContent = template;
}

// Copy email template to clipboard
function copyEmailTemplate() {
    const template = document.getElementById('email-template').textContent;
    navigator.clipboard.writeText(template)
        .then(() => {
            alert('Email template copied to clipboard!');
        })
        .catch(err => {
            console.error('Failed to copy: ', err);
        });
}

// Open email client with pre-filled template
function openEmailWithTemplate() {
    if (!contractId) {
        alert('Please complete the contract first.');
        return;
    }
    
    const name = document.getElementById('contractor-name').value;
    const email = document.getElementById('contractor-email').value;
    
    const subject = `Tklesson Tutor Contract Submission - ${name}`;
    const body = `Dear Tklesson Team,

Please find attached my completed and signed Tutor Independent Contractor Agreement.

Contract Details:
- Name: ${name}
- Email: ${email}
- Contract ID: ${contractId}
- Date Signed: ${signatureDate}
- Signing Order: Second Signatory (Accepted Tklesson's offer)

I have reviewed and agreed to all terms and conditions outlined in the contract.

Please confirm receipt and next steps.

Sincerely,

${name}`;
    
    window.location.href = `mailto:info@tklesson.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================

// Add event listeners for dynamic validation
function setupEventListeners() {
    // Listen to all inputs for validation
    document.querySelectorAll('.form-input, select').forEach(field => {
        field.addEventListener('input', checkFormCompletion);
        field.addEventListener('change', checkFormCompletion);
    });
    
    // Listen to checkboxes
    document.getElementById('age-verification').addEventListener('change', checkFormCompletion);
    document.getElementById('privacy-consent').addEventListener('change', checkFormCompletion);
    document.getElementById('final-agreement').addEventListener('change', checkFormCompletion);
    document.getElementById('paypal-fee-acknowledgment').addEventListener('change', checkFormCompletion);
    
    // Listen to country change
    document.getElementById('country-residence').addEventListener('change', function() {
        updatePaymentOptions();
        checkFormCompletion();
    });
    
    // Bank number auto-update
    if (document.getElementById('institution-number')) {
        document.getElementById('institution-number').addEventListener('input', updateBankNumber);
        document.getElementById('transit-number').addEventListener('input', updateBankNumber);
        document.getElementById('account-number').addEventListener('input', updateBankNumber);
    }
    
    // Auto-fill institution number based on bank selection
    if (document.getElementById('bank-name')) {
        document.getElementById('bank-name').addEventListener('change', function() {
            const bankCodes = {
                'td': '004',
                'rbc': '003',
                'scotiabank': '002',
                'bmo': '001',
                'cibc': '010',
                'hsbc': '016',
                'national': '006',
                'tangerine': '614'
            };
            
            const selectedBank = this.value;
            if (bankCodes[selectedBank]) {
                document.getElementById('institution-number').value = bankCodes[selectedBank];
                updateBankNumber();
            } else if (selectedBank === 'other') {
                document.getElementById('institution-number').value = '';
                document.getElementById('institution-number').focus();
            }
        });
    }
}

// ============================================
// CHECK FOR EXISTING CONTRACT
// ============================================

async function checkExistingContract() {
    const email = sessionStorage.getItem('tk_email');
    if (!email) return;
    
    try {
        const query = await db.collection('contracts')
            .where('contractorDetails.email', '==', email)
            .limit(1)
            .get();
        
        if (!query.empty) {
            const contractData = query.docs[0].data();
            
            // Show notification that contract already exists
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #fff3cd;
                border: 2px solid #ffc107;
                padding: 15px 25px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                max-width: 500px;
                text-align: center;
            `;
            notification.innerHTML = `
                <strong>üìã Contract Already Submitted</strong><br>
                <span style="font-size: 0.9em;">
                    Contract ID: ${contractData.contractId}<br>
                    You're viewing your existing contract.
                </span>
            `;
            document.body.appendChild(notification);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 10000);
            
            // Pre-fill the contract ID display
            contractId = contractData.contractId;
            document.getElementById('contract-id-display').textContent = contractId;
        }
    } catch (error) {
        console.error('Error checking contract:', error);
    }
}

// ============================================
// LOGOUT FUNCTION
// ============================================

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        sessionStorage.clear();
        window.location.href = 'https://www.tklesson.com/testing/contract-login.html';
    }
}

// ============================================
// INITIALIZE EVERYTHING
// ============================================

async function init() {
    console.log("Initializing contract form...");
    
    // Initialize Firebase services
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    
    // Initialize signatures
    initializeCompanySignature();
    
    // Setup payment and event listeners
    setupPaymentToggle();
    setupEventListeners();
    updatePaymentOptions();
    checkFormCompletion();
    
    // Check for existing contract
    await checkExistingContract();
    
    console.log("‚úÖ Contract form initialized successfully");
}

// Run initialization when page loads
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
