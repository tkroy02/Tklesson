// Initialize the dashboard only when authentication state is ready
document.addEventListener('DOMContentLoaded', () => {
  // Use Firebase's onAuthStateChanged instead of manual polling
  auth.onAuthStateChanged(user => {
    if (user) {
      console.log('User authenticated:', user.uid);
      initDashboard(user);
    } else {
      console.log('No user signed in â€” redirecting to login...');
      window.location.href = 'student-login.html';
    }
  });
});

function initDashboard(user) {
  console.log('Initializing dashboard for user:', user.uid);

  // Initialize package store
  initPackageStore();

  // --------------------------
  // Navigation setup
  // --------------------------
  document.querySelectorAll('.menu-item a').forEach(item => {
    item.addEventListener('click', function (e) {
      e.preventDefault();

      // Update active menu item
      document.querySelectorAll('.menu-item a').forEach(a => a.classList.remove('active'));
      this.classList.add('active');

      // Show the corresponding section
      const sectionId = this.getAttribute('data-section');
      document.querySelectorAll('.dashboard-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');

      // Load specific data based on the section
      if (sectionId === 'scheduling') {
        if (!schedulingLoaded) {
          loadTutorsForScheduling();
          schedulingLoaded = true;
        }
        updateBookingButtonState();
      } else if (sectionId === 'tutors') {
        if (!tutorsLoaded) {
          loadMyTutors();
          loadAvailableTutors();
          tutorsLoaded = true;
        }
      } else if (sectionId === 'bookings') {
        if (!bookingsLoaded) {
          loadUserBookings();
          bookingsLoaded = true;
        }
      } else if (sectionId === 'sessions') {
        if (!sessionsLoaded) {
          loadUserSessionHistory();
          sessionsLoaded = true;
        }
      } else if (sectionId === 'packages') {
        loadPackageBalance();
      } else if (sectionId === 'chat') {
        if (!chatSystemInitialized) {
          initChatSystem();
          chatSystemInitialized = true;
        } else {
          loadChatContacts();
        }
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) chatContainer.style.display = 'block';
      }
    });
  });

  // --------------------------
  // Logout button
  // --------------------------
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      auth.signOut()
        .then(() => window.location.href = 'student-login.html')
        .catch(error => console.error('Logout error:', error));
    });
  }

  // --------------------------
  // Profile section
  // --------------------------
  const editBtn = document.getElementById('editProfileBtn');
  const form = document.getElementById('profileForm');
  const saveBtn = document.getElementById('saveProfileBtn');

  if (editBtn && form) {
    editBtn.addEventListener('click', function () {
      const isHidden = form.style.display === 'none' || form.style.display === '';
      form.style.display = isHidden ? 'block' : 'none';
      this.textContent = isHidden ? 'Cancel Editing' : 'Edit Profile';
    });
  }

  if (saveBtn) {
    saveBtn.addEventListener('click', saveProfile);
  }
}
