<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Learning Scheduler</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Basic styling for layout - keeping minimal for functionality */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: linear-gradient(to bottom, #4361ee, #3a0ca3);
            color: white;
            padding: 20px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
        }
        
        .dashboard-section {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .dashboard-section.active {
            display: block;
        }
        
        .section-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .session-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .session-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-verified {
            background: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        .status-cancelled {
            background: rgba(230, 57, 70, 0.1);
            color: #e63946;
        }
        
        .session-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-primary {
            background: #4361ee;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-outline {
            background: transparent;
            color: #4361ee;
            border: 1px solid #4361ee;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
        }
        
        .tab.active {
            border-bottom: 2px solid #4361ee;
            color: #4361ee;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .sessions-table th, .sessions-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .sessions-table th {
            background: #f8f9fa;
        }
        
        .filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .filter-container select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: #4361ee;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                height: 100vh;
                transition: left 0.3s;
                z-index: 999;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding-top: 70px;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .stats-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <h1>Tklesson</h1>
                </div>
                <div class="user-info">
                    <div class="user-details">
                        <h3 id="userName">Loading...</h3>
                        <p id="userRole">Student</p>
                    </div>
                </div>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="#profile" class="active" data-section="profile">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#scheduling" data-section="scheduling">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Scheduling</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#tutors" data-section="tutors">
                        <i class="fas fa-user-tie"></i>
                        <span>My Tutors</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#bookings" data-section="bookings">
                        <i class="fas fa-bookmark"></i>
                        <span>My Bookings</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#sessions" data-section="sessions">
                        <i class="fas fa-history"></i>
                        <span>Sessions History</span>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="page-title">
                    <h2>Student Dashboard</h2>
                    <p>Welcome back! Here's your learning overview</p>
                </div>
                <div class="top-bar-actions">
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="upcomingSessionsCount">0</div>
                    <div class="stat-label">Upcoming Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tutorsCount">0</div>
                    <div class="stat-label">Active Tutors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="hoursLearned">0</div>
                    <div class="stat-label">Hours Learned</div>
                </div>
            </div>

            <section id="profile" class="dashboard-section active">
                <div class="section-header">
                    <h3><i class="fas fa-user-circle"></i> Profile Information</h3>
                </div>
                <div class="profile-card">
                    <div class="profile-details">
                        <h3 id="profileName">Loading...</h3>
                        <p><i class="fas fa-envelope"></i> <span id="profileEmail">Loading...</span></p>
                        <p><i class="fas fa-user-tag"></i> <span id="profileRole">Student Account</span></p>
                        <span class="status-badge status-verified" id="profileStatus">Verified</span>
                    </div>
                </div>
            </section>

            <section id="scheduling" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-calendar-alt"></i> New Booking</h3>
                </div>
                <p>Scheduling functionality would go here.</p>
            </section>

            <section id="tutors" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-user-tie"></i> Find Tutors</h3>
                </div>
                <p>Tutors functionality would go here.</p>
            </section>

            <section id="bookings" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-bookmark"></i> My Bookings</h3>
                </div>
                <div id="bookingsContainer">
                    <p>Loading your bookings...</p>
                </div>
            </section>

            <section id="sessions" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-history"></i> Sessions History</h3>
                </div>
                
                <div class="filter-container">
                    <div>
                        <label>Filter by Date Range:</label>
                        <select id="historyFilter" class="form-control">
                            <option value="all">All Time</option>
                            <option value="month">This Month</option>
                            <option value="3months">Last 3 Months</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div>
                        <label>Action Type:</label>
                        <select id="actionTypeFilter" class="form-control">
                            <option value="all">All Actions</option>
                            <option value="student booked">Student Booked</option>
                            <option value="tutor confirmed">Tutor Confirmed</option>
                            <option value="auto-confirmed">Auto-Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="student cancelled">Student Cancelled</option>
                            <option value="tutor cancelled">Tutor Cancelled</option>
                            <option value="tutor reschedule request">Tutor Reschedule Request</option>
                            <option value="student reschedule request">Student Reschedule Request</option>
                            <option value="rescheduled">Rescheduled</option>
                        </select>
                    </div>
                </div>

                <div id="sessionsContainer">
                    <p>Loading session history...</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjo5LY4EsFlX8j_8NbLUObooUsCqJM8KM",
            authDomain: "tk-scheduler.firebaseapp.com",
            projectId: "tk-scheduler",
            storageBucket: "tk-scheduler.appspot.com",
            messagingSenderId: "746606755052",
            appId: "1:746606755052:web:d7eae92976cb2f2fa9f9c9",
            measurementId: "G-Q5L607R3N7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let sessionsData = [];
        let currentUser = null;
        let userData = null;

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData();
            } else {
                window.location.href = 'student-login.html';
            }
        });

        // Load user data from Firestore
        function loadUserData() {
            db.collection('students').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        document.getElementById('userName').textContent = userData.fullName || 'Unknown User';
                        document.getElementById('profileName').textContent = userData.fullName || 'Unknown User';
                        document.getElementById('profileEmail').textContent = currentUser.email;
                        
                        // Initialize dashboard
                        initDashboard();
                    } else {
                        console.error('No user data found');
                    }
                })
                .catch((error) => {
                    console.error('Error getting user data:', error);
                });
        }

        // Initialize dashboard functionality
        function initDashboard() {
            // Set up navigation
            document.querySelectorAll('.menu-item a').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Update active menu item
                    document.querySelectorAll('.menu-item a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show the corresponding section
                    const sectionId = this.getAttribute('data-section');
                    document.querySelectorAll('.dashboard-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(sectionId).classList.add('active');

                    // Load data for the selected section
                    if (sectionId === 'bookings') {
                        loadUserBookings();
                    } else if (sectionId === 'sessions') {
                        loadUserSessionHistory();
                    }
                });
            });
            
            // Set up logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    auth.signOut().then(() => {
                        window.location.href = 'student-login.html';
                    });
                }
            });
            
            // Set up mobile menu toggle
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Set up filter event listeners
            document.getElementById('historyFilter').addEventListener('change', applyFilters);
            document.getElementById('actionTypeFilter').addEventListener('change', applyFilters);
            
            // Load initial data
            loadUserBookings();
            loadUserSessionHistory();
            updateUserStats();
        }

        // Load user bookings
        function loadUserBookings() {
            const container = document.getElementById('bookingsContainer');
            container.innerHTML = '<p>Loading your bookings...</p>';
            
            // In a real implementation, this would query Firestore
            // For now, we'll use mock data
            setTimeout(() => {
                const mockBookings = [
                    {
                        id: '1',
                        subject: 'Mathematics',
                        date: new Date(Date.now() + 86400000), // Tomorrow
                        tutorName: 'John Smith',
                        duration: '1.5',
                        sessionType: 'online',
                        status: 'confirmed'
                    },
                    {
                        id: '2',
                        subject: 'Physics',
                        date: new Date(Date.now() + 172800000), // Day after tomorrow
                        tutorName: 'Jane Doe',
                        duration: '2',
                        sessionType: 'in-person',
                        status: 'pending'
                    }
                ];
                
                if (mockBookings.length === 0) {
                    container.innerHTML = '<p>You have no upcoming bookings.</p>';
                    return;
                }
                
                let html = '';
                mockBookings.forEach(booking => {
                    const formattedDate = booking.date.toLocaleDateString();
                    const formattedTime = booking.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    html += `
                        <div class="session-card">
                            <div class="session-header">
                                <div class="session-title">${booking.subject}</div>
                                <div class="session-date">${formattedDate} at ${formattedTime}</div>
                            </div>
                            <div class="session-details">
                                <div class="session-detail">
                                    <i class="fas fa-user-tie"></i>
                                    <span>Tutor: ${booking.tutorName}</span>
                                </div>
                                <div class="session-detail">
                                    <i class="fas fa-clock"></i>
                                    <span>Duration: ${booking.duration} hours</span>
                                </div>
                                <div class="session-detail">
                                    <i class="fas fa-video"></i>
                                    <span>Type: ${booking.sessionType === 'in-person' ? 'In-Person' : 'Online'}</span>
                                </div>
                                <div class="session-detail">
                                    <i class="fas fa-hourglass-half"></i>
                                    <span>Status: <span class="status-badge ${getStatusClass(booking.status)}">${booking.status}</span></span>
                                </div>
                            </div>
                            <div class="session-actions">
                                <button class="btn-primary" onclick="joinSession('${booking.id}')">Join Session</button>
                                <button class="btn-outline" onclick="cancelBooking('${booking.id}')">Cancel</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateUpcomingSessionsCount(mockBookings.length);
            }, 500);
        }

        // Load user session history
        function loadUserSessionHistory() {
            const container = document.getElementById('sessionsContainer');
            container.innerHTML = '<p>Loading session history...</p>';
            
            // In a real implementation, this would query Firestore
            // For now, we'll use mock data with proper timestamps
            setTimeout(() => {
                // Generate mock session data with various dates
                const now = new Date();
                const mockSessions = [
                    {
                        id: '1',
                        date: new Date(now.getFullYear(), now.getMonth(), now.getDate() - 5), // 5 days ago
                        tutorName: 'John Smith',
                        subject: 'Mathematics',
                        duration: '1.5',
                        status: 'completed',
                        actionTime: new Date(now.getFullYear(), now.getMonth(), now.getDate() - 5, 14, 30),
                        actionType: 'Student Booked'
                    },
                    {
                        id: '2',
                        date: new Date(now.getFullYear(), now.getMonth() - 1, 15), // Last month
                        tutorName: 'Jane Doe',
                        subject: 'Physics',
                        duration: '2',
                        status: 'completed',
                        actionTime: new Date(now.getFullYear(), now.getMonth() - 1, 15, 10, 0),
                        actionType: 'Tutor Confirmed'
                    },
                    {
                        id: '3',
                        date: new Date(now.getFullYear(), now.getMonth() - 2, 10), // 2 months ago
                        tutorName: 'Robert Johnson',
                        subject: 'Chemistry',
                        duration: '1',
                        status: 'cancelled',
                        actionTime: new Date(now.getFullYear(), now.getMonth() - 2, 10, 16, 45),
                        actionType: 'Student Cancelled'
                    },
                    {
                        id: '4',
                        date: new Date(now.getFullYear() - 1, 11, 20), // Last year
                        tutorName: 'Sarah Williams',
                        subject: 'Biology',
                        duration: '1.5',
                        status: 'completed',
                        actionTime: new Date(now.getFullYear() - 1, 11, 20, 9, 15),
                        actionType: 'Completed'
                    },
                    {
                        id: '5',
                        date: new Date(now.getFullYear(), now.getMonth(), now.getDate() - 10), // 10 days ago
                        tutorName: 'Michael Brown',
                        subject: 'English',
                        duration: '1',
                        status: 'rescheduled',
                        actionTime: new Date(now.getFullYear(), now.getMonth(), now.getDate() - 10, 11, 20),
                        actionType: 'Rescheduled'
                    }
                ];
                
                // Store the data for filtering
                sessionsData = mockSessions;
                
                if (mockSessions.length === 0) {
                    container.innerHTML = '<p>No session history found.</p>';
                    return;
                }
                
                // Display the sessions
                displaySessions(mockSessions);
            }, 500);
        }

        // Display sessions in the table
        function displaySessions(sessions) {
            const container = document.getElementById('sessionsContainer');
            
            let html = `
                <table class="sessions-table">
                    <thead>
                        <tr>
                            <th>Session Date</th>
                            <th>Session Time</th>
                            <th>Tutor</th>
                            <th>Subject</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Action Date</th>
                            <th>Action Type</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sessions.forEach(session => {
                const sessionDate = session.date;
                const formattedDate = sessionDate.toLocaleDateString();
                const formattedTime = sessionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const actionTime = session.actionTime;
                const actionDate = actionTime.toLocaleDateString();
                const actionTimeFormatted = actionTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                html += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td>${session.tutorName}</td>
                        <td>${session.subject}</td>
                        <td>${session.duration} hours</td>
                        <td><span class="status-badge ${getStatusClass(session.status)}">${session.status}</span></td>
                        <td>
                            <div>${actionDate}</div>
                            <div style="font-size: 11px; color: #888;">${actionTimeFormatted}</div>
                        </td>
                        <td><span class="status-badge ${getActionTypeClass(session.actionType)}">${session.actionType}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Apply filters to sessions
        function applyFilters() {
            const timeFilter = document.getElementById('historyFilter').value;
            const actionFilter = document.getElementById('actionTypeFilter').value;
            
            let filteredSessions = [...sessionsData];
            
            // Apply time filter based on actual date objects
            if (timeFilter !== 'all') {
                const now = new Date();
                let startDate;
                
                switch(timeFilter) {
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case '3months':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                        break;
                    case 'quarter':
                        const currentQuarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), currentQuarter * 3, 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                }
                
                filteredSessions = filteredSessions.filter(session => {
                    return session.actionTime >= startDate;
                });
            }
            
            // Apply action type filter
            if (actionFilter !== 'all') {
                filteredSessions = filteredSessions.filter(session => {
                    return session.actionType.toLowerCase() === actionFilter.toLowerCase();
                });
            }
            
            // Display filtered results
            displaySessions(filteredSessions);
            
            // Show message if no results
            if (filteredSessions.length === 0) {
                const container = document.getElementById('sessionsContainer');
                container.innerHTML = '<p>No sessions match your filters.</p>';
            }
        }

        // Helper function to get CSS class for status badges
        function getStatusClass(status) {
            switch(status) {
                case 'confirmed':
                case 'completed':
                    return 'status-verified';
                case 'pending':
                    return 'status-pending';
                case 'cancelled':
                    return 'status-cancelled';
                case 'rescheduled':
                    return 'status-pending';
                default:
                    return 'status-pending';
            }
        }

        // Helper function to get CSS class for action types
        function getActionTypeClass(actionType) {
            switch(actionType.toLowerCase()) {
                case 'student booked':
                case 'tutor confirmed':
                case 'auto-confirmed':
                case 'completed':
                    return 'status-verified';
                case 'student cancelled':
                case 'tutor cancelled':
                    return 'status-cancelled';
                case 'tutor reschedule request':
                case 'student reschedule request':
                case 'rescheduled':
                    return 'status-pending';
                default:
                    return 'status-pending';
            }
        }

        // Update user stats
        function updateUserStats() {
            // In a real implementation, this would calculate from Firestore data
            document.getElementById('upcomingSessionsCount').textContent = '2';
            document.getElementById('tutorsCount').textContent = '3';
            document.getElementById('hoursLearned').textContent = '15.5';
        }

        // Placeholder functions for button actions
        function joinSession(sessionId) {
            alert(`Joining session ${sessionId}`);
        }

        function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                alert(`Booking ${bookingId} cancelled`);
                // In a real implementation, this would update Firestore
                loadUserBookings(); // Refresh the list
            }
        }

        function updateUpcomingSessionsCount(count) {
            document.getElementById('upcomingSessionsCount').textContent = count;
        }
    </script>
</body>
</html>
