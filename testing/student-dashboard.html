// Initialize Firebase with compat version
firebase.initializeApp(firebaseConfig);

// Initialize Firebase services
const auth = firebase.auth();
const db = firebase.firestore();

// Global variables
let currentUser = null;
let userData = null;
let sessionsDataLoaded = false;
let tutorsLoaded = false;
let bookingsLoaded = false;
let sessionsLoaded = false;
let schedulingLoaded = false; // â† ADD THIS
let inactivityTimer;

// Initialize the dashboard
function initDashboard() {
  // Wait for authentication to be ready
  if (!auth.currentUser) {
    console.log('Waiting for authentication...');
    setTimeout(initDashboard, 500); // Retry in 500ms
    return;
  }
  
  console.log('Initializing dashboard for user:', auth.currentUser.uid);
  
  // Initialize package store - ADD THIS LINE
  initPackageStore();
  
  // Set up navigation
  document.querySelectorAll('.menu-item a').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Update active menu item
      document.querySelectorAll('.menu-item a').forEach(a => a.classList.remove('active'));
      this.classList.add('active');
      
      // Show the corresponding section
      const sectionId = this.getAttribute('data-section');
      document.querySelectorAll('.dashboard-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');

      // Load specific data based on the section - ONLY if not already loaded
      if (sectionId === 'scheduling') {
        if (!schedulingLoaded) {
          loadTutorsForScheduling();
          schedulingLoaded = true;
        }
        // ADD THIS LINE HERE - it should run every time scheduling section is opened
        updateBookingButtonState();
      } else if (sectionId === 'tutors') {
        // Load both my tutors and available tutors when the tutors section is opened
        if (!tutorsLoaded) {
          loadMyTutors();
          loadAvailableTutors();
          tutorsLoaded = true;
        }
      } else if (sectionId === 'bookings') {
        if (!bookingsLoaded) {
          loadUserBookings();
          bookingsLoaded = true;
        }
      } else if (sectionId === 'sessions') {
        // Only load sessions history on first visit to the tab
        if (!sessionsLoaded) {
          loadUserSessionHistory();
          sessionsLoaded = true;
        }
      }
      // ADD PACKAGES SECTION HANDLING HERE IF NEEDED
      else if (sectionId === 'packages') {
        // Refresh package balance when packages section is opened
        loadPackageBalance();
      }
      // ADD CHAT SECTION HANDLING
      else if (sectionId === 'chat') {
        // Initialize chat system only once
        if (!chatSystemInitialized) {
          initChatSystem();
        } else {
          // Just reload contacts if already initialized
          loadChatContacts();
        }
        
        // Ensure chat container is visible
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
          chatContainer.style.display = 'block';
        }
      }
    });
  });
  
  // Set up logout button
  document.getElementById('logoutBtn').addEventListener('click', function() {
    auth.signOut().then(() => {
      window.location.href = 'student-login.html';
    }).catch(error => {
      console.error('Logout error:', error);
    });
  });

  //......................................................................................
  //Profile Section starts here. All JS functionalities of the profile section starts here
  //.......................................................................................
  
  // Set up profile editing
  document.getElementById('editProfileBtn').addEventListener('click', function() {
    const form = document.getElementById('profileForm');
    if (form.style.display === 'none') {
      form.style.display = 'block';
      this.textContent = 'Cancel Editing';
    } else {
      form.style.display = 'none';
      this.textContent = 'Edit Profile';
    }
  });

  // Set up profile saving
  document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
}  // <-- CLOSES initDashboard() function

// Initialize the dashboard when the page loads
document.addEventListener('DOMContentLoaded', initDashboard); 

async function loadDashboardData() {
  await loadUserData(currentUser.uid);
  await loadMyTutors();
  await loadUserBookings();
  updateActiveTutorsCount();
}
  
// Load user data from Firestore
function loadUserData() {
  if (!currentUser) return;

  db.collection('students').doc(currentUser.uid).get()
    .then(doc => {
      if (doc.exists) {
        userData = doc.data();
        updateUIWithUserData();
      } else {
        console.error('No user data found');
      }
    })
    .catch(error => {
      console.error('Error loading user data:', error);
    });
}

// Update UI with user data
function updateUIWithUserData() {
  if (!userData) return;

  // Update user name and email in various places
  const userNameElements = document.querySelectorAll('#userName, #profileName');
  userNameElements.forEach(el => {
    el.textContent = userData.name || 'User';
  });

  const userEmailElements = document.querySelectorAll('#profileEmail, #email');
  userEmailElements.forEach(el => {
    el.value = userData.email || currentUser.email;
    if (el.tagName === 'SPAN') {
      el.textContent = userData.email || currentUser.email;
    }
  });

  // Update profile form fields
  document.getElementById('fullName').value = userData.name || '';
  document.getElementById('phone').value = userData.phone || '';
  document.getElementById('role').value = userData.role || 'Student';

  // Update profile status
  const profileStatus = document.getElementById('profileStatus');
  if (userData.emailVerified || currentUser.emailVerified) {
    profileStatus.textContent = 'Verified';
    profileStatus.className = 'status-badge status-verified';
  } else {
    profileStatus.textContent = 'Pending Verification';
    profileStatus.className = 'status-badge status-pending';
  }
}

// Save profile data to Firestore
function saveProfile() {
  if (!currentUser) return;

  const name = document.getElementById('fullName').value;
  const phone = document.getElementById('phone').value;

  // Update user data in Firestore
  db.collection('students').doc(currentUser.uid).update({
    name: name,
    phone: phone,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert('Profile updated successfully!');
    // Reload user data to update UI
    loadUserData();
    // Hide the form
    document.getElementById('profileForm').style.display = 'none';
    document.getElementById('editProfileBtn').textContent = 'Edit Profile';
  })
  .catch(error => {
    console.error('Error updating profile:', error);
    alert('Error updating profile. Please try again.');
  });
}

//.............................................................................
//Profile Section ends. All JS functionalities of the profile section ends here
//.............................................................................
