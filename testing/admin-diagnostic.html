<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Access Diagnostic Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #6a7eee;
            --primary-dark: #2f4ac0;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --error: #e63946;
            --warning: #ffc107;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 16px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            height: 50px;
        }

        .logo h1 {
            font-size: 24px;
            color: var(--primary);
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .card-header h2 {
            font-size: 22px;
            color: var(--primary-dark);
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: var(--gray);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: var(--light);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            align-items: center;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .status-success {
            background: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }

        .status-error {
            background: rgba(230, 57, 70, 0.2);
            color: var(--error);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .status-text {
            font-weight: 500;
        }

        .status-details {
            color: var(--gray);
            font-size: 14px;
            margin-top: 5px;
        }

        .log-output {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }

        .log-time {
            color: #75715e;
            margin-right: 10px;
        }

        .log-info {
            color: #a6e22e;
        }

        .log-error {
            color: #f92672;
        }

        .log-warning {
            color: #fd971f;
        }

        .solution-box {
            background: rgba(76, 201, 240, 0.1);
            border-left: 4px solid var(--success);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .solution-box h3 {
            color: var(--success);
            margin-bottom: 10px;
        }

        .firestore-data {
            margin: 15px 0;
        }

        .data-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            padding: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: 500;
            color: var(--gray);
        }

        .hidden {
            display: none;
        }

        .rule-error {
            background: rgba(230, 57, 70, 0.1);
            border-left: 4px solid var(--error);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .rule-error h3 {
            color: var(--error);
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .data-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-tools" style="font-size: 30px; color: var(--primary);"></i>
                <h1>Admin Access Diagnostic Tool</h1>
            </div>
            <button class="btn btn-primary" id="runDiagnostics">
                <i class="fas fa-play-circle"></i> Run Diagnostics
            </button>
        </header>

        <div class="card">
            <div class="card-header">
                <h2>Connection Status</h2>
            </div>
            <div id="connectionStatus">
                <div class="status-item">
                    <div class="status-info">
                        <div class="status-icon status-warning">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div>
                            <div class="status-text">Firebase Connection</div>
                            <div class="status-details">Click "Run Diagnostics" to check connection</div>
                        </div>
                    </div>
                    <div class="status-result">Pending</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Authentication Status</h2>
            </div>
            <div id="authStatus">
                <div class="status-item">
                    <div class="status-info">
                        <div class="status-icon status-warning">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div>
                            <div class="status-text">User Authentication</div>
                            <div class="status-details">Click "Run Diagnostics" to check authentication status</div>
                        </div>
                    </div>
                    <div class="status-result">Pending</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Admin Privileges Check</h2>
            </div>
            <div id="adminStatus">
                <div class="status-item">
                    <div class="status-info">
                        <div class="status-icon status-warning">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div>
                            <div class="status-text">Admin Collection Access</div>
                            <div class="status-details">Checking if your user ID exists in the admins collection</div>
                        </div>
                    </div>
                    <div class="status-result">Pending</div>
                </div>
            </div>
            <div id="adminDetails" class="hidden">
                <div class="firestore-data">
                    <div class="data-row">
                        <div class="data-label">Your User ID:</div>
                        <div id="userUID">Not found</div>
                    </div>
                    <div class="data-row">
                        <div class="data-label">Admin Document Exists:</div>
                        <div id="adminDocExists">Checking...</div>
                    </div>
                    <div class="data-row">
                        <div class="data-label">Document Data:</div>
                        <div id="adminDocData">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Security Rules Analysis</h2>
            </div>
            <div id="rulesAnalysis">
                <div class="status-item">
                    <div class="status-info">
                        <div class="status-icon status-warning">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div>
                            <div class="status-text">Firestore Rules Check</div>
                            <div class="status-details">Checking if rules allow access to admins collection</div>
                        </div>
                    </div>
                    <div class="status-result">Pending</div>
                </div>
                <div id="rulesDetails" class="hidden">
                    <div class="rule-error">
                        <h3><i class="fas fa-exclamation-triangle"></i> Security Rules Issue Detected</h3>
                        <p>Your Firestore security rules don't include any rules for the <code>admins</code> collection.</p>
                        <p>This means it falls under the default rule:</p>
                        <pre>match /{document=**} {
  allow read, write: if false;
}</pre>
                        <p>Which blocks all client-side access to the admins collection.</p>
                    </div>
                    
                    <div class="solution-box">
                        <h3><i class="fas fa-lightbulb"></i> Solution</h3>
                        <p>Add these rules to your Firestore security rules:</p>
                        <pre>
// ----------------------
// Admins Collection
// ----------------------
match /admins/{adminId} {
  // Only admins can read the admin collection
  allow read: if isAdmin();
  
  // No client-side write access to admin collection
  allow write: if false;
}
                        </pre>
                        <p>After adding these rules, deploy them and run the diagnostic again.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Diagnostic Log</h2>
            </div>
            <div class="log-output" id="diagnosticLog">
                <div class="log-entry">
                    <span class="log-time">[00:00:00]</span>
                    <span class="log-info">Ready to run diagnostics. Click the "Run Diagnostics" button to start.</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Potential Solutions</h2>
            </div>
            <div id="solutions">
                <div class="solution-box">
                    <h3><i class="fas fa-lightbulb"></i> Common Issues and Fixes</h3>
                    <p><strong>1. Missing Rules for Admins Collection</strong><br>
                    Your security rules don't include any rules for the admins collection, so access is denied by default.</p>
                    
                    <p><strong>2. Firestore Security Rules</strong><br>
                    Add specific rules for the admins collection to allow read access for admins.</p>
                    
                    <p><strong>3. Firebase Project Configuration</strong><br>
                    Verify that your Firebase config in the code matches your project settings.</p>
                    
                    <p><strong>4. Collection Name Mismatch</strong><br>
                    Ensure the collection name is exactly "admins" (case-sensitive).</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration (same as your admin dashboard)
        const firebaseConfig = {
            apiKey: "AIzaSyBjo5LY4EsFlX8j_8NbLUObooUsCqJM8KM",
            authDomain: "tk-scheduler.firebaseapp.com",
            projectId: "tk-scheduler",
            storageBucket: "tk-scheduler.appspot.com",
            messagingSenderId: "746606755052",
            appId: "1:746606755052:web:d7eae92976cb2f2fa9f9c9",
            measurementId: "G-Q5L607R3N7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const runDiagnosticsBtn = document.getElementById('runDiagnostics');
        const diagnosticLog = document.getElementById('diagnosticLog');
        const connectionStatus = document.getElementById('connectionStatus');
        const authStatus = document.getElementById('authStatus');
        const adminStatus = document.getElementById('adminStatus');
        const adminDetails = document.getElementById('adminDetails');
        const userUID = document.getElementById('userUID');
        const adminDocExists = document.getElementById('adminDocExists');
        const adminDocData = document.getElementById('adminDocData');
        const rulesAnalysis = document.getElementById('rulesAnalysis');
        const rulesDetails = document.getElementById('rulesDetails');

        // Add log entry
        function addLogEntry(message, type = 'info') {
            const now = new Date();
            const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">${timeString}</span>
                <span class="log-${type}">${message}</span>
            `;
            
            diagnosticLog.appendChild(logEntry);
            diagnosticLog.scrollTop = diagnosticLog.scrollHeight;
        }

        // Update status item
        function updateStatus(element, status, message, details = '') {
            const statusIcon = element.querySelector('.status-icon');
            const statusText = element.querySelector('.status-text');
            const statusDetails = element.querySelector('.status-details');
            const statusResult = element.querySelector('.status-result');
            
            statusResult.textContent = message;
            
            if (status === 'success') {
                statusIcon.className = 'status-icon status-success';
                statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                statusResult.style.color = 'var(--success)';
            } else if (status === 'error') {
                statusIcon.className = 'status-icon status-error';
                statusIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                statusResult.style.color = 'var(--error)';
            } else {
                statusIcon.className = 'status-icon status-warning';
                statusIcon.innerHTML = '<i class="fas fa-question-circle"></i>';
                statusResult.style.color = 'var(--warning)';
            }
            
            if (details) {
                statusDetails.textContent = details;
            }
        }

        // Run diagnostics
        async function runDiagnostics() {
            diagnosticLog.innerHTML = '';
            addLogEntry('Starting diagnostics...', 'info');
            
            // Test Firebase connection
            addLogEntry('Testing Firebase connection...', 'info');
            updateStatus(connectionStatus, 'warning', 'Testing...', 'Checking Firebase connection');
            
            try {
                // Test Firestore connection with a simple query to a public collection
                await db.collection('Job_Applications').limit(1).get();
                addLogEntry('Firebase connection successful', 'info');
                updateStatus(connectionStatus, 'success', 'Connected', 'Firebase connection established');
            } catch (error) {
                addLogEntry(`Firebase connection failed: ${error.message}`, 'error');
                updateStatus(connectionStatus, 'error', 'Failed', 'Could not connect to Firebase');
                return;
            }
            
            // Check authentication status
            addLogEntry('Checking authentication status...', 'info');
            updateStatus(authStatus, 'warning', 'Checking...', 'Checking if user is authenticated');
            
            const user = auth.currentUser;
            
            if (user) {
                addLogEntry(`User authenticated: ${user.email} (UID: ${user.uid})`, 'info');
                updateStatus(authStatus, 'success', 'Authenticated', `Logged in as ${user.email}`);
                
                // Check admin privileges
                addLogEntry('Checking admin privileges...', 'info');
                updateStatus(adminStatus, 'warning', 'Checking...', 'Verifying admin access');
                
                userUID.textContent = user.uid;
                
                try {
                    const adminDoc = await db.collection('admins').doc(user.uid).get();
                    
                    if (adminDoc.exists) {
                        addLogEntry('Admin document found in Firestore', 'info');
                        updateStatus(adminStatus, 'success', 'Admin Access', 'You have admin privileges');
                        
                        adminDocExists.textContent = 'Yes';
                        adminDocData.textContent = JSON.stringify(adminDoc.data(), null, 2);
                        adminDetails.classList.remove('hidden');
                        
                        addLogEntry('Admin document data: ' + JSON.stringify(adminDoc.data()), 'info');
                        addLogEntry('Diagnostics completed successfully. You should have admin access.', 'info');
                    } else {
                        addLogEntry('Admin document NOT found in Firestore', 'error');
                        updateStatus(adminStatus, 'error', 'No Access', 'Your user ID was not found in the admins collection');
                        
                        adminDocExists.textContent = 'No';
                        adminDetails.classList.remove('hidden');
                        
                        addLogEntry('Make sure you created a document in the "admins" collection with your user ID as the document ID', 'warning');
                    }
                } catch (error) {
                    addLogEntry(`Error checking admin document: ${error.message}`, 'error');
                    updateStatus(adminStatus, 'error', 'Error', 'Failed to check admin document');
                    
                    // Check if it's a permissions error
                    if (error.code === 'permission-denied') {
                        addLogEntry('Permission denied error detected. This indicates a security rules issue.', 'error');
                        updateStatus(rulesAnalysis, 'error', 'Rules Issue', 'Security rules blocking access');
                        rulesDetails.classList.remove('hidden');
                    }
                }
            } else {
                addLogEntry('User not authenticated. Please sign in first.', 'error');
                updateStatus(authStatus, 'error', 'Not Authenticated', 'Please sign in to continue');
                
                // Try to redirect to login page
                addLogEntry('Redirecting to login page...', 'info');
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 2000);
            }
        }

        // Event listeners
        runDiagnosticsBtn.addEventListener('click', runDiagnostics);

        // Auto-run diagnostics if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                addLogEntry('User detected, running diagnostics automatically...', 'info');
                runDiagnostics();
            }
        });
    </script>
</body>
</html>
