<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tklesson - Profile Photo Upload</title>
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        /* Login Container Styles */
        .login-container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
            padding: 40px;
            text-align: center;
            display: none;
        }
        
        .login-logo {
            font-size: 2.5em;
            color: #082b6f;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .login-logo span {
            color: #3498db;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1em;
            letter-spacing: 1px;
        }
        
        .login-input-group {
            margin-bottom: 20px;
        }
        
        .login-input-wrapper {
            position: relative;
        }
        
        .login-input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 18px;
        }
        
        .login-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
            background: #f8fafc;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
        }
        
        .login-password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
        }
        
        .login-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .login-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        .login-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .login-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .login-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .login-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* Upload Container Styles */
        .upload-container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
            padding: 40px;
            text-align: center;
            display: none;
        }
        
        .logo {
            font-size: 2.5em;
            color: #082b6f;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .logo span {
            color: #3498db;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
            border-left: 4px solid #3498db;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 12px;
            padding: 40px 20px;
            margin: 20px 0;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            background: #d1ecf1;
            border-color: #27ae60;
            border-style: solid;
        }
        
        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .preview-container {
            margin: 30px 0;
            display: none;
        }
        
        .photo-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 0 auto;
            border-radius: 8px;
            border: 3px solid #3498db;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: left;
            display: none;
        }
        
        /* BUTTON STYLES - CLEAR SEPARATION */
        .select-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 20px 0;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .select-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .submit-button {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
            transition: all 0.3s;
            display: none;
        }
        
        .submit-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        .submit-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .cancel-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 500;
            display: none;
        }
        
        .cancel-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .instructions {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            color: #555;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .contract-reference {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .logout-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .logout-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media print {
            .logo span {
                -webkit-text-fill-color: #3498db !important;
                color: #3498db !important;
                background: none !important;
                -webkit-background-clip: initial !important;
                background-clip: initial !important;
            }
        }
        
        @media (max-width: 600px) {
            .upload-container,
            .login-container {
                padding: 25px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .photo-preview {
                max-width: 250px;
                max-height: 250px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .submit-button,
            .cancel-button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-logo">TK<span>LESSON</span></div>
        <div class="login-subtitle">PROFILE PHOTO UPLOAD</div>
        
        <form id="loginForm">
            <div class="login-input-group">
                <div class="login-input-wrapper">
                    <i class="fas fa-envelope login-input-icon"></i>
                    <input type="email" id="email" class="login-input" placeholder="Email address" required>
                </div>
            </div>
            
            <div class="login-input-group">
                <div class="login-input-wrapper">
                    <i class="fas fa-lock login-input-icon"></i>
                    <input type="password" id="password" class="login-input" placeholder="Password" required>
                    <button type="button" class="login-password-toggle" id="passwordToggle">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
            <button type="submit" class="login-button" id="loginBtn">
                <span id="btnText">Continue to Upload</span>
                <i class="fas fa-spinner" id="btnSpinner" style="display: none; animation: spin 1s linear infinite;"></i>
            </button>
            
            <div class="login-message" id="loginMessage"></div>
        </form>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
            <a href="https://www.tklesson.com" style="color: #64748b; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;">
                <i class="fas fa-home"></i>
                Back to homepage
            </a>
        </div>
    </div>
    
    <!-- Upload Container (Shown after login) -->
    <div class="upload-container" id="uploadContainer">
        <div class="logo">TK<span>LESSON</span></div>
        <h1>Tutor Profile Photo Upload</h1>
        <p class="subtitle">Upload your professional profile photo</p>
        
        <div class="user-info" id="userInfo">
            <p><strong>Welcome:</strong> <span id="userEmail"></span></p>
            <p><strong>Contract Reference:</strong> <span id="contract-id">Loading...</span></p>
            <p><small>Your photo will be used for your tutor profile</small></p>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“·</div>
            <div class="upload-text">Click to Select Photo</div>
            <div class="upload-hint">or drag & drop your photo here</div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;">
        </div>
        
        <div class="preview-container" id="previewContainer">
            <img id="photoPreview" class="photo-preview" alt="Photo Preview">
            <div class="file-info" id="fileInfo">
                <p><strong>File:</strong> <span id="fileName"></span></p>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
                <p><strong>Type:</strong> <span id="fileType"></span></p>
            </div>
        </div>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons">
            <button class="submit-button" id="submitButton" disabled>Submit Photo</button>
            <button class="cancel-button" id="cancelButton">Cancel</button>
        </div>
        
        <button class="logout-button" id="logoutButton">Logout</button>
        
        <div class="instructions">
            <h3>ðŸ“‹ Photo Requirements</h3>
            <ul>
                <li>Professional headshot or clear face photo</li>
                <li>File formats: JPG, PNG (no HEIC/HEIF)</li>
                <li>Maximum file size: 5 MB</li>
                <li>Recommended dimensions: 400x400 pixels (square)</li>
                <li>Good lighting, neutral background preferred</li>
                <li>No group photos or copyrighted images</li>
            </ul>
            <p><em>Your photo will be visible to students on your tutor profile.</em></p>
        </div>
    </div>

    <!-- Add Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBjo5LY4EsFlX8j_8NbLUObooUsCqJM8KM",
            authDomain: "tk-scheduler.firebaseapp.com",
            projectId: "tk-scheduler",
            storageBucket: "tk-scheduler.firebasestorage.app",
            messagingSenderId: "746606755052",
            appId: "1:746606755052:web:d7eae92976cb2f2fa9f9c9",
            measurementId: "G-Q5L607R3N7"
        };

        // Initialize Firebase
        let auth, db, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let currentFile = null;
        let uploadInProgress = false;
        let userContractId = '';
        let userEmail = '';
        let userUid = '';

        // ============================================
        // SECURITY CHECK & SESSION MANAGEMENT
        // ============================================
        const SESSION_TIMEOUT = 8 * 60 * 60 * 1000; // 8 hours
        const LOGIN_PAGE = 'https://www.tklesson.com/testing/contract-login.html';

        function checkSession() {
            const isAuth = sessionStorage.getItem('tk_auth') === 'true';
            const email = sessionStorage.getItem('tk_email');
            const uid = sessionStorage.getItem('tk_uid');
            const loginTime = sessionStorage.getItem('tk_login_time');
            
            if (isAuth && email && uid && loginTime) {
                const sessionAge = Date.now() - parseInt(loginTime);
                if (sessionAge <= SESSION_TIMEOUT) {
                    return { isAuthenticated: true, email, uid };
                }
            }
            return { isAuthenticated: false };
        }

        async function checkTutorApproval(uid, email) {
            try {
                const tutorDoc = await db.collection('tutors').doc(uid).get();
                
                if (tutorDoc.exists) {
                    const data = tutorDoc.data();
                    return {
                        isTutor: true,
                        isApproved: data.approved === true,
                        status: data.status || 'pending'
                    };
                }
                
                const emailQuery = await db.collection('tutors')
                    .where('email', '==', email)
                    .limit(1)
                    .get();
                    
                if (!emailQuery.empty) {
                    const data = emailQuery.docs[0].data();
                    return {
                        isTutor: true,
                        isApproved: data.approved === true,
                        status: data.status || 'pending'
                    };
                }
                
                return { isTutor: false, isApproved: false, status: 'not-found' };
                
            } catch (error) {
                console.error('Error checking tutor:', error);
                return { isTutor: false, isApproved: false, status: 'error' };
            }
        }

        async function getContractIdFromEmail(email) {
            try {
                const query = await db.collection('contracts')
                    .where('contractorDetails.email', '==', email)
                    .limit(1)
                    .get();
                
                if (!query.empty) {
                    const data = query.docs[0].data();
                    return {
                        exists: true,
                        contractId: data.contractId,
                        documentId: query.docs[0].id,
                        status: data.contractInfo?.status || 'signed'
                    };
                }
                return { exists: false };
            } catch (error) {
                console.error('Error getting contract:', error);
                return { exists: false };
            }
        }

        // ============================================
        // LOGIN FUNCTIONS
        // ============================================
        function showLoginMessage(text, type) {
            const loginMessage = document.getElementById('loginMessage');
            loginMessage.textContent = text;
            loginMessage.className = `login-message login-${type}`;
            loginMessage.style.display = 'block';
            
            setTimeout(() => {
                if (type === 'success') {
                    loginMessage.style.display = 'none';
                }
            }, 3000);
        }

        function setLoginLoading(isLoading) {
            const loginBtn = document.getElementById('loginBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            if (isLoading) {
                loginBtn.disabled = true;
                btnText.textContent = 'Signing in...';
                btnSpinner.style.display = 'inline-block';
            } else {
                loginBtn.disabled = false;
                btnText.textContent = 'Continue to Upload';
                btnSpinner.style.display = 'none';
            }
        }

        // ============================================
        // UPLOAD FUNCTIONS
        // ============================================
        function showUploadMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        async function submitPhotoToFirebase(file) {
            return new Promise((resolve, reject) => {
                try {
                    if (!userContractId || !userUid) {
                        reject(new Error('User not properly authenticated'));
                        return;
                    }

                    // Create unique filename
                    const timestamp = Date.now();
                    const sanitizedName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
                    const fileName = `${userContractId}_${timestamp}_${sanitizedName}`;
                    const storagePath = `tutor-photos/${userContractId}/${fileName}`;
                    
                    // Create storage reference
                    const storageRef = storage.ref(storagePath);
                    const uploadTask = storageRef.put(file);
                    
                    // Monitor upload progress
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            document.getElementById('progressFill').style.width = progress + '%';
                        },
                        (error) => {
                            console.error('Upload error:', error);
                            reject(error);
                        },
                        async () => {
                            try {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Save photo info to Firestore
                                const photoData = {
                                    contractId: userContractId,
                                    tutorUid: userUid,
                                    tutorEmail: userEmail,
                                    fileName: fileName,
                                    originalName: file.name,
                                    fileSize: file.size,
                                    fileType: file.type,
                                    downloadURL: downloadURL,
                                    storagePath: storagePath,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    status: 'uploaded'
                                };
                                
                                // Save to Firestore
                                await db.collection('tutorPhotos').add(photoData);
                                
                                // Update tutor document with photo URL
                                await db.collection('tutors').doc(userUid).update({
                                    profilePhoto: downloadURL,
                                    profilePhotoUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                resolve({
                                    url: downloadURL,
                                    path: storagePath,
                                    contractId: userContractId,
                                    fileName: fileName
                                });
                                
                            } catch (error) {
                                console.error('Error saving photo data:', error);
                                reject(error);
                            }
                        }
                    );
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            const session = checkSession();
            
            if (session.isAuthenticated) {
                const tutorStatus = await checkTutorApproval(session.uid, session.email);
                
                if (!tutorStatus.isTutor || !tutorStatus.isApproved) {
                    showLogin();
                    showLoginMessage('Access is restricted to approved tutors.', 'error');
                    return;
                }
                
                const contractData = await getContractIdFromEmail(session.email);
                
                if (!contractData.exists) {
                    showLogin();
                    showLoginMessage('No contract found. Please complete your contract first.', 'warning');
                    return;
                }
                
                userContractId = contractData.contractId;
                userEmail = session.email;
                userUid = session.uid;
                
                showUpload();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('uploadContainer').style.display = 'none';
        }

        function showUpload() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('uploadContainer').style.display = 'block';
            
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('contract-id').textContent = userContractId;
            
            initUpload();
        }

        function initUpload() {
            // DOM Elements
            const uploadArea = document.getElementById('uploadArea');
            const photoInput = document.getElementById('photoInput');
            const previewContainer = document.getElementById('previewContainer');
            const photoPreview = document.getElementById('photoPreview');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileType = document.getElementById('fileType');
            const submitButton = document.getElementById('submitButton');
            const cancelButton = document.getElementById('cancelButton');
            const logoutButton = document.getElementById('logoutButton');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const statusMessage = document.getElementById('statusMessage');

            // Configuration
            const CONFIG = {
                maxFileSize: 5 * 1024 * 1024,
                allowedTypes: ['image/jpeg', 'image/jpg', 'image/png']
            };

            // Event Listeners
            uploadArea.addEventListener('click', () => photoInput.click());
            photoInput.addEventListener('change', handleFileSelect);
            
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            submitButton.addEventListener('click', handleSubmit);
            cancelButton.addEventListener('click', handleCancel);
            logoutButton.addEventListener('click', handleLogout);

            function handleFileSelect(event) {
                const file = event.target.files[0];
                processSelectedFile(file);
            }

            function handleDragOver(event) {
                event.preventDefault();
                uploadArea.classList.add('dragover');
            }

            function handleDragLeave(event) {
                event.preventDefault();
                uploadArea.classList.remove('dragover');
            }

            function handleDrop(event) {
                event.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = event.dataTransfer.files[0];
                processSelectedFile(file);
            }

            function processSelectedFile(file) {
                if (!file) return;
                
                // Validate file type
                if (!CONFIG.allowedTypes.includes(file.type.toLowerCase())) {
                    showUploadMessage('Please select a JPG or PNG image file.', 'error');
                    return;
                }
                
                // Validate file size
                if (file.size > CONFIG.maxFileSize) {
                    showUploadMessage('File is too large. Maximum size is 5MB.', 'error');
                    return;
                }
                
                currentFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    previewContainer.style.display = 'block';
                    
                    // Update file info
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    fileType.textContent = file.type.split('/')[1].toUpperCase();
                    fileInfo.style.display = 'block';
                    
                    // Show submit and cancel buttons
                    submitButton.style.display = 'inline-block';
                    cancelButton.style.display = 'inline-block';
                    submitButton.disabled = false;
                    
                    // Update upload area text
                    uploadArea.querySelector('.upload-text').textContent = 'Photo Selected';
                    uploadArea.querySelector('.upload-hint').textContent = 'Click "Submit Photo" to upload';
                    
                    // Clear any previous messages
                    statusMessage.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            async function handleSubmit() {
    if (!currentFile || uploadInProgress) return;
    
    uploadInProgress = true;
    submitButton.disabled = true;
    submitButton.textContent = 'Submitting...';
    cancelButton.style.display = 'none';
    progressBar.style.display = 'block';
    progressFill.style.width = '0%';
    
    try {
        // SUBMIT: Actually upload to Firebase
        const result = await submitPhotoToFirebase(currentFile);
        
        // Show success message
        showUploadMessage('âœ… Photo submitted successfully! Your profile photo has been updated.', 'success');
        
        // Wait 2 seconds so user can see the success message
        setTimeout(() => {
            // Then hide the upload area and buttons
            submitButton.style.display = 'none';
            uploadArea.style.display = 'none';
            fileInfo.style.display = 'none';
            previewContainer.style.display = 'none';
            
            // Add a "Done" button
            const doneButton = document.createElement('button');
            doneButton.className = 'submit-button';
            doneButton.textContent = 'Return to Dashboard';
            doneButton.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
            doneButton.onclick = () => window.location.href = 'https://www.tklesson.com/tutor-dashboard';
            document.getElementById('actionButtons').appendChild(doneButton);
        }, 2000); // Wait 2 seconds before hiding
        
    } catch (error) {
        console.error('Submit error:', error);
        showUploadMessage('âŒ Submission failed: ' + error.message, 'error');
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Photo';
        cancelButton.style.display = 'inline-block';
        uploadInProgress = false;
    }
}

            function handleCancel() {
                // CANCEL: Clear everything without uploading
                currentFile = null;
                uploadInProgress = false;
                
                // Reset file input
                photoInput.value = '';
                
                // Hide preview and info
                photoPreview.style.display = 'none';
                fileInfo.style.display = 'none';
                previewContainer.style.display = 'none';
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
                
                // Hide buttons
                submitButton.style.display = 'none';
                submitButton.disabled = true;
                submitButton.textContent = 'Submit Photo';
                cancelButton.style.display = 'none';
                
                // Reset upload area
                uploadArea.style.display = 'block';
                uploadArea.querySelector('.upload-text').textContent = 'Click to Select Photo';
                uploadArea.querySelector('.upload-hint').textContent = 'or drag & drop your photo here';
                
                // Clear status message
                statusMessage.style.display = 'none';
            }

function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
            sessionStorage.clear();
            // Redirect to homepage instead of contract login
            window.location.href = 'https://www.tklesson.com/index.html';
        });
    }
}
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // ============================================
        // LOGIN FORM HANDLING
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            init();
            
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                const passwordToggle = document.getElementById('passwordToggle');
                const passwordInput = document.getElementById('password');
                
                passwordToggle.addEventListener('click', () => {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    passwordToggle.innerHTML = isPassword ? 
                        '<i class="fas fa-eye-slash"></i>' : 
                        '<i class="fas fa-eye"></i>';
                });
                
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value;
                    
                    if (!email || !password) {
                        showLoginMessage('Please fill in all fields', 'error');
                        return;
                    }
                    
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        showLoginMessage('Please enter a valid email address', 'error');
                        return;
                    }
                    
                    setLoginLoading(true);
                    
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        if (!user.emailVerified) {
                            showLoginMessage('Please verify your email address first.', 'warning');
                            await auth.signOut();
                            setLoginLoading(false);
                            return;
                        }
                        
                        const tutorStatus = await checkTutorApproval(user.uid, email);
                        
                        if (!tutorStatus.isTutor) {
                            showLoginMessage('Access is restricted to approved tutors.', 'error');
                            await auth.signOut();
                            setLoginLoading(false);
                            return;
                        }
                        
                        if (!tutorStatus.isApproved) {
                            let message = 'Your account is ';
                            if (tutorStatus.status === 'pending') {
                                message += 'pending approval.';
                            } else if (tutorStatus.status === 'rejected') {
                                message += 'not approved.';
                            } else {
                                message += `in ${tutorStatus.status} status.`;
                            }
                            
                            showLoginMessage(message, 'warning');
                            await auth.signOut();
                            setLoginLoading(false);
                            return;
                        }
                        
                        const contractData = await getContractIdFromEmail(email);
                        
                        if (!contractData.exists) {
                            showLoginMessage('No contract found. Please complete your contract first.', 'warning');
                            await auth.signOut();
                            setLoginLoading(false);
                            return;
                        }
                        
                        sessionStorage.setItem('tk_auth', 'true');
                        sessionStorage.setItem('tk_email', email);
                        sessionStorage.setItem('tk_uid', user.uid);
                        sessionStorage.setItem('tk_login_time', Date.now().toString());
                        sessionStorage.setItem('tk_contract_id', contractData.contractId);
                        
                        await db.collection('tutors').doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        userContractId = contractData.contractId;
                        userEmail = email;
                        userUid = user.uid;
                        
                        showLoginMessage('âœ… Success! Loading upload form...', 'success');
                        
                        setTimeout(() => {
                            showUpload();
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Login error:', error);
                        
                        let message = 'Login failed. Please try again.';
                        
                        switch (error.code) {
                            case 'auth/user-not-found':
                                message = 'No account found with this email.';
                                break;
                            case 'auth/wrong-password':
                                message = 'Incorrect password.';
                                break;
                            case 'auth/invalid-email':
                                message = 'Invalid email format.';
                                break;
                            case 'auth/user-disabled':
                                message = 'Account is disabled.';
                                break;
                            case 'auth/too-many-requests':
                                message = 'Too many attempts. Try later.';
                                break;
                        }
                        
                        showLoginMessage(message, 'error');
                        setLoginLoading(false);
                    }
                });
                
                document.getElementById('email').focus();
            }
        });
    </script>
</body>
</html>
