


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Learning Scheduler</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="canonical" href="https://tklesson.com/testing/tutor-dashboard.html" />
    <script src='https://meet.jit.si/external_api.js'></script>

    <script src="https://tklesson.com/resources-loader.js"></script>
    <script>loadCommonResources();</script>

    
<!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script> <!-- T

    <!-- Add this to the <head> section of your tutor dashboard HTML -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
      crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #6a7eee;
            --primary-dark: #2f4ac0;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --accent-light: #ff5da2;
            --light: #f8f9fa;
            --dark: #212529;
            --dark-light: #424649;
            --success: #4cc9f0;
            --success-light: #7ad7f5;
            --error: #e63946;
            --warning: #ffc107;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 15px 35px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

.rejected-earning {
    background-color: rgba(230, 57, 70, 0.05) !important;
    color: #999;
}

.rejected-earning:hover {
    background-color: rgba(230, 57, 70, 0.1) !important;
}

.rejected-earning td {
    opacity: 0.7;
}

/* Earnings Table Mobile Responsiveness */
.sessions-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.sessions-table thead {
    background: #4361ee;
    color: white;
}

.sessions-table th {
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
}

.sessions-table td {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
}

/* Mobile Card Layout */
.earnings-card {
    display: none;
    background: white;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #4361ee;
}

.earnings-card .card-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f5f5f5;
}

.earnings-card .card-row:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.earnings-card .card-label {
    font-weight: 600;
    color: #666;
    font-size: 14px;
}

.earnings-card .card-value {
    font-weight: 500;
    color: #333;
    text-align: right;
}

.earnings-card .amount {
    font-weight: 700;
    color: #4361ee;
    font-size: 16px;
}

.earnings-card .status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
}

/* Responsive Breakpoint */
@media (max-width: 768px) {
    .sessions-table {
        display: none;
    }
    
    .earnings-card {
        display: block;
    }
    
    .total-earnings {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        font-weight: 600;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 20px;
    }
}

@media (min-width: 769px) {
    .earnings-card {
        display: none;
    }
    
    .sessions-table {
        display: table;
    }
}
        
/* Status badges for earnings */
.status-approved {
    background: rgba(76, 201, 240, 0.1);
    color: #4cc9f0;
}

.status-pending {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.status-rejected {
    background: rgba(230, 57, 70, 0.1);
    color: #e63946;
}
      
.btn-warning {
    background: var(--warning);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition);
}

.btn-warning:hover {
    background: #e0a800;
}

.pending-earning {
    background-color: rgba(255, 193, 7, 0.05) !important;
}

.pending-earning:hover {
    background-color: rgba(255, 193, 7, 0.1) !important;
}
        
.tutor-guidance {
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border-left: 4px solid #e74c3c;
}

.tutor-guidance h4 {
  margin: 0 0 10px 0;
  color: white;
  font-size: 1.2em;
}

.tutor-guidance p {
  margin: 0 0 15px 0;
  opacity: 0.9;
  line-height: 1.5;
}

.response-guidelines {
  background: rgba(255,255,255,0.15);
  padding: 15px;
  border-radius: 8px;
  font-size: 0.9em;
  border: 1px solid rgba(255,255,255,0.2);
}

.response-guidelines i {
  font-size: 1.2em;
  margin-right: 8px;
  color: #3498db;
}

.response-guidelines strong {
  color: #ecf0f1;
}

.response-guidelines ul {
  margin: 10px 0 0 0;
  padding-left: 20px;
}

.response-guidelines li {
  margin-bottom: 5px;
  opacity: 0.9;
}


.highlight-pulse {
    animation: highlightPulse 2s ease-in-out;
    border-left: 4px solid #4361ee !important;
}

@keyframes highlightPulse {
    0% { background-color: rgba(67, 97, 238, 0.1); }
    50% { background-color: rgba(67, 97, 238, 0.2); }
    100% { background-color: rgba(67, 97, 238, 0.1); }
}

/* Table Body Text Only */
.sessions-table tbody td {
    font-family: 'Inter', -apple-system, sans-serif;
    font-size: 15px;            /* was 14px → slightly larger */
    line-height: 1.6;           /* was 1.5 → a bit more breathing room */
    font-weight: 400;
    color: #374151;
}

/* Action Time - Emphasized */
.sessions-table tbody td:nth-child(1) {
    font-weight: 600;
    color: #111827;
}

/* Action Type Badge Text */
.action-badge {
    font-size: 13px;            /* was 12px */
    font-weight: 600;
    letter-spacing: 0.03em;     /* slightly more spacing for clarity */
}

/* Student Name */
.sessions-table tbody td:nth-child(3) {
    font-weight: 500;
    color: #1f2937;
    font-size: 15px;            /* match base for consistency */
}

/* Subject */
.sessions-table tbody td:nth-child(4) {
    font-style: normal;
    color: #4b5563;
    font-size: 14px;            /* small bump from default */
}

/* Session Date - Secondary */
.sessions-table tbody td:nth-child(5) {
    font-size: 14px;            /* was 13px */
    color: #6b7280;
}

/* Type & Duration */
.sessions-table tbody td:nth-child(6),
.sessions-table tbody td:nth-child(7) {
    color: #4b5563;
    font-weight: 400;
    font-size: 14px;            /* previously unbalanced */
}

/* Timestamp Text */
.timestamp-cell {
    font-size: 13px;            /* was 12px */
    color: #6b7280;
}

/* Relative Time */
.action-relative-time {
    font-size: 12.5px;          /* was 11px → subtle increase */
    color: #7c3aed;
    font-weight: 500;
}

        
/*Add this CSS for pagination styling*/
const paginationCSS = `
.pagination-container {
    margin-top: 20px;
    text-align: center;
}

.pagination-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.pagination-info {
    color: var(--text-secondary, #666);
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.pagination-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid var(--border-color, #ddd);
    background: white;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    min-width: 40px;
}

.pagination-btn:hover {
    background: var(--gray-light, #f5f5f5);
    border-color: var(--primary, #4361ee);
}

.pagination-btn.active {
    background: var(--primary, #4361ee);
    color: white;
    border-color: var(--primary, #4361ee);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-ellipsis {
    padding: 8px 5px;
    color: var(--text-secondary, #666);
}

@media (max-width: 768px) {
    .pagination-buttons {
        gap: 3px;
    }
    
    .pagination-btn {
        padding: 6px 8px;
        font-size: 0.8rem;
        min-width: 35px;
    }
}
`;


/* Cancellation Policy Styles */
.cancellation-policy {
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid;
}

.cancellation-policy.policy-refund {
    background: #e8f5e8;
    border-left-color: #4CAF50;
}

.cancellation-policy.policy-no-refund {
    background: #fff3cd;
    border-left-color: #ffc107;
}

.policy-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 1.1em;
}

.policy-message {
    font-weight: 600;
    margin-bottom: 8px;
}

.policy-details {
    font-size: 0.9em;
    color: #666;
}

.cancellation-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 10px 0;
    font-size: 0.9em;
}

.cancellation-indicator.refund-available {
    background: #e8f5e8;
    color: #2e7d32;
    border-left: 3px solid #4CAF50;
}

.cancellation-indicator.no-refund {
    background: #fff3cd;
    color: #856404;
    border-left: 3px solid #ffc107;
}

.cancellation-indicator.too-late {
    background: #f8d7da;
    color: #721c24;
    border-left: 3px solid #dc3545;
}

.warning-badge {
    background: #ffc107;
    color: #856404;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7em;
    font-weight: bold;
    margin-left: 8px;
}

.within-24h-window {
    border-left: 4px solid #ffc107;
}
        

/* ============================================= */
/* RATINGS & REVIEWS SECTION STYLES */
/* ============================================= */

/* Overview Stats */
.ratings-overview {
    background: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--box-shadow);
}

.overview-stats {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 2rem;
    align-items: center;
}

/* Average Rating */
.rating-summary {
    text-align: center;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: var(--border-radius);
    color: white;
}

.average-rating .rating-value {
    font-size: 3.5rem;
    font-weight: 700;
    display: block;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.average-rating .stars {
    margin: 1rem 0;
    justify-content: center;
}

.average-rating .rating-count {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Rating Breakdown */
.rating-breakdown {
    padding: 1rem;
}

.rating-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.8rem;
}

.rating-bar span:first-child {
    width: 60px;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.bar-container {
    flex: 1;
    height: 8px;
    background: var(--gray-light);
    border-radius: 10px;
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    background: linear-gradient(135deg, #ffd700, #ffa500);
    border-radius: 10px;
    transition: width 1s ease-in-out;
}

.rating-bar .count {
    width: 30px;
    text-align: right;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

/* Reviews Container */
.reviews-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Review Card */
.review-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--box-shadow);
    border-left: 4px solid transparent;
    transition: var(--transition);
}

.review-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--box-shadow-hover);
}

.review-card.rating-5 { border-left-color: #4CAF50; }
.review-card.rating-4 { border-left-color: #8BC34A; }
.review-card.rating-3 { border-left-color: #FFC107; }
.review-card.rating-2 { border-left-color: #FF9800; }
.review-card.rating-1 { border-left-color: #f44336; }

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.review-student-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.student-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.2rem;
}

.student-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.student-details h4 {
    margin: 0 0 0.3rem 0;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.student-details .subject {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.review-meta {
    text-align: right;
}

.review-date {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

/* Stars */
.stars {
    display: flex;
    gap: 2px;
}

.star {
    color: #ddd;
    font-size: 1.1rem;
}

.star.filled {
    color: #ffd700;
}

.star.half-filled {
    background: linear-gradient(90deg, #ffd700 50%, #ddd 50%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Review Content */
.review-content {
    margin: 1rem 0;
}

.review-text {
    line-height: 1.6;
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.session-info {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.session-info span {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Review Actions */
.review-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid var(--border-light);
}

.response-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--success);
}

.response-indicator.not-responded {
    color: var(--warning);
}

.response-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    font-size: 0.9rem;
    transition: var(--transition);
}

.response-btn:hover {
    background: var(--primary-dark);
}

/* Response Section */
.review-response {
    background: var(--gray-light);
    padding: 1rem;
    border-radius: var(--border-radius-sm);
    margin-top: 1rem;
    border-left: 3px solid var(--primary);
}

.response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.response-header h5 {
    margin: 0;
    color: var(--primary);
    font-size: 0.95rem;
}

.response-date {
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.response-text {
    color: var(--text-primary);
    line-height: 1.5;
}

/* Response Form */
.response-form {
    margin-top: 1rem;
}

.response-textarea {
    width: 100%;
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    font-family: inherit;
    font-size: 0.95rem;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 1rem;
    transition: var(--transition);
}

.response-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.response-form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

/* Empty State */
.reviews-empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-secondary);
}

.reviews-empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
    color: var(--primary);
}

.reviews-empty-state h4 {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

/* Filter Controls */
.reviews-filter {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    align-items: center;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-sm);
    background: white;
    font-size: 0.9rem;
    cursor: pointer;
}

/* Rating Summary Cards */
.rating-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.rating-card {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    text-align: center;
    box-shadow: var(--box-shadow);
    transition: var(--transition);
}

.rating-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--box-shadow-hover);
}

.rating-card .rating-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.rating-card.rating-5 .rating-value { color: #4CAF50; }
.rating-card.rating-4 .rating-value { color: #8BC34A; }
.rating-card.rating-3 .rating-value { color: #FFC107; }
.rating-card.rating-2 .rating-value { color: #FF9800; }
.rating-card.rating-1 .rating-value { color: #f44336; }

.rating-card .rating-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .ratings-overview {
        padding: 1.5rem;
    }
    
    .overview-stats {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .review-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .review-meta {
        text-align: left;
        width: 100%;
    }
    
    .review-actions {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .reviews-filter {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .rating-cards {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .session-info {
        flex-direction: column;
        gap: 0.5rem;
    }
}

@media (max-width: 480px) {
    .rating-cards {
        grid-template-columns: 1fr;
    }
    
    .review-student-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .student-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
}

/* Animation for new reviews */
@keyframes highlightNew {
    0% {
        background-color: rgba(255, 235, 59, 0.3);
    }
    100% {
        background-color: transparent;
    }
}

.review-card.new-review {
    animation: highlightNew 2s ease-in-out;
}

/* Loading States */
.reviews-loading {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.review-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Badge for new reviews */
.new-review-badge {
    background: var(--accent);
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: 0.5rem;
}
        
/* ============================================= */
/* PREMIUM CHAT SYSTEM STYLES */
/* ============================================= */

.chat-section {
  background: white;
  border-radius: 20px;
  padding: 0;
  box-shadow: 0 5px 20px rgba(0,0,0,0.08);
  overflow: hidden;
  display: none;
}

.chat-section.active {
  display: block;
}

.chat-header {
  padding: 25px;
  border-bottom: 2px solid #f1f5f9;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.chat-header h3 {
  margin: 0;
  font-size: 1.4em;
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-container {
  display: flex;
  height: 600px;
}

/* Tutors List */
.chat-contacts {
  width: 350px;
  border-right: 1px solid #f1f5f9;
  background: #f8fafc;
  overflow-y: auto;
}

.contact-search {
  padding: 20px;
  border-bottom: 1px solid #e2e8f0;
}

.contact-search input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 0.95em;
  transition: all 0.3s ease;
}

.contact-search input:focus {
  border-color: #667eea;
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.contacts-list {
  padding: 0;
}

.contact-item {
  padding: 20px;
  border-bottom: 1px solid #f1f5f9;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 15px;
}

.contact-item:hover {
  background: white;
  transform: translateX(5px);
}

.contact-item.active {
  background: white;
  border-right: 4px solid #667eea;
}

.contact-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 1.2em;
}

.contact-avatar img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.contact-info {
  flex: 1;
}

.contact-name {
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 5px;
}

.contact-subject {
  color: #64748b;
  font-size: 0.9em;
}

.contact-status {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 5px;
}

.status-online {
  width: 10px;
  height: 10px;
  background: #48bb78;
  border-radius: 50%;
}

.status-offline {
  width: 10px;
  height: 10px;
  background: #a0aec0;
  border-radius: 50%;
}

.last-message {
  color: #94a3b8;
  font-size: 0.85em;
  max-width: 150px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.unread-count {
  background: #ff6b6b;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7em;
  font-weight: 600;
}

/* Chat Messages Area */
.chat-messages {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
}

.chat-header-detail {
  padding: 20px 25px;
  border-bottom: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: white;
}

.current-contact {
  display: flex;
  align-items: center;
  gap: 15px;
}

.chat-actions {
  display: flex;
  gap: 10px;
}

.action-btn {
  padding: 8px 16px;
  border: 2px solid #e2e8f0;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
  font-size: 0.9em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.action-btn:hover {
  border-color: #667eea;
  color: #667eea;
}

.action-btn.primary {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.action-btn.primary:hover {
  background: #5a67d8;
  border-color: #5a67d8;
}

.messages-container {
  flex: 1;
  padding: 25px;
  overflow-y: auto;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.message {
  max-width: 70%;
  padding: 15px 20px;
  border-radius: 18px;
  position: relative;
  animation: messageSlide 0.3s ease;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.sent {
  align-self: flex-end;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border-bottom-right-radius: 5px;
}

.message.received {
  align-self: flex-start;
  background: white;
  color: #2d3748;
  border-bottom-left-radius: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-time {
  font-size: 0.75em;
  opacity: 0.7;
  margin-top: 5px;
  text-align: right;
}

.message-input-container {
  padding: 20px 25px;
  border-top: 1px solid #f1f5f9;
  background: white;
}

.message-input-wrapper {
  display: flex;
  gap: 15px;
  align-items: flex-end;
}

.message-input {
  flex: 1;
  padding: 15px 20px;
  border: 2px solid #e2e8f0;
  border-radius: 25px;
  resize: none;
  font-family: inherit;
  font-size: 0.95em;
  transition: all 0.3s ease;
  max-height: 120px;
  min-height: 50px;
}

.message-input:focus {
  border-color: #667eea;
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.send-btn {
  padding: 15px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.send-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Quick Actions */
.quick-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.quick-action {
  padding: 8px 16px;
  background: #f1f5f9;
  border: none;
  border-radius: 15px;
  cursor: pointer;
  font-size: 0.85em;
  color: #64748b;
  transition: all 0.3s ease;
}

.quick-action:hover {
  background: #667eea;
  color: white;
}

/* Typing Indicator */
.typing-indicator {
  align-self: flex-start;
  background: white;
  padding: 15px 20px;
  border-radius: 18px;
  border-bottom-left-radius: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  color: #64748b;
  font-size: 0.9em;
}

.typing-dots {
  display: flex;
  gap: 3px;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  background: #64748b;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-5px);
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  .chat-container {
    flex-direction: column;
    height: 500px;
  }
  
  .chat-contacts {
    width: 100%;
    height: 200px;
    border-right: none;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .contact-item {
    padding: 15px;
  }
  
  .message {
    max-width: 85%;
  }
}

/* Empty Chat State */
.chat-empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  text-align: center;
  color: #64748b;
}

.chat-empty-state i {
  font-size: 4em;
  margin-bottom: 20px;
  opacity: 0.5;
}

.chat-empty-state h4 {
  margin-bottom: 10px;
  color: #475569;
}

.chat-empty-state p {
  max-width: 400px;
  line-height: 1.6;
}
        
/* My Bookings Section Styling */
.bookings-section {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color, #e1e5e9);
}

.section-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color, #2c3e50);
    margin: 0;
}

.upcoming-sessions-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

// Add this comprehensive mobile CSS
const mobileSessionsCSS = `
/* Mobile Sessions Container */
.mobile-sessions-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

/* Mobile Session Card */
.mobile-session-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color, #e1e5e9);
    transition: all 0.3s ease;
}

.mobile-session-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.session-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 10px;
}

.session-main-info {
    flex: 1;
}

.session-subject {
    margin: 0 0 4px 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-dark);
}

.session-student {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.session-status-badges {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-end;
}

.session-card-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.detail-row i {
    width: 16px;
    color: var(--primary);
    text-align: center;
}

.session-card-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.session-card-actions button {
    flex: 1;
    min-width: 120px;
    padding: 8px 12px;
    font-size: 0.85rem;
}

/* Mobile Stats */
.mobile-stats {
    padding: 12px !important;
}

.mobile-stats .stat-item {
    text-align: center;
}

.mobile-stats .stat-number {
    font-size: 1.2em !important;
}

.mobile-stats .stat-label {
    font-size: 0.7em !important;
}

/* Responsive Table Container */
.sessions-table-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--border-color, #e1e5e9);
    border-radius: 8px;
    margin-bottom: 20px;
}

/* Mobile Pagination */
@media (max-width: 768px) {
    .pagination-buttons {
        gap: 3px;
    }
    
    .pagination-btn {
        padding: 6px 8px;
        font-size: 0.8rem;
        min-width: 35px;
    }
    
    .pagination-info {
        font-size: 0.8rem;
        text-align: center;
    }
}

/* Hide table on mobile, show cards */
@media (max-width: 768px) {
    .sessions-table-container {
        display: none;
    }
    
    .mobile-sessions-container {
        display: flex;
    }
}

/* Show table on desktop, hide cards */
@media (min-width: 769px) {
    .sessions-table-container {
        display: block;
    }
    
    .mobile-sessions-container {
        display: none;
    }
}

/* Make table responsive on very small screens */
@media (max-width: 480px) {
    .session-card-actions {
        flex-direction: column;
    }
    
    .session-card-actions button {
        min-width: auto;
    }
    
    .session-card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .session-status-badges {
        flex-direction: row;
        align-items: center;
        width: 100%;
        justify-content: flex-start;
        margin-top: 8px;
    }
}

        
/* Session Cards Grid */
.bookings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.session-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--border-color, #f0f0f0);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.session-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.session-card.reschedule-requested {
    border-left: 4px solid var(--warning, #ffc107);
    background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
}

/* Session Header */
.session-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-light, #f8f9fa);
}

.session-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary, #2c3e50);
    margin: 0;
}

.session-date {
    font-size: 0.9rem;
    color: var(--text-secondary, #6c757d);
    background: var(--bg-light, #f8f9fa);
    padding: 0.4rem 0.8rem;
    border-radius: 12px;
    font-weight: 500;
}

/* Session Details */
.session-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.session-detail {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.95rem;
    color: var(--text-primary, #2c3e50);
}

.session-detail i {
    width: 16px;
    color: var(--primary-color, #667eea);
    font-size: 0.9rem;
}

/* Status Badges */
.status-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: capitalize;
    display: inline-block;
}

.status-verified {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.status-pending {
    background: linear-gradient(135deg, #FF9800, #f57c00);
    color: white;
}

.status-cancelled {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
}

.status-reschedule-requested {
    background: linear-gradient(135deg, #FFC107, #ffa000);
    color: white;
}

/* Session Actions */
.session-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    padding-top: 1rem;
    border-top: 1px solid var(--border-light, #f8f9fa);
}

.session-actions button {
    flex: 1;
    min-width: 120px;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.session-actions button i {
    font-size: 0.8rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
}

.btn-outline {
    background: transparent;
    color: var(--text-secondary, #6c757d);
    border: 2px solid var(--border-color, #e1e5e9);
}

.btn-outline:hover {
    background: var(--bg-light, #f8f9fa);
    border-color: var(--primary-color, #667eea);
    color: var(--primary-color, #667eea);
}

.session-actions button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* Empty and Error States */
.empty-state, .error-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary, #6c757d);
}

.empty-state i, .error-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3, .error-state h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary, #2c3e50);
}

/* Booking Info Text */
.booking-info-text {
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
    border: 1px solid #e1bee7;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-top: 2rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--text-primary, #2c3e50);
    font-size: 0.9rem;
}

.booking-info-text i {
    color: var(--primary-color, #667eea);
    font-size: 1.1rem;
}

/* Reschedule Request Highlight */
.reschedule-highlight {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #FFC107, #ffa000);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
}

/* Responsive Design */
@media (max-width: 768px) {
    .bookings-section {
        padding: 1rem;
    }
    
    .section-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .bookings-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .session-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .session-actions {
        flex-direction: column;
    }
    
    .session-actions button {
        min-width: auto;
    }
}

:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --success-color: #4CAF50;
    --warning-color: #FFC107;
    --danger-color: #f44336;
    --text-primary: #2c3e50;
    --text-secondary: #6c757d;
    --border-color: #e1e5e9;
    --border-light: #f8f9fa;
    --bg-light: #f8f9fa;
}
        
/* Loading Animation */
.session-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.session-card {
    animation: fadeIn 0.5s ease-out;
}
        
        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: var(--box-shadow);
        }

        /* Ensure menu toggle is only visible on mobile */
        @media (min-width: 769px) {
            .menu-toggle {
                display: none !important;
            }
        }

        /* Loading spinner */
        .spinner {
            /* spinner-specific styles go here */
        }

        /* Sidebar header */
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .logo img {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            object-fit: contain;
        }

        .logo h1 {
            font-size: 22px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--glass-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 20px;
        }

        .user-details h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-details p {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-menu {
            list-style: none;
            padding: 16px 0;
        }

        .menu-item {
            margin-bottom: 4px;
        }

        .menu-item a {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .menu-item a:hover, .menu-item a.active {
            background: var(--glass-bg);
            color: white;
            border-left: 4px solid var(--accent);
        }

        .menu-item i {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.session-stats {
    display: flex;
    justify-content: space-around;
    margin: 15px 0;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    display: block;
    font-size: 1.5em;
    font-weight: bold;
    color: var(--primary);
}

.stat-label {
    font-size: 0.8em;
    color: #666;
}

.session-item {
    transition: all 0.3s ease;
}

.session-item:hover {
    transform: translateX(5px);
}

/* Status color classes for session items */
.status-success { color: var(--success); }
.status-primary { color: var(--primary); }
.status-warning { color: var(--warning); }
.status-error { color: var(--error); }
.status-gray { color: var(--gray); }

.status-success-light { background: rgba(76, 201, 240, 0.1); }
.status-primary-light { background: rgba(67, 97, 238, 0.1); }
.status-warning-light { background: rgba(255, 193, 7, 0.1); }
.status-error-light { background: rgba(230, 57, 70, 0.1); }
.status-gray-light { background: rgba(108, 117, 125, 0.1); }

/* ============================================= */
/* MOBILE RESPONSIVE CHAT STYLES FOR TUTOR */
/* ============================================= */

/* Mobile Chat Container */
@media (max-width: 768px) {
    .chat-section {
        border-radius: 0;
        margin: -1rem;
        height: calc(100vh - 60px);
    }
    
    .chat-container {
        flex-direction: column;
        height: 100%;
    }
    
    /* Contacts List - Mobile */
    .chat-contacts {
        width: 100%;
        height: 40vh;
        border-right: none;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .contact-search {
        padding: 15px;
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 10;
    }
    
    .contact-search input {
        padding: 10px 12px;
        font-size: 0.9em;
    }
    
    .contacts-list {
        max-height: calc(40vh - 70px);
        overflow-y: auto;
    }
    
    .contact-item {
        padding: 15px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .contact-item.active {
        border-right: none;
        border-bottom: 4px solid #667eea;
    }
    
    .contact-avatar {
        width: 40px;
        height: 40px;
        font-size: 1em;
    }
    
    .contact-info {
        flex: 1;
        width: 100%;
    }
    
    .contact-name {
        font-size: 1em;
        margin-bottom: 2px;
    }
    
    .contact-subject {
        font-size: 0.8em;
    }
    
    .contact-status {
        align-items: flex-start;
        width: 100%;
        margin-top: 5px;
    }
    
    .last-message {
        max-width: none;
        font-size: 0.85em;
    }
    
    .timestamp-cell {
        font-size: 0.75em;
    }
    
    /* Chat Messages Area - Mobile */
    .chat-messages {
        height: 60vh;
    }
    
    .chat-header-detail {
        padding: 15px 20px;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .current-contact {
        flex: 1;
    }
    
    .chat-actions {
        display: none; /* Hide actions on mobile for simplicity */
    }
    
    .messages-container {
        padding: 15px;
        max-height: calc(60vh - 130px);
        overflow-y: auto;
    }
    
    .message {
        max-width: 85%;
        padding: 12px 15px;
    }
    
    .message-time {
        font-size: 0.7em;
    }
    
    .message-input-container {
        padding: 15px;
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 1px solid #f1f5f9;
    }
    
    .message-input-wrapper {
        gap: 10px;
    }
    
    .message-input {
        padding: 12px 15px;
        font-size: 0.9em;
        min-height: 45px;
        max-height: 100px;
    }
    
    .send-btn {
        width: 45px;
        height: 45px;
        padding: 12px;
    }
    
    .quick-actions {
        margin-top: 10px;
        gap: 8px;
    }
    
    .quick-action {
        padding: 6px 12px;
        font-size: 0.8em;
    }
    
    /* Mobile-specific chat states */
    .chat-mobile-only {
        display: block;
    }
    
    .chat-desktop-only {
        display: none;
    }
    
    /* Back button for mobile */
    .chat-back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        margin: 0 15px; /* Removed top margin since we're using header padding */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        position: absolute;
        top: 50px; /* Position below menu toggle */
        left: 15px;
        z-index: 5;
    }
}

/* Small Mobile Devices */
@media (max-width: 480px) {
    .chat-section {
        margin: -0.5rem;
        height: calc(100vh - 50px);
    }
    
    .contact-item {
        padding: 12px;
    }
    
    .contact-avatar {
        width: 35px;
        height: 35px;
        font-size: 0.9em;
    }
    
    .message {
        max-width: 90%;
        padding: 10px 12px;
    }
    
    .message-text {
        font-size: 0.9em;
    }
    
    .message-input {
        padding: 10px 12px;
        font-size: 0.85em;
    }
    
    .send-btn {
        width: 40px;
        height: 40px;
        padding: 10px;
    }
    
    .quick-actions {
        gap: 5px;
    }
    
    .quick-action {
        padding: 5px 8px;
        font-size: 0.75em;
    }
}

/* Tablet Devices */
@media (min-width: 769px) and (max-width: 1024px) {
    .chat-contacts {
        width: 300px;
    }
    
    .contact-item {
        padding: 15px;
    }
    
    .message {
        max-width: 75%;
    }
}

/* Mobile Landscape Orientation */
@media (max-height: 500px) and (max-width: 768px) {
    .chat-contacts {
        height: 35vh;
    }
    
    .chat-messages {
        height: 65vh;
    }
    
    .contacts-list {
        max-height: calc(35vh - 70px);
    }
    
    .messages-container {
        max-height: calc(65vh - 130px);
    }
}

/* ============================================= */
/* MOBILE CHAT INTERACTION ENHANCEMENTS */
/* ============================================= */

/* Add touch-friendly improvements */
.contact-item {
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}

.message-input {
    -webkit-user-select: text;
    user-select: text;
}

/* Smooth transitions for mobile */
.chat-container {
    transition: all 0.3s ease;
}

/* Mobile swipe gestures (optional) */
.chat-contacts, .chat-messages {
    -webkit-overflow-scrolling: touch;
}
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 24px;
            transition: var(--transition);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: white;
            padding: 16px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .page-title h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .page-title p {
            color: var(--gray);
            font-size: 14px;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Availability Toggle Styles */
        .availability-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-light);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
      
        .notification-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: var(--primary-dark);
        }

        /* Stats Container */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 24px;
        }

        .stat-icon.blue {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .stat-icon.green {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .stat-icon.pink {
            background: rgba(247, 37, 133, 0.1);
            color: var(--accent);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

/* Notification Styles */
.notification-btn {
  position: relative;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--gray-light);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
}

.notification-btn:hover {
  background: var(--primary-light);
  color: white;
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--accent);
  color: white;
  font-size: 10px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}

.notification-dropdown {
  position: absolute;
  top: 50px;
  right: 0;
  width: 350px;
  background: white;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow-hover);
  z-index: 2000;
  display: none;
  max-height: 400px;
  overflow-y: auto;
}

.notification-item {
  padding: 12px;
  border-bottom: 1px solid var(--gray-light);
  cursor: pointer;
  transition: background 0.2s;
}

.notification-item:hover {
  background: var(--gray-light);
}

.notification-item.unread {
  background: rgba(67, 97, 238, 0.05);
}

.notification-item:active {
    transform: scale(0.98);
    background-color: var(--background-active, #e9ecef);
}

.notification-item.read-transition {
    opacity: 0.7;
    background-color: var(--background-read, #f8f9fa);
}

.notification-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 15px;
  border-radius: var(--border-radius-sm);
  box-shadow: var(--box-shadow-hover);
  z-index: 3000;
  max-width: 300px;
  animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
        
        /* Dashboard Sections */
        .dashboard-section {
            display: none;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 24px;
            margin-bottom: 30px;
        }

        .dashboard-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-light);
        }

        .section-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timestamp-cell {
            font-size: 12px;
            color: var(--gray);
        }

        .status-reschedule-requested {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .status-cancelled {
            background: rgba(230, 57, 70, 0.1);
            color: var(--error);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .sessions-table th:nth-child(7),
        .sessions-table td:nth-child(7) {
            white-space: nowrap;
            min-width: 160px;
        }

        /* Profile Card */
        .profile-card {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            padding: 24px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-right: 20px;
        }

        .profile-details {
            flex: 1;
        }

        .profile-details h3 {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .profile-details p {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--gray);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-verified {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .edit-profile-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .edit-profile-btn:hover {
            background: var(--primary-dark);
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius-sm);
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .save-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .save-btn:hover {
            background: var(--primary-dark);
        }

        /* Add to your CSS section */
        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }
        
        /* Session Cards */
        .session-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .session-card:hover {
            box-shadow: var(--box-shadow-hover);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .session-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-dark);
        }

        .session-date {
            color: var(--gray);
            font-size: 14px;
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .session-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
        }

        .session-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-success:hover {
            background: var(--success-light);
        }

        .btn-danger {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-danger:hover {
            background: #c53030;
        }

        /* Tutors/Students Container */
        .tutors-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .tutor-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .tutor-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }

        .tutor-header {
            padding: 20px;
            text-align: center;
            background: linear-gradient(to right, var(--primary-light), var(--primary));
            color: white;
        }

        .tutor-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--glass-bg);
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .tutor-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tutor-subject {
            font-size: 14px;
            opacity: 0.9;
        }

        .tutor-details {
            padding: 20px;
        }

        .tutor-details p {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--gray);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray);
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .tab:hover {
            color: var(--primary-dark);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tables */
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }

        .sessions-table th,
        .sessions-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .sessions-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 600;
    border: none;
}

        .sessions-table tr:hover {
            background: rgba(67, 97, 238, 0.03);
        }

        .total-earnings {
            text-align: right;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            padding: 16px;
            background: var(--gray-light);
            border-radius: var(--border-radius-sm);
        }

        /* Modal Styles */
        .modal {
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: none; /* This is key */
    align-items: center;
    justify-content: center;
}

.modal[style*="display: none"] {
    display: none !important;
    visibility: hidden !important;
}
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-dark);
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-actions {
            padding: 20px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

/* NUCLEAR MODAL HIDING */
.modal[style*="display: none"],
.modal[style*="display:none"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
}

/* Ensure hidden modals stay hidden */
.modal:not([style*="display: flex"]):not([style*="display: block"]) {
    display: none !important;
}
        
        /* Reschedule status styles */
        .session-card.reschedule-pending {
            border-left: 4px solid var(--warning);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .stat-icon.orange {
            background: rgba(255, 165, 0, 0.1);
            color: #ff8c00;
        }

        /* Menu Toggle for Mobile */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--box-shadow);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .main-content {
                margin-left: 240px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

/* ------------------------------------------------------------------ */
/* CSS FIX FOR LINGERING OVERLAY/MODAL BACKDROP */
/* ------------------------------------------------------------------ */

.modal-backdrop, 
.loading-overlay {
    /* * The core CSS fix: always force the inactive state to be hidden 
     * and non-interactable, unless the 'is-active' class is present.
     */
    visibility: hidden;
    opacity: 0;
    pointer-events: none; /* Crucial: ensures clicks pass through */
    transition: opacity 0.3s, visibility 0.3s;
    
    /* Ensure it covers the whole screen, which causes the linger issue */
    position: fixed; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999; /* Must be high */
    background: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
}

/* Force the overlay to be visible and clickable when the JS adds the 'is-active' class */
.modal-backdrop.is-active, 
.loading-overlay.is-active {
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
}
        
        @media (max-width: 768px) {
  .menu-toggle {
    display: flex !important;
    position: fixed;     /* Stays in viewport */
    top: 20px;
    left: 20px;
    z-index: 1100;      /* Higher than sidebar */
  }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 80px 16px 24px;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .profile-card {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 16px;
            }
            
            .tutors-container {
                grid-template-columns: 1fr;
            }
            
            .session-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .session-actions {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 1px solid var(--gray-light);
            }
            
            .tab.active {
                border-bottom: 2px solid var(--primary);
            }
        }
    </style>
</head>
<body>
    <div class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </div>
    <div class="chat-mobile-only" id="mobileChatHeader" style="display: none;">
    <div class="chat-back-btn" id="chatBackBtn">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
    </div>
</div>
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="Tklesson3.png" alt="Tklesson Logo">
                    <h1>Tklesson</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="userName">Tutor Name</h3>
                        <p id="userRole">Tutor</p>
                    </div>
                </div>
            </div>

            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="#profile" class="active" data-section="profile">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#tutoring-opportunities" data-section="tutoring-opportunities">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Tutoring Opportunities</span>
                        <span class="notification-badge" id="pendingCount" style="display: none;">0</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#my-students" data-section="my-students">
                        <i class="fas fa-users"></i>
                        <span>My Students</span>
                    </a>
                </li>
                <li class="menu-item">
  <a href="#chat" data-section="chat">
    <i class="fas fa-comments"></i>
    <span>Messages</span>
    <span class="menu-badge" id="unreadMessagesCount" style="display: none;">0</span>
  </a>
</li>
                <li class="menu-item">
                    <a href="#bookings" data-section="bookings">
                        <i class="fas fa-bookmark"></i>
                        <span>My Bookings</span>
                    </a>
                </li>
                <li class="menu-item">
    <a href="#ratings-reviews" data-section="ratings-reviews">
        <i class="fas fa-star"></i>
        <span>Ratings & Reviews</span>
        <span class="menu-badge" id="newReviewsCount" style="display: none;">0</span>
    </a>
</li>
                <li class="menu-item">
                    <a href="#sessions" data-section="sessions">
                        <i class="fas fa-history"></i>
                        <span>Sessions History</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#invoice-session" data-section="invoice-session">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Invoice Session</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#your-earnings" data-section="your-earnings">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Your Earnings</span>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="page-title">
                    <h2>Dashboard</h2>
                    <p>Welcome back! Here's your teaching overview</p>
                </div>
                <div class="top-bar-actions">
                    <div class="availability-toggle">
                        <span class="toggle-label" id="availabilityLabel">Available</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="availabilityToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="notification-btn" id="tutorNotificationBtn">
    <i class="fas fa-bell"></i>
    <span class="notification-badge" id="tutorNotificationCount" style="display: none;">0</span>
  </div>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-value" id="upcomingSessionsCount">0</div>
                    <div class="stat-label">Upcoming Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="activeStudentsCount">0</div>
                    <div class="stat-label">Active Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="pendingSessionsCount">0</div>
                    <div class="stat-label">Pending Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon pink">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-value" id="monthlyEarnings">$0</div>
                    <div class="stat-label">Monthly Earnings</div>
                </div>
            </div>

            <section id="profile" class="dashboard-section active">
                <div class="section-header">
                    <h3><i class="fas fa-user-circle"></i> Profile Information</h3>
                </div>

                <div class="profile-card">
                    <div class="profile-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="profile-details">
                        <h3 id="profileName">Tutor Name</h3>
                        <p><i class="fas fa-envelope"></i> <span id="profileEmail">tutor@example.com</span></p>
                        <p><i class="fas fa-user-tag"></i> <span id="profileRole">Tutor Account</span></p>
                        <span class="status-badge status-verified" id="profileStatus">Verified</span>
                    </div>
                    <button class="edit-profile-btn" id="editProfileBtn">Edit Profile</button>
                </div>

                <div class="section-header">
                    <h3><i class="fas fa-cog"></i> Account Settings</h3>
                </div>

                <form id="profileForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Full Name</label>
                            <input type="text" id="name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" class="form-control" disabled>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="role">Account Type</label>
                            <input type="text" id="role" class="form-control" value="Tutor" disabled>
                        </div>
                    </div>
                    <button type="button" class="save-btn" id="saveProfileBtn">Save Changes</button>
                </form>
            </section>

            <section id="tutoring-opportunities" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-calendar-alt"></i> Tutoring Opportunities</h3>
                </div>
                <div id="opportunitiesContainer">
                    <div class="spinner" id="opportunitiesSpinner"></div>
                </div>
            </section>

            <section id="my-students" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> My Students</h3>
                </div>
                <div id="studentsContainer">
                    <p>Loading student information...</p>
                </div>
            </section>

<section id="chat" class="dashboard-section">
  <div class="section-header">
    <h3><i class="fas fa-comments"></i> Messages</h3>
  </div>
  
  <div class="chat-section active" id="chatContainer">
    <div class="chat-header">
      <h3><i class="fas fa-comments"></i> Student Messages</h3>
    </div>
    
    <div class="chat-container">
      <!-- Contacts List - Shows Students -->
      <div class="chat-contacts">
        <div class="contact-search">
          <input type="text" id="contactSearch" placeholder="Search students...">
        </div>
        <div class="contacts-list" id="contactsList">
          <div class="empty-state">
            <i class="fas fa-comments"></i>
            <h4>No Conversations</h4>
            <p>Your conversations with students will appear here</p>
          </div>
        </div>
      </div>
      
      <!-- Chat Messages Area -->
      <div class="chat-messages">
        <div class="chat-empty-state" id="emptyChatState">
          <i class="fas fa-comments"></i>
          <h4>No Chat Selected</h4>
          <p>Select a conversation to message a student</p>
        </div>
        
        <div class="chat-header-detail" id="chatHeader" style="display: none;">
          <div class="current-contact">
            <div class="contact-avatar">
              <i class="fas fa-user-graduate"></i> <!-- Changed icon for student -->
            </div>
            <div class="contact-info">
              <div class="contact-name" id="currentContactName">Student Name</div>
              <div class="contact-subject" id="currentContactSubject">Subject</div>
            </div>
          </div>
          <div class="chat-actions">
            <!-- Optional: Different actions for tutors -->
            <button class="action-btn" onclick="viewStudentSchedule()">
              <i class="fas fa-calendar"></i> View Schedule
            </button>
          </div>
        </div>
        
        <!-- Messages container and input stay the same -->
        <div class="messages-container" id="messagesContainer" style="display: none;">
          <!-- Messages will be loaded here -->
        </div>
        
        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="message-input-wrapper">
            <textarea 
              class="message-input" 
              id="messageInput" 
              placeholder="Type your message..."
              rows="1"
            ></textarea>
            <button class="send-btn" id="sendMessageBtn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="quick-actions">
            <!-- Different quick messages for tutors -->
            <button class="quick-action" onclick="insertQuickMessage('I can help you with that in our next session.')">
              Session Help
            </button>
            <button class="quick-action" onclick="insertQuickMessage('Great work on the last assignment!')">
              Positive Feedback
            </button>
            <button class="quick-action" onclick="insertQuickMessage('Let me send you some practice materials.')">
              Study Materials
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="ratings-reviews" class="dashboard-section">
    <div class="section-header">
        <h3><i class="fas fa-star"></i> Ratings & Reviews</h3>
    </div>
    
    <!-- Add tutor guidance section -->
    <div class="tutor-guidance">
        <h4>Professional Responses Build Trust</h4>
        <p>Respond thoughtfully to student feedback to demonstrate your commitment to improvement and build stronger relationships.</p>
        <div class="response-guidelines">
            <i class="fas fa-graduation-cap"></i>
            <strong>Professional Response Guidelines:</strong>
            <ul>
                <li>Thank students for their feedback</li>
                <li>Address concerns constructively</li>
                <li>Maintain professional tone always</li>
                <li>Focus on learning improvement</li>
            </ul>
        </div>
    </div>
    
    <div class="ratings-overview">
        <div class="overview-stats">
            <div class="rating-summary">
                <div class="average-rating">
                    <span class="rating-value" id="averageRating">0.0</span>
                    <div class="stars" id="averageStars"></div>
                    <span class="rating-count" id="totalReviews">0 Reviews</span>
                </div>
            </div>
            <div class="rating-breakdown">
                <div class="rating-bar">
                    <span>5 stars</span>
                    <div class="bar-container">
                        <div class="bar-fill" data-rating="5"></div>
                    </div>
                    <span class="count" id="count5">0</span>
                </div>
                <!-- Repeat for 4, 3, 2, 1 stars -->
            </div>
        </div>
    </div>
    
    <div class="reviews-container" id="reviewsContainer">
        <!-- Reviews will be loaded here -->
    </div>
</section>
            
           <section id="bookings" class="dashboard-section">
    <div class="bookings-section">
        <div class="section-header">
            <h1 class="section-title">My Bookings</h1>
            <div class="upcoming-sessions-badge">
                <i class="fas fa-calendar-check"></i>
                <span id="upcomingSessionsCount">0</span> Upcoming Sessions
            </div>
        </div>
        
        <div id="bookingsContainer" class="bookings-grid">
            <!-- Bookings will be dynamically inserted here -->
        </div>
    </div>
</section>
            
            <section id="sessions" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-history"></i> Sessions History</h3>
                </div>

                <div class="filter-section">
                    <div class="filter-group">
                        <label for="historyFilter">Time Period:</label>
                        <select id="historyFilter" class="form-control">
                            <option value="all">All Time</option>
                            <option value="month">This Month</option>
                            <option value="3months">Last 3 Months</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="actionTypeFilter">Action Type:</label>
                        <select id="actionTypeFilter" class="form-control">
                            <option value="all">All Actions</option>
                            <option value="session confirmed">Session Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="tutor cancelled">Tutor Cancelled</option>
                            <option value="tutor reschedule request">Tutor Reschedule Request</option>
                            <option value="student cancelled">Student Cancelled</option>
                            <option value="rescheduled">Rescheduled</option>
                            <option value="session held">Session Held</option>
                        </select>
                    </div>
                </div>

                <div id="sessionsContainer">
                    <div class="spinner" id="sessionsSpinner"></div>
                </div>
            </section> <!-- ✅ ADD THIS CLOSING TAG -->

            
            <section id="invoice-session" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Invoice Session</h3>
                </div>
                
                <form id="invoiceForm">
                    <div class="form-group">
                        <label for="completedSession">Select Completed Session</label>
                        <select id="completedSession" class="form-control">
                            <option value="">Loading completed sessions...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hours">Hours</label>
                            <input type="number" id="hours" class="form-control" value="1" min="0.5" step="0.5">
                        </div>
                        <div class="form-group">
                            <label for="rate">Hourly Rate ($)</label>
                            <input type="number" id="rate" class="form-control" value="40" min="0" step="5" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="invoiceNotes">Session Note for Invoice (Optional)</label>
                        <textarea id="invoiceNotes" class="form-control" rows="4" placeholder="Enter notes related to this invoice."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="total">Total Amount ($)</label>
                        <input type="text" id="total" class="form-control" value="60.00" readonly>
                    </div>
                    <button type="submit" class="save-btn" id="generateInvoiceBtn">Generate Invoice</button>
                </form>
            </section>

            <section id="your-earnings" class="dashboard-section">
                <div class="section-header">
                    <h3><i class="fas fa-dollar-sign"></i> Your Earnings</h3>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="earnings-overview">Overview</div>
                    <div class="tab" data-tab="earnings-history">Earnings History</div>
                </div>
                
                <div class="tab-content active" id="earnings-overview">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon blue">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-value" id="totalSessionsCount">0</div>
                            <div class="stat-label">Total Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-value" id="totalEarnings">$0</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon pink">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value" id="avgSessionEarnings">$0</div>
                            <div class="stat-label">Avg. per Session</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value" id="totalHours">0</div>
                            <div class="stat-label">Total Hours</div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="earnings-history">
                    <table class="sessions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Subject</th>
                                <th>Hours</th>
                                <th>Rate</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="earningsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">No earnings history available</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="total-earnings">
                        Total: <span id="earningsTotal">$0.00</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for Session Details -->
    <div class="modal" id="sessionModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Session Details</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="sessionModalBody">
                <!-- Session details will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="btn-outline" id="closeModalBtn">Close</button>
                <button class="btn-primary" id="confirmSessionBtn">Confirm Session</button>
            </div>
        </div>
    </div>

    <!-- Modal for Reschedule Request -->
    <div class="modal" id="rescheduleModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Request Reschedule</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="rescheduleForm">
                    <div class="form-group">
                        <label for="rescheduleDate">New Date</label>
                        <input type="date" id="rescheduleDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="rescheduleTime">New Time</label>
                        <input type="time" id="rescheduleTime" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="rescheduleReason">Reason for Reschedule</label>
                        <textarea id="rescheduleReason" class="form-control" rows="3" placeholder="Please provide a reason for rescheduling this session." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn-outline" id="cancelRescheduleBtn">Cancel</button>
                <button class="btn-primary" id="submitRescheduleBtn">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Modal for Cancel Session -->
    <div class="modal" id="cancelModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cancel Session</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="cancelForm">
                    <div class="form-group">
                        <label for="cancelReason">Reason for Cancellation</label>
                        <textarea id="cancelReason" class="form-control" rows="3" placeholder="Please provide a reason for cancelling this session." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn-outline" id="cancelCancelBtn">Cancel</button>
                <button class="btn-danger" id="confirmCancelBtn">Confirm Cancellation</button>
            </div>
        </div>
    </div>
    
   <script>
// Firebase configuration and initialization
const firebaseConfig = {
    apiKey: "AIzaSyBjo5LY4EsFlX8j_8NbLUObooUsCqJM8KM",
    authDomain: "tk-scheduler.firebaseapp.com",
    projectId: "tk-scheduler",
    storageBucket: "tk-scheduler.appspot.com",
    messagingSenderId: "746606755052",
    appId: "1:746606755052:web:d7eae92976cb2f2fa9f9c9",
    measurementId: "G-Q5L607R3N7"
};

// Initialize Firebase with compat version
firebase.initializeApp(firebaseConfig);

// Initialize Firebase services
const auth = firebase.auth();
const db = firebase.firestore();

//Basic Functionality starts here. This includes log out, inactivity timer, sidebar navigation, among others. 
       
// Global variables
let currentUser = null;
let userData = null;
let inactivityTimer;
let pendingSessions = [];
let confirmedSessions = [];
let sessionsLoaded = false;
let tutorsLoaded = false;
let bookingsLoaded = false;
let currentSessionsPage = 1;
const SESSIONS_PER_PAGE = 10;

// Inactivity timer functions
function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(logoutDueToInactivity, 2 * 60 * 60 * 1000); // 2 hours
}

function logoutDueToInactivity() {
    alert('You have been logged out due to inactivity.');
    auth.signOut().then(() => {
        window.location.href = 'tutor-login.html';
    });
}

function setupActivityListeners() {
    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
    
    events.forEach(event => {
        document.addEventListener(event, resetInactivityTimer);
    });
    
    // Also reset timer when navigating between sections
    const menuItems = document.querySelectorAll('.menu-item a');
    menuItems.forEach(item => {
        item.addEventListener('click', resetInactivityTimer);
    });
}

// Helper function to safely get user's full name with role
function getUserDisplayInfo(userData, currentUser, defaultRole = 'Tutor') {
    const name = userData?.fullName || currentUser?.displayName || 
                currentUser?.email?.split('@')[0] || defaultRole;
    
    const role = userData?.role ? 
                userData.role.charAt(0).toUpperCase() + userData.role.slice(1) : 
                defaultRole;
    
    return { name, role };
}

// Authentication state listener
auth.onAuthStateChanged((user) => {
    if (user) {
        // Start inactivity timer
        resetInactivityTimer();
        setupActivityListeners();
        
        // Load user data
        currentUser = user;
        loadUserData(user.uid);
        loadDashboardData().then(() => {
        loadTutoringOpportunities(user.uid);
        loadMyStudents();

            // Initialize profile editing functionality
            setupProfileEditing();
        });
    } else {
        // Clear timer if user logs out manually
        clearTimeout(inactivityTimer);
        window.location.href = 'tutor-login.html';
    }
});

// Logout functionality
function setupLogout() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'tutor-login.html';
                });
            }
        });
    }
}

// Sidebar Navigation and Section Switching
function setupSidebarNavigation() {
    // Get all menu items and sections
    const menuItems = document.querySelectorAll('.menu-item a');
    const sections = document.querySelectorAll('.dashboard-section');
    
    // Add click event listeners to menu items
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all menu items and sections
            menuItems.forEach(i => i.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));
            
            // Add active class to clicked menu item
            this.classList.add('active');
            
            // Show corresponding section
            const sectionId = this.getAttribute('data-section');
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Load section-specific content
                loadSectionContent(sectionId);
                
                // Refresh tutoring opportunities when switching to that section
                if (sectionId === 'tutoring-opportunities' && typeof currentUser !== 'undefined') {
                    // Small delay to ensure section is visible before showing spinner
                    setTimeout(() => {
                        loadTutoringOpportunities(currentUser.uid);
                    }, 50);
                }
            } // ← This was missing
            
            // Close sidebar on mobile after clicking
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });
    });
}
       
// Add this global variable at the top with your other globals
let currentSection = 'profile';
let sectionLoading = false;

// Load content for specific sections
function loadSectionContent(sectionId) {
    // Prevent loading if already loading or same section
    if (sectionLoading || currentSection === sectionId) return;
    
    sectionLoading = true;
    currentSection = sectionId;

    switch(sectionId) {
        case 'ratings-reviews':
            initRatingsAndReviews();
            break;
        case 'my-students':
            if (!tutorsLoaded) {
                loadMyStudents();
                tutorsLoaded = true;
            }
            break;
        case 'bookings':
            case 'bookings':
    if (currentUser && currentUser.uid) {
        loadMyBookings(); // This will run EVERY time bookings tab is clicked
    } else {
        const container = document.getElementById('bookingsContainer');
        if (container) {
            container.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Authentication Required</h3>
                    <p>Please log in to view your bookings.</p>
                </div>
            `;
        }
    }
    break;
        case 'sessions':
            if (!sessionsLoaded) {
                loadSessionsHistory();
                sessionsLoaded = true;
            }
            break;
        // Add other cases as needed
    }
    
    sectionLoading = false;
}
       
// Mobile menu toggle
function setupMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    
    if (menuToggle) {
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
        });
    }
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
            if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });
}

// Tab functionality for earnings section
function setupEarningsTabs() {
    const tabs = document.querySelectorAll('.tab[data-tab]');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
}

// Modal functionality
function setupModals() {
    // Close modals when clicking X
    const closeButtons = document.querySelectorAll('.close-modal');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
                // Force cleanup
                setTimeout(forceRemoveOverlays, 100);
            }
        });
    });
    
    // Close modals when clicking outside
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                setTimeout(forceRemoveOverlays, 100);
            }
        });
    });
    
    // Close modal buttons
    const closeModalBtn = document.getElementById('closeModalBtn');
if (closeModalBtn) {
    closeModalBtn.addEventListener('click', function() {
        const modal = document.getElementById('sessionModal');
        modal.style.display = 'none';
        // Force remove any lingering overlays
        forceRemoveOverlays();
    });
}
    
    const cancelRescheduleBtn = document.getElementById('cancelRescheduleBtn');
    if (cancelRescheduleBtn) {
        cancelRescheduleBtn.addEventListener('click', function() {
            document.getElementById('rescheduleModal').style.display = 'none';
        });
    }
    
    const cancelCancelBtn = document.getElementById('cancelCancelBtn');
    if (cancelCancelBtn) {
        cancelCancelBtn.addEventListener('click', function() {
            document.getElementById('cancelModal').style.display = 'none';
        });
    }
}

// Initialize all functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupSidebarNavigation();
    setupMobileMenu();
    setupEarningsTabs();
    setupModals();
    setupResponsiveSessions(); // Add this line
    initStudentSchedule();
    setupLogout();
    
    // Initialize invoice form calculations
    setupInvoiceCalculations();
});
       
// PROFILE SECTION STARTS HERE
// =============================================

async function loadDashboardData() {
    if (!currentUser || !currentUser.uid) {
        console.error("No user logged in");
        return;
    }
    
    const uid = currentUser.uid;
    const tutorId = currentUser.uid; // Define tutorId here
    await loadUserData(uid);
    await loadTutoringOpportunities(uid); // Use uid instead of tutorId
    await loadMyBookings();  
    await loadEarningsData();    // Add other essential data loads here
}
       
// Load user data from Firestore
async function loadUserData(uid) {
    try {
        const userDoc = await db.collection('tutors').doc(uid).get();
        const container = document.getElementById('profile');
        
        if (userDoc.exists) {
            userData = userDoc.data();
            updateProfileUI(userData);
            updateUIWithUserData();
            setupAvailabilityToggle(); // Initialize the toggle after loading user data
        } else {
            container.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Profile Not Found</h3>
                    <p>Please complete your profile setup.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error("Error loading user data:", error);
        showErrorMessage('Failed to load profile data. Please refresh the page.');
    }
}
       
// Fixed UI update function
function updateProfileUI(data) {
    const name = data.fullName || data.name || 'Tutor';
    const email = data.email || currentUser.email || 'No email';
    const phone = data.phone || data.personal?.phone || 'Not provided';
    const role = data.role ? data.role.charAt(0).toUpperCase() + data.role.slice(1) : 'Tutor';
    
    // Update display elements
    document.getElementById('profileName').textContent = name;
    document.getElementById('profileEmail').textContent = email;
    document.getElementById('profileRole').textContent = `${role} Account`;
    
    // Add phone display to profile card if element exists, otherwise create it
    let phoneElement = document.getElementById('profilePhone');
    if (!phoneElement) {
        // Add phone line to profile card
        const profileDetails = document.querySelector('.profile-details');
        const roleElement = profileDetails.querySelector('p:nth-child(3)'); // Get the role line
        const phoneLine = document.createElement('p');
        phoneLine.innerHTML = '<i class="fas fa-phone"></i> <span id="profilePhone">' + phone + '</span>';
        profileDetails.insertBefore(phoneLine, roleElement);
    } else {
        phoneElement.textContent = phone;
    }
    
    // Update form fields
    document.getElementById('name').value = name;
    document.getElementById('email').value = email;
    document.getElementById('phone').value = phone === 'Not provided' ? '' : phone;
    document.getElementById('role').value = role;
}

// Update all UI elements with user data
function updateUIWithUserData() {
    if (!userData || !currentUser) return;
    
    const { name, role } = getUserDisplayInfo(userData, currentUser);
    
    // Update sidebar and other UI elements
    document.getElementById('userName').textContent = name;
    document.getElementById('profileName').textContent = name;
    
    const email = userData.email || currentUser.email || 'No email';
    document.getElementById('profileEmail').textContent = email;
}

// Enhanced phone validation helper
function isValidPhone(phone) {
    if (!phone) return true; // Phone is optional
    const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
    return phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''));
}

// Enhanced save profile changes
async function saveProfileChanges(name, phone) {
    try {
        const updateData = {
            fullName: name,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Only update phone if it's provided and different from current
        if (phone !== (userData.phone || userData.personal?.phone || '')) {
            updateData.phone = phone || '';
            
            // Also update in personal subcollection if it exists
            if (userData.personal) {
                updateData['personal.phone'] = phone || '';
            }
        }
        
        await db.collection('tutors').doc(currentUser.uid).update(updateData);
        
        // Update local userData
        userData.fullName = name;
        userData.phone = phone || '';
        if (userData.personal) {
            userData.personal.phone = phone || '';
        }
        
        // Update UI immediately
        updateProfileUI(userData);
        
        // Reset form
        document.getElementById('profileForm').style.display = 'none';
        document.getElementById('editProfileBtn').textContent = 'Edit Profile';
        document.getElementById('editProfileBtn').classList.remove('editing');
        
        showSuccessMessage('Profile updated successfully!');
        
    } catch (error) {
        console.error("Error updating profile:", error);
        showErrorMessage('Error updating profile. Please try again.');
    }
}

// Enhanced setupProfileEditing with phone validation
function setupProfileEditing() {
    let originalValues = {};
    
    document.getElementById('editProfileBtn').addEventListener('click', function() {
        const form = document.getElementById('profileForm');
        
        if (form.style.display === 'none') {
            // Store original values before editing
            originalValues = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value
            };
            
            form.style.display = 'block';
            this.textContent = 'Cancel Editing';
            this.classList.add('editing');
        } else {
            // Cancel editing - reset to original values
            document.getElementById('name').value = originalValues.name;
            document.getElementById('phone').value = originalValues.phone;
            
            form.style.display = 'none';
            this.textContent = 'Edit Profile';
            this.classList.remove('editing');
        }
    });
    
    document.getElementById('saveProfileBtn').addEventListener('click', function() {
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        
        // Enhanced validation
        if (!name) {
            alert('Please enter your full name');
            return;
        }
        
        if (phone && !isValidPhone(phone)) {
            alert('Please enter a valid phone number (digits only, optional country code)');
            return;
        }
        
        saveProfileChanges(name, phone);
    });
}

// Utility functions for messages (keep existing)
function showSuccessMessage(message) {
    // You could use a toast notification here
    alert(message);
}

function showErrorMessage(message) {
    alert(message);
}

function setupAvailabilityToggle() {
    const toggle = document.getElementById('availabilityToggle');
    const label = document.getElementById('availabilityLabel');
    
    // Load current availability from Firestore
    if (userData) {
        const isAvailable = userData.available !== false; // Default to true if not set
        toggle.checked = isAvailable;
        updateAvailabilityLabel(label, isAvailable);
    }
    
    // Handle toggle changes
    toggle.addEventListener('change', async function() {
        const isAvailable = this.checked;
        
        try {
            // Update Firestore
            await db.collection('tutors').doc(currentUser.uid).update({
                available: isAvailable,
                isAvailable: isAvailable, // Update both fields for consistency
                lastAvailabilityUpdate: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update local userData
            userData.available = isAvailable;
            userData.isAvailable = isAvailable;
            
            // Update UI
            updateAvailabilityLabel(label, isAvailable);
            
            console.log('Availability updated to:', isAvailable);
            
        } catch (error) {
            console.error("Error updating availability:", error);
            // Revert toggle on error
            this.checked = !isAvailable;
            alert('Error updating availability. Please try again.');
        }
    });
}

function updateAvailabilityLabel(label, isAvailable) {
    label.textContent = isAvailable ? 'Available' : 'Unavailable';
    label.style.color = isAvailable ? 'var(--success)' : 'var(--error)';
}


// =============================================
// PROFILE SECTION ENDS HERE
// =============================================

// Tutoring Opportunities Section starts here. All JS functionalities of the Tutoring Opportunities section starts here

// Load tutoring opportunities (pending sessions)
async function loadTutoringOpportunities(tutorId) {
    const container = document.getElementById('opportunitiesContainer');
    container.innerHTML = '<div class="spinner" id="opportunitiesSpinner"></div>';
    
    try {
        // Query sessions where this tutor is assigned and status is pending
        const querySnapshot = await db.collection('bookedSessions')
            .where('tutorId', '==', tutorId)
            .where('status', '==', 'pending')
            .orderBy('date', 'asc')
            .get();
        
        const pendingSessions = [];
        let pendingCount = 0;
        
        container.innerHTML = '';
        
        if (querySnapshot.empty) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h3>No Pending Sessions</h3>
                    <p>You don't have any pending session requests at the moment.</p>
                </div>
            `;
            document.getElementById('pendingSessionsCount').textContent = '0';
            document.getElementById('pendingCount').textContent = '0';
            return;
        }

        // Process each session
        for (const doc of querySnapshot.docs) {
            const session = doc.data();
            session.id = doc.id;
            pendingSessions.push(session);
            
            // Get student details
            let studentData = {};
            try {
                const studentDoc = await db.collection('students').doc(session.studentId).get();
                if (studentDoc.exists) {
                    studentData = studentDoc.data();
                }
            } catch (error) {
                console.error("Error loading student data:", error);
            }
            
            // Create session card
            const sessionCard = createSessionCard(session, studentData);
            container.appendChild(sessionCard);
            pendingCount++;
        }
        
        // Update counts
        updatePendingCount(pendingCount);
        
    } catch (error) {
        console.error("Error loading tutoring opportunities:", error);
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error Loading Opportunities</h3>
                <p>Failed to load tutoring opportunities. Please try again.</p>
            </div>
        `;
    }
}

// Create session card HTML
function createSessionCard(session, studentData) {
    const date = session.date.toDate();
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const card = document.createElement('div');
    card.className = 'session-card';
    card.id = `session-${session.id}`;
    
    card.innerHTML = `
        <div class="session-header">
            <div class="session-title">${session.subject} Session Request</div>
            <div class="session-date">${formattedDate}, ${formattedTime}</div>
        </div>
        <div class="session-details">
            <div class="session-detail">
                <i class="fas fa-user-graduate"></i> Student: ${studentData.fullName || session.studentName || 'Unknown Student'}
            </div>
            <div class="session-detail">
                <i class="fas fa-book"></i> Subject: ${session.subject || 'No subject'}
            </div>
            <div class="session-detail">
                <i class="fas fa-clock"></i> Duration: ${session.duration || '1.5'} hours
            </div>
            <div class="session-detail">
                <i class="fas ${session.sessionType === 'online' ? 'fa-video' : 'fa-map-marker-alt'}"></i> 
                ${session.sessionType === 'online' ? 'Online' : 'In-Person'}
            </div>
            <div class="session-detail">
                <i class="fas fa-video"></i> Jitsi Room: Will be created when you confirm
            </div>
            <div class="session-detail">
                <i class="fas fa-dollar-sign"></i> Rate: $${session.hourlyRate || '40'}/hour
            </div>
            <div class="session-detail">
                <i class="fas fa-sticky-note"></i> Notes: ${session.notes || 'No notes provided'}
            </div>
        </div>
        <div class="session-actions">
            <button class="btn-success confirm-btn" data-session-id="${session.id}">
                <i class="fas fa-check"></i> Confirm Session
            </button>
            <button class="btn-danger reject-btn" data-session-id="${session.id}">
                <i class="fas fa-times"></i> Reject
            </button>
        </div>
    `;
    
    // Add event listeners to buttons
    setTimeout(() => {
        const confirmBtn = card.querySelector('.confirm-btn');
        const rejectBtn = card.querySelector('.reject-btn');
        
        confirmBtn.addEventListener('click', () => confirmSession(session.id));
        rejectBtn.addEventListener('click', () => rejectSession(session.id));
    }, 100);
    
    return card;
}

// Generate Jitsi meeting room ID and link
function generateJitsiMeetLink() {
    const prefix = 'tutor-session-';
    const timestamp = Date.now();
    const randomId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    
    const jitsiRoomId = `${prefix}${randomId}-${timestamp}`;
    const meetId = `jitsi_${timestamp}_${Math.random().toString(36).substring(2, 10)}`;
    const meetLink = `https://meet.jit.si/${jitsiRoomId}`;
    
    return {
        jitsiRoomId,
        meetId,
        meetLink,
        meetPlatform: 'jitsi_meet',
        meetCreated: true
    };
}

// Main confirm session function - Tutor creates the Jitsi meeting
async function confirmSession(sessionId) {
    if (!confirm('Confirm this session?')) return;
    
    // Store reference to modal BEFORE async operations
    const sessionModal = document.getElementById('sessionModal');
    
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        if (!sessionDoc.exists) {
            alert('Session not found!');
            return;
        }
        
        const session = sessionDoc.data();
        session.id = sessionId;

        // Generate Jitsi meeting link (tutor as moderator)
        const jitsiMeetingData = generateJitsiMeetLink();
        
        // Update session status to confirmed and add tutor-generated Jitsi meeting
        await db.collection('bookedSessions').doc(sessionId).update({
            status: 'confirmed',
            ...jitsiMeetingData,
            confirmedAt: new Date(),
            confirmedBy: 'tutor',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Send notification to student with the new Jitsi meeting link
        await createSessionNotification(session, jitsiMeetingData.meetLink);
        
        // Show success message with the Jitsi meeting link
        showSessionConfirmationSuccess(session, jitsiMeetingData);
        
        // CRITICAL: Close the modal FIRST before any other UI updates
        if (sessionModal) {
            sessionModal.style.display = 'none';
            sessionModal.style.visibility = 'hidden';
        }
        
        // Small delay before showing success notification
        setTimeout(() => {
            showNotification('✅ Session confirmed! Jitsi meeting room created and student has been notified.', 'success');
        }, 300);
        
        // Refresh the UI
        if (typeof loadTutoringOpportunities === 'function' && typeof currentUser !== 'undefined') {
            loadTutoringOpportunities(currentUser.uid);
        }
        
    } catch (error) {
        console.error("Error confirming session:", error);
        showNotification('❌ Error confirming session. Please try again.', 'error');
        
        // Close modal even on error
        if (sessionModal) {
            sessionModal.style.display = 'none';
            sessionModal.style.visibility = 'hidden';
        }
    //} finally {
        // FINAL CLEANUP - This runs no matter what
       // setTimeout(() => {
         //   forceRemoveAllOverlays();
        //}, 100);
    //}
//}
       
    // Forcefully hide the lingering overlay/backdrop
const overlay = document.querySelector('.modal-backdrop') || document.getElementById('sessionModalOverlay');
if (overlay) {
    // Option 1: Hide by toggling a CSS class
    overlay.classList.remove('is-active'); 
    
    // Option 2: Force hide with inline CSS
    overlay.style.display = 'none'; 
}

function forceRemoveAllOverlays() {
    console.log('☢️ NUCLEAR OVERLAY REMOVAL INITIATED');
    
    // 1. Remove by ID - but NOT the success modal
    const modalIds = [
        'sessionModal', 'rescheduleModal', 'cancelModal',
        'bookingsRescheduleModal', 'bookingsCancelModal', 
        'bookingsDetailsModal', 'studentScheduleModal',
        'studentSessionsModal', 'studentProfileModal'
        // NOTE: NOT removing 'customSuccessModal'
    ];
    
    modalIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'none';
            element.style.visibility = 'hidden';
        }
    });
    
    // 2. Remove all .modal elements EXCEPT the success modal
    document.querySelectorAll('.modal').forEach(modal => {
        if (modal.id !== 'customSuccessModal') {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
        }
    });
    
    // 3. Remove all .modal-backdrop elements
    document.querySelectorAll('.modal-backdrop, .loading-overlay').forEach(backdrop => {
        backdrop.remove();
    });
    
    // 4. Find and remove any suspicious overlays by checking styles
    document.querySelectorAll('*').forEach(el => {
        const styles = window.getComputedStyle(el);
        
        // Check for overlay characteristics
        if (styles.position === 'fixed' && 
            styles.zIndex >= 1000 &&
            (styles.backgroundColor.includes('rgba(0, 0, 0') || 
             styles.background.includes('rgba(0, 0, 0'))) {
            
            // Check if it's covering the whole screen
            if (styles.width === '100%' || parseInt(styles.width) >= window.innerWidth - 50) {
                console.log('🗑️ Removing suspicious overlay:', el.id, el.className);
                el.remove();
            }
        }
    });
    
    // 5. Reset body styles
    document.body.style.overflow = '';
    document.body.style.pointerEvents = '';
    document.body.style.position = '';
    
    // 6. Recreate modals (they'll be hidden by default)
    setTimeout(recreateModals, 200);
    
    console.log('✅ Nuclear cleanup complete');
}
        
function closeSuccessModal() {
    const modal = document.getElementById('customSuccessModal');
    if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

// Make it globally accessible
window.closeSuccessModal = closeSuccessModal;
        
        // Check for overlay characteristics
        if (styles.position === 'fixed' && 
            styles.zIndex >= 1000 &&
            (styles.backgroundColor.includes('rgba(0, 0, 0') || 
             styles.background.includes('rgba(0, 0, 0'))) {
            
            // Check if it's covering the whole screen
            if (styles.width === '100%' || parseInt(styles.width) >= window.innerWidth - 50) {
                console.log('🗑️ Removing suspicious overlay:', el.id, el.className);
                el.remove();
            }
        }
    });
    
    // 5. Reset body styles
    document.body.style.overflow = '';
    document.body.style.pointerEvents = '';
    document.body.style.position = '';
    
    // 6. Recreate modals (they'll be hidden by default)
    setTimeout(recreateModals, 200);
    
    console.log('✅ Nuclear cleanup complete');
}

function recreateModals() {
    // Recreate the session modal
    if (!document.getElementById('sessionModal')) {
        const modal = document.createElement('div');
        modal.id = 'sessionModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Session Details</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="sessionModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="closeModalBtn">Close</button>
                    <button class="btn-primary" id="confirmSessionBtn">Confirm Session</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Re-setup modal listeners
        setupModals();
    }
}
       
// Create session notification for student
async function createSessionNotification(session, meetLink) {
    const sessionDate = session.date.toDate();
    
    await db.collection('notifications').add({
        userId: session.studentId,
        type: 'session_confirmed',
        title: 'Session Confirmed! 🎯',
        message: `Your ${session.subject} session has been confirmed by ${session.tutorName || 'your tutor'}.`,
        details: {
            subject: session.subject,
            date: sessionDate.toLocaleDateString(),
            time: sessionDate.toLocaleTimeString(),
            duration: session.duration,
            meetLink: meetLink,
            tutorName: session.tutorName || 'Your Tutor',
            sessionId: session.id,
            meetPlatform: 'jitsi_meet',
            meetGeneratedBy: 'tutor'
        },
        relatedSessionId: session.id,
        isRead: false,
        priority: 'high',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}

// Show confirmation success with Jitsi meeting link
function showSessionConfirmationSuccess(session, jitsiMeetingData) {
    const modalContent = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; color: #4CAF50; margin-bottom: 15px;">✅</div>
            <h3 style="color: #2E7D32; margin-bottom: 10px;">Session Confirmed!</h3>
            <p>The student has been notified and a Jitsi meeting room has been created with you as the moderator.</p>
            
            <div style="background: #E8F5E8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #4CAF50;">
                <i class="fas fa-crown" style="color: #FFD700; margin-right: 5px;"></i>
                <strong>Your Jitsi Meeting Room (Moderator):</strong><br>
                <div style="word-break: break-all; margin: 10px 0; font-family: monospace; background: white; padding: 10px; border-radius: 4px;">
                    ${jitsiMeetingData.meetLink}
                </div>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 15px 0;">
                <button onclick="copyToClipboard('${jitsiMeetingData.meetLink}')" class="btn-primary">
                    <i class="fas fa-copy"></i> Copy Meeting Link
                </button>
                <button onclick="window.open('${jitsiMeetingData.meetLink}', '_blank', 'width=1000,height=700')" class="btn-success">
                    <i class="fas fa-video"></i> Open Jitsi Meeting
                </button>
            </div>
            
            <div style="background: #E3F2FD; padding: 12px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #2196F3;">
                <i class="fas fa-info-circle" style="color: #2196F3;"></i> 
                <strong>Room ID:</strong> ${jitsiMeetingData.jitsiRoomId}<br>
                <small>Share this ID with the student if they have trouble with the link</small>
            </div>
            
            <div style="background: #FFF3CD; padding: 10px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #FFC107;">
                <i class="fas fa-crown" style="color: #FFD700;"></i> 
                <strong>Moderator Access:</strong> As the meeting creator, you'll have moderator controls in Jitsi.
            </div>
        </div>
    `;
    
    showCustomModal('Session Confirmed - Jitsi Meeting Ready', modalContent);
}

// Utility function to copy link to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Jitsi meeting link copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Meeting link copied to clipboard!', 'success');
    });
}

// Show notification function
function showNotification(message, type = 'info') {
    // Create or use existing notification system
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        border-radius: 5px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

// Show custom modal function
function showCustomModal(title, content) {
    // Remove any existing custom modal first
    const existingModal = document.getElementById('customSuccessModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'customSuccessModal';
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 25px; border-radius: 10px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-top: 0; color: #333;">${title}</h2>
            ${content}
            <div style="text-align: center; margin-top: 20px;">
                <button id="closeCustomModalBtn" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add close button handler
    const closeBtn = document.getElementById('closeCustomModalBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            modal.remove();
        });
    }
    
    // Allow clicking outside to close
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
        
// Reject a session
async function rejectSession(sessionId) {
    if (!confirm('Are you sure you want to reject this session request? The student will receive their credits back.')) return;
    
    try {
        // Show loading state
        const rejectBtn = document.querySelector(`.reject-btn[data-session-id="${sessionId}"]`);
        if (rejectBtn) {
            const originalText = rejectBtn.innerHTML;
            rejectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
            rejectBtn.disabled = true;
        }

        // Call the cancelSession Cloud Function to handle credit refund
        const cancelSessionFunction = firebase.app().functions('us-central1').httpsCallable('cancelSession');
        const result = await cancelSessionFunction({
            sessionId: sessionId,
            cancelledBy: 'tutor_rejection',
            reason: 'Tutor rejected session request'
        });

        // Show success message with credit refund info
        // Show appropriate success message based on refund status
const message = result.data.refunded 
    ? 'Session rejected! Student credits have been refunded.'
    : 'Session rejected. Student credits were not refunded (within 24-hour window).';
    
showNotification(message, 'success');

// Update UI - mark as rejected with refund status
const sessionCard = document.getElementById(`session-${sessionId}`);
if (sessionCard) {
    const refundStatus = result.data.refunded ? 'Refunded' : 'Not Refunded';
    
    sessionCard.style.opacity = '0.6';
    sessionCard.querySelector('.session-actions').innerHTML = `
        <span class="status-badge status-rejected">
            Rejected - Credits ${refundStatus}
        </span>
    `;
    
    // Remove after brief delay
    setTimeout(() => {
        sessionCard.remove();
        loadMyBookings(); // Reload after removal
    }, 1500);
} else {
    // Fallback if card not found
    loadMyBookings();
}
        
        // Update counts
        const pendingCount = parseInt(document.getElementById('pendingCount').textContent) - 1;
        updatePendingCount(pendingCount);
        
    } catch (error) {
        console.error("Error rejecting session:", error);
        
        // Restore button if it exists
        const rejectBtn = document.querySelector(`.reject-btn[data-session-id="${sessionId}"]`);
        if (rejectBtn) {
            rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
            rejectBtn.disabled = false;
        }
        
        let errorMessage = 'Error rejecting session. Please try again.';
        
        if (error.message && error.message.includes('not found')) {
            errorMessage = 'Session not found or already processed.';
        } else if (error.message && error.message.includes('permission')) {
            errorMessage = 'You do not have permission to reject this session.';
        } else if (error.details) {
            errorMessage = error.details;
        }
        
        showNotification(errorMessage, 'error');
    }
}
       
// Update pending count in sidebar, top bar, and stats card
function updatePendingCount(count) {
    const pendingCountElement = document.getElementById('pendingCount');
    const notificationCountElement = document.getElementById('notificationCount');
    const pendingSessionsCountElement = document.getElementById('pendingSessionsCount');
    
    // Update notification badges (sidebar and top bar)
    if (count > 0) {
        if (pendingCountElement) {
            pendingCountElement.textContent = count;
            pendingCountElement.style.display = 'inline-block';
        }
        if (notificationCountElement) {
            notificationCountElement.textContent = count;
            notificationCountElement.style.display = 'inline-block';
        }
    } else {
        if (pendingCountElement) {
            pendingCountElement.style.display = 'none';
        }
        if (notificationCountElement) {
            notificationCountElement.style.display = 'none';
        }
    }
    
    // Update stats card (always visible, even when count is 0)
    if (pendingSessionsCountElement) {
        pendingSessionsCountElement.textContent = count;
    }
}

     
// =======================================================================================================================================
// Tutoring Opportunities Section ends here. All JS functionalities of the Tutoring Opportunities section ends here       
// =======================================================================================================================================       
// =======================================================================================================================================
// MY STUDENTS SECTION STARTS HERE
// =======================================================================================================================================

// Load students who have booked sessions with this tutor
async function loadMyStudents() {
    const container = document.getElementById('studentsContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="spinner">Loading students...</div>';
    
    try {
        // Get all sessions for this tutor (excluding cancelled ones)
        const sessionsSnapshot = await db.collection('bookedSessions')
            .where('tutorId', '==', currentUser.uid)
            .where('status', 'in', ['pending', 'confirmed', 'completed', 'rescheduled'])
            .orderBy('date', 'desc')
            .get();
        
        if (sessionsSnapshot.empty) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <h3>No Students Yet</h3>
                    <p>Students will appear here once they book sessions with you.</p>
                </div>
            `;
            document.getElementById('activeStudentsCount').textContent = '0';
            return;
        }
        
        // Get all invoices to count invoiced sessions
        const invoicesSnapshot = await db.collection('tutorInvoices')
            .where('tutorId', '==', currentUser.uid)
            .get();
        
        // Create a map of session IDs that have been invoiced
        const invoicedSessions = new Map();
        invoicesSnapshot.forEach(doc => {
            const invoice = doc.data();
            if (invoice.sessionId) {
                invoicedSessions.set(invoice.sessionId, true);
            }
        });
        
        // Organize students with their session data
        const studentsMap = new Map();
        const currentTime = new Date();
        
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            session.id = doc.id;
            
            if (session.studentId && session.studentName) {
                if (!studentsMap.has(session.studentId)) {
                    studentsMap.set(session.studentId, {
                        studentId: session.studentId,
                        studentName: session.studentName,
                        sessions: [],
                        totalSessions: 0,
                        completedSessions: 0, // This will now count invoiced sessions
                        upcomingSessions: 0,
                        lastSessionDate: null,
                        favoriteSubject: null,
                        subjectCount: new Map()
                    });
                }
                
                const studentData = studentsMap.get(session.studentId);
                studentData.sessions.push(session);
                studentData.totalSessions++;
                
                // Track subject frequency
                if (session.subject) {
                    const currentCount = studentData.subjectCount.get(session.subject) || 0;
                    studentData.subjectCount.set(session.subject, currentCount + 1);
                }
                
                // Track session status - COUNT INVOICED SESSIONS INSTEAD OF COMPLETED
                if (invoicedSessions.has(session.id)) {
                    studentData.completedSessions++; // Count as "completed" if invoiced
                } else if (session.status === 'confirmed' || session.status === 'rescheduled') {
                    const sessionDate = session.date.toDate();
                    if (sessionDate > currentTime) {
                        studentData.upcomingSessions++;
                    }
                }
                
                // Track last session date
                const sessionDate = session.date.toDate();
                if (!studentData.lastSessionDate || sessionDate > studentData.lastSessionDate) {
                    studentData.lastSessionDate = sessionDate;
                }
            }
        });
        
        // Determine favorite subject for each student
        studentsMap.forEach(studentData => {
            let maxCount = 0;
            let favoriteSubject = null;
            
            studentData.subjectCount.forEach((count, subject) => {
                if (count > maxCount) {
                    maxCount = count;
                    favoriteSubject = subject;
                }
            });
            
            studentData.favoriteSubject = favoriteSubject;
        });
        
        // Convert map to array and sort by last session date (most recent first)
        const studentsArray = Array.from(studentsMap.values()).sort((a, b) => 
            b.lastSessionDate - a.lastSessionDate
        );
        
        displayStudentsWithRealData(studentsArray, container);
        
    } catch (error) {
        console.error("Error loading students:", error);
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error Loading Students</h3>
                <p>Failed to load student information. Please try again.</p>
            </div>
        `;
    }
}
       
// Display students with real data
function displayStudentsWithRealData(studentsArray, container) {
    container.innerHTML = `
        <div class="section-header">
            <h3><i class="fas fa-chart-bar"></i> Student Overview</h3>
        </div>
        <div class="stats-container" style="margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value">${studentsArray.length}</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-value">${studentsArray.reduce((sum, student) => sum + student.upcomingSessions, 0)}</div>
                <div class="stat-label">Upcoming Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pink">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-value">${studentsArray.reduce((sum, student) => sum + student.completedSessions, 0)}</div>
                <div class="stat-label">Completed Sessions</div>
            </div>
        </div>
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Student Directory</h3>
        </div>
        <div class="tutors-container" id="studentsDirectory"></div>
    `;
    
    const studentsDirectory = document.getElementById('studentsDirectory');
    
    studentsArray.forEach((studentData, index) => {
        const studentCard = createStudentCardWithRealData(studentData, index);
        studentsDirectory.appendChild(studentCard);
    });
    
    // Update active students count in dashboard stats
    document.getElementById('activeStudentsCount').textContent = studentsArray.length;
}

// Enhanced function to load student profile data
async function loadStudentProfileData(studentId) {
    try {
        const studentDoc = await db.collection('students').doc(studentId).get();
        if (studentDoc.exists) {
            return studentDoc.data();
        }
        return null;
    } catch (error) {
        console.error("Error loading student profile:", error);
        return null;
    }
}

// Enhanced view student profile function
async function viewStudentProfile(studentData) {
    // Load complete student profile data
    const studentProfile = await loadStudentProfileData(studentData.studentId);
    
    // Create modal content with all available student information
    const modalContent = `
        <div class="profile-modal-content">
            <div class="student-profile-header">
                <div class="student-avatar" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 32px;">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h3 style="text-align: center; margin-bottom: 10px; color: var(--primary-dark);">${studentData.studentName}</h3>
                <p style="text-align: center; color: var(--gray); margin-bottom: 20px;">Student Profile</p>
            </div>
            
            <div class="profile-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="detail-item">
                    <strong><i class="fas fa-envelope"></i> Email:</strong>
                    <span>${studentProfile?.email || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                    <strong><i class="fas fa-phone"></i> Phone:</strong>
                    <span>${studentProfile?.phone || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                    <strong><i class="fas fa-birthday-cake"></i> Age:</strong>
                    <span>${studentProfile?.age || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                    <strong><i class="fas fa-graduation-cap"></i> Grade Level:</strong>
                    <span>${studentProfile?.gradeLevel || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                    <strong><i class="fas fa-school"></i> Specific Grade:</strong>
                    <span>${studentProfile?.specificgradeLevel || 'Not provided'}</span>
                </div>
                <div class="detail-item">
                    <strong><i class="fas fa-university"></i> School:</strong>
                    <span>${studentProfile?.schoolName || 'Not provided'}</span>
                </div>
            </div>
            
            <div class="learning-section" style="margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-bullseye"></i> Learning Goals</h4>
                <p style="background: var(--gray-light); padding: 10px; border-radius: 8px; font-style: italic;">
                    ${studentProfile?.learningGoals || 'No learning goals specified'}
                </p>
            </div>
            
            <div class="parent-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h4 style="color: var(--secondary); margin-bottom: 10px;"><i class="fas fa-users"></i> Parent/Guardian Information</h4>
                <div class="parent-details">
                    <p><strong>Parent Name:</strong> ${studentProfile?.parentName || 'Not provided'}</p>
                    <p><strong>Parent Email:</strong> ${studentProfile?.parentEmail || 'Not provided'}</p>
                </div>
            </div>
            
            <div class="session-stats" style="display: flex; justify-content: space-around; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px;">
                <div class="stat-item" style="text-align: center;">
                    <div class="stat-number" style="font-size: 1.5em; font-weight: bold;">${studentData.totalSessions}</div>
                    <div class="stat-label" style="font-size: 0.8em;">Total Sessions</div>
                </div>
                <div class="stat-item" style="text-align: center;">
                    <div class="stat-number" style="font-size: 1.5em; font-weight: bold;">${studentData.completedSessions}</div>
                    <div class="stat-label" style="font-size: 0.8em;">Completed</div>
                </div>
                <div class="stat-item" style="text-align: center;">
                    <div class="stat-number" style="font-size: 1.5em; font-weight: bold;">${studentData.upcomingSessions}</div>
                    <div class="stat-label" style="font-size: 0.8em;">Upcoming</div>
                </div>
            </div>
        </div>
    `;
    
    // Show in modal (replace the alert with actual modal display)
    showStudentProfileModal(studentData.studentName, modalContent);
}

// Function to display student profile in a modal
function showStudentProfileModal(studentName, content) {
    // Create or update modal
    let modal = document.getElementById('studentProfileModal');
    
    if (!modal) {
        // Create modal if it doesn't exist
        modal = document.createElement('div');
        modal.id = 'studentProfileModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Student Profile</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="studentProfileModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="closeStudentProfileBtn">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners for the new modal
        const closeBtn = modal.querySelector('.close-modal');
        const closeActionBtn = modal.querySelector('#closeStudentProfileBtn');
        
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        closeActionBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Update modal content
    document.getElementById('studentProfileModalBody').innerHTML = content;
    
    // Show modal
    modal.style.display = 'flex';
}

// Enhanced student card creation with better profile button
function createStudentCardWithRealData(studentData, index) {
    const card = document.createElement('div');
    card.className = 'tutor-card';
    card.style.animationDelay = `${index * 0.1}s`;
    card.style.opacity = '0';
    card.style.animation = 'fadeInUp 0.6s ease forwards';
    
    const lastSessionDate = studentData.lastSessionDate ? 
        studentData.lastSessionDate.toLocaleDateString() : 'No sessions yet';
    
    const favoriteSubject = studentData.favoriteSubject || 'Various subjects';
    
    card.innerHTML = `
        <div class="tutor-header">
            <div class="tutor-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="tutor-name">${studentData.studentName}</div>
            <div class="tutor-subject">${favoriteSubject}</div>
        </div>
        <div class="tutor-details">
            <div class="session-stats">
                <div class="stat-item">
                    <span class="stat-number">${studentData.totalSessions}</span>
                    <span class="stat-label">Total Sessions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${studentData.completedSessions}</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${studentData.upcomingSessions}</span>
                    <span class="stat-label">Upcoming</span>
                </div>
            </div>
            <p><i class="fas fa-book"></i> <strong>Favorite Subject:</strong> ${favoriteSubject}</p>
            <p><i class="fas fa-calendar"></i> <strong>Last Session:</strong> ${lastSessionDate}</p>
            <p><i class="fas fa-star"></i> <strong>Status:</strong> Active Student</p>
        </div>
        <div class="session-actions" style="padding: 0 20px 20px; justify-content: center; gap: 10px;">
            <button class="btn-primary view-sessions-btn" data-student-id="${studentData.studentId}">
                <i class="fas fa-history"></i> View Sessions
            </button>
            <button class="btn-success view-profile-btn" data-student-id="${studentData.studentId}">
                <i class="fas fa-id-card"></i> Full Profile
            </button>
        </div>
    `;
    
    // Add event listeners
    setTimeout(() => {
        const viewSessionsBtn = card.querySelector('.view-sessions-btn');
        const viewProfileBtn = card.querySelector('.view-profile-btn');
        
        if (viewSessionsBtn) {
            viewSessionsBtn.addEventListener('click', () => viewStudentSessions(studentData));
        }
        if (viewProfileBtn) {
            viewProfileBtn.addEventListener('click', () => viewStudentProfile(studentData));
        }
    }, 100);
    
    return card;
}

// Enhanced view student sessions function
function viewStudentSessions(studentData) {
    const sortedSessions = studentData.sessions.sort((a, b) => b.date.toDate() - a.date.toDate());
    
    let sessionsHTML = `
        <h4 style="color: var(--primary-dark); margin-bottom: 15px;">Sessions with ${studentData.studentName}</h4>
        <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    sortedSessions.forEach((session, index) => {
        const sessionDate = session.date.toDate();
        const statusClass = getStatusClass(session.status);
        const isUpcoming = session.status === 'confirmed' && sessionDate > new Date();
        
        sessionsHTML += `
            <div class="session-item" style="border-left: 4px solid var(--${statusClass}); padding: 12px; margin: 10px 0; background: #f8f9fa; border-radius: 8px; transition: all 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong style="color: var(--dark);">${session.subject || 'No subject'}</strong>
                    <span class="status-badge" style="background: var(--${statusClass}-light); color: var(--${statusClass}); padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">
                        ${session.status.charAt(0).toUpperCase() + session.status.slice(1)}
                    </span>
                </div>
                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                    <i class="fas fa-calendar"></i> ${sessionDate.toLocaleDateString()} 
                    <i class="fas fa-clock" style="margin-left: 10px;"></i> ${sessionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
                <div style="font-size: 0.9em; display: flex; justify-content: space-between;">
                    <span>Duration: ${session.duration || '1.5'} hours</span>
                    <span>Rate: $${session.hourlyRate || '40'}/hour</span>
                </div>
                ${session.notes ? `
                    <div style="font-size: 0.85em; color: #888; margin-top: 8px; font-style: italic;">
                        <i class="fas fa-sticky-note"></i> ${session.notes}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    sessionsHTML += `</div>`;
    
    // Show sessions in modal
    showStudentSessionsModal(studentData.studentName, sessionsHTML);
}

// Function to display student sessions in a modal
function showStudentSessionsModal(studentName, content) {
    let modal = document.getElementById('studentSessionsModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'studentSessionsModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>Session History - ${studentName}</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="studentSessionsModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="closeStudentSessionsBtn">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = modal.querySelector('.close-modal');
        const closeActionBtn = modal.querySelector('#closeStudentSessionsBtn');
        
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        closeActionBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    document.getElementById('studentSessionsModalBody').innerHTML = content;
    modal.style.display = 'flex';
}

// Helper function to get status class for styling
function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'success';
        case 'confirmed': return 'primary';
        case 'pending': return 'warning';
        case 'cancelled': return 'error';
        case 'rescheduled': return 'info';
        default: return 'gray';
    }
}
// =============================================
//My Students Section Ends here.
// =============================================

// =======================================================================================================================================
// BOOKINGS SECTION STARTS HERE
// =======================================================================================================================================

// Global variables for bookings
let allBookings = [];
let currentBookingsFilter = 'upcoming';
let displayedBookingsCount = 10;

// Load tutor's bookings
async function loadMyBookings() {
    const container = document.getElementById('bookingsContainer');
    if (!container) return;
    
    // Check if user is authenticated
    if (!currentUser || !currentUser.uid) {
        console.error("User not authenticated");
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Authentication Required</h3>
                <p>Please log in to view your bookings.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '<div class="spinner">Loading your bookings...</div>';
    
    try {
        // Get all sessions for this tutor (excluding cancelled ones)
        const sessionsSnapshot = await db.collection('bookedSessions')
            .where('tutorId', '==', currentUser.uid)
            .where('status', 'in', ['pending', 'confirmed', 'rescheduled', 'completed'])
            .orderBy('date', 'asc')
            .get();
        
        allBookings = [];
        
        if (sessionsSnapshot.empty) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-bookmark"></i>
                    <h3>No Bookings Yet</h3>
                    <p>Your upcoming and pending sessions will appear here.</p>
                </div>
            `;
            document.getElementById('upcomingSessionsCount').textContent = '0';
            return;
        }
        
        // Process all bookings
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            session.id = doc.id;
            allBookings.push(session);
        });
        
        // Apply initial filter and display
        applyBookingsFilter();
        
        // Setup filter event listeners
        setupBookingsFilters();
        
        // Update upcoming sessions count in dashboard
        const upcomingCount = allBookings.filter(booking => {
            const bookingDate = booking.date.toDate();
            return (booking.status === 'confirmed' || booking.status === 'rescheduled') && 
                   bookingDate > new Date();
        }).length;
        
// Update all elements with the upcoming sessions count
document.querySelectorAll('#upcomingSessionsCount').forEach(element => {
    element.textContent = upcomingCount;
});
        
    } catch (error) {
        console.error("Error loading bookings:", error);
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error Loading Bookings</h3>
                <p>Failed to load your bookings. Please try again.</p>
            </div>
        `;
    }
}
        
// Apply filters to bookings
function applyBookingsFilter() {
    const container = document.getElementById('bookingsContainer');
    const loadMoreBtn = document.getElementById('loadMoreBookingsBtn');
    
    let filteredBookings = [...allBookings];
    const now = new Date();
    
    // Apply status filter
    switch(currentBookingsFilter) {
    case 'upcoming':
        filteredBookings = filteredBookings.filter(booking => {
            const bookingDate = booking.date.toDate();
            return (booking.status === 'confirmed' || booking.status === 'rescheduled') && 
                   bookingDate > now;
        });
        break;
    case 'ongoing':  // ADD THIS CASE
        filteredBookings = filteredBookings.filter(booking => {
            const bookingDate = booking.date.toDate();
            const sessionEndTime = new Date(bookingDate.getTime() + (parseFloat(booking.duration || 1.5) * 60 * 60 * 1000));
            return (booking.status === 'confirmed' || booking.status === 'rescheduled') && 
                   bookingDate <= now && sessionEndTime > now;
        });
        break;
    case 'pending':
            filteredBookings = filteredBookings.filter(booking => booking.status === 'pending');
            break;
        case 'past':
            filteredBookings = filteredBookings.filter(booking => {
                const bookingDate = booking.date.toDate();
                return bookingDate <= now;
            });
            break;
        default: // 'all'
            // No filter applied
            break;
    }
    
    // Display filtered bookings
    displayFilteredBookings(filteredBookings, container, loadMoreBtn);
}

// Add this global variable
let displayedPastBookingsCount = 10;
       
// Display filtered bookings
function displayFilteredBookings(bookings, container, loadMoreBtn) {
    if (bookings.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-filter"></i>
                <h3>No Bookings Match Your Filter</h3>
                <p>Try selecting a different filter to see more bookings.</p>
            </div>
        `;
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        return;
    }
    
    // Sort by date (upcoming first)
    if (currentBookingsFilter === 'past') {
    bookings.sort((a, b) => b.date.toDate() - a.date.toDate());
} else {
    bookings.sort((a, b) => a.date.toDate() - b.date.toDate());
}
    
    // Get bookings to display (with load more functionality)
    const bookingsToDisplay = bookings.slice(0, displayedBookingsCount);
    
    let bookingsHTML = `
        <div class="bookings-stats">
            <div class="stat-item">
                <span class="stat-number">${bookingsToDisplay.length}</span>
                <span class="stat-label">Displayed</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">${bookings.length}</span>
                <span class="stat-label">Total Filtered</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">${allBookings.length}</span>
                <span class="stat-label">All Bookings</span>
            </div>
        </div>
        <div class="bookings-list">
    `;
    
    bookingsToDisplay.forEach(booking => {
        bookingsHTML += createBookingCard(booking);
    });
    
    bookingsHTML += `</div>`;
    
    container.innerHTML = bookingsHTML;
    
    // Show/hide load more button
    if (loadMoreBtn) {
        if (bookings.length > displayedBookingsCount) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.onclick = () => {
                displayedBookingsCount += 10;
                applyBookingsFilter();
            };
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }
    
    // Add event listeners to booking cards
    addBookingCardListeners();
}

// Create booking card with all functionality
function createBookingCard(booking) {
    const date = booking.date.toDate();
    const formattedDate = date.toLocaleDateString();
    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const now = new Date();
    const sessionStartTime = date;
    const sessionEndTime = new Date(date.getTime() + (parseFloat(booking.duration || 1.5) * 60 * 60 * 1000));
    
    const isPastSession = sessionEndTime <= now;
    const isCurrentSession = sessionStartTime <= now && sessionEndTime > now;
    const isUpcomingSession = sessionStartTime > now;
    
    // Calculate cancellation policy status
    const timeDiff = sessionStartTime.getTime() - now.getTime();
    const hoursUntilSession = timeDiff / (1000 * 60 * 60);
    const isWithin24Hours = hoursUntilSession <= 24;
    const canCancelWithRefund = isUpcomingSession && !isWithin24Hours;
    const canCancelWithoutRefund = isUpcomingSession && isWithin24Hours && hoursUntilSession > 1; // Allow cancellation up to 1 hour before
    
    // Add cancellation policy indicator
    let cancellationIndicator = '';
    if (isUpcomingSession) {
        if (canCancelWithRefund) {
            cancellationIndicator = `
                <div class="cancellation-indicator refund-available">
                    <i class="fas fa-check-circle"></i>
                    <span>Student will receive credit refund if cancelled</span>
                </div>
            `;
        } else if (canCancelWithoutRefund) {
            cancellationIndicator = `
                <div class="cancellation-indicator no-refund">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Student will lose credits if cancelled (within 24h)</span>
                </div>
            `;
        } else if (hoursUntilSession <= 1) {
            cancellationIndicator = `
                <div class="cancellation-indicator too-late">
                    <i class="fas fa-ban"></i>
                    <span>Cannot cancel (less than 1 hour until session)</span>
                </div>
            `;
        }
    }
    
    // Calculate if join button should be active (30 minutes before session starts)
    const thirtyMinutesBefore = new Date(sessionStartTime.getTime() - (30 * 60 * 1000));
    const canJoinSession = now >= thirtyMinutesBefore && now <= sessionEndTime;
    
    const statusClass = getStatusClass(booking.status);
    const sessionType = booking.sessionType === 'online' ? 'Online' : 'In-Person';
    
    return `
        <div class="session-card booking-card ${isPastSession ? 'past-session' : ''} ${isCurrentSession ? 'current-session' : ''} ${isWithin24Hours ? 'within-24h-window' : ''}" id="booking-${booking.id}">
            <div class="session-header">
                <div class="session-title">${booking.subject || 'General Tutoring'} Session</div>
                <div class="session-date">
                    ${formattedDate}, ${formattedTime}
                    ${isCurrentSession ? '<span class="live-badge">LIVE</span>' : ''}
                    ${isWithin24Hours ? '<span class="warning-badge">WITHIN 24H</span>' : ''}
                </div>
            </div>
            
            ${cancellationIndicator}
            
            <div class="session-details">
                <div class="session-detail">
                    <i class="fas fa-user-graduate"></i> Student: ${booking.studentName || 'Unknown Student'}
                </div>
                <div class="session-detail">
                    <i class="fas fa-book"></i> Subject: ${booking.subject || 'General'}
                </div>
                <div class="session-detail">
                    <i class="fas fa-clock"></i> Duration: ${booking.duration || '1.5'} hours
                </div>
                <div class="session-detail">
                    <i class="fas ${booking.sessionType === 'online' ? 'fa-video' : 'fa-map-marker-alt'}"></i> 
                    ${sessionType}
                </div>
                <div class="session-detail">
                    <i class="fas fa-dollar-sign"></i> Rate: $${booking.hourlyRate || '40'}/hour
                </div>
                <div class="session-detail">
                    <i class="fas fa-sticky-note"></i> Notes: ${booking.notes || 'No notes provided'}
                </div>
            </div>
            
            <div class="session-status">
                <span class="status-badge status-${statusClass}">${booking.status.toUpperCase()}</span>
                ${isCurrentSession ? '<span class="status-badge status-live">IN PROGRESS</span>' : ''}
                ${isPastSession ? '<span class="status-badge status-completed">COMPLETED</span>' : ''}
            </div>
            
            <div class="session-actions">
                ${booking.sessionType === 'online' && booking.meetLink ? `
                    <button class="btn-primary join-session-btn ${canJoinSession ? '' : 'disabled'}" 
                            data-session-id="${booking.id}" 
                            data-meet-link="${booking.meetLink}"
                            ${canJoinSession ? '' : 'disabled="disabled"'}>
                        <i class="fas fa-video"></i> 
                        ${canJoinSession ? 'Join Session' : 'Join Available 30min Before'}
                    </button>
                ` : ''}
                
                ${!isPastSession && booking.status !== 'pending' && hoursUntilSession > 1 ? `
                    <button class="btn-warning reschedule-btn" data-session-id="${booking.id}">
                        <i class="fas fa-clock"></i> Reschedule
                    </button>
                ` : ''}
                
                ${!isPastSession && hoursUntilSession > 1 ? `
                    <button class="btn-danger cancel-btn" data-session-id="${booking.id}">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                ` : ''}
                
                ${hoursUntilSession <= 1 && isUpcomingSession ? `
                    <button class="btn-danger disabled" disabled title="Cannot cancel within 1 hour of session">
                        <i class="fas fa-ban"></i> Cannot Cancel
                    </button>
                ` : ''}
                
                <button class="btn-outline details-btn" data-session-id="${booking.id}">
                    <i class="fas fa-info-circle"></i> Details
                </button>
            </div>
            
            ${booking.rescheduleRequested ? `
                <div class="reschedule-notice">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Reschedule requested - awaiting student confirmation</span>
                </div>
            ` : ''}
        </div>
    `;
}
        
// Setup bookings filter event listeners
function setupBookingsFilters() {
    // Create filter buttons if they don't exist
    let filterContainer = document.querySelector('.bookings-filter-container');
    
    if (!filterContainer) {
        filterContainer = document.createElement('div');
        filterContainer.className = 'bookings-filter-container';
filterContainer.innerHTML = `
    <div class="filter-buttons">
        <button class="filter-btn active" data-filter="upcoming">Upcoming</button>
        <button class="filter-btn" data-filter="ongoing">Live Now</button>
        <button class="filter-btn" data-filter="pending">Pending</button>
        <button class="filter-btn" data-filter="past">Past</button>
        <button class="filter-btn" data-filter="all">All</button>
    </div>
    <button class="btn-outline" id="loadMoreBookingsBtn" style="display: none;">
        <i class="fas fa-chevron-down"></i> Load More Bookings
    </button>
`;        
        const bookingsContainer = document.getElementById('bookingsContainer');
        if (bookingsContainer) {
            bookingsContainer.parentNode.insertBefore(filterContainer, bookingsContainer);
        }
        
        // Add event listeners to filter buttons
        const filterButtons = filterContainer.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all buttons
                filterButtons.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update filter and apply
                currentBookingsFilter = this.getAttribute('data-filter');
                displayedBookingsCount = 10; // Reset to first page
                applyBookingsFilter();
            });
        });
    }
}

// Add event listeners to booking cards
function addBookingCardListeners() {
    // Join session buttons
    document.querySelectorAll('.join-session-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const sessionId = this.getAttribute('data-session-id');
        console.log('Join button clicked, session:', sessionId);
        
        if (sessionId && !this.disabled) {
            joinSession(sessionId);
        }
    });
});
    
    
    // Reschedule buttons
    document.querySelectorAll('.reschedule-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            openRescheduleModal(sessionId);
        });
    });
    
    // Cancel buttons
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            openCancelModal(sessionId);
        });
    });
    
    // Details buttons
    document.querySelectorAll('.details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            showBookingDetails(sessionId);
        });
    });
}

// Join session functionality
async function joinSession(sessionId) {
    console.log('Join session called for:', sessionId);
    
    // Find the button - handle the trailing space in class name
    const button = document.querySelector(`[data-session-id="${sessionId}"].join-session-btn`);
    
    if (!button) {
        console.error('Join button not found for session:', sessionId);
        // Try alternative selector in case classes change
        const alternativeButton = document.querySelector(`[data-session-id="${sessionId}"]`);
        if (alternativeButton) {
            await performJoinSession(sessionId);
            return;
        }
        alert('Error: Cannot find join button. Please refresh the page.');
        return;
    }
    
    const originalHTML = button.innerHTML;
    
    try {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Joining...';
        button.disabled = true;
        
        // Perform the actual join logic
        await performJoinSession(sessionId);
        
    } catch (error) {
        // Restore button on error
        button.innerHTML = originalHTML;
        button.disabled = false;
        console.error('Join session failed:', error);
    }
}

// The actual join logic - no UI manipulation here
async function performJoinSession(sessionId) {
    try {
        console.log('Fetching session data for:', sessionId);
        
        // Get fresh session data from Firestore
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        
        if (!sessionDoc.exists) {
            throw new Error('Session not found in database');
        }
        
        const session = sessionDoc.data();
        const meetLink = session.meetLink;
        
        console.log('Session data:', session);
        console.log('Meeting link:', meetLink);
        
        if (!meetLink) {
            throw new Error('No meeting link available for this session');
        }
        
        // Validate link format
        if (!meetLink.startsWith('http')) {
            throw new Error('Invalid meeting link format');
        }
        
        // Open the meeting room in a new tab
        console.log('Opening meeting room:', meetLink);
        window.open(meetLink, '_blank', 'noopener,noreferrer');
        
        // Optional: Log the join action
        try {
            await db.collection('bookedSessions').doc(sessionId).update({
                lastJoinedByTutor: new Date(),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (updateError) {
            console.warn('Could not update join timestamp (non-critical):', updateError);
        }
        
    } catch (error) {
        console.error('Error in performJoinSession:', error);
        alert(`Cannot join session: ${error.message}`);
        throw error; // Re-throw to handle in parent function
    }
}       
       
// Open reschedule modal
async function openRescheduleModal(sessionId) {
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        if (!sessionDoc.exists) {
            alert('Session not found.');
            return;
        }
        
        const session = sessionDoc.data();
        const originalDate = session.date.toDate();
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        
        const modalContent = `
            <h3>Reschedule Session</h3>
            <p>Request to reschedule your session with ${session.studentName || 'the student'}.</p>
            
            <form id="rescheduleForm">
                <div class="form-group">
                    <label for="newSessionDate">New Date *</label>
                    <input type="date" id="newSessionDate" class="form-control" min="${today}" required>
                </div>
                
                <div class="form-group">
                    <label for="newSessionTime">New Time *</label>
                    <input type="time" id="newSessionTime" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="rescheduleReason">Reason for Reschedule *</label>
                    <textarea id="rescheduleReason" class="form-control" rows="3" 
                              placeholder="Please provide a reason for rescheduling this session..." required></textarea>
                </div>
                
                <div class="original-session-info">
                    <h4>Original Session Details</h4>
                    <p><strong>Date:</strong> ${originalDate.toLocaleDateString()}</p>
                    <p><strong>Time:</strong> ${originalDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                    <p><strong>Student:</strong> ${session.studentName || 'Unknown'}</p>
                    <p><strong>Subject:</strong> ${session.subject || 'General'}</p>
                </div>
            </form>
        `;
        
        showRescheduleModal(modalContent, sessionId);
        
    } catch (error) {
        console.error("Error opening reschedule modal:", error);
        alert('Error loading session details. Please try again.');
    }
}

// Show reschedule modal
function showRescheduleModal(content, sessionId) {
    let modal = document.getElementById('bookingsRescheduleModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bookingsRescheduleModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>Request Reschedule</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="bookingsRescheduleModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="cancelRescheduleRequestBtn">Cancel</button>
                    <button class="btn-primary" id="submitRescheduleRequestBtn">Submit Request</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = modal.querySelector('.close-modal');
        const cancelBtn = modal.querySelector('#cancelRescheduleRequestBtn');
        const submitBtn = modal.querySelector('#submitRescheduleRequestBtn');
        
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        cancelBtn.addEventListener('click', () => modal.style.display = 'none');
        submitBtn.addEventListener('click', () => submitRescheduleRequest(sessionId));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    document.getElementById('bookingsRescheduleModalBody').innerHTML = content;
    modal.style.display = 'flex';
}

// Submit reschedule request
async function submitRescheduleRequest(sessionId) {
    const modal = document.getElementById('bookingsRescheduleModal');
    const newDate = modal.querySelector('#newSessionDate').value;
    const newTime = modal.querySelector('#newSessionTime').value;
    const reason = modal.querySelector('#rescheduleReason').value.trim();
    
    console.log('Form values:', { newDate, newTime, reason }); // Debug log
    
    // Validate form
    if (!newDate || !newTime || !reason) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Combine date and time
    const newDateTime = new Date(`${newDate}T${newTime}`);
    
    if (newDateTime <= new Date()) {
        alert('Please select a future date and time for the rescheduled session.');
        return;
    }
    
    try {
        // Update session in bookedSessions
        await db.collection('bookedSessions').doc(sessionId).update({
            rescheduleRequested: true,
            rescheduleRequestedBy: 'tutor',
            rescheduleRequestedAt: new Date(),
            proposedNewDate: newDateTime,
            rescheduleReason: reason,
            status: 'reschedule_requested',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for student
        await createRescheduleNotification(sessionId, reason, newDateTime);
        
        // Close modal
        modal.style.display = 'none';
        
        // Show success message
        showBookingActionSuccess('Reschedule request sent to student successfully!');
        
        // Reload bookings to reflect changes
        loadMyBookings();
        
    } catch (error) {
        console.error("Error submitting reschedule request:", error);
        alert('Error submitting reschedule request. Please try again.');
    }
}
       

// Create reschedule notification for student
async function createRescheduleNotification(sessionId, reason, newDateTime) {
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        const session = sessionDoc.data();
        
        await db.collection('notifications').add({
            userId: session.studentId,
            type: 'reschedule_request',
            title: 'Reschedule Request',
            message: `Tutor has requested to reschedule your ${session.subject} session`,
            details: {
                reason: reason,
                proposedNewDate: newDateTime.toISOString(),
                tutorName: session.tutorName || 'Your tutor',
                sessionId: sessionId,
                subject: session.subject
            },
            relatedSessionId: sessionId,
            isRead: false,
            priority: 'high',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('Reschedule notification created for student');
    } catch (error) {
        console.error("Error creating reschedule notification:", error);
    }
}

// Open cancel modal
async function openCancelModal(sessionId) {
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        if (!sessionDoc.exists) {
            alert('Session not found.');
            return;
        }
        
        const session = sessionDoc.data();
        const sessionDate = session.date.toDate();
        const now = new Date();
        const timeDiff = sessionDate.getTime() - now.getTime();
        const hoursUntilSession = timeDiff / (1000 * 60 * 60);
        
        // Determine cancellation policy status
        const isWithin24Hours = hoursUntilSession <= 24;
        const canRefundCredits = !isWithin24Hours;
        
        let policyMessage = '';
        let policyClass = '';
        
        if (canRefundCredits) {
            policyMessage = `✅ Student will receive their credits back`;
            policyClass = 'policy-refund';
        } else {
            policyMessage = `⚠️ Student will lose their credits (within 24-hour window)`;
            policyClass = 'policy-no-refund';
        }
        
        const modalContent = `
            <h3>Cancel Session</h3>
            <p>Are you sure you want to cancel your session with ${session.studentName || 'the student'}?</p>
            
            <div class="cancellation-policy ${policyClass}">
                <div class="policy-header">
                    <i class="fas ${canRefundCredits ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                    <strong>Cancellation Policy</strong>
                </div>
                <div class="policy-message">${policyMessage}</div>
                <div class="policy-details">
                    <strong>Session Time:</strong> ${sessionDate.toLocaleString()}<br>
                    <strong>Time Until Session:</strong> ${Math.max(0, hoursUntilSession).toFixed(1)} hours<br>
                    <strong>24-hour Cutoff:</strong> ${canRefundCredits ? 'After' : 'Before'} session start
                </div>
            </div>
            
            <div class="session-info">
                <h4>Session Details</h4>
                <p><strong>Student:</strong> ${session.studentName || 'Unknown'}</p>
                <p><strong>Date:</strong> ${sessionDate.toLocaleDateString()}</p>
                <p><strong>Time:</strong> ${sessionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                <p><strong>Subject:</strong> ${session.subject || 'General'}</p>
                <p><strong>Duration:</strong> ${session.duration || '1.5'} hours</p>
            </div>
            
            <form id="cancelForm">
                <div class="form-group">
                    <label for="cancelReason">Reason for Cancellation *</label>
                    <textarea id="cancelReason" class="form-control" rows="3" 
                              placeholder="Please provide a reason for cancelling this session..." required></textarea>
                </div>
            </form>
            
            <div class="warning-message">
                <i class="fas fa-exclamation-triangle"></i>
                <span>This action cannot be undone. The student will be notified of the cancellation.</span>
            </div>
        `;
        
        showCancelModal(modalContent, sessionId, isWithin24Hours);
        
    } catch (error) {
        console.error("Error opening cancel modal:", error);
        alert('Error loading session details. Please try again.');
    }
}

// Show cancel modal with policy indicators
function showCancelModal(content, sessionId, isWithin24Hours) {
    let modal = document.getElementById('bookingsCancelModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bookingsCancelModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header">
                    <h3>Cancel Session</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="bookingsCancelModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="cancelCancelBtn">Keep Session</button>
                    <button class="btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-exclamation-triangle"></i> Confirm Cancellation
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = modal.querySelector('.close-modal');
        const cancelBtn = modal.querySelector('#cancelCancelBtn');
        
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        cancelBtn.addEventListener('click', () => modal.style.display = 'none');
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    // Update confirm button based on policy
    const confirmBtn = modal.querySelector('#confirmCancelBtn');
    if (isWithin24Hours) {
        confirmBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Confirm (Student Loses Credits)';
        confirmBtn.style.background = '#dc3545';
    } else {
        confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm (Student Gets Refund)';
        confirmBtn.style.background = '#fd7e14';
    }
    
    // Set the content and store sessionId
    document.getElementById('bookingsCancelModalBody').innerHTML = content;
    modal.dataset.sessionId = sessionId;
    modal.style.display = 'flex';
    
    // IMPORTANT: Clone the button to remove all old event listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    
    // Focus on reason textarea
    setTimeout(() => {
        const reasonInput = modal.querySelector('#cancelReason');
        if (reasonInput) {
            reasonInput.focus();
        }
    }, 100);
}

// Confirm cancellation - Call Cloud Function
async function confirmCancellation(sessionId) {
    console.log('🔧 confirmCancellation called with sessionId:', sessionId);
    const modal = document.getElementById('bookingsCancelModal');
    console.log('🔧 Modal dataset sessionId:', modal?.dataset.sessionId);
    if (!modal) {
        alert('Error: Cancel modal not found.');
        return;
    }
    
    const reasonInput = modal.querySelector('#cancelReason');
    if (!reasonInput) {
        alert('Error: Reason input field not found.');
        return;
    }
    
    const reason = reasonInput.value.trim();
    
    if (!reason) {
        alert('Please provide a reason for cancellation.');
        reasonInput.focus();
        return;
    }

    try {
        // Show loading state
        const confirmBtn = modal.querySelector('#confirmCancelBtn');
        const originalText = confirmBtn.innerHTML; // Define originalText here
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        confirmBtn.disabled = true;

        // Call the same Cloud Function used by student dashboard
        // Use the correct Firebase Functions reference
        const cancelSessionFunction = firebase.app().functions('us-central1').httpsCallable('cancelSession');
        const result = await cancelSessionFunction({
            sessionId: sessionId,
            cancelledBy: 'tutor',
            reason: reason
        });

        newConfirmBtn.onclick = () => confirmCancellation(); // No parameter
        
        // Close modal
        modal.style.display = 'none';
        
        // Show appropriate success message based on credit handling
        if (result.data.refunded) {
            showBookingActionSuccess('Session cancelled! Student credits have been refunded.');
        } else {
            showBookingActionSuccess('Session cancelled. Student credits were not refunded (within 24-hour window).');
        }

        // ✅ RELOAD REMOVED - UI updates will handle the visual changes
        
    } catch (error) {
        console.error('Error cancelling session:', error);
        
        // Restore button - now originalText is in scope
        const confirmBtn = modal.querySelector('#confirmCancelBtn');
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
        
        // Show appropriate error message
        let errorMessage = 'Error cancelling session. Please try again.';
        
        if (error.message && error.message.includes('cancellation window')) {
            errorMessage = 'Cannot cancel: This session is too close to start time.';
        } else if (error.message && error.message.includes('not found')) {
            errorMessage = 'Session not found or already cancelled.';
        } else if (error.message && error.message.includes('permission')) {
            errorMessage = 'You do not have permission to cancel this session.';
        } else if (error.details) {
            errorMessage = error.details;
        }
        
        alert(errorMessage);
    }
}
       
// Create cancellation notification for student
async function createCancellationNotification(sessionId, reason) {
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        const session = sessionDoc.data();
        
        await db.collection('notifications').add({
            userId: session.studentId,
            type: 'session_cancelled',
            title: 'Session Cancelled',
            message: `Tutor has cancelled your ${session.subject} session`,
            details: {
                reason: reason,
                tutorName: session.tutorName || 'Your tutor',
                sessionId: sessionId,
                subject: session.subject,
                originalDate: session.date
            },
            relatedSessionId: sessionId,
            isRead: false,
            priority: 'high',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('Cancellation notification created for student');
    } catch (error) {
        console.error("Error creating cancellation notification:", error);
    }
}

// Show booking details
async function showBookingDetails(sessionId) {
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        if (!sessionDoc.exists) {
            alert('Session details not found.');
            return;
        }
        
        const session = sessionDoc.data();
        const date = session.date.toDate();
        const isPastSession = date <= new Date();
        
        let detailsHTML = `
            <h3>Session Details</h3>
            <div class="session-details-grid">
                <div class="detail-item">
                    <strong>Student:</strong> ${session.studentName || 'Unknown'}
                </div>
                <div class="detail-item">
                    <strong>Date:</strong> ${date.toLocaleDateString()}
                </div>
                <div class="detail-item">
                    <strong>Time:</strong> ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
                <div class="detail-item">
                    <strong>Subject:</strong> ${session.subject || 'General'}
                </div>
                <div class="detail-item">
                    <strong>Duration:</strong> ${session.duration || '1.5'} hours
                </div>
                <div class="detail-item">
                    <strong>Type:</strong> ${session.sessionType === 'online' ? 'Online' : 'In-Person'}
                </div>
                <div class="detail-item">
                    <strong>Rate:</strong> $${session.hourlyRate || '40'}/hour
                </div>
                <div class="detail-item">
                    <strong>Total:</strong> $${session.totalPrice || (parseFloat(session.duration || 1.5) * parseFloat(session.hourlyRate || 40)).toFixed(2)}
                </div>
                <div class="detail-item">
                    <strong>Status:</strong> <span class="status-badge status-${getStatusClass(session.status)}">${session.status.toUpperCase()}</span>
                </div>
        `;
        
        if (session.sessionType === 'online' && session.meetLink) {
            detailsHTML += `
                <div class="detail-item">
                    <strong>Meeting Link:</strong> 
                    <a href="${session.meetLink}" target="_blank" class="meet-link">${session.meetLink}</a>
                </div>
            `;
        }
        
        if (session.notes) {
            detailsHTML += `
                <div class="detail-item full-width">
                    <strong>Notes:</strong> ${session.notes}
                </div>
            `;
        }
        
        if (session.rescheduleRequested) {
            detailsHTML += `
                <div class="detail-item full-width warning">
                    <strong>Reschedule Requested:</strong> 
                    ${session.rescheduleReason || 'No reason provided'}
                </div>
            `;
        }
        
        if (session.cancelledAt) {
            detailsHTML += `
                <div class="detail-item full-width error">
                    <strong>Cancelled:</strong> 
                    ${session.cancelReason || 'No reason provided'}
                    <br><small>on ${session.cancelledAt.toDate().toLocaleString()}</small>
                </div>
            `;
        }
        
        detailsHTML += `</div>`;
        
        showBookingDetailsModal(detailsHTML);
        
    } catch (error) {
        console.error("Error loading booking details:", error);
        alert('Error loading session details.');
    }
}

// Show booking details modal
function showBookingDetailsModal(content) {
    let modal = document.getElementById('bookingsDetailsModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bookingsDetailsModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Session Details</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="bookingsDetailsModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="closeDetailsBtn">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = modal.querySelector('.close-modal');
        const closeDetailsBtn = modal.querySelector('#closeDetailsBtn');
        
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        closeDetailsBtn.addEventListener('click', () => modal.style.display = 'none');
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    document.getElementById('bookingsDetailsModalBody').innerHTML = content;
    modal.style.display = 'flex';
}

// Show booking action success message
function showBookingActionSuccess(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'booking-toast success';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
    `;
    toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Helper function to get status class
function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'success';
        case 'confirmed': 
        case 'rescheduled': return 'primary';
        case 'pending': return 'warning';
        case 'cancelled': return 'error';
        case 'reschedule_requested': return 'warning';
        default: return 'gray';
    }
}

// Add CSS styles for bookings section
function addBookingsStyles() {
    const styleId = 'bookings-styles';
    if (document.getElementById(styleId)) return;
    
    const styles = `
        .bookings-filter-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-light);
            background: white;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .filter-btn:hover:not(.active) {
            background: var(--gray-light);
        }
        
        .bookings-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }
        
        .booking-card {
            position: relative;
            transition: var(--transition);
        }
        
        .booking-card.current-session {
            border-left: 4px solid var(--success);
        }
        
        .booking-card.past-session {
            opacity: 0.8;
            background: #f8f9fa;
        }
        
        .live-badge {
            background: var(--error);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        .session-status {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .status-live {
            background: var(--error);
        }
        
        .status-completed {
            background: var(--success);
        }
        
        .reschedule-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }
        
        .original-session-info,
        .session-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius-sm);
            margin: 15px 0;
        }
        
        .warning-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            margin-top: 15px;
            border-left: 4px solid #dc3545;
        }
        
        .session-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .detail-item {
            padding: 8px 0;
        }
        
        .detail-item.full-width {
            grid-column: 1 / -1;
        }
        
        .detail-item.warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            border-left: 4px solid #ffc107;
        }
        
        .detail-item.error {
            background: #f8d7da;
            padding: 10px;
            border-radius: var(--border-radius-sm);
            border-left: 4px solid #dc3545;
        }
        
        .meet-link {
            word-break: break-all;
            color: var(--primary);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .bookings-filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .session-details-grid {
                grid-template-columns: 1fr;
            }
            
            .bookings-stats {
                gap: 15px;
            }
            
            .stat-item {
                text-align: center;
            }
        }
    `;
    
    const styleSheet = document.createElement('style');
    styleSheet.id = styleId;
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
}

// Initialize bookings section
function initBookingsSection() {
    addBookingsStyles();
    // loadMyBookings() will be called when the bookings section is shown
}

// Add loading states
function showLoadingState() {
    const container = document.getElementById('bookingsContainer');
    container.innerHTML = `
        <div class="session-card loading">
            <div class="session-header">
                <div class="session-title shimmer" style="width: 70%"></div>
                <div class="session-date shimmer" style="width: 30%"></div>
            </div>
            <div class="session-details">
                <div class="session-detail shimmer" style="width: 80%"></div>
                <div class="session-detail shimmer" style="width: 60%"></div>
                <div class="session-detail shimmer" style="width: 50%"></div>
            </div>
        </div>
    `.repeat(3);
}


// Add shimmer effect CSS
const shimmerCSS = `
.shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
    height: 1rem;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
`;

// Inject shimmer CSS
const shimmerStyle = document.createElement('style');
shimmerStyle.textContent = shimmerCSS;
document.head.appendChild(shimmerStyle);
       

// Add this function to force-hide any lingering overlays
function hideAllOverlays() {
    // Hide all modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.style.display = 'none';
    });
    
    // Hide any overlay backdrops
    const overlays = document.querySelectorAll('.modal-backdrop, .loading-overlay');
    overlays.forEach(overlay => {
        overlay.classList.remove('is-active');
        overlay.style.display = 'none';
    });
}


// =======================================================================================================================================
// BOOKINGS SECTION ENDS HERE
// =======================================================================================================================================       

// =============================================
// BOOKINGS BOOKINGS SECTION ENDS HERE
// =============================================


// =============================================
// SESSIONS HISTORY SECTION STARTS HERE
// =============================================

// Global variables for sessions history
let allSessionsHistory = [];
let displayedSessionsCount = 10;
let currentHistoryFilter = 'all';
let currentActionTypeFilter = 'all';

// Load sessions history with comprehensive session data
async function loadSessionsHistory() {
    const container = document.getElementById('sessionsContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="spinner">Loading session history...</div>';
    
    try {
        // First, auto-complete any expired sessions
        await checkAndCompleteExpiredSessions();
        
        // Get ALL sessions for this tutor (past and future, all statuses)
        const sessionsSnapshot = await db.collection('bookedSessions')
    .where('tutorId', '==', currentUser.uid)
    .where('status', 'in', ['pending', 'confirmed', 'rescheduled', 'completed']) // ADD 'completed'
    .orderBy('date', 'asc')
    .get();
        
        allSessionsHistory = [];
        
        if (sessionsSnapshot.empty) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3>No Session History</h3>
                    <p>Your session history will appear here once you start teaching.</p>
                </div>
            `;
            return;
        }
        
        // Process all sessions
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            session.id = doc.id;
            allSessionsHistory.push(session);
        });
        
        // Apply initial filters and display
        applySessionHistoryFilters();
        
        // Setup filter event listeners
        setupSessionHistoryFilters();
        
    } catch (error) {
        console.error("Error loading session history:", error);
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error Loading History</h3>
                <p>Failed to load session history. Please try again.</p>
            </div>
        `;
    }
}

// Check and auto-complete expired sessions
async function checkAndCompleteExpiredSessions() {
    const now = new Date();
    
    try {
        // Get confirmed sessions that have passed
        const sessionsSnapshot = await db.collection('bookedSessions')
            .where('tutorId', '==', currentUser.uid)
            .where('status', '==', 'confirmed')
            .where('date', '<', firebase.firestore.Timestamp.now())
            .limit(20)
            .get();
        
        console.log(`Checking ${sessionsSnapshot.size} sessions for auto-completion`);
        
        const batch = db.batch();
        let completedCount = 0;
        
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            const sessionDate = session.date.toDate();
            const duration = parseFloat(session.duration || 1.5);
            const sessionEndTime = new Date(sessionDate.getTime() + (duration * 60 * 60 * 1000));
            
            // Check if session has ended (add 5 minute buffer)
            const bufferTime = new Date(sessionEndTime.getTime() + (5 * 60 * 1000));
            
            if (now >= bufferTime) {
                batch.update(doc.ref, {
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    autoCompleted: true,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                completedCount++;
                console.log(`Auto-completing session: ${doc.id}`);
            }
        });
        
        if (completedCount > 0) {
            await batch.commit();
            console.log(`✅ Auto-completed ${completedCount} sessions`);
            
            // Refresh the sessions list
            if (currentSection === 'sessions') {
                await loadSessionsHistory();
            }
        }
        
    } catch (error) {
        console.error("Error auto-completing sessions:", error);
    }
}


       
async function manuallyCompleteSession(sessionId) {
    try {
        await db.collection('bookedSessions').doc(sessionId).update({
            status: 'completed',
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoCompleted: false,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('Session marked as completed');
        showSuccessMessage('Session marked as completed!');
        
        // Refresh sessions list
        await loadSessionsHistory();
        
    } catch (error) {
        console.error("Error completing session:", error);
        showErrorMessage('Failed to complete session: ' + error.message);
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function showSuccessMessage(message) {
    // Use your existing notification system
    alert(message); // Replace with your toast/notification
}

function showErrorMessage(message) {
    // Use your existing notification system
    alert(message); // Replace with your toast/notification
}

// Apply filters to session history
function applySessionHistoryFilters() {
    const container = document.getElementById('sessionsContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    let filteredSessions = [...allSessionsHistory];
    
    // Apply time period filter
    const now = new Date();
filteredSessions = filteredSessions.filter(session => {
    const actionTime = getActionTime(session);
    const actionDate = actionTime.timestamp.toDate();
    
    switch(currentHistoryFilter) {
        case 'month':
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return actionDate >= startOfMonth;
        case '3months':
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            return actionDate >= threeMonthsAgo;
        case 'year':
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            return actionDate >= startOfYear;
        default: // 'all'
            return true;
    }
});
    
    // Apply Action Type filter
if (currentActionTypeFilter !== 'all') {
    filteredSessions = filteredSessions.filter(session => {
        const filterValue = currentActionTypeFilter.toLowerCase();
        
        switch (filterValue) {
            case 'session confirmed':
            case 'confirmed':
                return session.status === 'confirmed';
                
            case 'completed':
                return session.status === 'completed';
                
            case 'tutor cancelled':
                return session.status === 'cancelled' && session.cancelledBy === currentUser.uid;
                
            case 'student cancelled':
                return session.status === 'cancelled' && session.cancelledBy === session.studentId;
                
            case 'rescheduled':
                return session.status === 'rescheduled';
                
            case 'pending':
                return session.status === 'pending' || (!session.confirmedAt && session.bookedAt);
                
            default:
                return true;
        }
    });
}
    
    // Display sessions
    displayFilteredSessions(filteredSessions, container, loadMoreBtn);
}

// Display filtered sessions
function displayFilteredSessions(sessions, container, loadMoreBtn) {
    if (sessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-filter"></i>
                <h3>No Sessions Match Your Filters</h3>
                <p>Try adjusting your filter criteria to see more sessions.</p>
            </div>
        `;
        return;
    }
    
    // Sort by date (most recent first)
    sessions.sort((a, b) => {
    const actionTimeA = getActionTime(a).timestamp.toDate();
    const actionTimeB = getActionTime(b).timestamp.toDate();
    return actionTimeB - actionTimeA;
});
    
    // Calculate pagination
    const totalPages = Math.ceil(sessions.length / SESSIONS_PER_PAGE);
    const startIndex = (currentSessionsPage - 1) * SESSIONS_PER_PAGE;
    const endIndex = startIndex + SESSIONS_PER_PAGE;
    const sessionsToDisplay = sessions.slice(startIndex, endIndex);
    
    // Check if mobile
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // MOBILE VIEW: Cards layout
        container.innerHTML = `
            <div class="mobile-sessions-container">
                ${sessionsToDisplay.map(session => createMobileSessionCard(session)).join('')}
            </div>
            <div class="session-stats mobile-stats">
                <div class="stat-item">
                    <span class="stat-number">${sessionsToDisplay.length}</span>
                    <span class="stat-label">This Page</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${sessions.length}</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${allSessionsHistory.length}</span>
                    <span class="stat-label">All</span>
                </div>
            </div>
            <div class="pagination-container" id="sessionsPagination">
                <!-- Pagination will be inserted here -->
            </div>
        `;
    } else {
        // DESKTOP VIEW: Table layout
        container.innerHTML = `
            <div class="sessions-table-container">
                <table class="sessions-table">
                    <thead>
                        <tr>
                             <th>Action Time</th>
                    <th>Action Type</th>
                    <th>Student</th>
                    <th>Subject</th>
                    <th>Session Date</th>
                    <th>Type</th>
                    <th>Duration</th>
                    <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody">
                        ${sessionsToDisplay.map(session => createSessionHistoryRow(session)).join('')}
                    </tbody>
                </table>
            </div>
            <div class="session-stats">
                <div class="stat-item">
                    <span class="stat-number">${sessionsToDisplay.length}</span>
                    <span class="stat-label">This Page</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${sessions.length}</span>
                    <span class="stat-label">Total Filtered</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${allSessionsHistory.length}</span>
                    <span class="stat-label">All Sessions</span>
                </div>
            </div>
            <div class="pagination-container" id="sessionsPagination">
                <!-- Pagination will be inserted here -->
            </div>
        `;
    }
    
    // Add pagination controls (ONCE, not duplicated)
    createPaginationControls(totalPages, sessions.length);
    
    // Add event listeners (ONCE, not duplicated)
    addSessionHistoryListeners();
}

// Add this to handle window resizing
function setupResponsiveSessions() {
    let resizeTimeout;
    
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            // Re-apply filters to refresh the view when window size changes
            if (currentSection === 'sessions') {
                applySessionHistoryFilters();
            }
        }, 250);
    });
}

// ADD THIS FUNCTION - it creates table rows for session history
function createSessionHistoryRow(session) {
    const sessionDate = session.date.toDate();
    const formattedSessionDate = sessionDate.toLocaleDateString();
    const formattedSessionTime = sessionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Get action time information
    const actionTimeInfo = getActionTime(session);
    const actionDate = actionTimeInfo.timestamp.toDate();
    const formattedActionDate = actionDate.toLocaleDateString();
    const formattedActionTime = actionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const isFutureSession = sessionDate > new Date();
    const sessionType = session.sessionType === 'online' ? 'Online' : 'In-Person';
    
    // Use Tutor Action as the Action Type - UPDATED: No more "Session Held"
    const tutorAction = getTutorActionForSession(session);
    const actionClass = getActionClass(tutorAction);
    
    return `
        <tr class="session-history-row ${isFutureSession ? 'future-session' : 'past-session'}">
            <td>
                <div class="action-time-cell">
                    <div class="action-date">${formattedActionDate}</div>
                    <div class="action-time">${formattedActionTime}</div>
                    <div class="action-relative-time">${getRelativeTime(actionDate)}</div>
                </div>
            </td>
            <td>
                <span class="action-badge action-${actionClass}">${tutorAction}</span>
            </td>
            <td>${session.studentName || 'Unknown Student'}</td>
            <td>${session.subject || 'General'}</td>
            <td>
                <div>${formattedSessionDate}</div>
                <div class="timestamp-cell">${formattedSessionTime}</div>
                ${isFutureSession ? '<div class="future-badge">Upcoming</div>' : ''}
            </td>
            <td>${sessionType}</td>
            <td>${session.duration || '1.5'}h</td>
            <td>
                <button class="btn-outline view-session-btn" data-session-id="${session.id}">
                    <i class="fas fa-eye"></i> Details
                </button>
                ${session.status === 'completed' ? `
                    <button class="btn-success invoice-session-btn" data-session-id="${session.id}" style="margin-top: 5px;">
                        <i class="fas fa-file-invoice"></i> Invoice
                    </button>
                ` : ''}
                ${session.status === 'confirmed' && sessionDate < new Date() ? `
                    <button class="btn-primary complete-session-btn" data-session-id="${session.id}" style="margin-top: 5px;">
                        <i class="fas fa-check-circle"></i> Mark Complete
                    </button>
                ` : ''}
            </td>
        </tr>
    `;
}

// Helper function to get status class for styling
function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'success';
        case 'confirmed': return 'primary';
        case 'pending': return 'warning';
        case 'cancelled': return 'error';
        case 'rescheduled': return 'info';
        default: return 'gray';
    }
}

// Get tutor action description for session - UPDATED: No more "Session Held"
function getTutorActionForSession(session) {
    const now = new Date();
    const sessionDate = session.date.toDate();
    
    switch(session.status) {
        case 'completed':
            return 'Session Completed';
        case 'confirmed':
            return 'Session Confirmed';
        case 'pending':
            return 'Awaiting Response';
        case 'cancelled':
            return session.cancelledBy === currentUser.uid ? 'Tutor Cancelled' : 'Student Cancelled';
        case 'rescheduled':
            return 'Rescheduled';
        case 'reschedule_requested':
            return 'Reschedule Pending';
        default:
            return 'No Action';
    }
}

// Get CSS class for action badge - UPDATED: No more "Session Held"
function getActionClass(action) {
    switch(action) {
        case 'Session Completed':
            return 'success';
        case 'Session Confirmed':
            return 'primary';
        case 'Awaiting Response':
        case 'Reschedule Pending':
            return 'warning';
        case 'Tutor Cancelled':
        case 'Student Cancelled':
            return 'error';
        case 'Rescheduled':
            return 'info';
        default:
            return 'gray';
    }
}

// Setup session history filter event listeners
function setupSessionHistoryFilters() {
    const historyFilter = document.getElementById('historyFilter');
    const actionTypeFilter = document.getElementById('actionTypeFilter');
    
    if (historyFilter) {
        historyFilter.addEventListener('change', function() {
            currentHistoryFilter = this.value;
            currentSessionsPage = 1; // Reset to page 1
            applySessionHistoryFilters();
        });
    }
    
    if (actionTypeFilter) {
        actionTypeFilter.addEventListener('change', function() {
            currentActionTypeFilter = this.value;
            currentSessionsPage = 1; // Reset to page 1
            applySessionHistoryFilters();
        });
    }
}
       
// Enhanced session details view for history section
async function showSessionDetails(sessionId) {
    try {
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        if (!sessionDoc.exists) {
            alert('Session details not found.');
            return;
        }
        
        const session = sessionDoc.data();
        const date = session.date.toDate();
        const isFutureSession = date > new Date();
        const isPastSession = date < new Date();
        
        // Get additional session metadata
        const sessionMetadata = await getSessionMetadata(sessionId);
        
        const modalContent = `
            <div class="session-details">
                <h3 style="color: var(--primary-dark); margin-bottom: 20px;">
                    <i class="fas fa-calendar-alt"></i> Session Details
                </h3>
                
                <div class="session-header-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0; color: var(--secondary);">${session.subject || 'General Tutoring'}</h4>
                            <p style="margin: 5px 0 0 0; color: #666;">with ${session.studentName || 'Unknown Student'}</p>
                        </div>
                        <span class="status-badge status-${getStatusClass(session.status)}" style="font-size: 14px;">
                            ${session.status.toUpperCase()}
                        </span>
                    </div>
                </div>
                
                <div class="details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="detail-item">
                        <strong><i class="fas fa-calendar"></i> Date:</strong>
                        <span>${date.toLocaleDateString()}</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-clock"></i> Time:</strong>
                        <span>${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-user-graduate"></i> Student:</strong>
                        <span>${session.studentName || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-book"></i> Subject:</strong>
                        <span>${session.subject || 'General Tutoring'}</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-clock"></i> Duration:</strong>
                        <span>${session.duration || '1.5'} hours</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-video"></i> Type:</strong>
                        <span>${session.sessionType === 'online' ? 'Online' : 'In-Person'}</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-dollar-sign"></i> Rate:</strong>
                        <span>$${session.hourlyRate || '40'}/hour</span>
                    </div>
                    <div class="detail-item">
                        <strong><i class="fas fa-calculator"></i> Total:</strong>
                        <span>$${session.totalPrice || (parseFloat(session.duration || 1.5) * parseFloat(session.hourlyRate || 40)).toFixed(2)}</span>
                    </div>
                </div>
                
                ${session.notes ? `
                    <div class="notes-section" style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Session Notes:</strong>
                        <p style="margin-top: 5px; font-style: italic;">${session.notes}</p>
                    </div>
                ` : ''}
                
                <div class="session-timeline" style="border-left: 3px solid var(--primary); padding-left: 15px; margin-left: 5px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Session Timeline</h4>
                    ${sessionMetadata.timeline.map(event => `
                        <div style="margin-bottom: 8px; padding: 5px 0;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 10px;"></div>
                                <span style="font-weight: 500;">${event.action}</span>
                                <span style="margin-left: auto; font-size: 0.8em; color: #666;">
                                    ${event.timestamp.toDate().toLocaleString()}
                                </span>
                            </div>
                            ${event.details ? `<div style="font-size: 0.9em; color: #666; margin-left: 18px;">${event.details}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
                
                ${!isFutureSession && session.status === 'completed' ? `
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                        <strong style="color: #2e7d32;">This session has been completed.</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">You can generate an invoice for this session from the Invoice section.</p>
                    </div>
                ` : ''}
                
                ${isPastSession && session.status === 'confirmed' ? `
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                        <strong style="color: #856404;">This session has passed but is not yet marked as completed.</strong>
                        <p style="margin: 10px 0 0 0;">
                            <button class="btn-primary" onclick="manuallyCompleteSession('${sessionId}')" style="width: 100%;">
                                <i class="fas fa-check-circle"></i> Mark Session as Completed
                            </button>
                        </p>
                    </div>
                ` : ''}
            </div>
        `;
        
        showSessionDetailsModal(modalContent);
        
    } catch (error) {
        console.error("Error loading session details:", error);
        alert('Error loading session details.');
    }
}

function getActionTime(session) {
    // Priority order for action timestamps
    if (session.cancelledAt) {
        return {
            timestamp: session.cancelledAt,
            action: 'Cancelled',
            type: 'cancellation'
        };
    } else if (session.confirmedAt) {
        return {
            timestamp: session.confirmedAt,
            action: 'Confirmed',
            type: 'confirmation'
        };
    } else if (session.completedAt) {
        return {
            timestamp: session.completedAt,
            action: 'Completed',
            type: 'completion'
        };
    } else if (session.bookedAt) {
        return {
            timestamp: session.bookedAt,
            action: 'Booked',
            type: 'booking'
        };
    } else if (session.lastUpdated) {
        return {
            timestamp: session.lastUpdated,
            action: 'Updated',
            type: 'update'
        };
    } else {
        // Fallback to session date
        return {
            timestamp: session.date,
            action: 'Scheduled',
            type: 'scheduled'
        };
    }
}

// Get CSS class for action type badge
function getActionTypeClass(actionType) {
    switch(actionType) {
        case 'cancellation':
            return 'error';
        case 'confirmation':
            return 'success';
        case 'completion':
            return 'primary';
        case 'booking':
            return 'info';
        case 'update':
            return 'warning';
        default:
            return 'gray';
    }
}

// Get relative time string (e.g., "2 hours ago")
function getRelativeTime(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} min ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString();
    }
}
       
// Get additional session metadata for timeline
async function getSessionMetadata(sessionId) {
    const metadata = {
        timeline: []
    };
    
    try {
        // Get session document to check for timestamps
        const sessionDoc = await db.collection('bookedSessions').doc(sessionId).get();
        const sessionData = sessionDoc.data();
        
        // Add creation event
        if (sessionData.createdAt) {
            metadata.timeline.push({
                action: 'Session Created',
                timestamp: sessionData.createdAt,
                details: 'Session was booked by student'
            });
        }
        
        // Add confirmation event
        if (sessionData.confirmedAt) {
            metadata.timeline.push({
                action: 'Session Confirmed',
                timestamp: sessionData.confirmedAt,
                details: 'You confirmed this session'
            });
        }
        
        // Add completion event
        if (sessionData.completedAt) {
            metadata.timeline.push({
                action: 'Session Completed',
                timestamp: sessionData.completedAt,
                details: 'Session was marked as completed'
            });
        }
        
        // Add cancellation event if applicable
        if (sessionData.cancelledAt) {
    let cancelledByName = 'unknown';
    if (sessionData.cancelledBy === currentUser.uid) {
        cancelledByName = 'You';
    } else if (sessionData.cancelledBy === sessionData.studentId) {
        cancelledByName = sessionData.studentName || 'Student';
    }
    
    metadata.timeline.push({
        action: 'Session Cancelled',
        timestamp: sessionData.cancelledAt,
        details: `Cancelled by ${cancelledByName}`
    });
}
        
        // Sort timeline by timestamp
        metadata.timeline.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());
        
    } catch (error) {
        console.error("Error loading session metadata:", error);
    }
    
    return metadata;
}

// Show session details modal
function showSessionDetailsModal(content) {
    let modal = document.getElementById('sessionDetailsModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'sessionDetailsModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3>Session Details</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="sessionDetailsModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="closeSessionDetailsBtn">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = modal.querySelector('.close-modal');
        const closeActionBtn = modal.querySelector('#closeSessionDetailsBtn');
        
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        closeActionBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    document.getElementById('sessionDetailsModalBody').innerHTML = content;
    modal.style.display = 'flex';
}

// Add event listeners to session history actions
function addSessionHistoryListeners() {
    // View session buttons
    document.querySelectorAll('.view-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            showSessionDetails(sessionId);
        });
    });
    
    // Invoice session buttons (for completed sessions)
    document.querySelectorAll('.invoice-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            // Switch to invoice section and pre-select this session
            switchToInvoiceSection(sessionId);
        });
    });
    
    // Complete session buttons (for past confirmed sessions)
    document.querySelectorAll('.complete-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sessionId = this.getAttribute('data-session-id');
            manuallyCompleteSession(sessionId);
        });
    });
}

// Switch to invoice section and pre-select session
function switchToInvoiceSection(sessionId) {
    // Activate invoice section menu item
    document.querySelectorAll('.menu-item a').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-section') === 'invoice-session') {
            item.classList.add('active');
        }
    });
    
    // Show invoice section
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.classList.remove('active');
        if (section.id === 'invoice-session') {
            section.classList.add('active');
        }
    });
    
    // Pre-select the session in invoice form
    setTimeout(() => {
        const sessionSelect = document.getElementById('completedSession');
        if (sessionSelect) {
            sessionSelect.value = sessionId;
            // Trigger change event to update hours/rate if needed
            sessionSelect.dispatchEvent(new Event('change'));
        }
    }, 100);
}

// CSS for mobile sessions
const mobileSessionsCSS = `
/* Mobile Sessions Container */
.mobile-sessions-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

/* Mobile Session Card */
.mobile-session-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color, #e1e5e9);
    transition: all 0.3s ease;
}

.mobile-session-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.session-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
    gap: 10px;
}

.session-main-info {
    flex: 1;
}

.session-subject {
    margin: 0 0 4px 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-dark);
}

.session-student {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.session-status-badges {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: flex-end;
}

.session-card-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.detail-row i {
    width: 16px;
    color: var(--primary);
    text-align: center;
}

.session-card-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.session-card-actions button {
    flex: 1;
    min-width: 120px;
    padding: 8px 12px;
    font-size: 0.85rem;
}

/* Mobile Stats */
.mobile-stats {
    padding: 12px !important;
}

.mobile-stats .stat-item {
    text-align: center;
}

.mobile-stats .stat-number {
    font-size: 1.2em !important;
}

.mobile-stats .stat-label {
    font-size: 0.7em !important;
}

/* Responsive Table Container */
.sessions-table-container {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--border-color, #e1e5e9);
    border-radius: 8px;
    margin-bottom: 20px;
}

/* Mobile Pagination */
@media (max-width: 768px) {
    .pagination-buttons {
        gap: 3px;
    }
    
    .pagination-btn {
        padding: 6px 8px;
        font-size: 0.8rem;
        min-width: 35px;
    }
    
    .pagination-info {
        font-size: 0.8rem;
        text-align: center;
    }
}

/* Hide table on mobile, show cards */
@media (max-width: 768px) {
    .sessions-table-container {
        display: none;
    }
    
    .mobile-sessions-container {
        display: flex;
    }
}

/* Show table on desktop, hide cards */
@media (min-width: 769px) {
    .sessions-table-container {
        display: block;
    }
    
    .mobile-sessions-container {
        display: none;
    }
}

/* Make table responsive on very small screens */
@media (max-width: 480px) {
    .session-card-actions {
        flex-direction: column;
    }
    
    .session-card-actions button {
        min-width: auto;
    }
    
    .session-card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .session-status-badges {
        flex-direction: row;
        align-items: center;
        width: 100%;
        justify-content: flex-start;
        margin-top: 8px;
    }
}
`;

// Create mobile session card function
function createMobileSessionCard(session) {
    const sessionDate = session.date.toDate();
    const formattedSessionDate = sessionDate.toLocaleDateString();
    const formattedSessionTime = sessionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Get action time information
    const actionTimeInfo = getActionTime(session);
    const actionDate = actionTimeInfo.timestamp.toDate();
    const formattedActionDate = actionDate.toLocaleDateString();
    const formattedActionTime = actionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Use Tutor Action as the Action Type - UPDATED: No more "Session Held"
    const tutorAction = getTutorActionForSession(session);
    const actionClass = getActionClass(tutorAction);
    
    return `
        <div class="mobile-session-card" data-session-id="${session.id}">
            <div class="session-card-header">
                <div class="session-main-info">
                    <h4 class="session-subject">${session.subject || 'General'}</h4>
                    <span class="session-student">${session.studentName || 'Unknown Student'}</span>
                </div>
                <div class="session-status-badges">
                    <span class="action-badge action-${actionClass}">${tutorAction}</span>
                </div>
            </div>
            
            <div class="session-card-details">
                <div class="detail-row action-time-highlight">
                    <i class="fas fa-clock"></i>
                    <span><strong>${tutorAction}:</strong> ${formattedActionDate}, ${formattedActionTime}</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-calendar"></i>
                    <span>Session: ${formattedSessionDate}, ${formattedSessionTime}</span>
                </div>
                <div class="detail-row">
                    <i class="fas fa-hourglass-half"></i>
                    <span>${session.duration || '1.5'} hours</span>
                </div>
                <div class="detail-row">
                    <i class="fas ${session.sessionType === 'online' ? 'fa-video' : 'fa-map-marker-alt'}"></i>
                    <span>${session.sessionType === 'online' ? 'Online' : 'In-Person'}</span>
                </div>
            </div>
            
            <div class="session-card-actions">
                <button class="btn-outline view-session-btn" data-session-id="${session.id}">
                    <i class="fas fa-eye"></i> Details
                </button>
                ${session.status === 'completed' ? `
                    <button class="btn-success invoice-session-btn" data-session-id="${session.id}">
                        <i class="fas fa-file-invoice"></i> Invoice
                    </button>
                ` : ''}
                ${session.status === 'confirmed' && sessionDate < new Date() ? `
                    <button class="btn-primary complete-session-btn" data-session-id="${session.id}">
                        <i class="fas fa-check-circle"></i> Complete
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

// Create pagination controls function
function createPaginationControls(totalPages, totalSessions) {
    const paginationContainer = document.getElementById('sessionsPagination');
    if (!paginationContainer) return;
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = `
            <div class="pagination-info">
                Showing all ${totalSessions} sessions
            </div>
        `;
        return;
    }
    
    let paginationHTML = `
        <div class="pagination-controls">
            <div class="pagination-info">
                Page ${currentSessionsPage} of ${totalPages} • 
                Showing ${Math.min(SESSIONS_PER_PAGE, totalSessions - ((currentSessionsPage - 1) * SESSIONS_PER_PAGE))} of ${totalSessions} sessions
            </div>
            <div class="pagination-buttons">
    `;
    
    // Previous button
    if (currentSessionsPage > 1) {
        paginationHTML += `<button class="pagination-btn" data-page="${currentSessionsPage - 1}">
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;
    }
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentSessionsPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust if we're near the end
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page + ellipsis
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" data-page="1">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
    }
    
    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentSessionsPage) {
            paginationHTML += `<button class="pagination-btn active" data-page="${i}">${i}</button>`;
        } else {
            paginationHTML += `<button class="pagination-btn" data-page="${i}">${i}</button>`;
        }
    }
    
    // Last page + ellipsis
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
    }
    
    // Next button
    if (currentSessionsPage < totalPages) {
        paginationHTML += `<button class="pagination-btn" data-page="${currentSessionsPage + 1}">
            Next <i class="fas fa-chevron-right"></i>
        </button>`;
    }
    
    paginationHTML += `</div></div>`;
    paginationContainer.innerHTML = paginationHTML;
    
    // Add event listeners to pagination buttons
    paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const page = parseInt(btn.dataset.page);
            if (page !== currentSessionsPage) {
                currentSessionsPage = page;
                applySessionHistoryFilters();
            }
        });
    });
}

// SIMPLE TEST - Load ALL sessions to see what's available
async function loadCompletedSessions() {
    const sessionSelect = document.getElementById('completedSession');
    console.log('Looking for sessions to invoice...');
    
    try {
        // Calculate date 7 days ago
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        // Get PAST sessions from last 7 days that haven't been invoiced
        const sessionsSnapshot = await db.collection('bookedSessions')
            .where('tutorId', '==', currentUser.uid)
            .where('date', '>=', sevenDaysAgo)  // Sessions from last 7 days
            .where('date', '<=', new Date())    // Sessions that already happened (past)
            .where('invoiced', '!=', true)      // Not already invoiced
            .get();
        
        console.log('Found sessions for invoicing:', sessionsSnapshot.size);
        
        completedSessions = [];
        sessionSelect.innerHTML = '<option value="">Select a session to invoice</option>';
        
        if (sessionsSnapshot.empty) {
            console.log('No sessions found for invoicing');
            sessionSelect.innerHTML = '<option value="">No sessions available for invoicing</option>';
            showInvoiceMessage('No past sessions found in the last 7 days. Sessions must be completed to appear here.');
            return;
        }
        
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            session.id = doc.id;
            completedSessions.push(session);
            
            console.log('Session available for invoice:', {
                id: session.id,
                studentName: session.studentName,
                status: session.status,
                date: session.date.toDate(),
                invoiced: session.invoiced
            });
            
            const sessionDate = session.date.toDate();
            const option = document.createElement('option');
            option.value = session.id;
            option.textContent = `${sessionDate.toLocaleDateString()} - ${session.studentName || 'Student'} - ${session.subject || 'General'} [${session.status}]`;
            
            sessionSelect.appendChild(option);
        });
        
        console.log('Total sessions available for invoice:', completedSessions.length);
        
    } catch (error) {
        console.error("Error loading sessions for invoice:", error);
        sessionSelect.innerHTML = '<option value="">Error loading sessions</option>';
        showInvoiceError('Error loading sessions: ' + error.message);
    }
}
       
// =============================================
// SESSIONS HISTORY SECTION ENDS HERE
// =============================================

// =============================================
// INVOICE SESSION SECTION STARTS HERE
// =============================================

// =============================================
// NEW INVOICE SECTION - FROM SCRATCH
// =============================================

let availableSessions = [];
let invoiceInitialized = false;
let currentInvoiceSection = false; // Track if we're currently in invoice section

// ADD MISSING FUNCTIONS
function setupInvoiceCalculations() {
    console.log('🧮 Setting up invoice calculations...');
    
    const hoursInput = document.getElementById('hours');
    const rateInput = document.getElementById('rate');
    
    if (hoursInput && rateInput) {
        hoursInput.addEventListener('input', calculateInvoiceTotal);
        rateInput.addEventListener('input', calculateInvoiceTotal);
        console.log('✅ Invoice calculations setup complete');
    }
}

function showInvoiceError(message) {
    console.error('❌ Invoice Error:', message);
    alert('Invoice Error: ' + message);
}

function showInvoiceMessage(message) {
    console.log('ℹ️ Invoice Message:', message);
    // You can implement a proper message display here if needed
}

// Initialize invoice section when page loads
function initInvoiceSection() {
    console.log('🔍 Initializing invoice section...');
    
    // Wait for user to be authenticated
    if (!currentUser || !currentUser.uid) {
        console.log('👤 Waiting for user authentication...');
        setTimeout(initInvoiceSection, 1000);
        return;
    }
    
    console.log('✅ User authenticated:', currentUser.uid);
    
    // Setup tab listeners
    setupTabListeners();
    
    // Check current active tab on load
    checkActiveTab();
}

// Listen for tab clicks - ONLY refresh when switching TO invoice section
function setupTabListeners() {
    document.addEventListener('click', function(e) {
        const target = e.target;
        
        // Check if this is a click that switches TO the invoice section
        if (target.closest('[data-tab="invoice"]') || 
            target.closest('[href*="invoice"]') ||
            target.textContent.toLowerCase().includes('invoice') ||
            (target.classList && target.classList.contains('tab-link'))) {
            
            // Only refresh if we're not already in the invoice section
            if (!currentInvoiceSection) {
                console.log('📌 Switching TO invoice section - refreshing sessions');
                currentInvoiceSection = true;
                invoiceInitialized = false; // Allow refresh
                setTimeout(loadInvoiceSession, 100);
            } else {
                console.log('📌 Already in invoice section - no refresh needed');
            }
        } else {
            // If clicking other tabs, mark that we're leaving invoice section
            currentInvoiceSection = false;
        }
    });
}

// Check if invoice is already active on page load
function checkActiveTab() {
    const invoiceSection = document.getElementById('invoice-session');
    if (invoiceSection && invoiceSection.style.display !== 'none') {
        console.log('📌 Invoice section active on page load - loading sessions');
        currentInvoiceSection = true;
        invoiceInitialized = false;
        loadInvoiceSession();
    }
}

// MAIN FUNCTION - Only loads when needed
async function loadInvoiceSession() {
    // Only load if not already initialized
    if (invoiceInitialized) {
        console.log('⚡ Invoice already loaded - skipping refresh');
        return;
    }
    
    console.log('🚀 loadInvoiceSession RUNNING - Fetching fresh data');
    
    const sessionSelect = document.getElementById('completedSession');
    if (!sessionSelect) {
        console.error('❌ Dropdown not found');
        return;
    }
    
    // Show loading state
    sessionSelect.innerHTML = '<option value="">Loading sessions...</option>';
    
    try {
        // SIMPLIFIED QUERY
        const sessionsSnapshot = await db.collection('bookedSessions')
            .where('tutorId', '==', currentUser.uid)
            .orderBy('date', 'desc')
            .limit(20)
            .get();
        
        console.log('✅ Found total sessions:', sessionsSnapshot.size);
        
        availableSessions = [];
        sessionSelect.innerHTML = '<option value="">Select a session to invoice</option>';
        
        if (sessionsSnapshot.empty) {
            sessionSelect.innerHTML = '<option value="">No sessions available</option>';
            showInvoiceMessage('No sessions found for invoicing.');
            invoiceInitialized = true;
            return;
        }
        
        // Filter manually in JavaScript
        const now = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        let validSessionsCount = 0;
        let invoicedSessionsCount = 0;
        
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            session.id = doc.id;
            
            const sessionDate = session.date.toDate();
            
            // Manual filtering: Past sessions from last 7 days
            if (sessionDate >= sevenDaysAgo && sessionDate <= now) {
                
                // Check if already invoiced
                if (session.invoiced === true) {
                    invoicedSessionsCount++;
                    return; // Skip invoiced sessions
                }
                
                availableSessions.push(session);
                validSessionsCount++;
                
                const duration = parseFloat(session.duration || '1.5');
                const endTime = new Date(sessionDate.getTime() + (duration * 60 * 60 * 1000));
                
                const option = document.createElement('option');
                option.value = session.id;
                
                const dateStr = sessionDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const startTimeStr = sessionDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                const endTimeStr = endTime.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                option.textContent = `${dateStr} (${startTimeStr}-${endTimeStr}) - ${session.studentName} - ${session.subject}`;
                
                sessionSelect.appendChild(option);
            }
        });
        
        console.log('🎉 Success! Loaded', validSessionsCount, 'sessions for invoicing');
        console.log('📋 Skipped', invoicedSessionsCount, 'already invoiced sessions');
        
        if (validSessionsCount === 0) {
            if (invoicedSessionsCount > 0) {
                sessionSelect.innerHTML = '<option value="">All recent sessions have been invoiced</option>';
                showInvoiceMessage('All sessions from the last 7 days have already been invoiced. Check Your Earnings section for payment status.');
            } else {
                sessionSelect.innerHTML = '<option value="">No past sessions available for invoicing</option>';
                showInvoiceMessage('No past sessions found in the last 7 days. Only sessions that have already occurred can be invoiced.');
            }
        }
        
        invoiceInitialized = true; // Mark as loaded
        setupInvoiceForm();
        
    } catch (error) {
        console.error('❌ Error loading sessions:', error);
        sessionSelect.innerHTML = '<option value="">Error loading sessions</option>';
        showInvoiceError('Error loading sessions: ' + error.message);
        invoiceInitialized = true; // Still mark as initialized to prevent repeated errors
    }
}

// Setup form functionality
function setupInvoiceForm() {
    console.log('⚙️ Setting up invoice form...');
    
    const sessionSelect = document.getElementById('completedSession');
    const invoiceForm = document.getElementById('invoiceForm');
    const generateBtn = document.getElementById('generateInvoiceBtn');
    
    if (sessionSelect) {
        sessionSelect.addEventListener('change', function(e) {
            const sessionId = e.target.value;
            console.log('Session selected:', sessionId);
            
            const session = availableSessions.find(s => s.id === sessionId);
            if (session) {
                populateSessionDetails(session);
            } else {
                resetInvoiceForm();
            }
        });
    }
    
    if (invoiceForm) {
        invoiceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleInvoiceSubmission();
        });
    }
    
    if (generateBtn) {
        generateBtn.addEventListener('click', handleInvoiceSubmission);
    }
    
    setupInvoiceCalculations();
    console.log('✅ Invoice form setup complete');
}

// Populate form with session details
function populateSessionDetails(session) {
    console.log('📝 Populating details for session:', session.id);
    
    const hoursInput = document.getElementById('hours');
    const rateInput = document.getElementById('rate');
    const notesInput = document.getElementById('invoiceNotes');
    
    if (hoursInput) hoursInput.value = session.duration || '1.5';
    if (rateInput) {
        rateInput.value = session.hourlyRate || '40';
        rateInput.readOnly = true;
    }
    if (notesInput) {
        const sessionDate = session.date?.toDate();
        const defaultNotes = `Tutoring session with ${session.studentName} on ${sessionDate?.toLocaleDateString()}`;
        notesInput.value = defaultNotes;
    }
    
    calculateInvoiceTotal();
}

// Reset invoice form
function resetInvoiceForm() {
    const hoursInput = document.getElementById('hours');
    const rateInput = document.getElementById('rate');
    const notesInput = document.getElementById('invoiceNotes');
    const totalInput = document.getElementById('total');
    
    if (hoursInput) hoursInput.value = '1.5';
    if (rateInput) {
        rateInput.value = '40';
        rateInput.readOnly = false;
    }
    if (notesInput) notesInput.value = '';
    if (totalInput) totalInput.value = '60.00';
}

// Calculate invoice total
function calculateInvoiceTotal() {
    const hours = parseFloat(document.getElementById('hours')?.value) || 0;
    const rate = parseFloat(document.getElementById('rate')?.value) || 0;
    const total = hours * rate;
    
    const totalInput = document.getElementById('total');
    if (totalInput) totalInput.value = total.toFixed(2);
}

// Handle invoice submission - Only refresh after successful submission
async function handleInvoiceSubmission() {
    console.log('🚀 Invoice submission started');
    
    const sessionSelect = document.getElementById('completedSession');
    const selectedSessionId = sessionSelect?.value;
    
    if (!selectedSessionId) {
        alert('Please select a session first');
        return;
    }
    
    const session = availableSessions.find(s => s.id === selectedSessionId);
    if (!session) {
        alert('Session not found');
        return;
    }
    
    try {
        console.log('Submitting invoice for session:', session.id);
        
        // Show loading
        const generateBtn = document.getElementById('generateInvoiceBtn');
        const originalText = generateBtn?.innerHTML;
        if (generateBtn) {
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            generateBtn.disabled = true;
        }
        
        // Get form values
        const hours = parseFloat(document.getElementById('hours')?.value) || 1.5;
        const rate = parseFloat(document.getElementById('rate')?.value) || 40;
        const notes = document.getElementById('invoiceNotes')?.value || '';
        const total = hours * rate;
        
        // Create invoice
        const invoiceData = {
            sessionId: session.id,
            tutorId: currentUser.uid,
            tutorName: userData?.fullName || 'Tutor',
            studentId: session.studentId,
            studentName: session.studentName,
            sessionDate: session.date,
            subject: session.subject,
            hours: hours,
            hourlyRate: rate,
            totalAmount: total,
            notes: notes,
            status: 'pending',
            invoiceNumber: 'INV-' + Date.now(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            sessionType: session.sessionType || 'online'
        };
        
        // Save to Firestore
        const invoiceRef = await db.collection('tutorInvoices').add(invoiceData);
        
        // Mark session as invoiced
        await db.collection('bookedSessions').doc(session.id).update({
            invoiced: true,
            invoiceId: invoiceRef.id,
            invoiceSubmittedAt: new Date()
        });
        
        console.log('✅ Invoice submitted successfully:', invoiceRef.id);
        
        // Reset form
        resetInvoiceForm();
        
        // Force refresh to remove the invoiced session from dropdown
        invoiceInitialized = false;
        await loadInvoiceSession();
        
        // Auto-navigate to earnings section
        navigateToEarningsSection();
        
        // Show success message
        setTimeout(() => {
            alert('Invoice submitted successfully! You can track payment status in Your Earnings section.');
        }, 500);
        
    } catch (error) {
        console.error('❌ Invoice submission failed:', error);
        alert('Failed to submit invoice: ' + error.message);
    } finally {
        // Reset button
        const generateBtn = document.getElementById('generateInvoiceBtn');
        if (generateBtn) {
            generateBtn.innerHTML = 'Generate Invoice';
            generateBtn.disabled = false;
        }
    }
}

// Navigate to Earnings section
function navigateToEarningsSection() {
    console.log('💰 Navigating to Earnings section...');
    
    // Try to find and click the earnings tab
    const earningsTab = document.querySelector('[data-tab="earnings"], [href*="earnings"], .nav-earnings, #earnings-tab');
    if (earningsTab) {
        earningsTab.click();
        console.log('✅ Clicked earnings tab');
    }
    
    // Refresh earnings data
    setTimeout(() => {
        if (typeof loadEarningsData === 'function') {
            loadEarningsData();
            console.log('✅ Earnings data refreshed');
        }
    }, 1000);
}

// Manual test function
window.testInvoiceSection = async function() {
    console.log('🧪 TESTING INVOICE SECTION...');
    invoiceInitialized = false;
    await loadInvoiceSession();
};

// Call this when your page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Page loaded - setting up invoice listeners');
    initInvoiceSection();
});

// Also call it when Firebase is ready
if (typeof firebase !== 'undefined') {
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            console.log('🔥 User authenticated - setting up invoice listeners');
            if (!invoiceInitialized) {
                initInvoiceSection();
            }
        }
    });
}
       
// =============================================
// INVOICE SESSION SECTION ENDS HERE
// =============================================


// =============================================
// YOUR EARNINGS SECTION STARTS HERE
// =============================================

// Load earnings data from tutorInvoices collection
async function loadEarningsData() {
    try {
        // Get all invoices for this tutor
        const invoicesSnapshot = await db.collection('tutorInvoices')
            .where('tutorId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        if (invoicesSnapshot.empty) {
            displayEmptyEarningsState();
            return;
        }
        
        const earningsData = processEarningsData(invoicesSnapshot);
        displayEarningsOverview(earningsData);
        displayEarningsHistory(earningsData.invoices);
        displayMonthlyReports(earningsData.invoices);
        
    } catch (error) {
        console.error("Error loading earnings data:", error);
        displayEarningsErrorState();
    }
}

// Get current pay period dates
function getCurrentPayPeriod() {
    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    let periodStart, periodEnd, periodName;
    
    if (currentDay <= 15) {
        // First half of month: 1st to 15th
        periodStart = new Date(currentYear, currentMonth, 1);
        periodEnd = new Date(currentYear, currentMonth, 15);
        periodName = `${today.toLocaleDateString('en-US', { month: 'long' })} 1st-15th`;
    } else {
        // Second half of month: 16th to last day
        periodStart = new Date(currentYear, currentMonth, 16);
        
        // Calculate last day of month (handles 28, 29, 30, 31 days automatically)
        const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
        periodEnd = new Date(currentYear, currentMonth, lastDay);
        periodName = `${today.toLocaleDateString('en-US', { month: 'long' })} 16th-${lastDay}`;
    }
    
    return {
        start: periodStart,
        end: periodEnd,
        name: periodName,
        isCurrentPeriod: today >= periodStart && today <= periodEnd
    };
}

// Get previous pay period
function getPreviousPayPeriod() {
    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    let periodStart, periodEnd, periodName;
    
    if (currentDay <= 15) {
        // Previous period was second half of previous month
        const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
        const prevMonthLastDay = new Date(prevYear, prevMonth + 1, 0).getDate();
        
        periodStart = new Date(prevYear, prevMonth, 16);
        periodEnd = new Date(prevYear, prevMonth, prevMonthLastDay);
        periodName = `${new Date(prevYear, prevMonth).toLocaleDateString('en-US', { month: 'long' })} 16th-${prevMonthLastDay}`;
    } else {
        // Previous period was first half of current month
        periodStart = new Date(currentYear, currentMonth, 1);
        periodEnd = new Date(currentYear, currentMonth, 15);
        periodName = `${today.toLocaleDateString('en-US', { month: 'long' })} 1st-15th`;
    }
    
    return {
        start: periodStart,
        end: periodEnd,
        name: periodName
    };
}

// Process earnings data from invoices
function processEarningsData(invoicesSnapshot) {
    const invoices = [];
    let totalInvoiced = 0;        
    let actualEarnings = 0;       
    let approvedHours = 0;        
    let approvedSessions = 0;     
    let totalHours = 0;           
    let totalSessions = 0;        
    
    // Pay period tracking
    const currentPeriod = getCurrentPayPeriod();
    const previousPeriod = getPreviousPayPeriod();
    
    let currentPeriodEarnings = 0;
    let currentPeriodSessions = 0;
    let previousPeriodEarnings = 0;
    let previousPeriodSessions = 0;
    
    let currentMonthInvoiced = 0;
    let currentMonthEarnings = 0;
    let pendingEarnings = 0;
    let rejectedEarnings = 0;
    let pendingSessions = 0;
    let rejectedSessions = 0;
    
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        invoice.id = doc.id;
        
        const invoiceDate = invoice.createdAt.toDate();
        const sessionDate = invoice.sessionDate.toDate();
        const hours = parseFloat(invoice.hours) || 1.5;
        const hourlyRate = parseFloat(invoice.hourlyRate) || 40;
        const sessionEarnings = hours * hourlyRate;
        const status = invoice.status || 'pending';
        
        // Always count in total submitted (ALL invoices)
        totalInvoiced += sessionEarnings;
        totalHours += hours;
        totalSessions += 1;
        
        // Count in current pay period
        if (invoiceDate >= currentPeriod.start && invoiceDate <= currentPeriod.end) {
            if (status === 'approved') {
                currentPeriodEarnings += sessionEarnings;
                currentPeriodSessions += 1;
            }
        }
        
        // Count in previous pay period
        if (invoiceDate >= previousPeriod.start && invoiceDate <= previousPeriod.end) {
            if (status === 'approved') {
                previousPeriodEarnings += sessionEarnings;
                previousPeriodSessions += 1;
            }
        }
        
        // Count in current month totals
        if (invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear) {
            currentMonthInvoiced += sessionEarnings;
        }
        
        // Handle status-specific tracking
        if (status === 'approved') {
            actualEarnings += sessionEarnings;
            approvedHours += hours;
            approvedSessions += 1;
            if (invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear) {
                currentMonthEarnings += sessionEarnings;
            }
        } else if (status === 'pending') {
            pendingEarnings += sessionEarnings;
            pendingSessions += 1;
        } else if (status === 'rejected') {
            rejectedEarnings += sessionEarnings;
            rejectedSessions += 1;
        }
        
        invoices.push({
            ...invoice,
            invoiceDate,
            sessionDate,
            hours,
            hourlyRate,
            sessionEarnings,
            status: status
        });
    });
    
    const avgSessionEarnings = approvedSessions > 0 ? 
        actualEarnings / approvedSessions : 0;
    
    return {
        invoices,
        approvedSessions,
        approvedHours,
        totalSessions,
        totalHours,
        totalInvoiced,
        actualEarnings,
        pendingEarnings,
        rejectedEarnings,
        pendingSessions,
        rejectedSessions,
        avgSessionEarnings,
        currentMonthInvoiced,
        currentMonthEarnings,
        // Pay period data
        currentPeriodEarnings,
        currentPeriodSessions,
        currentPeriodName: currentPeriod.name,
        previousPeriodEarnings,
        previousPeriodSessions,
        previousPeriodName: previousPeriod.name
    };
}

// Display earnings overview
function displayEarningsOverview(earningsData) {
    // Update the main stats with ONLY APPROVED data
    document.getElementById('totalSessionsCount').textContent = earningsData.approvedSessions;
    document.getElementById('totalHours').textContent = earningsData.approvedHours.toFixed(1);
    document.getElementById('avgSessionEarnings').textContent = `$${earningsData.avgSessionEarnings.toFixed(2)}`;
    
    // Update Total Earnings to show ACTUAL EARNINGS (approved only)
    document.getElementById('totalEarnings').textContent = `$${earningsData.actualEarnings.toFixed(2)}`;
    
    // UPDATE: Change to current pay period earnings
    document.getElementById('monthlyEarnings').textContent = `$${earningsData.currentPeriodEarnings.toFixed(2)}`;
    
    // Update the label to show pay period
    const monthlyEarningsElement = document.getElementById('monthlyEarnings').closest('.stat-card');
    if (monthlyEarningsElement) {
        const labelElement = monthlyEarningsElement.querySelector('.stat-label');
        if (labelElement) {
            labelElement.textContent = 'Current Pay Period';
            // Add tooltip with period dates
            labelElement.title = earningsData.currentPeriodName;
        }
    }
    
    // Add breakdown below the existing stats
    updateEarningsBreakdown(earningsData);
}

function updateEarningsBreakdown(earningsData) {
    // Remove existing breakdown if any
    const existingBreakdown = document.getElementById('earningsBreakdown');
    if (existingBreakdown) {
        existingBreakdown.remove();
    }
    
    // Create breakdown container
    const breakdown = document.createElement('div');
    breakdown.id = 'earningsBreakdown';
    breakdown.style.marginTop = '20px';
    breakdown.style.padding = '20px';
    breakdown.style.backgroundColor = '#f8f9fa';
    breakdown.style.borderRadius = '8px';
    breakdown.style.border = '1px solid #e0e0e0';
    
    let breakdownHTML = '<h4 style="margin-bottom: 15px; color: #4361ee;">Pay Period Overview</h4>';
    breakdownHTML += '<div class="stats-container">';
    
    // Current pay period
    breakdownHTML += `
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(76, 201, 240, 0.1); color: #4cc9f0;">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="stat-value" style="color: #4cc9f0; font-size: 20px;">$${earningsData.currentPeriodEarnings.toFixed(2)}</div>
            <div class="stat-label">Current Period</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ${earningsData.currentPeriodSessions} sessions
            </div>
            <div style="font-size: 11px; color: #999; margin-top: 3px;">
                ${earningsData.currentPeriodName}
            </div>
        </div>
    `;
    
    // Previous pay period
    breakdownHTML += `
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(108, 117, 125, 0.1); color: #6c757d;">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-value" style="color: #6c757d; font-size: 20px;">$${earningsData.previousPeriodEarnings.toFixed(2)}</div>
            <div class="stat-label">Last Period</div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ${earningsData.previousPeriodSessions} sessions
            </div>
            <div style="font-size: 11px; color: #999; margin-top: 3px;">
                ${earningsData.previousPeriodName}
            </div>
        </div>
    `;
    
    // Total submitted work
    breakdownHTML += `
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(67, 97, 238, 0.1); color: #4361ee;">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="stat-value" style="color: #4361ee; font-size: 20px;">${earningsData.totalSessions}</div>
            <div class="stat-label">Sessions Submitted</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(67, 97, 238, 0.1); color: #4361ee;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" style="color: #4361ee; font-size: 20px;">${earningsData.totalHours.toFixed(1)}</div>
            <div class="stat-label">Hours Submitted</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(67, 97, 238, 0.1); color: #4361ee;">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <div class="stat-value" style="color: #4361ee; font-size: 20px;">$${earningsData.totalInvoiced.toFixed(2)}</div>
            <div class="stat-label">Total Invoiced</div>
        </div>
    `;
    
    // Add pending if any
    if (earningsData.pendingEarnings > 0) {
        breakdownHTML += `
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: #ffc107;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" style="color: #ffc107; font-size: 20px;">${earningsData.pendingSessions}</div>
                <div class="stat-label">Pending Sessions</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(255, 193, 7, 0.1); color: #ffc107;">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value" style="color: #ffc107; font-size: 20px;">$${earningsData.pendingEarnings.toFixed(2)}</div>
                <div class="stat-label">Pending Approval</div>
            </div>
        `;
    }
    
    // Add rejected if any
    if (earningsData.rejectedEarnings > 0) {
        breakdownHTML += `
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(230, 57, 70, 0.1); color: #e63946;">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-value" style="color: #e63946; font-size: 20px;">${earningsData.rejectedSessions}</div>
                <div class="stat-label">Rejected Sessions</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(230, 57, 70, 0.1); color: #e63946;">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value" style="color: #e63946; font-size: 20px;">-$${earningsData.rejectedEarnings.toFixed(2)}</div>
                <div class="stat-label">Rejected Amount</div>
            </div>
        `;
    }
    
    breakdownHTML += '</div>';
    
    // Add pay period info box
    breakdownHTML += `
        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4361ee; margin-top: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-info-circle" style="color: #4361ee;"></i>
                <div>
                    <strong>Pay Schedule:</strong> Semi-monthly (15th and last day of month)
                </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                Invoices approved during each period are paid on the 15th and last day of the following month.
            </div>
        </div>
    `;
    
    // Add summary text
    breakdownHTML += `<p style="margin-top: 15px; font-size: 14px; color: #666; text-align: center;">
        <i class="fas fa-info-circle"></i> 
        You've submitted <strong>${earningsData.totalSessions} sessions</strong> totaling <strong>$${earningsData.totalInvoiced.toFixed(2)}</strong>. 
        ${earningsData.pendingSessions > 0 ? `<strong>${earningsData.pendingSessions} sessions ($${earningsData.pendingEarnings.toFixed(2)})</strong> are awaiting approval.` : ''}
        ${earningsData.approvedSessions > 0 ? `<strong>${earningsData.approvedSessions} sessions ($${earningsData.actualEarnings.toFixed(2)})</strong> have been approved.` : ''}
    </p>`;
    
    breakdown.innerHTML = breakdownHTML;
    
    // Insert the breakdown after the stats container
    const statsContainer = document.querySelector('#earnings-overview .stats-container');
    if (statsContainer && statsContainer.parentNode) {
        statsContainer.parentNode.insertBefore(breakdown, statsContainer.nextSibling);
    }
}

// Display monthly reports for tax purposes
function displayMonthlyReports(invoices) {
    // Group invoices by month-year
    const monthlyData = {};
    
    invoices.forEach(invoice => {
        if (invoice.status === 'approved') {
            const invoiceDate = invoice.invoiceDate;
            const monthYear = `${invoiceDate.getFullYear()}-${(invoiceDate.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthName = invoiceDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = {
                    monthName: monthName,
                    monthKey: monthYear,
                    earnings: 0,
                    sessions: 0,
                    hours: 0
                };
            }
            
            monthlyData[monthYear].earnings += invoice.sessionEarnings;
            monthlyData[monthYear].sessions += 1;
            monthlyData[monthYear].hours += invoice.hours;
        }
    });
    
    // Convert to array and sort by date (newest first)
    const monthlyArray = Object.values(monthlyData).sort((a, b) => {
        return new Date(b.monthKey) - new Date(a.monthKey);
    });
    
    // Create or update monthly reports section
    let monthlyReportsSection = document.getElementById('monthlyReportsSection');
    if (!monthlyReportsSection) {
        monthlyReportsSection = document.createElement('div');
        monthlyReportsSection.id = 'monthlyReportsSection';
        monthlyReportsSection.style.marginTop = '30px';
        monthlyReportsSection.style.padding = '20px';
        monthlyReportsSection.style.backgroundColor = '#f8f9fa';
        monthlyReportsSection.style.borderRadius = '8px';
        monthlyReportsSection.style.border = '1px solid #e0e0e0';
        
        // Insert after earnings breakdown
        const earningsBreakdown = document.getElementById('earningsBreakdown');
        if (earningsBreakdown) {
            earningsBreakdown.parentNode.insertBefore(monthlyReportsSection, earningsBreakdown.nextSibling);
        }
    }
    
    if (monthlyArray.length === 0) {
        monthlyReportsSection.innerHTML = `
            <h4 style="margin-bottom: 15px; color: #4361ee;">
                <i class="fas fa-file-invoice-dollar"></i> Monthly Earnings Report
            </h4>
            <p style="color: #666; text-align: center;">No monthly earnings data available yet.</p>
        `;
        return;
    }
    
    // Pagination settings
    const monthsPerPage = 6;
    const totalPages = Math.ceil(monthlyArray.length / monthsPerPage);
    let currentPage = 1;
    
    function renderMonthlyPage(page) {
        const startIndex = (page - 1) * monthsPerPage;
        const endIndex = startIndex + monthsPerPage;
        const monthsToShow = monthlyArray.slice(startIndex, endIndex);
        
        let reportsHTML = `
            <h4 style="margin-bottom: 15px; color: #4361ee;">
                <i class="fas fa-file-invoice-dollar"></i> Monthly Earnings Report (For Tax Purposes)
            </h4>
            <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
                <i class="fas fa-info-circle"></i> Use this report for tax filing and income tracking
                <span style="float: right; font-weight: 600;">
                    Page ${page} of ${totalPages} • ${monthlyArray.length} months total
                </span>
            </div>
            <div class="stats-container">
        `;
        
        monthsToShow.forEach(monthData => {
            reportsHTML += `
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(123, 97, 255, 0.1); color: #7b61ff;">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-value" style="color: #7b61ff; font-size: 18px;">$${monthData.earnings.toFixed(2)}</div>
                    <div class="stat-label">${monthData.monthName}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ${monthData.sessions} sessions • ${monthData.hours.toFixed(1)} hours
                    </div>
                </div>
            `;
        });
        
        reportsHTML += `</div>`;
        
        // Add pagination controls if needed
        if (totalPages > 1) {
            reportsHTML += `
                <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px;">
                    <button class="btn-outline" onclick="changeMonthlyPage(${page - 1})" ${page === 1 ? 'disabled style="opacity: 0.5;"' : ''}>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    
                    <span style="color: #666; font-weight: 600;">
                        Page ${page} of ${totalPages}
                    </span>
                    
                    <button class="btn-outline" onclick="changeMonthlyPage(${page + 1})" ${page === totalPages ? 'disabled style="opacity: 0.5;"' : ''}>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }
        
        // Add export button
        reportsHTML += `
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" onclick="exportMonthlyReport()" style="padding: 10px 20px; margin-right: 10px;">
                    <i class="fas fa-download"></i> Export Full Report
                </button>
                <button class="btn-outline" onclick="showYearlySummary()" style="padding: 10px 20px;">
                    <i class="fas fa-chart-bar"></i> Yearly Summary
                </button>
            </div>
        `;
        
        monthlyReportsSection.innerHTML = reportsHTML;
        
        // Store current state for pagination
        monthlyReportsSection.setAttribute('data-current-page', page);
        monthlyReportsSection.setAttribute('data-total-pages', totalPages);
        monthlyReportsSection.setAttribute('data-monthly-data', JSON.stringify(monthlyArray));
    }
    
    // Initial render
    renderMonthlyPage(currentPage);
}

// FIXED: Global function for monthly report pagination
function changeMonthlyPage(newPage) {
    const monthlyReportsSection = document.getElementById('monthlyReportsSection');
    if (!monthlyReportsSection) return;
    
    const currentPage = parseInt(monthlyReportsSection.getAttribute('data-current-page') || '1');
    const totalPages = parseInt(monthlyReportsSection.getAttribute('data-total-pages') || '1');
    
    if (newPage >= 1 && newPage <= totalPages && newPage !== currentPage) {
        const monthlyData = JSON.parse(monthlyReportsSection.getAttribute('data-monthly-data') || '[]');
        
        // Re-render with new page
        const startIndex = (newPage - 1) * 6;
        const endIndex = startIndex + 6;
        const monthsToShow = monthlyData.slice(startIndex, endIndex);
        
        let reportsHTML = `
            <h4 style="margin-bottom: 15px; color: #4361ee;">
                <i class="fas fa-file-invoice-dollar"></i> Monthly Earnings Report
            </h4>
            <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
                <i class="fas fa-info-circle"></i> Page ${newPage} of ${totalPages} • ${monthlyData.length} months total
                <span style="float: right; font-weight: 600;">
                    Showing ${startIndex + 1}-${Math.min(endIndex, monthlyData.length)} of ${monthlyData.length} months
                </span>
            </div>
            <div class="stats-container">
        `;
        
        monthsToShow.forEach(monthData => {
            reportsHTML += `
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(123, 97, 255, 0.1); color: #7b61ff;">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-value" style="color: #7b61ff; font-size: 18px;">$${monthData.earnings.toFixed(2)}</div>
                    <div class="stat-label">${monthData.monthName}</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ${monthData.sessions} sessions • ${monthData.hours.toFixed(1)} hours
                    </div>
                </div>
            `;
        });
        
        reportsHTML += `</div>`;
        
        // Pagination controls
        reportsHTML += `
            <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px;">
                <button class="btn-outline" onclick="changeMonthlyPage(${newPage - 1})" ${newPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                
                <span style="color: #666; font-weight: 600;">
                    Page ${newPage} of ${totalPages}
                </span>
                
                <button class="btn-outline" onclick="changeMonthlyPage(${newPage + 1})" ${newPage === totalPages ? 'disabled style="opacity: 0.5;"' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
        
        // Export buttons
        reportsHTML += `
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" onclick="exportMonthlyReport()" style="padding: 10px 20px; margin-right: 10px;">
                    <i class="fas fa-download"></i> Export Full Report
                </button>
                <button class="btn-outline" onclick="showYearlySummary()" style="padding: 10px 20px;">
                    <i class="fas fa-chart-bar"></i> Yearly Summary
                </button>
            </div>
        `;
        
        monthlyReportsSection.innerHTML = reportsHTML;
        monthlyReportsSection.setAttribute('data-current-page', newPage);
    }
}

// FIXED: Global function for yearly summary
function showYearlySummary() {
    const monthlyReportsSection = document.getElementById('monthlyReportsSection');
    if (!monthlyReportsSection) return;
    
    const monthlyData = JSON.parse(monthlyReportsSection.getAttribute('data-monthly-data') || '[]');
    const currentPage = parseInt(monthlyReportsSection.getAttribute('data-current-page') || '1');
    const totalPages = parseInt(monthlyReportsSection.getAttribute('data-total-pages') || '1');
    
    // Group by year
    const yearlyData = {};
    monthlyData.forEach(month => {
        const year = month.monthName.split(' ')[1];
        if (!yearlyData[year]) {
            yearlyData[year] = {
                year: year,
                earnings: 0,
                sessions: 0,
                hours: 0,
                months: 0
            };
        }
        yearlyData[year].earnings += month.earnings;
        yearlyData[year].sessions += month.sessions;
        yearlyData[year].hours += month.hours;
        yearlyData[year].months += 1;
   }); // FIXED: Added missing closing brace and parenthesis here
    
    const yearlyArray = Object.values(yearlyData).sort((a, b) => b.year - a.year);
    
    let yearlyHTML = `
        <h4 style="margin-bottom: 15px; color: #4361ee;">
            <i class="fas fa-chart-bar"></i> Yearly Earnings Summary
        </h4>
        <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
            <i class="fas fa-info-circle"></i> Annual overview for tax planning
        </div>
        <div class="stats-container">
    `;
    
    yearlyArray.forEach(yearData => {
        yearlyHTML += `
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(255, 107, 107, 0.1); color: #ff6b6b;">
                    <i class="fas fa-calendar-star"></i>
                </div>
                <div class="stat-value" style="color: #ff6b6b; font-size: 20px;">$${yearData.earnings.toFixed(2)}</div>
                <div class="stat-label">${yearData.year} Total</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${yearData.sessions} sessions • ${yearData.hours.toFixed(1)} hours
                </div>
                <div style="font-size: 11px; color: #999; margin-top: 3px;">
                    ${yearData.months} active months
                </div>
            </div>
        `;
    });
    
    yearlyHTML += `</div>`;
    
    // Back button - FIXED: Store the data before switching views
    yearlyHTML += `
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-outline" onclick="returnToMonthlyView()" style="padding: 10px 20px;">
                <i class="fas fa-arrow-left"></i> Back to Monthly View
            </button>
        </div>
    `;
    
    monthlyReportsSection.innerHTML = yearlyHTML;
    
    // Store the monthly data in the section so we can return to it
    monthlyReportsSection.setAttribute('data-monthly-data-backup', JSON.stringify(monthlyData));
    monthlyReportsSection.setAttribute('data-current-page-backup', currentPage);
    monthlyReportsSection.setAttribute('data-total-pages-backup', totalPages);
}

// NEW FUNCTION: Return to monthly view from yearly view
function returnToMonthlyView() {
    const monthlyReportsSection = document.getElementById('monthlyReportsSection');
    if (!monthlyReportsSection) return;
    
    // Get the stored data
    const monthlyData = JSON.parse(monthlyReportsSection.getAttribute('data-monthly-data-backup') || '[]');
    const currentPage = parseInt(monthlyReportsSection.getAttribute('data-current-page-backup') || '1');
    const totalPages = parseInt(monthlyReportsSection.getAttribute('data-total-pages-backup') || '1');
    
    if (monthlyData.length === 0) {
        // If no backup data, just go to page 1
        changeMonthlyPage(1);
        return;
    }
    
    // Re-render the monthly view with the stored page
    const startIndex = (currentPage - 1) * 6;
    const endIndex = startIndex + 6;
    const monthsToShow = monthlyData.slice(startIndex, endIndex);
    
    let reportsHTML = `
        <h4 style="margin-bottom: 15px; color: #4361ee;">
            <i class="fas fa-file-invoice-dollar"></i> Monthly Earnings Report
        </h4>
        <div style="margin-bottom: 15px; font-size: 14px; color: #666;">
            <i class="fas fa-info-circle"></i> Page ${currentPage} of ${totalPages} • ${monthlyData.length} months total
            <span style="float: right; font-weight: 600;">
                Showing ${startIndex + 1}-${Math.min(endIndex, monthlyData.length)} of ${monthlyData.length} months
            </span>
        </div>
        <div class="stats-container">
    `;
    
    monthsToShow.forEach(monthData => {
        reportsHTML += `
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(123, 97, 255, 0.1); color: #7b61ff;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-value" style="color: #7b61ff; font-size: 18px;">$${monthData.earnings.toFixed(2)}</div>
                <div class="stat-label">${monthData.monthName}</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${monthData.sessions} sessions • ${monthData.hours.toFixed(1)} hours
                </div>
            </div>
        `;
    });
    
    reportsHTML += `</div>`;
    
    // Pagination controls
    if (totalPages > 1) {
        reportsHTML += `
            <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 20px;">
                <button class="btn-outline" onclick="changeMonthlyPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                
                <span style="color: #666; font-weight: 600;">
                    Page ${currentPage} of ${totalPages}
                </span>
                
                <button class="btn-outline" onclick="changeMonthlyPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled style="opacity: 0.5;"' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }
    
    // Export buttons
    reportsHTML += `
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-primary" onclick="exportMonthlyReport()" style="padding: 10px 20px; margin-right: 10px;">
                <i class="fas fa-download"></i> Export Full Report
            </button>
            <button class="btn-outline" onclick="showYearlySummary()" style="padding: 10px 20px;">
                <i class="fas fa-chart-bar"></i> Yearly Summary
            </button>
        </div>
    `;
    
    monthlyReportsSection.innerHTML = reportsHTML;
    
    // Restore the data attributes
    monthlyReportsSection.setAttribute('data-current-page', currentPage);
    monthlyReportsSection.setAttribute('data-total-pages', totalPages);
    monthlyReportsSection.setAttribute('data-monthly-data', JSON.stringify(monthlyData));
}
       
// FIXED: Global function for export
function exportMonthlyReport() {
    const monthlyReportsSection = document.getElementById('monthlyReportsSection');
    if (!monthlyReportsSection) return;
    
    const monthlyData = JSON.parse(monthlyReportsSection.getAttribute('data-monthly-data') || '[]');
    
    if (monthlyData.length === 0) {
        alert('No data available to export.');
        return;
    }
    
    // Create CSV content
    let csvContent = "Month,Earnings,Sessions,Hours,Average Hourly Rate\n";
    
    monthlyData.forEach(month => {
        const hourlyRate = month.hours > 0 ? (month.earnings / month.hours).toFixed(2) : "0.00";
        csvContent += `"${month.monthName}",${month.earnings.toFixed(2)},${month.sessions},${month.hours.toFixed(1)},${hourlyRate}\n`;
    });
    
    // Calculate totals
    const totalEarnings = monthlyData.reduce((sum, month) => sum + month.earnings, 0);
    const totalSessions = monthlyData.reduce((sum, month) => sum + month.sessions, 0);
    const totalHours = monthlyData.reduce((sum, month) => sum + month.hours, 0);
    
    csvContent += `\n"TOTAL",${totalEarnings.toFixed(2)},${totalSessions},${totalHours.toFixed(1)},""\n`;
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `earnings-report-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    alert(`✅ Earnings report downloaded! ${monthlyData.length} months of data exported.`);
}

// Display earnings history table WITH PAGINATION
function displayEarningsHistory(invoices) {
    const tableBody = document.getElementById('earningsTableBody');
    const earningsTotal = document.getElementById('earningsTotal');
    const earningsHistorySection = document.getElementById('earnings-history');
    
    // Remove existing mobile cards if any
    const existingCards = document.querySelectorAll('.earnings-card');
    existingCards.forEach(card => card.remove());
    
    // Remove existing pagination if any
    const existingPagination = document.getElementById('earningsHistoryPagination');
    if (existingPagination) {
        existingPagination.remove();
    }

    if (invoices.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                    <i class="fas fa-chart-line" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                    <p style="color: #666;">No earnings history yet. Submitted invoices will appear here.</p>
                </td>
            </tr>
        `;
        earningsTotal.textContent = '$0.00';
        return;
    }

    // Pagination settings
    const itemsPerPage = 10;
    const totalPages = Math.ceil(invoices.length / itemsPerPage);
    let currentPage = 1;

    function renderEarningsPage(page) {
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const invoicesToShow = invoices.slice(startIndex, endIndex);

        // Clear existing content
        tableBody.innerHTML = '';
        
        // Remove existing mobile cards
        const existingCards = document.querySelectorAll('.earnings-card');
        existingCards.forEach(card => card.remove());

        invoicesToShow.forEach(invoice => {
            const status = invoice.status || 'pending';
            let statusBadge = '';
            let amountStyle = '';
            let rowClass = '';

            // Safely handle sessionDate
            let sessionDateDisplay = 'Invalid Date';
            try {
                if (invoice.sessionDate && typeof invoice.sessionDate.toDate === 'function') {
                    sessionDateDisplay = invoice.sessionDate.toDate().toLocaleDateString();
                } else if (invoice.sessionDate instanceof Date) {
                    sessionDateDisplay = invoice.sessionDate.toLocaleDateString();
                } else if (invoice.sessionDate) {
                    sessionDateDisplay = new Date(invoice.sessionDate).toLocaleDateString();
                }
            } catch (error) {
                console.warn('Error formatting session date:', error);
                sessionDateDisplay = 'Invalid Date';
            }

            // Status styling
            if (status === 'pending') {
                statusBadge = '<span class="status-badge status-pending">Pending</span>';
                rowClass = 'pending-earning';
                amountStyle = 'color: #ffc107;';
            } else if (status === 'rejected') {
                statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
                rowClass = 'rejected-earning';
                amountStyle = 'color: #e63946; text-decoration: line-through;';
            } else if (status === 'approved') {
                statusBadge = '<span class="status-badge status-approved">Approved</span>';
                amountStyle = 'color: #4cc9f0;';
            }

            // Desktop table row
            const tableRow = `
                <tr class="earning-row ${rowClass}">
                    <td>${sessionDateDisplay}</td>
                    <td>${invoice.studentName || 'Unknown Student'}${statusBadge}</td>
                    <td>${invoice.subject || 'General'}</td>
                    <td>${invoice.hours}h</td>
                    <td>$${invoice.hourlyRate}/h</td>
                    <td><strong style="${amountStyle}">$${invoice.sessionEarnings.toFixed(2)}</strong></td>
                </tr>
            `;
            tableBody.innerHTML += tableRow;

            // Mobile card
            const card = document.createElement('div');
            card.className = `earnings-card ${rowClass}`;
            card.innerHTML = `
                <div class="card-row">
                    <span class="card-label">Date & Student</span>
                    <span class="card-value">${sessionDateDisplay}<br>${invoice.studentName || 'Unknown Student'} ${statusBadge}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Subject</span>
                    <span class="card-value">${invoice.subject || 'General'}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Duration</span>
                    <span class="card-value">${invoice.hours}h @ $${invoice.hourlyRate}/h</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Amount</span>
                    <span class="card-value amount" style="${amountStyle}">$${invoice.sessionEarnings.toFixed(2)}</span>
                </div>
            `;
            
            // Insert card after the table
            earningsHistorySection.insertBefore(card, earningsHistorySection.querySelector('.total-earnings'));
        });

        // Update pagination controls
        updateEarningsPagination(page, totalPages, invoices.length, startIndex, endIndex);

        // Store current state
        tableBody.setAttribute('data-current-page', page);
        tableBody.setAttribute('data-total-pages', totalPages);
        tableBody.setAttribute('data-earnings-data', JSON.stringify(invoices));
    }

    function updateEarningsPagination(currentPage, totalPages, totalItems, startIndex, endIndex) {
        let paginationContainer = document.getElementById('earningsHistoryPagination');
        
        if (!paginationContainer) {
            paginationContainer = document.createElement('div');
            paginationContainer.id = 'earningsHistoryPagination';
            paginationContainer.style.marginTop = '20px';
            paginationContainer.style.display = 'flex';
            paginationContainer.style.justifyContent = 'space-between';
            paginationContainer.style.alignItems = 'center';
            paginationContainer.style.padding = '15px';
            paginationContainer.style.backgroundColor = '#f8f9fa';
            paginationContainer.style.borderRadius = '8px';
            
            // Insert after the total earnings
            const totalEarnings = document.querySelector('.total-earnings');
            if (totalEarnings && totalEarnings.parentNode) {
                totalEarnings.parentNode.insertBefore(paginationContainer, totalEarnings.nextSibling);
            }
        }

        const pageInfo = `Showing ${startIndex + 1}-${Math.min(endIndex, totalItems)} of ${totalItems} invoices`;
        
        let paginationHTML = `
            <div style="font-size: 14px; color: #666;">
                <strong>${pageInfo}</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
        `;

        // Previous button
        paginationHTML += `
            <button class="btn-outline" onclick="changeEarningsPage(${currentPage - 1})" 
                    ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}
                    style="padding: 8px 12px; font-size: 12px;">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        `;

        // Page numbers
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button class="${i === currentPage ? 'btn-primary' : 'btn-outline'}" 
                            onclick="changeEarningsPage(${i})"
                            style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        ${i}
                    </button>
                `;
            }
        } else {
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `
                    <button class="btn-outline" onclick="changeEarningsPage(1)" style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        1
                    </button>
                `;
                if (startPage > 2) {
                    paginationHTML += `<span style="color: #666; padding: 0 5px;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="${i === currentPage ? 'btn-primary' : 'btn-outline'}" 
                            onclick="changeEarningsPage(${i})"
                            style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span style="color: #666; padding: 0 5px;">...</span>`;
                }
                paginationHTML += `
                    <button class="btn-outline" onclick="changeEarningsPage(${totalPages})" style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        ${totalPages}
                    </button>
                `;
            }
        }

        // Next button
        paginationHTML += `
            <button class="btn-outline" onclick="changeEarningsPage(${currentPage + 1})" 
                    ${currentPage === totalPages ? 'disabled style="opacity: 0.5;"' : ''}
                    style="padding: 8px 12px; font-size: 12px;">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        `;

        paginationHTML += `</div>`;
        paginationContainer.innerHTML = paginationHTML;
    }

    // Initial render
    renderEarningsPage(currentPage);

    // Calculate and display total of ALL invoices
    const allInvoicesTotal = invoices.reduce((total, invoice) => total + invoice.sessionEarnings, 0);
    earningsTotal.textContent = `$${allInvoicesTotal.toFixed(2)}`;
}

    function updateEarningsPagination(currentPage, totalPages, totalItems, startIndex, endIndex) {
        let paginationContainer = document.getElementById('earningsHistoryPagination');
        
        if (!paginationContainer) {
            paginationContainer = document.createElement('div');
            paginationContainer.id = 'earningsHistoryPagination';
            paginationContainer.style.marginTop = '20px';
            paginationContainer.style.display = 'flex';
            paginationContainer.style.justifyContent = 'space-between';
            paginationContainer.style.alignItems = 'center';
            paginationContainer.style.padding = '15px';
            paginationContainer.style.backgroundColor = '#f8f9fa';
            paginationContainer.style.borderRadius = '8px';
            
            // Insert after the table
            const table = document.querySelector('.sessions-table');
            if (table && table.parentNode) {
                table.parentNode.insertBefore(paginationContainer, table.nextSibling);
            }
        }

        const pageInfo = `Showing ${startIndex + 1}-${Math.min(endIndex, totalItems)} of ${totalItems} invoices`;
        
        let paginationHTML = `
            <div style="font-size: 14px; color: #666;">
                <strong>${pageInfo}</strong>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
        `;

        // Previous button
        paginationHTML += `
            <button class="btn-outline" onclick="changeEarningsPage(${currentPage - 1})" 
                    ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}
                    style="padding: 8px 12px; font-size: 12px;">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        `;

        // Page numbers
        if (totalPages <= 7) {
            // Show all pages if 7 or fewer
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button class="${i === currentPage ? 'btn-primary' : 'btn-outline'}" 
                            onclick="changeEarningsPage(${i})"
                            style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        ${i}
                    </button>
                `;
            }
        } else {
            // Show first page, current page range, and last page
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `
                    <button class="btn-outline" onclick="changeEarningsPage(1)" style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        1
                    </button>
                `;
                if (startPage > 2) {
                    paginationHTML += `<span style="color: #666; padding: 0 5px;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="${i === currentPage ? 'btn-primary' : 'btn-outline'}" 
                            onclick="changeEarningsPage(${i})"
                            style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span style="color: #666; padding: 0 5px;">...</span>`;
                }
                paginationHTML += `
                    <button class="btn-outline" onclick="changeEarningsPage(${totalPages})" style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                        ${totalPages}
                    </button>
                `;
            }
        }

        // Next button
        paginationHTML += `
            <button class="btn-outline" onclick="changeEarningsPage(${currentPage + 1})" 
                    ${currentPage === totalPages ? 'disabled style="opacity: 0.5;"' : ''}
                    style="padding: 8px 12px; font-size: 12px;">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        `;

        paginationHTML += `</div>`;
        paginationContainer.innerHTML = paginationHTML;
    }

    // Initial render
    renderEarningsPage(currentPage);

    // Calculate and display total of ALL invoices
    const allInvoicesTotal = invoices.reduce((total, invoice) => total + invoice.sessionEarnings, 0);
    earningsTotal.textContent = `$${allInvoicesTotal.toFixed(2)}`;

// Global function for earnings history pagination - FIXED VERSION
function changeEarningsPage(newPage) {
    const tableBody = document.getElementById('earningsTableBody');
    if (!tableBody) return;

    const currentPage = parseInt(tableBody.getAttribute('data-current-page') || '1');
    const totalPages = parseInt(tableBody.getAttribute('data-total-pages') || '1');
    const invoices = JSON.parse(tableBody.getAttribute('data-earnings-data') || '[]');

    if (newPage >= 1 && newPage <= totalPages && newPage !== currentPage) {
        // Re-render the page with the new page number
        const itemsPerPage = 10;
        const startIndex = (newPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const invoicesToShow = invoices.slice(startIndex, endIndex);

        const earningsHistorySection = document.getElementById('earnings-history');
        const earningsTotal = document.getElementById('earningsTotal');

        // Clear existing content
        tableBody.innerHTML = '';
        
        // Remove existing mobile cards
        const existingCards = document.querySelectorAll('.earnings-card');
        existingCards.forEach(card => card.remove());

        invoicesToShow.forEach(invoice => {
            const status = invoice.status || 'pending';
            let statusBadge = '';
            let amountStyle = '';
            let rowClass = '';

            // Safely handle sessionDate
            let sessionDateDisplay = 'Invalid Date';
            try {
                if (invoice.sessionDate && typeof invoice.sessionDate.toDate === 'function') {
                    sessionDateDisplay = invoice.sessionDate.toDate().toLocaleDateString();
                } else if (invoice.sessionDate instanceof Date) {
                    sessionDateDisplay = invoice.sessionDate.toLocaleDateString();
                } else if (invoice.sessionDate) {
                    sessionDateDisplay = new Date(invoice.sessionDate).toLocaleDateString();
                }
            } catch (error) {
                console.warn('Error formatting session date:', error);
                sessionDateDisplay = 'Invalid Date';
            }

            if (status === 'pending') {
                statusBadge = '<span class="status-badge status-pending">Pending</span>';
                rowClass = 'pending-earning';
                amountStyle = 'color: #ffc107;';
            } else if (status === 'rejected') {
                statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
                rowClass = 'rejected-earning';
                amountStyle = 'color: #e63946; text-decoration: line-through;';
            } else if (status === 'approved') {
                statusBadge = '<span class="status-badge status-approved">Approved</span>';
                amountStyle = 'color: #4cc9f0;';
            }

            // Desktop table row
            tableBody.innerHTML += `
                <tr class="earning-row ${rowClass}">
                    <td>${sessionDateDisplay}</td>
                    <td>${invoice.studentName || 'Unknown Student'}${statusBadge}</td>
                    <td>${invoice.subject || 'General'}</td>
                    <td>${invoice.hours}h</td>
                    <td>$${invoice.hourlyRate}/h</td>
                    <td><strong style="${amountStyle}">$${invoice.sessionEarnings.toFixed(2)}</strong></td>
                </tr>
            `;

            // Mobile card
            const card = document.createElement('div');
            card.className = `earnings-card ${rowClass}`;
            card.innerHTML = `
                <div class="card-row">
                    <span class="card-label">Date & Student</span>
                    <span class="card-value">${sessionDateDisplay}<br>${invoice.studentName || 'Unknown Student'} ${statusBadge}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Subject</span>
                    <span class="card-value">${invoice.subject || 'General'}</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Duration</span>
                    <span class="card-value">${invoice.hours}h @ $${invoice.hourlyRate}/h</span>
                </div>
                <div class="card-row">
                    <span class="card-label">Amount</span>
                    <span class="card-value amount" style="${amountStyle}">$${invoice.sessionEarnings.toFixed(2)}</span>
                </div>
            `;
            
            earningsHistorySection.insertBefore(card, earningsHistorySection.querySelector('.total-earnings'));
        });

        tableBody.setAttribute('data-current-page', newPage);

        // Update pagination controls
        updateEarningsPagination(newPage, totalPages, invoices.length, startIndex, endIndex);
    }
}

// Helper function to update pagination (needs to be global) - FIXED VERSION
function updateEarningsPagination(currentPage, totalPages, totalItems, startIndex, endIndex) {
    const paginationContainer = document.getElementById('earningsHistoryPagination');
    if (!paginationContainer) return;

    const pageInfo = `Showing ${startIndex + 1}-${Math.min(endIndex, totalItems)} of ${totalItems} invoices`;
    
    let paginationHTML = `
        <div style="font-size: 14px; color: #666;">
            <strong>${pageInfo}</strong>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
    `;

    // Previous button
    paginationHTML += `
        <button class="btn-outline" onclick="changeEarningsPage(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : ''}
                style="padding: 8px 12px; font-size: 12px;">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
    `;

    // Page numbers
    if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
                <button class="${i === currentPage ? 'btn-primary' : 'btn-outline'}" 
                        onclick="changeEarningsPage(${i})"
                        style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                    ${i}
                </button>
            `;
        }
    } else {
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
            paginationHTML += `
                <button class="btn-outline" onclick="changeEarningsPage(1)" style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                    1
                </button>
            `;
            if (startPage > 2) {
                paginationHTML += `<span style="color: #666; padding: 0 5px;">...</span>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button class="${i === currentPage ? 'btn-primary' : 'btn-outline'}" 
                        onclick="changeEarningsPage(${i})"
                        style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                    ${i}
                </button>
            `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<span style="color: #666; padding: 0 5px;">...</span>`;
            }
            paginationHTML += `
                <button class="btn-outline" onclick="changeEarningsPage(${totalPages})" style="padding: 8px 12px; font-size: 12px; min-width: 40px;">
                    ${totalPages}
                </button>
            `;
        }
    }

    // Next button
    paginationHTML += `
        <button class="btn-outline" onclick="changeEarningsPage(${currentPage + 1})" 
                ${currentPage === totalPages ? 'disabled style="opacity: 0.5;"' : ''}
                style="padding: 8px 12px; font-size: 12px;">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    `;

    paginationHTML += `</div>`;
    paginationContainer.innerHTML = paginationHTML;
}
       
// Display empty earnings state
function displayEmptyEarningsState() {
    document.getElementById('totalSessionsCount').textContent = '0';
    document.getElementById('totalEarnings').textContent = '$0.00';
    document.getElementById('avgSessionEarnings').textContent = '$0.00';
    document.getElementById('totalHours').textContent = '0';
    document.getElementById('monthlyEarnings').textContent = '$0.00';
    
    // Remove breakdown if it exists
    const breakdown = document.getElementById('earningsBreakdown');
    if (breakdown) {
        breakdown.remove();
    }
    
    // Remove monthly reports if exists
    const monthlyReports = document.getElementById('monthlyReportsSection');
    if (monthlyReports) {
        monthlyReports.remove();
    }
    
    const tableBody = document.getElementById('earningsTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
                <i class="fas fa-chart-line" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                <h4 style="color: #666; margin-bottom: 10px;">No Earnings Yet</h4>
                <p style="color: #999;">Your earnings will appear here once you submit invoices for your sessions.</p>
            </td>
        </tr>
    `;
}

// Display earnings error state
function displayEarningsErrorState() {
    const tableBody = document.getElementById('earningsTableBody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 15px;"></i>
                <h4 style="color: #666; margin-bottom: 10px;">Error Loading Earnings</h4>
                <p style="color: #999;">Please try refreshing the page or contact support if the problem continues.</p>
            </td>
        </tr>
    `;
}

// Add CSS for status badges
const earningsStyle = document.createElement('style');
earningsStyle.textContent = `
    .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
    }
    .status-pending {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }
    .status-approved {
        background: rgba(76, 201, 240, 0.1);
        color: #4cc9f0;
    }
    .status-rejected {
        background: rgba(230, 57, 70, 0.1);
        color: #e63946;
    }
    .pending-earning {
        background-color: rgba(255, 193, 7, 0.05);
    }
    .rejected-earning {
        background-color: rgba(230, 57, 70, 0.05);
        color: #999;
    }
    .rejected-earning td {
        opacity: 0.7;
    }
`;
document.head.appendChild(earningsStyle);

// =============================================
// YOUR EARNINGS SECTION ENDS HERE
// =============================================
// =============================================
// NOTIFICATION BELL FUNCTIONALITY STARTS HERE (REAL DATA VERSION)
// =============================================

// =============================================
// TUTOR NOTIFICATION SYSTEM (Using Dedicated tutorNotifications Collection)
// =============================================

class TutorNotificationSystem {
    constructor() {
        this.notifications = [];
        this.unreadCount = 0;
        this.realtimeListener = null;
        this.isInitialized = false;
        this.isLoading = false;
        
        // Debounce variables
        this.updateTimeout = null;
        this.clickHandlers = new Map();
        
        // Bind methods to maintain context
        this.handleBellClick = this.handleBellClick.bind(this);
        this.handleOutsideClick = this.handleOutsideClick.bind(this);
        this.handleKeydown = this.handleKeydown.bind(this);
        this.handleMarkAllRead = this.handleMarkAllRead.bind(this);
        this.handleClearAll = this.handleClearAll.bind(this);
        this.handleRealtimeUpdate = this.handleRealtimeUpdate.bind(this);
        this.handleRealtimeError = this.handleRealtimeError.bind(this);
    }

    // Initialize notification system with proper error handling
    async initialize() {
        if (this.isInitialized) {
            console.warn('Tutor notification system already initialized');
            return;
        }

        if (this.isLoading) {
            console.warn('Tutor notification system is already loading');
            return;
        }

        this.isLoading = true;

        try {
            await this.validateDependencies();
            this.setupDOMElements();
            await this.loadNotifications();
            this.startRealtimeListener();
            this.setupEventListeners();
            this.isInitialized = true;
            this.isLoading = false;
            
            console.log('Tutor notification system initialized successfully');
        } catch (error) {
            this.isLoading = false;
            this.handleInitializationError(error);
        }
    }

    // Validate required dependencies
    async validateDependencies() {
        if (typeof db === 'undefined') {
            throw new Error('Firestore database not available');
        }
        
        if (typeof currentUser === 'undefined' || !currentUser?.uid) {
            throw new Error('Tutor not authenticated');
        }
    }

    // Setup DOM elements with proper error handling
    setupDOMElements() {
        try {
            this.createNotificationDropdown();
            this.injectStyles();
        } catch (error) {
            throw new Error(`DOM setup failed: ${error.message}`);
        }
    }

    // Create notification dropdown with accessible markup
    createNotificationDropdown() {
        const existingDropdown = document.getElementById('tutorNotificationDropdown');
        if (existingDropdown) {
            existingDropdown.remove();
        }

        const dropdown = document.createElement('div');
        dropdown.id = 'tutorNotificationDropdown';
        dropdown.className = 'notification-dropdown hidden';
        dropdown.setAttribute('role', 'dialog');
        dropdown.setAttribute('aria-label', 'Notifications');
        dropdown.setAttribute('aria-modal', 'true');
        
        dropdown.innerHTML = `
            <div class="notification-header">
                <h4 class="notification-title">Tutor Notifications</h4>
                <div class="notification-actions">
                    <button id="tutorMarkAllReadBtn" class="btn-outline btn-small" 
                            aria-label="Mark all notifications as read">
                        Mark All Read
                    </button>
                    <button id="tutorClearNotificationsBtn" class="btn-outline btn-small" 
                            aria-label="Clear all notifications">
                        Clear All
                    </button>
                </div>
            </div>
            <div class="notification-list" id="tutorNotificationList" role="list">
                <div class="notification-loading">
                    <div class="loading-spinner" aria-label="Loading notifications"></div>
                    <span>Loading notifications...</span>
                </div>
            </div>
            <div class="notification-footer">
                <span id="tutorNotificationFooterText" aria-live="polite">Loading...</span>
            </div>
        `;

        document.body.appendChild(dropdown);
    }

    // Inject CSS styles for maintainability
    injectStyles() {
        const styleId = 'tutor-notification-system-styles';
        if (document.getElementById(styleId)) return;

        const styles = `
            .notification-dropdown {
                position: absolute;
                top: 60px;
                right: 10px;
                width: min(400px, 90vw);
                max-height: 500px;
                background: var(--background-primary, #ffffff);
                border: 1px solid var(--border-color, #e0e0e0);
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .notification-dropdown.hidden {
                display: none;
            }
            
            .notification-dropdown.visible {
                display: flex;
            }
            
            .notification-header {
                padding: 1rem;
                border-bottom: 1px solid var(--border-color, #e0e0e0);
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: var(--background-secondary, #f8f9fa);
            }
            
            .notification-title {
                margin: 0;
                color: var(--text-primary, #333333);
                font-size: 1.1rem;
                font-weight: 600;
            }
            
            .notification-actions {
                display: flex;
                gap: 0.5rem;
            }
            
            .notification-list {
                flex: 1;
                overflow-y: auto;
                max-height: 300px;
            }
            
            .notification-loading {
                padding: 2rem;
                text-align: center;
                color: var(--text-secondary, #666666);
            }
            
            .loading-spinner {
                width: 24px;
                height: 24px;
                border: 2px solid var(--border-color, #e0e0e0);
                border-top: 2px solid var(--primary-color, #007bff);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 0.5rem;
            }
            
            .notification-item {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid var(--border-light, #f0f0f0);
                cursor: pointer;
                transition: background-color 0.2s ease;
                display: flex;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .notification-item:hover {
                background-color: var(--background-hover, #f5f5f5);
            }
            
            .notification-item.unread {
                background-color: var(--background-accent, #f0f7ff);
            }
            
            .notification-item:focus {
                outline: 2px solid var(--primary-color, #007bff);
                outline-offset: -2px;
            }
            
            .notification-icon {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                flex-shrink: 0;
            }
            
            .notification-content {
                flex: 1;
                min-width: 0;
            }
            
            .notification-title-text {
                font-weight: 600;
                color: var(--text-primary, #333333);
                margin-bottom: 0.25rem;
                word-wrap: break-word;
            }
            
            .notification-message {
                font-size: 0.9rem;
                color: var(--text-secondary, #666666);
                line-height: 1.4;
                margin-bottom: 0.25rem;
            }
            
            .notification-time {
                font-size: 0.8rem;
                color: var(--text-tertiary, #999999);
            }
            
            .unread-indicator {
                width: 8px;
                height: 8px;
                background: var(--accent-color, #4361ee);
                border-radius: 50%;
                margin-left: 0.5rem;
                flex-shrink: 0;
                margin-top: 0.5rem;
            }
            
            .notification-footer {
                padding: 0.75rem 1rem;
                border-top: 1px solid var(--border-light, #f0f0f0);
                text-align: center;
                background: var(--background-secondary, #f8f9fa);
            }
            
            .notification-empty {
                padding: 2rem;
                text-align: center;
                color: var(--text-secondary, #666666);
            }
            
            .notification-error {
                padding: 1rem;
                text-align: center;
                color: var(--error-color, #dc3545);
            }
            
            .btn-retry {
                margin-top: 0.5rem;
                padding: 0.5rem 1rem;
                background: var(--primary-color, #007bff);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            
            .btn-retry:hover {
                background: var(--primary-dark, #0056b3);
            }
            
            .hidden {
                display: none !important;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @media (max-width: 480px) {
                .notification-dropdown {
                    right: 5px;
                    left: 5px;
                    width: auto;
                }
            }
        `;

        const styleElement = document.createElement('style');
        styleElement.id = styleId;
        styleElement.textContent = styles;
        document.head.appendChild(styleElement);
    }

    // Load notifications with efficient batch operations
    async loadNotifications() {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.showLoadingState();
        
        // Add timeout protection
        const loadTimeout = setTimeout(() => {
            if (this.isLoading) {
                console.warn('Notification load timeout');
                this.isLoading = false;
                this.handleLoadError(new Error('Load timeout after 10 seconds'));
            }
        }, 10000);

        try {
            const notificationsSnapshot = await this.fetchNotifications();
            clearTimeout(loadTimeout);
            
            if (notificationsSnapshot.empty) {
                this.notifications = [];
                this.unreadCount = 0;
                this.updateUI();
                return;
            }

            const sessionsMap = await this.preloadSessionData(notificationsSnapshot);
            this.processNotifications(notificationsSnapshot, sessionsMap);
            this.updateUI();
            
        } catch (error) {
            clearTimeout(loadTimeout);
            this.handleLoadError(error);
        } finally {
            this.isLoading = false;
            clearTimeout(loadTimeout);
        }
    }
    
    // Fetch notifications from tutorNotifications collection
    async fetchNotifications() {
        try {
            console.log('Current tutor UID:', currentUser.uid);
            console.log('Querying tutorNotifications collection...');
            
            // Use the dedicated tutorNotifications collection
            const snapshot = await db.collection('tutorNotifications')
                .where('tutorId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get();

            console.log('Query result:', snapshot.size, 'tutor notifications found');
            snapshot.forEach(doc => {
                console.log('Tutor notification data:', doc.data());
            });
            
            return snapshot;
        } catch (error) {
            console.error('Tutor notification query error:', error);
            
            // Fallback: try without ordering if there's an index issue
            try {
                console.log('Trying fallback query without ordering...');
                const snapshot = await db.collection('tutorNotifications')
                    .where('tutorId', '==', currentUser.uid)
                    .limit(20)
                    .get();
                    
                // Sort client-side
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const aTime = a.data().createdAt?.toDate() || new Date(0);
                    const bTime = b.data().createdAt?.toDate() || new Date(0);
                    return bTime - aTime;
                });

                return {
                    empty: sortedDocs.length === 0,
                    docs: sortedDocs
                };
            } catch (fallbackError) {
                console.error('Fallback query also failed:', fallbackError);
                throw error;
            }
        }
    }

    // Preload session data efficiently
    async preloadSessionData(notificationsSnapshot) {
        if (!notificationsSnapshot || notificationsSnapshot.empty) {
            return new Map();
        }

        const sessionIds = new Set();
        const docs = notificationsSnapshot.docs || [];

        // Collect all session IDs from notifications
        docs.forEach(doc => {
            const notification = doc.data();
            if (notification.relatedSessionId) {
                sessionIds.add(notification.relatedSessionId);
            }
        });

        if (sessionIds.size === 0) return new Map();

        try {
            const sessionIdsArray = Array.from(sessionIds);
            const sessionsMap = new Map();

            // Load sessions in batches of 10 (Firestore limit)
            for (let i = 0; i < sessionIdsArray.length; i += 10) {
                const chunk = sessionIdsArray.slice(i, i + 10);
                const sessionsSnapshot = await db.collection('bookedSessions')
                    .where('__name__', 'in', chunk)
                    .get();

                sessionsSnapshot.docs.forEach(doc => {
                    sessionsMap.set(doc.id, doc.data());
                });
            }

            return sessionsMap;
        } catch (error) {
            console.warn('Failed to load session data:', error);
            return new Map();
        }
    }

    // Process notifications with enriched data
    processNotifications(snapshot, sessionsMap) {
        this.notifications = [];

        if (!snapshot || snapshot.empty) {
            return;
        }

        const docs = snapshot.docs || [];
        docs.forEach(doc => {
            const notification = this.enrichNotificationData(doc, sessionsMap);
            this.notifications.push(notification);
        });

        this.unreadCount = this.notifications.filter(n => !n.isRead).length;
    }

    // Enrich notification with related data
    enrichNotificationData(doc, sessionsMap) {
        const data = doc.data();
        const notification = { 
            id: doc.id, 
            ...data,
            sessionData: null
        };

        // Add session data if available
        if (notification.relatedSessionId && sessionsMap) {
            notification.sessionData = sessionsMap.get(notification.relatedSessionId);
        }

        return notification;
    }

    // Update UI components
    updateUI() {
        this.updateBadge();
        this.updateDropdownContent();
        this.updateFooter();
    }

    // Update notification badge
updateBadge() {
    console.log('Updating badge - unread count:', this.unreadCount);
    
    let badge = document.getElementById('tutorNotificationCount');
    if (!badge) {
        console.error('Badge element not found!');
        return;
    }

    if (this.unreadCount > 0) {
        const displayCount = this.unreadCount > 99 ? '99+' : this.unreadCount.toString();
        badge.textContent = displayCount;
        badge.style.display = 'flex'; // Use your inline style approach
        badge.setAttribute('aria-label', `${this.unreadCount} unread notifications`);
        
        // Add pulse animation
        badge.classList.add('pulse');
        setTimeout(() => badge.classList.remove('pulse'), 1000);
        
        console.log('Badge updated with count:', displayCount);
    } else {
        badge.style.display = 'none'; // Use your inline style approach
        badge.setAttribute('aria-label', 'No unread notifications');
        console.log('Badge hidden - no unread notifications');
    }
}

    // Update dropdown content
    updateDropdownContent() {
    const list = document.getElementById('tutorNotificationList');
    if (!list) return;

    if (this.notifications.length === 0) {
        list.innerHTML = this.getEmptyStateHTML();
        return;
    }

    // **Sort by timestamp - newest first**
    const sortedNotifications = [...this.notifications].sort((a, b) => {
        const aTime = a.createdAt?.toDate?.() || a.createdAt || new Date(0);
        const bTime = b.createdAt?.toDate?.() || b.createdAt || new Date(0);
        return bTime - aTime; // Descending (newest first)
    });

    list.innerHTML = sortedNotifications.map(notification => 
        this.getNotificationHTML(notification)
    ).join('');

    this.attachNotificationHandlers();
}

    // Get notification HTML template
    getNotificationHTML(notification) {
        const timeAgo = this.getTimeAgo(notification.createdAt);
        const isUnread = !notification.isRead;
        const message = this.generateNotificationMessage(notification);

        return `
            <div class="notification-item ${isUnread ? 'unread' : ''}" 
                 data-notification-id="${notification.id}"
                 data-notification-type="${notification.type}"
                 data-session-id="${notification.relatedSessionId || ''}"
                 role="listitem"
                 tabindex="0">
                <div class="notification-icon" style="background: ${this.getNotificationColor(notification.type)}">
                    <i class="${this.getNotificationIcon(notification.type)}" aria-hidden="true"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title-text">${this.escapeHtml(notification.title)}</div>
                    <div class="notification-message">${this.escapeHtml(message)}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
                ${isUnread ? '<div class="unread-indicator" aria-label="Unread"></div>' : ''}
            </div>
        `;
    }

    // Attach event handlers to notifications
    attachNotificationHandlers() {
        const items = document.querySelectorAll('#tutorNotificationList .notification-item');
        
        items.forEach(item => {
            const handler = (e) => {
                if (e.type === 'click' || e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.handleNotificationClick(item);
                }
            };
            
            // Remove existing handler if any
            const existingHandler = this.clickHandlers.get(item);
            if (existingHandler) {
                item.removeEventListener('click', existingHandler);
                item.removeEventListener('keydown', existingHandler);
            }
            
            // Add new handlers
            item.addEventListener('click', handler);
            item.addEventListener('keydown', handler);
            this.clickHandlers.set(item, handler);
        });
    }

    // Handle notification click
    async handleNotificationClick(item) {
    const notificationId = item.dataset.notificationId;
    const notificationType = item.dataset.notificationType;
    const sessionId = item.dataset.sessionId;

    try {
        // Mark as read FIRST, then navigate
        await this.markAsRead(notificationId);
        
        // Update the UI immediately for better UX
        this.updateNotificationItemUI(item);
        
        // Navigate to relevant section
        this.navigateToRelevantSection(notificationType, sessionId);
        this.hideDropdown();
    } catch (error) {
        console.error('Error handling notification click:', error);
    }
}

// Helper method to update the UI of a notification item after marking as read
updateNotificationItemUI(item) {
    // Remove unread styling
    item.classList.remove('unread');
    
    // Remove the unread indicator if it exists
    const unreadIndicator = item.querySelector('.unread-indicator');
    if (unreadIndicator) {
        unreadIndicator.remove();
    }
    
    // Update the badge count immediately
    this.updateBadge();
}
    
    // Mark notification as read
    async markAsRead(notificationId) {
    const notification = this.notifications.find(n => n.id === notificationId);
    if (!notification || notification.isRead) return;

    try {
        await db.collection('tutorNotifications').doc(notificationId).update({
            isRead: true,
            readAt: new Date(),
            updatedAt: new Date()
        });

        // Update local state
        notification.isRead = true;
        this.unreadCount = Math.max(0, this.unreadCount - 1);
        
        // UI will be updated by the calling method for immediate feedback

    } catch (error) {
        console.error('Failed to mark notification as read:', error);
        throw error; // Re-throw to handle in the calling method
    }
}

    // Handle mark all as read
    async handleMarkAllRead() {
        try {
            await this.markAllAsRead();
        } catch (error) {
            console.error('Error marking all as read:', error);
            this.showToast('Failed to mark all notifications as read. Please try again.', 'error');
        }
    }

    // Mark all notifications as read
    async markAllAsRead() {
        const unreadNotifications = this.notifications.filter(n => !n.isRead);
        if (unreadNotifications.length === 0) return;

        try {
            const batch = db.batch();
            const updateTime = new Date();

            unreadNotifications.forEach(notification => {
                const ref = db.collection('tutorNotifications').doc(notification.id);
                batch.update(ref, {
                    isRead: true,
                    readAt: updateTime,
                    updatedAt: updateTime
                });
            });

            await batch.commit();

            // Update local state
            this.notifications.forEach(n => { n.isRead = true; });
            this.unreadCount = 0;
            this.updateUI();

            this.showToast('All notifications marked as read', 'success');

        } catch (error) {
            throw new Error(`Failed to mark all as read: ${error.message}`);
        }
    }

    // Handle clear all
    async handleClearAll() {
        try {
            await this.clearAll();
        } catch (error) {
            console.error('Error clearing all notifications:', error);
            this.showToast('Failed to clear notifications. Please try again.', 'error');
        }
    }

    // Clear all notifications
    async clearAll() {
        if (this.notifications.length === 0) return;

        // Confirm action
        if (!confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
            return;
        }

        try {
            const batch = db.batch();

            this.notifications.forEach(notification => {
                const ref = db.collection('tutorNotifications').doc(notification.id);
                batch.delete(ref);
            });

            await batch.commit();

            // Clear local state
            this.notifications = [];
            this.unreadCount = 0;
            this.updateUI();

            this.showToast('All notifications cleared', 'success');

        } catch (error) {
            throw new Error(`Failed to clear notifications: ${error.message}`);
        }
    }

    // Setup event listeners with proper cleanup
    setupEventListeners() {
        this.removeEventListeners();

        // Notification bell click
        this.notificationBtn = document.getElementById('tutorNotificationBtn');
        if (this.notificationBtn) {
            this.notificationBtn.addEventListener('click', this.handleBellClick);
        }

        // Dropdown buttons
        const markAllReadBtn = document.getElementById('tutorMarkAllReadBtn');
        const clearNotificationsBtn = document.getElementById('tutorClearNotificationsBtn');

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', this.handleMarkAllRead);
        }
        if (clearNotificationsBtn) {
            clearNotificationsBtn.addEventListener('click', this.handleClearAll);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', this.handleOutsideClick);
        
        // Keyboard navigation
        document.addEventListener('keydown', this.handleKeydown);
    }

    // Handle notification bell click
    handleBellClick(e) {
        e.stopPropagation();
        this.toggleDropdown();
    }

    // Toggle dropdown visibility
    toggleDropdown() {
        const dropdown = document.getElementById('tutorNotificationDropdown');
        if (!dropdown) return;

        if (dropdown.classList.contains('visible')) {
            this.hideDropdown();
        } else {
            this.showDropdown();
        }
    }

    // Show dropdown
    showDropdown() {
        const dropdown = document.getElementById('tutorNotificationDropdown');
        if (dropdown) {
            dropdown.classList.remove('hidden');
            dropdown.classList.add('visible');
            dropdown.setAttribute('aria-hidden', 'false');
            
            // Focus management for accessibility
            setTimeout(() => {
                const firstItem = dropdown.querySelector('.notification-item');
                if (firstItem) firstItem.focus();
            }, 100);
        }
    }

    // Hide dropdown
    hideDropdown() {
        const dropdown = document.getElementById('tutorNotificationDropdown');
        if (dropdown) {
            dropdown.classList.remove('visible');
            dropdown.classList.add('hidden');
            dropdown.setAttribute('aria-hidden', 'true');
        }
    }

    // Handle outside clicks
    handleOutsideClick(e) {
        const dropdown = document.getElementById('tutorNotificationDropdown');
        const bell = document.getElementById('tutorNotificationBtn');
        
        if (dropdown && bell && !dropdown.contains(e.target) && !bell.contains(e.target)) {
            this.hideDropdown();
        }
    }

    // Handle keyboard navigation
    handleKeydown(e) {
        if (e.key === 'Escape') {
            this.hideDropdown();
        }
    }

    // Start realtime listener with cleanup
    startRealtimeListener() {
        this.cleanupRealtimeListener();

        try {
            this.realtimeListener = db.collection('tutorNotifications')
                .where('tutorId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot(this.handleRealtimeUpdate, this.handleRealtimeError);
        } catch (error) {
            console.warn('Realtime listener failed to start:', error);
        }
    }

    // Handle realtime updates
    handleRealtimeUpdate(snapshot) {
        snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
                this.handleNewNotification(change.doc);
            } else if (change.type === 'modified') {
                this.handleUpdatedNotification(change.doc);
            } else if (change.type === 'removed') {
                this.handleRemovedNotification(change.doc.id);
            }
        });
    }

    // Handle realtime errors gracefully
    handleRealtimeError(error) {
        console.warn('Realtime listener error (non-critical):', error);
    }

    // Handle new notification
    handleNewNotification(doc) {
        const newNotification = { id: doc.id, ...doc.data() };
        
        // Check for duplicates
        if (this.notifications.find(n => n.id === newNotification.id)) return;

        this.notifications.unshift(newNotification);
        
        if (!newNotification.isRead) {
            this.unreadCount++;
            this.showToastNotification(newNotification);
        }

        this.debouncedUpdate();
    }

    // Handle updated notification
    handleUpdatedNotification(doc) {
        const updatedNotification = { id: doc.id, ...doc.data() };
        const index = this.notifications.findIndex(n => n.id === updatedNotification.id);
        
        if (index !== -1) {
            const wasUnread = !this.notifications[index].isRead;
            const isUnread = !updatedNotification.isRead;
            
            this.notifications[index] = updatedNotification;
            
            if (wasUnread && !isUnread) {
                this.unreadCount = Math.max(0, this.unreadCount - 1);
            } else if (!wasUnread && isUnread) {
                this.unreadCount++;
            }
            
            this.debouncedUpdate();
        }
    }

    // Handle removed notification
    handleRemovedNotification(notificationId) {
        const notification = this.notifications.find(n => n.id === notificationId);
        if (notification && !notification.isRead) {
            this.unreadCount = Math.max(0, this.unreadCount - 1);
        }
        
        this.notifications = this.notifications.filter(n => n.id !== notificationId);
        this.debouncedUpdate();
    }

    // Debounced UI update
    debouncedUpdate() {
        if (this.updateTimeout) {
            clearTimeout(this.updateTimeout);
        }
        this.updateTimeout = setTimeout(() => this.updateUI(), 100);
    }

    // Show toast notification
    showToastNotification(notification) {
        const message = this.generateNotificationMessage(notification);
        this.showToast(message, 'info');
    }

    // Show generic toast
    showToast(message, type = 'info') {
        // Simple console log for now - can be enhanced with proper toast UI
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Utility methods
    generateNotificationMessage(notification) {
        if (notification.message) return notification.message;
        
        // Tutor-specific notification messages
        const messages = {
            session_request: 'You have a new session request from a student.',
            session_confirmed: 'A student has confirmed a session with you.',
            session_cancelled: 'A session has been cancelled by the student.',
            payment_processed: 'Payment for your session has been processed.',
            reschedule_request: 'A student has requested to reschedule a session.',
            invoice_submitted: 'Your invoice has been submitted for processing.',
            student_feedback: 'A student has left feedback on your session.',
            invoice_approved: 'Your invoice has been approved by admin.',
            new_student_assigned: 'A new student has been assigned to you.',
            availability_reminder: 'Remember to update your availability.'
        };
        
        return messages[notification.type] || 'You have a new notification.';
    }

    getTimeAgo(timestamp) {
        if (!timestamp) return 'Recently';
        
        let date;
        try {
            if (timestamp?.toDate && typeof timestamp.toDate === 'function') {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else if (timestamp?.seconds) {
                date = new Date(timestamp.seconds * 1000);
            } else {
                return 'Recently';
            }
            
            if (isNaN(date.getTime())) return 'Recently';
            
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            const diffInHours = Math.floor(diffInMinutes / 60);
            const diffInDays = Math.floor(diffInHours / 24);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            if (diffInHours < 24) return `${diffInHours}h ago`;
            if (diffInDays < 7) return `${diffInDays}d ago`;
            
            return date.toLocaleDateString();
        } catch (error) {
            console.warn('Error parsing timestamp:', error);
            return 'Recently';
        }
    }

    getNotificationIcon(type) {
        const icons = {
            session_request: 'fas fa-calendar-plus',
            session_confirmed: 'fas fa-calendar-check',
            session_cancelled: 'fas fa-calendar-times',
            payment_processed: 'fas fa-dollar-sign',
            reschedule_request: 'fas fa-clock',
            invoice_submitted: 'fas fa-file-invoice',
            student_feedback: 'fas fa-star',
            invoice_approved: 'fas fa-check-circle',
            new_student_assigned: 'fas fa-user-plus',
            availability_reminder: 'fas fa-bell'
        };
        return icons[type] || 'fas fa-bell';
    }

    getNotificationColor(type) {
        const colors = {
            session_request: '#ffc107',
            session_confirmed: '#28a745',
            session_cancelled: '#dc3545',
            payment_processed: '#007bff',
            reschedule_request: '#6f42c1',
            invoice_submitted: '#17a2b8',
            student_feedback: '#fd7e14',
            invoice_approved: '#20c997',
            new_student_assigned: '#e83e8c',
            availability_reminder: '#6c757d'
        };
        return colors[type] || '#6c757d';
    }

    escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Helper methods for UI states
    showLoadingState() {
        const list = document.getElementById('tutorNotificationList');
        if (list) {
            list.innerHTML = `
                <div class="notification-loading">
                    <div class="loading-spinner" aria-label="Loading notifications"></div>
                    <span>Loading notifications...</span>
                </div>
            `;
        }
    }

    getEmptyStateHTML() {
        return `
            <div class="notification-empty">
                <i class="fas fa-bell-slash" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                <h4>No Notifications</h4>
                <p>You're all caught up! New notifications will appear here.</p>
            </div>
        `;
    }

    updateFooter() {
        const footer = document.getElementById('tutorNotificationFooterText');
        if (footer) {
            if (this.notifications.length === 0) {
                footer.textContent = 'No notifications';
            } else {
                footer.textContent = `${this.notifications.length} notification${this.notifications.length !== 1 ? 's' : ''} (${this.unreadCount} unread)`;
            }
        }
    }

    handleLoadError(error) {
        const list = document.getElementById('tutorNotificationList');
        if (list) {
            list.innerHTML = `
                <div class="notification-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Failed to load notifications</p>
                    <button class="btn-retry" onclick="tutorNotificationSystem.initialize()">Retry</button>
                </div>
            `;
        }
        console.error('Notification load error:', error);
    }

    handleInitializationError(error) {
        console.error('Tutor notification system initialization failed:', error);
        // You might want to show a user-friendly error message here
    }

    removeEventListeners() {
        // Clean up existing event listeners
        if (this.notificationBtn) {
            this.notificationBtn.removeEventListener('click', this.handleBellClick);
        }
        
        document.removeEventListener('click', this.handleOutsideClick);
        document.removeEventListener('keydown', this.handleKeydown);
        
        // Clean up notification item handlers
        this.clickHandlers.forEach((handler, item) => {
            item.removeEventListener('click', handler);
            item.removeEventListener('keydown', handler);
        });
        this.clickHandlers.clear();
    }

    cleanupRealtimeListener() {
        if (this.realtimeListener) {
            this.realtimeListener();
            this.realtimeListener = null;
        }
    }

    // Cleanup method for when the tutor logs out
   cleanup() {
        this.cleanupRealtimeListener();
        this.removeEventListeners();
        
        const dropdown = document.getElementById('tutorNotificationDropdown');
        if (dropdown) {
            dropdown.remove();
        }
        
        this.isInitialized = false;
        this.notifications = [];
        this.unreadCount = 0;
    }

    // ✅ CORRECT: This method should be INSIDE the class
    navigateToRelevantSection(notificationType, sessionId) {
        console.log('📱 Navigating to section for notification type:', notificationType, 'sessionId:', sessionId);
        
        try {
            switch (notificationType) {
                case 'session_request':
                case 'session_confirmed':
                case 'session_cancelled':
                case 'reschedule_request':
                    // Navigate to bookings section
                    if (typeof switchSection === 'function') {
                        console.log('📚 Switching to bookings section');
                        switchSection('bookings');
                        // Refresh bookings to show the updated status
                        setTimeout(() => {
                            if (typeof loadMyBookings === 'function') {
                                loadMyBookings();
                            }
                            // If we have a specific session ID, you could scroll to it
                            if (sessionId) {
                                const sessionElement = document.getElementById(`booking-${sessionId}`);
                                if (sessionElement) {
                                    sessionElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    sessionElement.classList.add('highlight-pulse');
                                    setTimeout(() => sessionElement.classList.remove('highlight-pulse'), 2000);
                                }
                            }
                        }, 500);
                    } else {
                        console.warn('switchSection function not available');
                    }
                    break;
                    
                case 'message':
                    // Navigate to chat section
                    if (typeof switchSection === 'function') {
                        console.log('💬 Switching to chat section');
                        switchSection('chat');
                        // The chat system should handle opening the relevant conversation
                    } else {
                        console.warn('switchSection function not available');
                    }
                    break;
                    
                case 'payment_processed':
                case 'invoice_submitted':
                case 'invoice_approved':
                    // Navigate to invoices section
                    if (typeof switchSection === 'function') {
                        console.log('💰 Switching to invoices section');
                        switchSection('invoices');
                    } else {
                        console.warn('switchSection function not available');
                    }
                    break;
                    
                default:
                    console.log('No specific section for notification type:', notificationType);
                    // Default to bookings section
                    if (typeof switchSection === 'function') {
                        switchSection('bookings');
                    }
            }
        } catch (error) {
            console.error('Error during navigation:', error);
            // Fallback to bookings section
            if (typeof switchSection === 'function') {
                switchSection('bookings');
            }
        }
    }
}  // ← This should be the ONLY closing brace for the class
       
// Initialize the tutor notification system when the page loads
let tutorNotificationSystem;

document.addEventListener('DOMContentLoaded', function() {
    tutorNotificationSystem = new TutorNotificationSystem();
    
    // Wait for Firebase auth to be ready
    auth.onAuthStateChanged((user) => {
        if (user && user.uid) {
            tutorNotificationSystem.initialize();
        }
    });
});

// =============================================
// NOTIFICATION CREATION HELPER FUNCTIONS
// =============================================

// Helper function to create tutor notifications
async function createTutorNotification(notificationData) {
    try {
        const notification = {
            tutorId: currentUser.uid,
            ...notificationData,
            isRead: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('tutorNotifications').add(notification);
        console.log('Tutor notification created:', notificationData.type);
    } catch (error) {
        console.error('Error creating tutor notification:', error);
    }
}

// Specific notification creators for different tutor events
async function notifyTutorSessionRequest(sessionId, studentName, subject) {
    await createTutorNotification({
        type: 'session_request',
        title: 'New Session Request',
        message: `${studentName} requested a ${subject} session`,
        relatedSessionId: sessionId,
        priority: 'high'
    });
}

async function notifyTutorSessionConfirmed(sessionId, studentName, subject) {
    await createTutorNotification({
        type: 'session_confirmed',
        title: 'Session Confirmed',
        message: `${studentName} confirmed the ${subject} session`,
        relatedSessionId: sessionId,
        priority: 'medium'
    });
}

async function notifyTutorPaymentProcessed(sessionId, amount, studentName) {
    await createTutorNotification({
        type: 'payment_processed',
        title: 'Payment Received',
        message: `$${amount} payment processed for session with ${studentName}`,
        relatedSessionId: sessionId,
        priority: 'high'
    });
}

async function notifyTutorInvoiceApproved(invoiceId, amount) {
    await createTutorNotification({
        type: 'invoice_approved',
        title: 'Invoice Approved',
        message: `Your invoice for $${amount} has been approved`,
        relatedSessionId: invoiceId,
        priority: 'medium'
    });
}

// Inject the CSS
const mobileStyle = document.createElement('style');
mobileStyle.textContent = mobileSessionsCSS;
document.head.appendChild(mobileStyle);
       
// =============================================
// NOTIFICATION BELL FUNCTIONALITY ENDS HERE
// =============================================

//----------------------------------------------------------------------------------------
//TUTOR CHAT SYSTEM STARTS HERE
//----------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------
//TUTOR CHAT SYSTEM STARTS HERE
//----------------------------------------------------------------------------------------
// =============================================
// TUTOR CHAT SYSTEM - WITH ADMIN SUPPORT
// =============================================

// Global chat variables with initialization tracking - SAME AS STUDENT
let currentChat = null;
let chatMessagesListener = null;
let contactsListener = null;
let typingTimeout = null;
let chatSystemInitialized = false;
let chatListenersActive = false;

// Initialize chat system - SAME PATTERN AS STUDENT
function initTutorChatSystem() {
    if (chatSystemInitialized) {
        console.log('Tutor chat system already initialized');
        return;
    }
    
    console.log('Initializing tutor chat system...');
    chatSystemInitialized = true;
    
    setupTutorChatEventListeners();
    loadTutorChatContacts();
    setupTutorRealtimeListeners();
}

// Setup chat event listeners - SIMILAR TO STUDENT
function setupTutorChatEventListeners() {
    // Send message on button click
    const sendBtn = document.getElementById('sendMessageBtn');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendTutorMessage);
    }
    
    // Send message on Enter key (but allow Shift+Enter for new line)
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTutorMessage();
            }
        });
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Contact search
    const contactSearch = document.getElementById('contactSearch');
    if (contactSearch) {
        contactSearch.addEventListener('input', function(e) {
            filterTutorContacts(e.target.value);
        });
    }
}

// Load chat contacts - WITH ADMIN SUPPORT
function loadTutorChatContacts() {
    const contactsList = document.getElementById('contactsList');
    if (!contactsList) return;
    
    // Clean up previous listener
    if (contactsListener) {
        contactsListener();
    }
    
    contactsList.innerHTML = '<div class="loading-state">Loading conversations...</div>';

    // Create permanent admin support contact for tutors
    const createAdminContact = () => {
        const adminContact = document.createElement('div');
        adminContact.className = 'contact-item admin-contact';
        adminContact.setAttribute('data-contact-id', 'admin');
        adminContact.setAttribute('data-student-id', 'admin');
        adminContact.innerHTML = `
            <div class="contact-avatar" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                <i class="fas fa-headset"></i>
            </div>
            <div class="contact-info">
                <div class="contact-name">TKLesson Support</div>
                <div class="contact-subject">Admin & Technical Support</div>
                <div class="contact-status">
                    <div class="status-online"></div>
                    <div class="last-message">Available for tutor support</div>
                </div>
            </div>
            <div class="contact-status">
                <div class="status-badge admin-badge">Support</div>
            </div>
        `;
        
        adminContact.addEventListener('click', () => {
            // Create admin contact object for openTutorChat function
            const adminContactInfo = {
                chatId: `support_tutor_${currentUser.uid}`,
                studentId: 'admin',
                studentName: 'TKLesson Support',
                studentAvatar: null,
                lastMessage: 'Click to start conversation',
                lastMessageAt: new Date(),
                unreadCount: 0,
                subject: 'Admin & Technical Support',
                isAdmin: true
            };
            openTutorChat(adminContactInfo);
        });
        
        // Add admin contact to the top of the list permanently
        if (contactsList.firstChild && contactsList.firstChild.className !== 'loading-state') {
            contactsList.insertBefore(adminContact, contactsList.firstChild);
        } else {
            contactsList.appendChild(adminContact);
        }
    };

    const tutorId = currentUser.uid;
    
    contactsListener = db.collection('chats')
        .where('participants', 'array-contains', tutorId)
        .orderBy('lastMessageAt', 'desc')
        .onSnapshot(async (snapshot) => {
            contactsList.innerHTML = '';
            
            // Always add admin contact first
            createAdminContact();
            
            if (snapshot.empty) {
                contactsList.innerHTML += `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h4>No Student Conversations</h4>
                        <p>Your conversations with students will appear here</p>
                    </div>
                `;
                updateTutorUnreadMessagesCount(0);
                return;
            }
            
            const contacts = [];
            let totalUnread = 0;
            
            for (const doc of snapshot.docs) {
                const chat = doc.data();
                const studentId = chat.participants.find(id => id !== tutorId);
                
                // Skip admin chats in the main list (they're handled separately)
                if (studentId === 'admin') continue;
                
                if (studentId) {
                    try {
                        // Get student details
                        const studentDoc = await db.collection('students').doc(studentId).get();
                        if (studentDoc.exists) {
                            const student = studentDoc.data();
                            const unreadCount = chat.unreadCounts?.[tutorId] || 0;
                            totalUnread += unreadCount;
                            
                            const contact = {
                                chatId: doc.id,
                                studentId: studentId,
                                studentName: student.fullName || 'Student',
                                studentAvatar: student.photoURL,
                                lastMessage: chat.lastMessage,
                                lastMessageAt: chat.lastMessageAt,
                                unreadCount: unreadCount,
                                subject: chat.subject || 'General',
                                isAdmin: false
                            };
                            contacts.push(contact);
                            
                            const contactElement = createTutorContactElement(contact);
                            contactsList.appendChild(contactElement);
                        }
                    } catch (error) {
                        console.error('Error loading student details:', error);
                    }
                }
            }
            
            updateTutorUnreadMessagesCount(totalUnread);
        }, (error) => {
            console.error('Error loading contacts:', error);
            contactsList.innerHTML = '<div class="error-state">Error loading conversations</div>';
        });
}

// Create contact element - SIMILAR TO STUDENT
function createTutorContactElement(contact) {
    const contactDiv = document.createElement('div');
    contactDiv.className = `contact-item ${currentChat?.studentId === contact.studentId ? 'active' : ''}`;
    contactDiv.setAttribute('data-student-id', contact.studentId);
    contactDiv.setAttribute('data-chat-id', contact.chatId);
    
    const lastMessageTime = contact.lastMessageAt ? formatMessageTime(contact.lastMessageAt.toDate()) : '';
    const unreadBadge = contact.unreadCount > 0 ? 
        `<div class="unread-count">${contact.unreadCount}</div>` : '';
    
    contactDiv.innerHTML = `
        <div class="contact-avatar">
            ${contact.studentAvatar ? 
                `<img src="${contact.studentAvatar}" alt="${contact.studentName}">` : 
                `<i class="fas fa-user-graduate"></i>`
            }
        </div>
        <div class="contact-info">
            <div class="contact-name">${contact.studentName}</div>
            <div class="contact-subject">${contact.subject}</div>
            <div class="last-message">${contact.lastMessage || 'No messages yet'}</div>
        </div>
        <div class="contact-status">
            <div class="status-online"></div>
            ${unreadBadge}
            <div class="last-message-time">${lastMessageTime}</div>
        </div>
    `;
    
    contactDiv.addEventListener('click', () => openTutorChat(contact));
    
    return contactDiv;
}

// Open chat with student - ENHANCED FOR ADMIN SUPPORT
async function openTutorChat(contact) {
    try {
        currentChat = contact;
        
        // Update UI to show chat is active
        document.querySelectorAll('.contact-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Update active contact in list - handle both student and admin contacts
        const activeContact = document.querySelector(`[data-student-id="${contact.studentId}"]`);
        if (activeContact) {
            activeContact.classList.add('active');
        }
        
        // Show chat interface
        document.getElementById('emptyChatState').style.display = 'none';
        document.getElementById('chatHeader').style.display = 'flex';
        document.getElementById('messagesContainer').style.display = 'flex';
        document.getElementById('messageInputContainer').style.display = 'block';
        
        // Update header based on contact type
        document.getElementById('currentContactName').textContent = contact.studentName;
        document.getElementById('currentContactSubject').textContent = contact.subject;
        
        // Update avatar and UI based on contact type
        const avatar = document.querySelector('#chatHeader .contact-avatar');
        const chatActions = document.querySelector('.chat-actions');
        
        if (contact.isAdmin) {
            // Admin chat styling
            avatar.innerHTML = '<i class="fas fa-headset"></i>';
            avatar.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
            
            // Hide any tutor-specific actions for admin
            if (chatActions) {
                chatActions.style.display = 'none';
            }
            
            // Add admin-specific quick messages for tutors
            setupTutorAdminQuickMessages();
            
            // For admin chats, check if chat exists and show welcome if not
            await handleTutorAdminChatWelcome(contact.chatId);
        } else {
            // Student chat styling
            avatar.innerHTML = contact.studentAvatar ? 
                `<img src="${contact.studentAvatar}" alt="${contact.studentName}">` : 
                '<i class="fas fa-user-graduate"></i>';
            avatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            
            // Show tutor-specific actions for students
            if (chatActions) {
                chatActions.style.display = 'flex';
            }
            
            // Setup student-specific quick messages
            setupTutorStudentQuickMessages();
            
            // Load messages normally for students
            loadTutorChatMessages(contact.chatId);
        }
        
        // Mark as read if it's a real chat (not admin placeholder)
        if (contact.chatId && !contact.isAdmin) {
            await markTutorChatAsRead(contact.chatId);
        }
        
    } catch (error) {
        console.error('Error opening chat:', error);
    }
}

// Handle admin chat welcome message for tutors
async function handleTutorAdminChatWelcome(chatId) {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return;
    
    // Check if admin chat exists
    const adminChatRef = db.collection('chats').doc(chatId);
    const chatDoc = await adminChatRef.get();
    
    if (!chatDoc.exists) {
        // No admin chat exists yet - show welcome message for tutors
        messagesContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-headset" style="font-size: 3rem; color: #ff6b6b; margin-bottom: 1rem;"></i>
                <h4>Welcome to TKLesson Support!</h4>
                <p>We're here to help you with any tutor-related questions or technical issues.</p>
                <p><strong>How can we assist you today?</strong></p>
                <div class="quick-messages" style="margin-top: 1rem;">
                    <div class="quick-message" onclick="insertQuickMessage('Hello, I need help with my tutor account')">Account help</div>
                    <div class="quick-message" onclick="insertQuickMessage('I have questions about payments or scheduling')">Payment/Scheduling</div>
                    <div class="quick-message" onclick="insertQuickMessage('I need technical support with the platform')">Technical support</div>
                    <div class="quick-message" onclick="insertQuickMessage('I have a question about student management')">Student questions</div>
                </div>
            </div>
        `;
    } else {
        // Admin chat exists - load messages normally
        loadTutorChatMessages(chatId);
    }
}

// Load chat messages - SAME AS BEFORE (no changes needed)
function loadTutorChatMessages(chatId) {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return;
    
    messagesContainer.innerHTML = '<div class="loading-state">Loading messages...</div>';
    
    // Clean up previous listener
    if (chatMessagesListener) {
        chatMessagesListener();
    }
    
    chatMessagesListener = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot((snapshot) => {
            if (snapshot.empty) {
                messagesContainer.innerHTML = '<div class="empty-state">No messages yet. Start the conversation!</div>';
                return;
            }
            
            messagesContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const message = doc.data();
                const messageElement = createTutorMessageElement(message);
                messagesContainer.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
}

// Create message element - SAME AS BEFORE (no changes needed)
function createTutorMessageElement(message) {
    const messageDiv = document.createElement('div');
    const isSent = message.senderId === currentUser.uid;
    
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    messageDiv.innerHTML = `
        <div class="message-text">${message.text}</div>
        <div class="message-time">${formatMessageTime(message.timestamp?.toDate())}</div>
    `;
    
    return messageDiv;
}

// Send message - ENHANCED FOR ADMIN SUPPORT
async function sendTutorMessage() {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    const text = messageInput.value.trim();
    
    if (!text || !currentChat) return;
    
    try {
        const tutorId = currentUser.uid;
        const tutorName = userData?.fullName || 'Tutor';
        
        // Check if this is an admin chat
        const isAdminChat = currentChat.isAdmin;
        
        let chatId;
        let receiverId;
        
        if (isAdminChat) {
            // Admin chat - use consistent naming for tutors
            chatId = `support_tutor_${tutorId}`;
            receiverId = 'admin';
        } else {
            // Student chat - use existing logic
            chatId = currentChat.chatId;
            receiverId = currentChat.studentId;
        }
        
        const messageData = {
            text: text,
            senderId: tutorId,
            senderName: tutorName,
            timestamp: new Date(),
            read: false,
            type: 'text'
        };
        
        // Get chat reference
        const chatRef = db.collection('chats').doc(chatId);
        const chatDoc = await chatRef.get();
        
        // Create chat if it doesn't exist
        if (!chatDoc.exists) {
            let chatData = {
                participants: [tutorId, receiverId],
                participantNames: {
                    [tutorId]: tutorName,
                    [receiverId]: isAdminChat ? 'TKLesson Support' : 'Student'
                },
                status: 'active',
                lastMessage: text,
                lastMessageAt: new Date(),
                lastMessageBy: tutorId,
                unreadCounts: {
                    [tutorId]: 0,
                    [receiverId]: 1
                },
                createdAt: new Date(),
                lastUpdated: new Date()
            };
            
            // Add admin-specific fields
            if (isAdminChat) {
                chatData.chatType = 'support_tutor';
                chatData.subject = 'Tutor Support';
                chatData.isAdminChat = true;
                chatData.tutorId = tutorId;
                chatData.tutorName = tutorName;
            } else {
                chatData.chatType = 'tutor_session';
                chatData.subject = currentChat.subject || 'Tutoring Session';
            }
            
            await chatRef.set(chatData);
        } else {
            // Update existing chat
            const updateData = {
                lastMessage: text,
                lastMessageAt: new Date(),
                lastMessageBy: tutorId,
                lastUpdated: new Date()
            };
            
            // Only increment unread count for the receiver
            if (chatDoc.data().lastMessageBy !== tutorId) {
                updateData[`unreadCounts.${receiverId}`] = firebase.firestore.FieldValue.increment(1);
            }
            
            await chatRef.update(updateData);
        }
        
        // Add message to messages subcollection
        await chatRef.collection('messages').add(messageData);
        
        // Clear input
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Reload messages to show the new message
        loadTutorChatMessages(chatId);
        
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    }
}

// Quick message functions for tutors
function setupTutorAdminQuickMessages() {
    const quickMessagesContainer = document.getElementById('quickMessages');
    if (!quickMessagesContainer) return;
    
    quickMessagesContainer.innerHTML = `
        <div class="quick-message" onclick="insertQuickMessage('Hello, I need help with my tutor account settings')">Account help</div>
        <div class="quick-message" onclick="insertQuickMessage('I have questions about payment processing')">Payment questions</div>
        <div class="quick-message" onclick="insertQuickMessage('I need technical support with the tutor dashboard')">Technical support</div>
        <div class="quick-message" onclick="insertQuickMessage('I have a question about student management or scheduling')">Student management</div>
    `;
    quickMessagesContainer.style.display = 'flex';
}

function setupTutorStudentQuickMessages() {
    const quickMessagesContainer = document.getElementById('quickMessages');
    if (!quickMessagesContainer) return;
    
    quickMessagesContainer.innerHTML = `
        <div class="quick-message" onclick="insertQuickMessage('Hello, I wanted to discuss our upcoming session')">Discuss session</div>
        <div class="quick-message" onclick="insertQuickMessage('Can we reschedule our lesson?')">Reschedule request</div>
        <div class="quick-message" onclick="insertQuickMessage('I have some materials to share for our next session')">Share materials</div>
        <div class="quick-message" onclick="insertQuickMessage('Thank you for the great session!')">Say thanks</div>
    `;
    quickMessagesContainer.style.display = 'flex';
}

// Mark chat as read - SAME AS BEFORE (no changes needed)
async function markTutorChatAsRead(chatId) {
    try {
        await db.collection('chats')
            .doc(chatId)
            .update({
                [`unreadCounts.${currentUser.uid}`]: 0
            });
            
        // Update unread counts
        updateTutorUnreadMessagesCount();
    } catch (error) {
        console.error('Error marking chat as read:', error);
    }
}

// Filter contacts - SAME AS BEFORE (no changes needed)
function filterTutorContacts(searchTerm) {
    const contactItems = document.querySelectorAll('.contact-item');
    contactItems.forEach(item => {
        const studentName = item.querySelector('.contact-name').textContent.toLowerCase();
        const studentSubject = item.querySelector('.contact-subject').textContent.toLowerCase();
        const searchLower = searchTerm.toLowerCase();
        
        if (studentName.includes(searchLower) || studentSubject.includes(searchLower)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

// Update unread messages count in menu - SAME AS BEFORE (no changes needed)
function updateTutorUnreadMessagesCount(count) {
    const unreadBadge = document.getElementById('unreadMessagesCount');
    if (unreadBadge) {
        if (count > 0) {
            unreadBadge.textContent = count > 99 ? '99+' : count.toString();
            unreadBadge.style.display = 'inline';
        } else {
            unreadBadge.style.display = 'none';
        }
    }
}

// Setup realtime listeners - SAME AS BEFORE (no changes needed)
function setupTutorRealtimeListeners() {
    console.log('Setting up realtime tutor chat listeners...');
    chatListenersActive = true;
}

// Clean up chat system properly - SAME AS BEFORE (no changes needed)
function cleanupTutorChatSystem() {
    if (contactsListener) {
        contactsListener();
        contactsListener = null;
    }
    
    if (chatMessagesListener) {
        chatMessagesListener();
        chatMessagesListener = null;
    }
    
    currentChat = null;
    chatSystemInitialized = false;
    chatListenersActive = false;
    
    console.log('Tutor chat system cleaned up');
}

// Format message time - SAME AS BEFORE (no changes needed)
function formatMessageTime(date) {
    if (!date) return '';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    
    return date.toLocaleDateString();
}

// Quick message function - SAME AS BEFORE (no changes needed)
function insertQuickMessage(text) {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.value = text;
        messageInput.focus();
    }
}

// Initialize chat system when dashboard loads - SAME AS BEFORE (no changes needed)
function initializeTutorChatOnAuth() {
    if (currentUser) {
        setTimeout(() => {
            initTutorChatSystem();
        }, 2000);
    }
}

// Add chat initialization to your existing auth state listener
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        // ... your existing code ...
        
        // Initialize tutor chat system
        initializeTutorChatOnAuth();
    } else {
        // Clean up when user logs out
        cleanupTutorChatSystem();
    }
});

// Also initialize when switching to chat section
document.addEventListener('DOMContentLoaded', function() {
    const chatMenuItem = document.querySelector('[data-section="chat"]');
    if (chatMenuItem) {
        chatMenuItem.addEventListener('click', function() {
            if (!chatSystemInitialized) {
                setTimeout(() => {
                    initTutorChatSystem();
                }, 100);
            }
        });
    }
});

// =======================================================
// ENHANCED TUTOR UNREAD MESSAGE TRACKING - ADD THIS SECTION
// =======================================================

// Global variables for enhanced tutor unread tracking
let tutorUnreadMessagesCount = 0;
let tutorChatUnreadCounts = {}; // { chatId: unreadCount }
let tutorUnreadListener = null;

// Enhanced loadTutorChatContacts with better unread tracking
function loadTutorChatContacts() {
    const contactsList = document.getElementById('contactsList');
    if (!contactsList) return;
    
    // Clean up previous listener
    if (contactsListener) {
        contactsListener();
    }
    
    contactsList.innerHTML = '<div class="loading-state">Loading conversations...</div>';

    // Create permanent admin support contact for tutors
    const createAdminContact = () => {
        const adminContact = document.createElement('div');
        adminContact.className = 'contact-item admin-contact';
        adminContact.setAttribute('data-contact-id', 'admin');
        adminContact.setAttribute('data-student-id', 'admin');
        
        const adminUnreadCount = tutorChatUnreadCounts[`support_tutor_${currentUser.uid}`] || 0;
        const unreadBadge = adminUnreadCount > 0 ? 
            `<div class="unread-count">${adminUnreadCount > 99 ? '99+' : adminUnreadCount}</div>` : '';
        
        adminContact.innerHTML = `
            <div class="contact-avatar" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                <i class="fas fa-headset"></i>
            </div>
            <div class="contact-info">
                <div class="contact-name">TKLesson Support</div>
                <div class="contact-subject">Admin & Technical Support</div>
                <div class="contact-status">
                    <div class="status-online"></div>
                    <div class="last-message">Available for tutor support</div>
                </div>
            </div>
            <div class="contact-status">
                <div class="status-badge admin-badge">Support</div>
                ${unreadBadge}
            </div>
        `;
        
        adminContact.addEventListener('click', () => {
            const adminContactInfo = {
                chatId: `support_tutor_${currentUser.uid}`,
                studentId: 'admin',
                studentName: 'TKLesson Support',
                studentAvatar: null,
                lastMessage: 'Click to start conversation',
                lastMessageAt: new Date(),
                unreadCount: tutorChatUnreadCounts[`support_tutor_${currentUser.uid}`] || 0,
                subject: 'Admin & Technical Support',
                isAdmin: true
            };
            openTutorChat(adminContactInfo);
        });
        
        if (contactsList.firstChild && contactsList.firstChild.className !== 'loading-state') {
            contactsList.insertBefore(adminContact, contactsList.firstChild);
        } else {
            contactsList.appendChild(adminContact);
        }
    };

    const tutorId = currentUser.uid;
    
    contactsListener = db.collection('chats')
        .where('participants', 'array-contains', tutorId)
        .orderBy('lastMessageAt', 'desc')
        .onSnapshot(async (snapshot) => {
            contactsList.innerHTML = '';
            
            // Always add admin contact first
            createAdminContact();
            
            if (snapshot.empty) {
                contactsList.innerHTML += `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h4>No Student Conversations</h4>
                        <p>Your conversations with students will appear here</p>
                    </div>
                `;
                updateTutorUnreadMessagesCount(0);
                return;
            }
            
            const contacts = [];
            let totalUnread = 0;
            tutorChatUnreadCounts = {}; // Reset unread counts
            
            for (const doc of snapshot.docs) {
                const chat = doc.data();
                const studentId = chat.participants.find(id => id !== tutorId);
                
                // Skip admin chats in the main list (they're handled separately)
                if (studentId === 'admin') continue;
                
                if (studentId) {
                    try {
                        // Get student details
                        const studentDoc = await db.collection('students').doc(studentId).get();
                        if (studentDoc.exists) {
                            const student = studentDoc.data();
                            const unreadCount = chat.unreadCounts?.[tutorId] || 0;
                            
                            // Store individual chat unread count
                            tutorChatUnreadCounts[doc.id] = unreadCount;
                            totalUnread += unreadCount;
                            
                            const contact = {
                                chatId: doc.id,
                                studentId: studentId,
                                studentName: student.fullName || 'Student',
                                studentAvatar: student.photoURL,
                                lastMessage: chat.lastMessage,
                                lastMessageAt: chat.lastMessageAt,
                                unreadCount: unreadCount,
                                subject: chat.subject || 'General',
                                isAdmin: false
                            };
                            contacts.push(contact);
                            
                            const contactElement = createTutorContactElement(contact);
                            contactsList.appendChild(contactElement);
                        }
                    } catch (error) {
                        console.error('Error loading student details:', error);
                    }
                }
            }
            
            // Also check admin chat for unread messages
            await checkTutorAdminChatUnreadCount(tutorId, totalUnread);
            
        }, (error) => {
            console.error('Error loading contacts:', error);
            contactsList.innerHTML = '<div class="error-state">Error loading conversations</div>';
        });
}

// Check admin chat for unread messages
async function checkTutorAdminChatUnreadCount(tutorId, currentTotalUnread) {
    try {
        const adminChatId = `support_tutor_${tutorId}`;
        const adminChatDoc = await db.collection('chats').doc(adminChatId).get();
        
        if (adminChatDoc.exists) {
            const adminChat = adminChatDoc.data();
            const adminUnreadCount = adminChat.unreadCounts?.[tutorId] || 0;
            
            // Store admin chat unread count
            tutorChatUnreadCounts[adminChatId] = adminUnreadCount;
            
            // Update total (admin unread count wasn't included in the main loop)
            const totalUnread = currentTotalUnread + adminUnreadCount;
            tutorUnreadMessagesCount = totalUnread;
            
            updateTutorUnreadMessagesCount(totalUnread);
            
            // Update admin contact badge if it exists
            updateTutorAdminContactBadge(adminUnreadCount);
        } else {
            // No admin chat exists yet
            tutorUnreadMessagesCount = currentTotalUnread;
            updateTutorUnreadMessagesCount(currentTotalUnread);
        }
    } catch (error) {
        console.error('Error checking admin chat unread count:', error);
        tutorUnreadMessagesCount = currentTotalUnread;
        updateTutorUnreadMessagesCount(currentTotalUnread);
    }
}

// Update admin contact badge for tutors
function updateTutorAdminContactBadge(unreadCount) {
    const adminContact = document.querySelector('.admin-contact');
    if (!adminContact) return;
    
    // Remove existing unread badge
    const existingBadge = adminContact.querySelector('.unread-count');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    // Add new unread badge if there are unread messages
    if (unreadCount > 0) {
        const contactStatus = adminContact.querySelector('.contact-status');
        if (contactStatus) {
            const unreadBadge = document.createElement('div');
            unreadBadge.className = 'unread-count';
            unreadBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            contactStatus.appendChild(unreadBadge);
        }
    }
}

// Enhanced createTutorContactElement with better unread display
function createTutorContactElement(contact) {
    const contactDiv = document.createElement('div');
    contactDiv.className = `contact-item ${currentChat?.studentId === contact.studentId ? 'active' : ''}`;
    contactDiv.setAttribute('data-student-id', contact.studentId);
    contactDiv.setAttribute('data-chat-id', contact.chatId);
    
    const lastMessageTime = contact.lastMessageAt ? formatMessageTime(contact.lastMessageAt.toDate()) : '';
    const unreadBadge = contact.unreadCount > 0 ? 
        `<div class="unread-count">${contact.unreadCount > 99 ? '99+' : contact.unreadCount}</div>` : '';
    
    contactDiv.innerHTML = `
        <div class="contact-avatar">
            ${contact.studentAvatar ? 
                `<img src="${contact.studentAvatar}" alt="${contact.studentName}">` : 
                `<i class="fas fa-user-graduate"></i>`
            }
        </div>
        <div class="contact-info">
            <div class="contact-name">${contact.studentName}</div>
            <div class="contact-subject">${contact.subject}</div>
            <div class="last-message">${contact.lastMessage || 'No messages yet'}</div>
        </div>
        <div class="contact-status">
            <div class="status-online"></div>
            ${unreadBadge}
            <div class="last-message-time">${lastMessageTime}</div>
        </div>
    `;
    
    contactDiv.addEventListener('click', () => openTutorChat(contact));
    
    return contactDiv;
}

// Enhanced openTutorChat with immediate unread count reset
async function openTutorChat(contact) {
    try {
        currentChat = contact;
        
        // Update UI to show chat is active
        document.querySelectorAll('.contact-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const activeContact = document.querySelector(`[data-student-id="${contact.studentId}"]`);
        if (activeContact) {
            activeContact.classList.add('active');
        }
        
        // Show chat interface
        document.getElementById('emptyChatState').style.display = 'none';
        document.getElementById('chatHeader').style.display = 'flex';
        document.getElementById('messagesContainer').style.display = 'flex';
        document.getElementById('messageInputContainer').style.display = 'block';
        
        // Update header
        document.getElementById('currentContactName').textContent = contact.studentName;
        document.getElementById('currentContactSubject').textContent = contact.subject;
        
        // Update avatar and UI
        const avatar = document.querySelector('#chatHeader .contact-avatar');
        const chatActions = document.querySelector('.chat-actions');
        
        if (contact.isAdmin) {
            avatar.innerHTML = '<i class="fas fa-headset"></i>';
            avatar.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
            
            if (chatActions) {
                chatActions.style.display = 'none';
            }
            
            setupTutorAdminQuickMessages();
            await handleTutorAdminChatWelcome(contact.chatId);
        } else {
            avatar.innerHTML = contact.studentAvatar ? 
                `<img src="${contact.studentAvatar}" alt="${contact.studentName}">` : 
                '<i class="fas fa-user-graduate"></i>';
            avatar.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            
            if (chatActions) {
                chatActions.style.display = 'flex';
            }
            
            setupTutorStudentQuickMessages();
            loadTutorChatMessages(contact.chatId);
        }
        
        // Immediately mark as read and update counts
        if (contact.chatId) {
            await markTutorChatAsRead(contact.chatId);
            updateTutorContactUnreadCount(contact.chatId, 0);
        }
        
    } catch (error) {
        console.error('Error opening chat:', error);
    }
}

// Enhanced markTutorChatAsRead with better count management
async function markTutorChatAsRead(chatId) {
    try {
        const tutorId = currentUser.uid;
        
        // Update in Firestore
        await db.collection('chats')
            .doc(chatId)
            .update({
                [`unreadCounts.${tutorId}`]: 0
            });
        
        // Update local state immediately
        const oldUnreadCount = tutorChatUnreadCounts[chatId] || 0;
        tutorChatUnreadCounts[chatId] = 0;
        
        // Update total unread count
        tutorUnreadMessagesCount = Math.max(0, tutorUnreadMessagesCount - oldUnreadCount);
        updateTutorUnreadMessagesCount(tutorUnreadMessagesCount);
        
        // Update contact badge in UI
        updateTutorContactBadge(chatId, 0);
        
    } catch (error) {
        console.error('Error marking chat as read:', error);
    }
}

// Update individual tutor contact badge
function updateTutorContactBadge(chatId, unreadCount) {
    // Update in contacts list
    const contactElement = document.querySelector(`[data-chat-id="${chatId}"]`);
    if (contactElement) {
        const existingBadge = contactElement.querySelector('.unread-count');
        if (existingBadge) {
            if (unreadCount > 0) {
                existingBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
            } else {
                existingBadge.remove();
            }
        } else if (unreadCount > 0) {
            const contactStatus = contactElement.querySelector('.contact-status');
            if (contactStatus) {
                const unreadBadge = document.createElement('div');
                unreadBadge.className = 'unread-count';
                unreadBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                contactStatus.appendChild(unreadBadge);
            }
        }
    }
    
    // Special handling for admin contact
    if (chatId.startsWith('support_tutor_')) {
        updateTutorAdminContactBadge(unreadCount);
    }
}

// Update tutor contact unread count in local state
function updateTutorContactUnreadCount(chatId, unreadCount) {
    const oldCount = tutorChatUnreadCounts[chatId] || 0;
    tutorChatUnreadCounts[chatId] = unreadCount;
    
    // Update total count
    tutorUnreadMessagesCount = tutorUnreadMessagesCount - oldCount + unreadCount;
    updateTutorUnreadMessagesCount(tutorUnreadMessagesCount);
    
    // Update UI
    updateTutorContactBadge(chatId, unreadCount);
}

// Enhanced updateTutorUnreadMessagesCount for sidebar badge
function updateTutorUnreadMessagesCount(count) {
    const unreadBadge = document.getElementById('unreadMessagesCount');
    if (unreadBadge) {
        if (count > 0) {
            unreadBadge.textContent = count > 99 ? '99+' : count.toString();
            unreadBadge.style.display = 'inline';
            
            // Add pulse animation for new messages
            unreadBadge.style.animation = 'none';
            setTimeout(() => {
                unreadBadge.style.animation = 'pulse 1s ease-in-out';
            }, 10);
        } else {
            unreadBadge.style.display = 'none';
        }
    }
    
    // Also update the menu item text if needed
    updateTutorChatMenuItemCount(count);
}

// Update tutor chat menu item with count
function updateTutorChatMenuItemCount(count) {
    const chatMenuItem = document.querySelector('a[data-section="chat"]');
    if (chatMenuItem) {
        const menuText = chatMenuItem.querySelector('span');
        if (menuText) {
            // Remove existing count from text
            const baseText = menuText.textContent.replace(/\(\d+\)\s*/, '');
            if (count > 0) {
                menuText.textContent = `${baseText} (${count})`;
            } else {
                menuText.textContent = baseText;
            }
        }
    }
}

// View student schedule
async function viewStudentSchedule() {
    try {
        console.log('View Student Schedule clicked');
        
        // Get the student ID from the current context (you may need to pass this)
        // For now, we'll show a modal to select a student
        const modalContent = `
            <h3>View Student Schedule</h3>
            <p>Select a student to view their upcoming schedule:</p>
            
            <div class="form-group">
                <label for="studentSelect">Select Student:</label>
                <select id="studentSelect" class="form-control">
                    <option value="">Choose a student...</option>
                </select>
            </div>
            
            <div id="studentScheduleContainer" style="margin-top: 20px; display: none;">
                <h4>Upcoming Sessions</h4>
                <div id="studentSessionsList"></div>
            </div>
        `;
        
        showStudentScheduleModal(modalContent);
        
        // Populate student dropdown with your recent students
        await populateStudentDropdown();
        
    } catch (error) {
        console.error("Error in viewStudentSchedule:", error);
        alert('Error loading student schedule. Please try again.');
    }
}

// Populate student dropdown with tutor's students
async function populateStudentDropdown() {
    try {
        const studentSelect = document.getElementById('studentSelect');
        if (!studentSelect) return;
        
        // Get unique student IDs from your bookings
        const uniqueStudentIds = [...new Set(allBookings.map(booking => booking.studentId))];
        
        if (uniqueStudentIds.length === 0) {
            studentSelect.innerHTML = '<option value="">No students found in your bookings</option>';
            return;
        }
        
        // Clear existing options except the first one
        studentSelect.innerHTML = '<option value="">Choose a student...</option>';
        
        // Fetch student details and populate dropdown
        for (const studentId of uniqueStudentIds) {
            try {
                const studentDoc = await db.collection('students').doc(studentId).get();
                if (studentDoc.exists) {
                    const student = studentDoc.data();
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = `${student.fullName || 'Unknown Student'} (${student.email || 'No email'})`;
                    studentSelect.appendChild(option);
                }
            } catch (error) {
                console.error(`Error fetching student ${studentId}:`, error);
            }
        }
        
        // Add event listener for student selection
        studentSelect.addEventListener('change', function() {
            const studentId = this.value;
            if (studentId) {
                loadStudentSchedule(studentId);
            } else {
                document.getElementById('studentScheduleContainer').style.display = 'none';
            }
        });
        
    } catch (error) {
        console.error("Error populating student dropdown:", error);
    }
}

// Load and display student's schedule
async function loadStudentSchedule(studentId) {
    try {
        const container = document.getElementById('studentScheduleContainer');
        const sessionsList = document.getElementById('studentSessionsList');
        
        if (!container || !sessionsList) return;
        
        sessionsList.innerHTML = '<div class="spinner">Loading student schedule...</div>';
        container.style.display = 'block';
        
        // Get student's upcoming sessions
        const now = new Date();
        const sessionsSnapshot = await db.collection('bookedSessions')
            .where('studentId', '==', studentId)
            .where('date', '>=', now)
            .where('status', 'in', ['confirmed', 'rescheduled', 'pending'])
            .orderBy('date', 'asc')
            .get();
        
        if (sessionsSnapshot.empty) {
            sessionsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h4>No Upcoming Sessions</h4>
                    <p>This student has no upcoming scheduled sessions.</p>
                </div>
            `;
            return;
        }
        
        let sessionsHTML = '<div class="student-sessions-list">';
        
        sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            const date = session.date.toDate();
            const formattedDate = date.toLocaleDateString();
            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            sessionsHTML += `
                <div class="student-session-item">
                    <div class="session-date-time">
                        <strong>${formattedDate}</strong> at ${formattedTime}
                    </div>
                    <div class="session-details">
                        <span class="subject">${session.subject || 'General Tutoring'}</span>
                        <span class="duration">${session.duration || '1.5'} hours</span>
                        <span class="status status-${getStatusClass(session.status)}">${session.status.toUpperCase()}</span>
                    </div>
                    <div class="session-tutor">
                        with ${session.tutorName || 'Tutor'}
                    </div>
                </div>
            `;
        });
        
        sessionsHTML += '</div>';
        sessionsList.innerHTML = sessionsHTML;
        
    } catch (error) {
        console.error("Error loading student schedule:", error);
        document.getElementById('studentSessionsList').innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading student schedule. Please try again.</p>
            </div>
        `;
    }
}

// Show student schedule modal
function showStudentScheduleModal(content) {
    let modal = document.getElementById('studentScheduleModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'studentScheduleModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>Student Schedule</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body" id="studentScheduleModalBody"></div>
                <div class="modal-actions">
                    <button class="btn-outline" id="closeStudentScheduleBtn">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listeners
        const closeBtn = modal.querySelector('.close-modal');
        const closeScheduleBtn = modal.querySelector('#closeStudentScheduleBtn');
        
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        closeScheduleBtn.addEventListener('click', () => modal.style.display = 'none');
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
    
    document.getElementById('studentScheduleModalBody').innerHTML = content;
    modal.style.display = 'flex';
}

// Add CSS styles for student schedule
function addStudentScheduleStyles() {
    const styleId = 'student-schedule-styles';
    if (document.getElementById(styleId)) return;
    
    const styles = `
        .student-sessions-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
        }
        
        .student-session-item {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
            transition: var(--transition);
        }
        
        .student-session-item:hover {
            background: var(--gray-light);
        }
        
        .student-session-item:last-child {
            border-bottom: none;
        }
        
        .session-date-time {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        .session-details {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        
        .session-details .subject {
            font-weight: 600;
            color: var(--primary);
        }
        
        .session-details .duration {
            color: var(--gray);
            font-size: 0.9em;
        }
        
        .session-tutor {
            color: var(--dark-light);
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .session-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    `;
    
    const styleSheet = document.createElement('style');
    styleSheet.id = styleId;
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
}

// Initialize student schedule functionality
function initStudentSchedule() {
    addStudentScheduleStyles();
}
       
// Enhanced real-time unread message tracking for tutors
function setupTutorRealtimeUnreadListeners() {
    const tutorId = currentUser.uid;
    
    // Listen for chat updates to track unread messages in real-time
    tutorUnreadListener = db.collection('chats')
        .where('participants', 'array-contains', tutorId)
        .onSnapshot((snapshot) => {
            let totalUnread = 0;
            
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'modified') {
                    const chat = change.doc.data();
                    const unreadCount = chat.unreadCounts?.[tutorId] || 0;
                    const chatId = change.doc.id;
                    
                    // Update local state
                    const oldCount = tutorChatUnreadCounts[chatId] || 0;
                    tutorChatUnreadCounts[chatId] = unreadCount;
                    
                    // Only update total if the count actually changed
                    if (oldCount !== unreadCount) {
                        totalUnread += unreadCount;
                        
                        // Update individual contact badge
                        updateTutorContactBadge(chatId, unreadCount);
                    }
                }
            });
            
            // Update total if we found changes
            if (totalUnread > 0) {
                tutorUnreadMessagesCount = Object.values(tutorChatUnreadCounts).reduce((sum, count) => sum + count, 0);
                updateTutorUnreadMessagesCount(tutorUnreadMessagesCount);
            }
        }, (error) => {
            console.error('Error in tutor unread messages listener:', error);
        });
    
    return tutorUnreadListener;
}

// Enhanced initialization with unread tracking
function initTutorChatSystem() {
    if (chatSystemInitialized) {
        console.log('Tutor chat system already initialized');
        return;
    }
    
    console.log('Initializing tutor chat system with enhanced unread tracking...');
    chatSystemInitialized = true;
    
    setupTutorChatEventListeners();
    loadTutorChatContacts();
    setupTutorRealtimeListeners();
    
    // Start enhanced unread tracking
    setupTutorRealtimeUnreadListeners();
}

// Get total unread messages count for tutors (for external use)
function getTutorTotalUnreadMessages() {
    return tutorUnreadMessagesCount;
}

// Get unread count for specific tutor chat
function getTutorChatUnreadCount(chatId) {
    return tutorChatUnreadCounts[chatId] || 0;
}

// Force refresh unread counts for tutors (useful after coming back online)
async function refreshTutorUnreadCounts() {
    console.log('Refreshing tutor unread message counts...');
    loadTutorChatContacts();
}

// Enhanced cleanup with unread listener cleanup
function cleanupTutorChatSystem() {
    if (contactsListener) {
        contactsListener();
        contactsListener = null;
    }
    
    if (chatMessagesListener) {
        chatMessagesListener();
        chatMessagesListener = null;
    }
    
    if (tutorUnreadListener) {
        tutorUnreadListener();
        tutorUnreadListener = null;
    }
    
    currentChat = null;
    chatSystemInitialized = false;
    chatListenersActive = false;
    
    console.log('Tutor chat system cleaned up');
}

// Initialize unread tracking when coming online
window.addEventListener('online', refreshTutorUnreadCounts);

// Export functions for global access
window.getTutorTotalUnreadMessages = getTutorTotalUnreadMessages;
window.getTutorChatUnreadCount = getTutorChatUnreadCount;
window.refreshTutorUnreadCounts = refreshTutorUnreadCounts;

// =======================================================
// END ENHANCED TUTOR UNREAD MESSAGE TRACKING
// =======================================================
       
// =============================================
// MOBILE CHAT FUNCTIONALITY
// =============================================

// Setup mobile chat features
function setupMobileChatFeatures() {
    const chatBackBtn = document.getElementById('chatBackBtn');
    const chatMessages = document.querySelector('.chat-messages');
    
    if (chatBackBtn && window.innerWidth <= 768) {
        chatBackBtn.addEventListener('click', function() {
            // Show contacts list, hide chat messages
            document.querySelector('.chat-contacts').style.display = 'block';
            chatMessages.style.display = 'none';
            document.getElementById('mobileChatHeader').style.display = 'none';
            
            // Reset current chat
            currentChat = null;
            
            // Remove active class from all contacts
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
        });
    }
    
    // Modify openTutorChat function for mobile
    const originalOpenTutorChat = window.openTutorChat;
    window.openTutorChat = function(contact) {
        if (window.innerWidth <= 768) {
            // On mobile, hide contacts and show messages
            document.querySelector('.chat-contacts').style.display = 'none';
            document.querySelector('.chat-messages').style.display = 'flex';
            document.getElementById('mobileChatHeader').style.display = 'flex';
        }
        
        // Call original function
        originalOpenTutorChat(contact);
    };
}

// Handle window resize for responsive behavior
function setupChatResponsiveBehavior() {
    window.addEventListener('resize', function() {
        const chatSection = document.querySelector('.chat-section');
        
        // Reset to desktop view on larger screens
        if (window.innerWidth > 768) {
            document.querySelector('.chat-contacts').style.display = 'block';
            document.querySelector('.chat-messages').style.display = 'flex';
            document.getElementById('mobileChatHeader').style.display = 'none';
            chatSection.classList.remove('keyboard-open');
        }
        
        // Handle keyboard open/close detection
        if (window.innerHeight < 500) {
            chatSection.classList.add('keyboard-open');
        } else {
            chatSection.classList.remove('keyboard-open');
        }
    });
}

// Initialize mobile features when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    setupMobileChatFeatures();
    setupChatResponsiveBehavior();
});

//----------------------------------------------------------------------------------------
//TUTOR CHAT SYSTEM ENDS HERE
//----------------------------------------------------------------------------------------

//----------------------------------------------------------------------------------
//RATINGS AND REVIEWS SECTION START HERE
//-----------------------------------------------------------------------------------
// =============================================
// RATINGS & REVIEWS SECTION
// =============================================

// Global variables
let allReviews = [];
let currentReviewFilter = 'all';
let currentRatingFilter = 'all';

// Load ratings and reviews
async function loadRatingsAndReviews() {
    const container = document.getElementById('reviewsContainer');
    if (!container) return;
    
    container.innerHTML = '<div class="spinner">Loading reviews...</div>';
    
    try {
        // Get all reviews for this tutor
        const reviewsSnapshot = await db.collection('ratings_reviews')
            .where('tutorId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        allReviews = [];
        
        if (reviewsSnapshot.empty) {
            showEmptyReviewsState(container);
            updateRatingStats([]);
            return;
        }
        
        // Process reviews
        reviewsSnapshot.forEach(doc => {
            const review = doc.data();
            review.id = doc.id;
            allReviews.push(review);
        });
        
        // Update rating statistics
        updateRatingStats(allReviews);
        
        // Apply filters and display
        applyReviewFilters();
        
        // Setup filter listeners
        setupReviewFilters();
        
    } catch (error) {
        console.error("Error loading reviews:", error);
        showErrorState(container);
    }
}

// Update rating statistics
function updateRatingStats(reviews) {
    if (reviews.length === 0) {
        document.getElementById('averageRating').textContent = '0.0';
        document.getElementById('totalReviews').textContent = '0 Reviews';
        resetRatingBars();
        return;
    }
    
    // Calculate average rating
    const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
    const averageRating = totalRating / reviews.length;
    
    // Count ratings by star
    const ratingCounts = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
    reviews.forEach(review => {
        ratingCounts[review.rating]++;
    });
    
    // Update UI
    document.getElementById('averageRating').textContent = averageRating.toFixed(1);
    document.getElementById('totalReviews').textContent = `${reviews.length} Review${reviews.length !== 1 ? 's' : ''}`;
    
    // Update stars display
    updateAverageStars(averageRating);
    
    // Update rating bars
    updateRatingBars(ratingCounts, reviews.length);
}

// Update average stars display
function updateAverageStars(averageRating) {
    const starsContainer = document.getElementById('averageStars');
    starsContainer.innerHTML = '';
    
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star';
        
        if (i <= Math.floor(averageRating)) {
            star.className += ' filled';
            star.innerHTML = '★';
        } else if (i === Math.ceil(averageRating) && averageRating % 1 > 0) {
            star.className += ' half-filled';
            star.innerHTML = '★';
        } else {
            star.innerHTML = '★';
        }
        
        starsContainer.appendChild(star);
    }
}

// Update rating bars
function updateRatingBars(ratingCounts, totalReviews) {
    for (let rating = 5; rating >= 1; rating--) {
        const count = ratingCounts[rating] || 0;
        const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
        
        const barFill = document.querySelector(`.bar-fill[data-rating="${rating}"]`);
        const countElement = document.getElementById(`count${rating}`);
        
        if (barFill) {
            barFill.style.width = `${percentage}%`;
        }
        if (countElement) {
            countElement.textContent = count;
        }
    }
}

// Reset rating bars
function resetRatingBars() {
    for (let rating = 5; rating >= 1; rating--) {
        const barFill = document.querySelector(`.bar-fill[data-rating="${rating}"]`);
        const countElement = document.getElementById(`count${rating}`);
        
        if (barFill) barFill.style.width = '0%';
        if (countElement) countElement.textContent = '0';
    }
}

// Apply review filters
function applyReviewFilters() {
    const container = document.getElementById('reviewsContainer');
    let filteredReviews = [...allReviews];
    
    // Apply rating filter
    if (currentRatingFilter !== 'all') {
        filteredReviews = filteredReviews.filter(review => 
            review.rating === parseInt(currentRatingFilter)
        );
    }
    
    // Apply response filter
    if (currentReviewFilter !== 'all') {
        filteredReviews = filteredReviews.filter(review => {
            if (currentReviewFilter === 'responded') {
                return review.tutorResponse && review.tutorResponse.trim() !== '';
            } else if (currentReviewFilter === 'not-responded') {
                return !review.tutorResponse || review.tutorResponse.trim() === '';
            }
            return true;
        });
    }
    
    // Display filtered reviews
    displayReviews(filteredReviews, container);
}

// Display reviews
function displayReviews(reviews, container) {
    if (reviews.length === 0) {
        container.innerHTML = `
            <div class="reviews-empty-state">
                <i class="fas fa-star"></i>
                <h4>No Reviews Found</h4>
                <p>No reviews match your current filter criteria.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = reviews.map(review => createReviewCard(review)).join('');
    
    // Add event listeners
    addReviewCardListeners();
}

// Create review card
function createReviewCard(review) {
    const reviewDate = review.createdAt.toDate();
    const hasResponse = review.tutorResponse && review.tutorResponse.trim() !== '';
    
    return `
        <div class="review-card rating-${review.rating}" data-review-id="${review.id}">
            <div class="review-header">
                <div class="review-student-info">
                    <div class="student-avatar">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="student-details">
                        <h4>${review.studentName || 'Student'}</h4>
                        <div class="subject">${review.subject || 'General Tutoring'}</div>
                        <div class="stars">
                            ${generateStars(review.rating)}
                        </div>
                    </div>
                </div>
                <div class="review-meta">
                    <div class="review-date">${formatReviewDate(reviewDate)}</div>
                    ${review.sessionId ? `<div class="session-reference">Session #${review.sessionId.substring(0, 8)}</div>` : ''}
                </div>
            </div>
            
            <div class="review-content">
                <div class="review-text">${review.reviewText || 'No review text provided.'}</div>
            </div>
            
            ${hasResponse ? `
                <div class="review-response">
                    <div class="response-header">
                        <h5><i class="fas fa-reply"></i> Your Response</h5>
                        <div class="response-date">${formatReviewDate(review.respondedAt.toDate())}</div>
                    </div>
                    <div class="response-text">${review.tutorResponse}</div>
                </div>
            ` : ''}
            
            <div class="review-actions">
                <div class="response-indicator ${hasResponse ? 'responded' : 'not-responded'}">
                    <i class="fas ${hasResponse ? 'fa-check-circle' : 'fa-clock'}"></i>
                    ${hasResponse ? 'Responded' : 'Not Responded'}
                </div>
                ${!hasResponse ? `
                    <button class="response-btn" data-review-id="${review.id}">
                        <i class="fas fa-reply"></i> Respond
                    </button>
                ` : `
                    <button class="response-btn" data-review-id="${review.id}">
                        <i class="fas fa-edit"></i> Edit Response
                    </button>
                `}
            </div>
        </div>
    `;
}

// Generate stars HTML
function generateStars(rating) {
    let starsHTML = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            starsHTML += '<span class="star filled">★</span>';
        } else {
            starsHTML += '<span class="star">★</span>';
        }
    }
    return starsHTML;
}

// Format review date
function formatReviewDate(date) {
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    
    return date.toLocaleDateString();
}

// Setup review filters
function setupReviewFilters() {
    const ratingFilter = document.getElementById('ratingFilter');
    const responseFilter = document.getElementById('responseFilter');
    
    if (ratingFilter) {
        ratingFilter.addEventListener('change', function() {
            currentRatingFilter = this.value;
            applyReviewFilters();
        });
    }
    
    if (responseFilter) {
        responseFilter.addEventListener('change', function() {
            currentReviewFilter = this.value;
            applyReviewFilters();
        });
    }
}

// Add review card listeners
function addReviewCardListeners() {
    document.querySelectorAll('.response-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const reviewId = this.getAttribute('data-review-id');
            openResponseModal(reviewId);
        });
    });
}

// Open response modal
async function openResponseModal(reviewId) {
    const review = allReviews.find(r => r.id === reviewId);
    if (!review) return;
    
    const modalContent = `
        <h3>Respond to Review</h3>
        <div class="review-preview">
            <div class="student-info">
                <strong>${review.studentName}</strong> - ${generateStars(review.rating)}
            </div>
            <div class="review-text-preview">"${review.reviewText}"</div>
        </div>
        <form id="responseForm">
            <div class="form-group">
                <label for="responseText">Your Response</label>
                <textarea 
                    id="responseText" 
                    class="response-textarea" 
                    placeholder="Write a thoughtful response to this review..."
                    rows="5"
                >${review.tutorResponse || ''}</textarea>
            </div>
        </form>
        <div class="response-guidelines">
            <h4><i class="fas fa-lightbulb"></i> Response Tips</h4>
            <ul>
                <li>Thank the student for their feedback</li>
                <li>Address any specific concerns mentioned</li>
                <li>Keep it professional and positive</li>
                <li>Offer to help with future learning needs</li>
            </ul>
        </div>
    `;
    
    showResponseModal(modalContent, reviewId);
}
       
// Show response modal
function showResponseModal(content, reviewId) {
    let modal = document.getElementById('responseModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'responseModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        document.body.appendChild(modal);
    }
    
    // Always recreate the modal content to ensure fresh event listeners
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Respond to Review</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="responseModalBody">
                ${content}
            </div>
            <div class="modal-actions">
                <button class="btn-outline" id="cancelResponseBtn">Cancel</button>
                <button class="btn-primary" id="submitResponseBtn" data-review-id="${reviewId}">Submit Response</button>
            </div>
        </div>
    `;
    
    // Add event listeners each time modal is shown
    const closeBtn = modal.querySelector('.close-modal');
    const cancelBtn = modal.querySelector('#cancelResponseBtn');
    const submitBtn = modal.querySelector('#submitResponseBtn');
    
    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    cancelBtn.addEventListener('click', () => modal.style.display = 'none');
    
    // Use the reviewId from the button's data attribute
    submitBtn.addEventListener('click', () => {
        const currentReviewId = submitBtn.getAttribute('data-review-id');
        submitResponse(currentReviewId);
    });
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    modal.style.display = 'flex';
    
    // Focus on textarea
    setTimeout(() => {
        const textarea = document.getElementById('responseText');
        if (textarea) textarea.focus();
    }, 100);
}
       
// Submit response
async function submitResponse(reviewId) {
    const modal = document.getElementById('responseModal');
    const responseText = document.getElementById('responseText').value.trim();
    
    if (!responseText) {
        alert('Please write a response before submitting.');
        return;
    }
    
    try {
        // Update review with response
        await db.collection('ratings_reviews').doc(reviewId).update({
            tutorResponse: responseText,
            respondedAt: new Date(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Close modal
        modal.style.display = 'none';
        
        // Show success message
        showReviewActionSuccess('Response submitted successfully!');
        
        // Reload reviews to reflect changes
        loadRatingsAndReviews();
        
    } catch (error) {
        console.error("Error submitting response:", error);
        alert('Error submitting response. Please try again.');
    }
}

// Show empty state
function showEmptyReviewsState(container) {
    container.innerHTML = `
        <div class="reviews-empty-state">
            <i class="fas fa-star"></i>
            <h4>No Reviews Yet</h4>
            <p>Your reviews from students will appear here once they rate your sessions.</p>
            <div class="encouragement-message">
                <p>Focus on providing great tutoring sessions, and the reviews will follow!</p>
            </div>
        </div>
    `;
}

// Show error state
function showErrorState(container) {
    container.innerHTML = `
        <div class="error-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Reviews</h3>
            <p>Failed to load reviews. Please try again.</p>
        </div>
    `;
}

// Show success message
function showReviewActionSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'booking-toast success';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
    `;
    toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Initialize ratings and reviews section
function initRatingsAndReviews() {
    // This will be called when the section is activated
    loadRatingsAndReviews();
} 

//----------------------------------------------------------------------------------
//RATINGS AND REVIEWS SECTION ENDS HERE
//-----------------------------------------------------------------------------------

       
</script>    

<button onclick="diagnoseOverlay(); forceRemoveAllOverlays();" 
        style="position: fixed; bottom: 10px; right: 10px; z-index: 99999; 
               padding: 10px; background: #ff4444; color: white; border: none; 
               border-radius: 5px; cursor: pointer; font-weight: bold;">
    🆘 DIAGNOSE & FIX
</button>
</body>
</html>



