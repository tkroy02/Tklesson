<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Monitor - TKLesson Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* MODERN DARK THEME FOR CHAT MONITOR */
        :root {
            --chat-admin-bg: #0f172a;
            --chat-admin-surface: #1e293b;
            --chat-admin-surface-light: #334155;
            --chat-admin-primary: #3b82f6;
            --chat-admin-primary-dark: #1d4ed8;
            --chat-admin-danger: #ef4444;
            --chat-admin-warning: #f59e0b;
            --chat-admin-success: #10b981;
            --chat-admin-info: #06b6d4;
            --chat-admin-text: #f1f5f9;
            --chat-admin-text-secondary: #94a3b8;
            --chat-admin-border: #475569;
            --chat-admin-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --border-radius-sm: 6px;
            --border-radius: 10px;
            --border-radius-lg: 14px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--chat-admin-bg);
            color: var(--chat-admin-text);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        /* Modern Top Navigation */
        .chat-monitor-header {
            background: var(--chat-admin-surface);
            border-bottom: 1px solid var(--chat-admin-border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--chat-admin-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--chat-admin-primary), var(--chat-admin-info));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .logo-text h1 {
            font-size: 18px;
            font-weight: 700;
            color: var(--chat-admin-text);
            letter-spacing: -0.5px;
        }

        .logo-text p {
            font-size: 12px;
            color: var(--chat-admin-text-secondary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Quick Stats */
        .quick-stats {
            display: flex;
            gap: 12px;
            margin-right: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--chat-admin-surface-light);
            border-radius: var(--border-radius-sm);
            font-size: 13px;
        }

        .stat-item i {
            font-size: 14px;
        }

        .stat-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--chat-admin-primary);
        }

        .stat-item.flagged {
            background: rgba(239, 68, 68, 0.2);
            color: var(--chat-admin-danger);
        }

        /* Search Box */
        .search-container {
            position: relative;
            width: 300px;
        }

        .search-box {
            width: 100%;
            padding: 10px 16px 10px 40px;
            background: var(--chat-admin-surface-light);
            border: 1px solid var(--chat-admin-border);
            border-radius: var(--border-radius);
            color: var(--chat-admin-text);
            font-size: 14px;
            transition: var(--transition);
        }

        .search-box:focus {
            outline: none;
            border-color: var(--chat-admin-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .search-box::placeholder {
            color: var(--chat-admin-text-secondary);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--chat-admin-text-secondary);
            font-size: 14px;
        }

        /* User Menu with Dropdown */
        .user-menu-container {
            position: relative;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--chat-admin-surface-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: var(--chat-admin-border);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--chat-admin-primary), var(--chat-admin-info));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .user-info h4 {
            font-size: 14px;
            font-weight: 600;
        }

        .user-info p {
            font-size: 11px;
            color: var(--chat-admin-text-secondary);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--chat-admin-surface);
            border: 1px solid var(--chat-admin-border);
            border-radius: var(--border-radius);
            min-width: 200px;
            box-shadow: var(--chat-admin-shadow);
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--chat-admin-border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--chat-admin-surface-light);
        }

        .dropdown-item.logout {
            color: var(--chat-admin-danger);
        }

        .dropdown-item.logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Main Layout */
        .chat-monitor-container {
            display: flex;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        /* Sidebar - Left Panel */
        .monitor-sidebar {
            width: 350px;
            background: var(--chat-admin-surface);
            border-right: 1px solid var(--chat-admin-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Filters Section */
        .filters-section {
            padding: 20px;
            border-bottom: 1px solid var(--chat-admin-border);
        }

        .filter-group {
            margin-bottom: 16px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--chat-admin-text-secondary);
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--chat-admin-surface-light);
            border: 1px solid var(--chat-admin-border);
            border-radius: var(--border-radius-sm);
            color: var(--chat-admin-text);
            font-size: 13px;
            transition: var(--transition);
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--chat-admin-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .filter-select option {
            background: var(--chat-admin-surface);
            color: var(--chat-admin-text);
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .filter-pill {
            padding: 6px 12px;
            background: var(--chat-admin-surface-light);
            border: 1px solid var(--chat-admin-border);
            border-radius: 20px;
            font-size: 12px;
            color: var(--chat-admin-text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-pill:hover {
            background: var(--chat-admin-border);
        }

        .filter-pill.active {
            background: var(--chat-admin-primary);
            color: white;
            border-color: var(--chat-admin-primary);
        }

        /* Conversations List */
        .conversations-section {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .conversation-header {
            padding: 16px 20px;
            background: var(--chat-admin-surface);
            border-bottom: 1px solid var(--chat-admin-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-header h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--chat-admin-text-secondary);
        }

        .conversation-count {
            background: var(--chat-admin-surface-light);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .conversations-list {
            list-style: none;
        }

        .conversation-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--chat-admin-border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .conversation-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 4px solid var(--chat-admin-primary);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .conversation-avatar.student {
            background: linear-gradient(135deg, #10b981, #34d399);
        }

        .conversation-avatar.tutor {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .conversation-avatar.support {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--chat-admin-text);
        }

        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-preview {
            font-size: 13px;
            color: var(--chat-admin-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--chat-admin-text-secondary);
        }

        .conversation-badge {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .unread-count {
            background: var(--chat-admin-danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        .user-role {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-role.student {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .user-role.tutor {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .user-role.support {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        /* Main Content - Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-admin-bg);
            position: relative;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            color: var(--chat-admin-text-secondary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--chat-admin-text);
        }

        .empty-state p {
            max-width: 400px;
            line-height: 1.6;
        }

        /* Chat Header */
        .chat-header {
            padding: 16px 24px;
            background: var(--chat-admin-surface);
            border-bottom: 1px solid var(--chat-admin-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-participant {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-participant-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .chat-participant-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-participant-info p {
            font-size: 13px;
            color: var(--chat-admin-text-secondary);
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            background: var(--chat-admin-surface-light);
            border: 1px solid var(--chat-admin-border);
            border-radius: var(--border-radius-sm);
            color: var(--chat-admin-text);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--chat-admin-border);
        }

        .action-btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--chat-admin-danger);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--chat-admin-bg);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            position: relative;
            animation: messageSlideIn 0.3s ease-out;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--chat-admin-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: var(--chat-admin-surface);
            color: var(--chat-admin-text);
            border: 1px solid var(--chat-admin-border);
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .sender-name {
            font-weight: 600;
        }

        .message.received .sender-name {
            color: var(--chat-admin-primary);
        }

        .message-time {
            opacity: 0.8;
        }

        .message-content {
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            opacity: 0;
            transition: var(--transition);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: var(--transition);
        }

        .message-action:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Admin Controls */
        .admin-controls {
            padding: 20px 24px;
            background: var(--chat-admin-surface);
            border-top: 1px solid var(--chat-admin-border);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--chat-admin-text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: var(--border-radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--chat-admin-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--chat-admin-primary-dark);
        }

        .btn-outline {
            background: transparent;
            color: var(--chat-admin-text);
            border: 1px solid var(--chat-admin-border);
        }

        .btn-outline:hover {
            background: var(--chat-admin-border);
        }

        .btn-danger {
            background: var(--chat-admin-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--chat-admin-text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--chat-admin-border);
            border-top-color: var(--chat-admin-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--chat-admin-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--chat-admin-border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--chat-admin-text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .monitor-sidebar {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .chat-monitor-container {
                flex-direction: column;
            }
            
            .monitor-sidebar {
                width: 100%;
                height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--chat-admin-border);
            }
            
            .quick-stats {
                display: none;
            }
            
            .search-container {
                width: 200px;
            }
        }

        @media (max-width: 480px) {
            .header-actions {
                gap: 8px;
            }
            
            .user-info {
                display: none;
            }
            
            .search-container {
                width: 150px;
            }
            
            .message {
                max-width: 85%;
            }
        }

        /* Admin Insights Panel */
        .insights-panel {
            width: 280px;
            background: var(--chat-admin-surface);
            border-left: 1px solid var(--chat-admin-border);
            padding: 20px;
            overflow-y: auto;
        }

        .insights-header {
            margin-bottom: 20px;
        }

        .insights-header h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--chat-admin-text-secondary);
        }

        .insight-item {
            padding: 16px;
            background: var(--chat-admin-surface-light);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            border-left: 4px solid transparent;
        }

        .insight-item.warning {
            border-left-color: var(--chat-admin-warning);
        }

        .insight-item.danger {
            border-left-color: var(--chat-admin-danger);
        }

        .insight-item.info {
            border-left-color: var(--chat-admin-info);
        }

        .insight-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-desc {
            font-size: 12px;
            color: var(--chat-admin-text-secondary);
            line-height: 1.4;
        }

        .insight-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            color: var(--chat-admin-text-secondary);
        }

        /* Flagged Message Highlight */
        .message.flagged {
            border: 2px solid var(--chat-admin-danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .flag-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--chat-admin-danger);
            color: white;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        /* Search Highlight */
        .highlight {
            background-color: rgba(245, 158, 11, 0.3);
            padding: 2px 4px;
            border-radius: 2px;
        }

        /* Export Button */
        .export-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            background: var(--chat-admin-success);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--chat-admin-shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            transition: var(--transition);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -1px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="chat-monitor-header">
        <div class="logo-section">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="logo-text">
                <h1>Chat Monitor</h1>
                <p>Real-time conversation oversight</p>
            </div>
        </div>

        <div class="header-actions">
            <div class="quick-stats">
                <div class="stat-item active" id="activeChatsCount">
                    <i class="fas fa-comments"></i>
                    <span>0 Active</span>
                </div>
                <div class="stat-item flagged" id="flaggedChatsCount">
                    <i class="fas fa-flag"></i>
                    <span>0 Flagged</span>
                </div>
            </div>

            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-box" id="globalSearch" placeholder="Search messages...">
            </div>

            <div class="user-menu-container">
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="user-info">
                        <h4 id="adminName">Admin User</h4>
                        <p>Chat Monitor</p>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item">
                        <i class="fas fa-user-cog"></i>
                        <span>Profile Settings</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </div>
                    <div class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Preferences</span>
                    </div>
                    <div class="dropdown-item logout" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="chat-monitor-container">
        <!-- Sidebar -->
        <aside class="monitor-sidebar">
            <div class="filters-section">
                <div class="filter-group">
                    <label for="chatTypeFilter">Chat Type</label>
                    <select id="chatTypeFilter" class="filter-select">
                        <option value="all">All Conversations</option>
                        <option value="admin_student">Admin ↔ Student</option>
                        <option value="admin_tutor">Admin ↔ Tutor</option>
                        <option value="tutor_student">Tutor ↔ Student</option>
                        <option value="support_student">Support ↔ Student</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="timeFilter">Time Period</label>
                    <select id="timeFilter" class="filter-select">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>

                <div class="quick-filters">
                    <div class="filter-pill" data-filter="unread">Unread</div>
                    <div class="filter-pill active" data-filter="flagged">Flagged</div>
                    <div class="filter-pill" data-filter="archived">Archived</div>
                    <div class="filter-pill" data-filter="no-response">No Response</div>
                </div>
            </div>

            <div class="conversations-section">
                <div class="conversation-header">
                    <h3>Conversations</h3>
                    <span class="conversation-count" id="conversationCount">0</span>
                </div>
                <ul class="conversations-list" id="conversationsList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading conversations...</p>
                    </div>
                </ul>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="empty-state" id="emptyChatState">
                <i class="fas fa-comments"></i>
                <h3>Select a Conversation</h3>
                <p>Choose a conversation from the sidebar to view messages and monitor activity.</p>
            </div>

            <!-- Active Chat (Hidden by default) -->
            <div id="activeChat" style="display: none;">
                <div class="chat-header">
                    <div class="chat-participant">
                        <div class="chat-participant-avatar" id="participantAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="chat-participant-info">
                            <h3 id="participantName">Participant Name</h3>
                            <p id="participantDetails">User details...</p>
                        </div>
                    </div>

                    <div class="chat-actions">
                        <button class="action-btn" id="flagConversationBtn">
                            <i class="fas fa-flag"></i>
                            <span>Flag</span>
                        </button>
                        <button class="action-btn" id="archiveConversationBtn">
                            <i class="fas fa-archive"></i>
                            <span>Archive</span>
                        </button>
                        <button class="action-btn danger" id="deleteConversationBtn">
                            <i class="fas fa-trash"></i>
                            <span>Delete</span>
                        </button>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>

                <div class="admin-controls">
                    <div class="control-group">
                        <label>Admin Actions</label>
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="joinConversationBtn">
                                <i class="fas fa-comment-medical"></i>
                                <span>Join Conversation</span>
                            </button>
                            <button class="btn btn-outline" id="exportChatBtn">
                                <i class="fas fa-download"></i>
                                <span>Export Chat</span>
                            </button>
                            <button class="btn btn-outline" id="clearChatBtn">
                                <i class="fas fa-eraser"></i>
                                <span>Clear Messages</span>
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label for="adminMessage">Send Message as Admin</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="adminMessage" class="filter-select" placeholder="Type your message...">
                            <button class="btn btn-primary" id="sendAdminMessageBtn">
                                <i class="fas fa-paper-plane"></i>
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Insights Panel (Optional - can be toggled) -->
        <aside class="insights-panel" id="insightsPanel" style="display: none;">
            <div class="insights-header">
                <h3>Conversation Insights</h3>
            </div>
            <div id="insightsContent">
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>Select a conversation to see insights</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Export Button (Floating) -->
    <div class="export-btn" id="exportAllBtn">
        <i class="fas fa-file-export"></i>
        <span>Export All</span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjo5LY4EsFlX8j_8NbLUObooUsCqJM8KM",
            authDomain: "tk-scheduler.firebaseapp.com",
            projectId: "tk-scheduler",
            storageBucket: "tk-scheduler.appspot.com",
            messagingSenderId: "746606755052",
            appId: "1:746606755052:web:d7eae92976cb2f2fa9f9c9",
            measurementId: "G-Q5L607R3N7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global Variables
        let currentUser = null;
        let currentChat = null;
        let conversations = [];
        let chatListeners = {};
        let flaggedMessages = new Set();

        // Authentication State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                checkAdminAccess(user.uid);
            } else {
                window.location.href = 'admin-chat-login.html';
            }
        });

        // Check Admin Access
        async function checkAdminAccess(uid) {
            try {
                const adminDoc = await db.collection('admins').doc(uid).get();
                if (!adminDoc.exists) {
                    alert('Access denied. Admin privileges required.');
                    auth.signOut();
                    return;
                }
                
                // Load admin data
                const adminData = adminDoc.data();
                document.getElementById('adminName').textContent = adminData.name || 'Admin User';
                
                // Initialize the chat monitor
                initChatMonitor();
            } catch (error) {
                console.error('Error checking admin access:', error);
                alert('Error verifying admin access.');
                auth.signOut();
            }
        }

        // Initialize Chat Monitor
        function initChatMonitor() {
            console.log('Initializing Chat Monitor...');
            
            setupEventListeners();
            loadAllConversations();
            setupRealtimeListeners();
            updateStats();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Search
            document.getElementById('globalSearch').addEventListener('input', handleSearch);
            
            // Filters
            document.getElementById('chatTypeFilter').addEventListener('change', loadAllConversations);
            document.getElementById('timeFilter').addEventListener('change', loadAllConversations);
            
            // Quick filters
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    loadAllConversations();
                });
            });
            
            // Conversation actions
            document.getElementById('flagConversationBtn').addEventListener('click', flagConversation);
            document.getElementById('archiveConversationBtn').addEventListener('click', archiveConversation);
            document.getElementById('deleteConversationBtn').addEventListener('click', deleteConversation);
            
            // Admin actions
            document.getElementById('joinConversationBtn').addEventListener('click', joinConversation);
            document.getElementById('exportChatBtn').addEventListener('click', exportChat);
            document.getElementById('clearChatBtn').addEventListener('click', clearChat);
            document.getElementById('sendAdminMessageBtn').addEventListener('click', sendAdminMessage);
            
            // Enter key for message
            document.getElementById('adminMessage').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendAdminMessage();
            });
            
            // Export all
            document.getElementById('exportAllBtn').addEventListener('click', exportAllConversations);
            
            // User menu dropdown
            document.getElementById('userMenu').addEventListener('click', toggleUserDropdown);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdownMenu');
                const userMenu = document.getElementById('userMenu');
                
                if (!userMenu.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Toggle User Dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }

        // Load All Conversations - FIXED FOR YOUR FIREBASE STRUCTURE
        async function loadAllConversations() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading conversations...</p></div>';
            
            try {
                // Get filters
                const chatType = document.getElementById('chatTypeFilter').value;
                const timeFilter = document.getElementById('timeFilter').value;
                const activeFilter = document.querySelector('.filter-pill.active').dataset.filter;
                
                // Calculate time range
                let startDate = new Date();
                switch(timeFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(startDate.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(startDate.getMonth() - 1);
                        break;
                    case 'all':
                        startDate = null;
                        break;
                }
                
                // Build query - FIXED: Use correct collection path
                let query = db.collection('chats');
                
                if (startDate) {
                    query = query.where('lastUpdated', '>=', startDate);
                }
                
                // Apply chat type filter
                if (chatType !== 'all') {
                    if (chatType === 'admin_student') {
                        query = query.where('participants', 'array-contains', 'admin');
                        query = query.where('participantTypes.admin', '==', 'support');
                    } else if (chatType === 'admin_tutor') {
                        query = query.where('participants', 'array-contains', 'admin');
                        query = query.where('participantTypes.admin', '==', 'support');
                    } else if (chatType === 'tutor_student') {
                        query = query.where('participants', 'array-contains', 'admin');
                        query = query.where('participantTypes.admin', '!=', 'support');
                    }
                }
                
                // Order by last activity
                query = query.orderBy('lastUpdated', 'desc');
                
                const snapshot = await query.limit(100).get();
                
                conversations = [];
                conversationsList.innerHTML = '';
                
                if (snapshot.empty) {
                    conversationsList.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>No conversations found</p></div>';
                    return;
                }
                
                // Process each chat
                for (const doc of snapshot.docs) {
                    const chat = doc.data();
                    chat.id = doc.id;
                    
                    // Determine chat type based on document ID and participants
                    const chatId = doc.id;
                    
                    // Skip if document ID doesn't match expected patterns
                    const isAdminStudent = chatId.startsWith('admin_student_');
                    const isAdminTutor = chatId.startsWith('admin_tutor_');
                    const isSupportStudent = chatId.startsWith('support_student_');
                    const isTutorStudent = !chatId.includes('_') || (chatId.length > 10 && !chatId.includes('admin') && !chatId.includes('support'));
                    
                    // Filter by chat type based on document ID
                    if (chatType !== 'all') {
                        if (chatType === 'admin_student' && !isAdminStudent) continue;
                        if (chatType === 'admin_tutor' && !isAdminTutor) continue;
                        if (chatType === 'support_student' && !isSupportStudent) continue;
                        if (chatType === 'tutor_student' && !isTutorStudent) continue;
                    }
                    
                    // Get chat type for display
                    let displayType = 'Unknown';
                    if (isAdminStudent) displayType = 'Admin ↔ Student';
                    else if (isAdminTutor) displayType = 'Admin ↔ Tutor';
                    else if (isSupportStudent) displayType = 'Support ↔ Student';
                    else if (isTutorStudent) displayType = 'Tutor ↔ Student';
                    
                    // Apply additional filters
                    if (activeFilter === 'unread') {
                        // Check if any unread counts > 0
                        const hasUnread = Object.values(chat.unreadCounts || {}).some(count => count > 0);
                        if (!hasUnread) continue;
                    }
                    
                    if (activeFilter === 'flagged') {
                        // Check if chat is flagged (you might need to add this field)
                        if (!chat.flagged) continue;
                    }
                    
                    if (activeFilter === 'archived') {
                        // Check if chat is archived (you might need to add this field)
                        if (!chat.archived) continue;
                    }
                    
                    if (activeFilter === 'no-response') {
                        // Check if last message is from non-admin and no response in 24h
                        const lastMessageTime = chat.lastUpdated?.toDate();
                        const isAdminLastMessage = chat.lastMessageBy === 'admin';
                        if (!lastMessageTime || isAdminLastMessage || (new Date() - lastMessageTime) < 24 * 60 * 60 * 1000) {
                            continue;
                        }
                    }
                    
                    conversations.push(chat);
                    
                    // Get participant details - FIXED for your structure
                    let participantName = 'Unknown';
                    let participantType = 'unknown';
                    let otherParticipantName = 'Unknown';
                    
                    if (chat.participantNames) {
                        const participants = Object.entries(chat.participantNames);
                        
                        // Find non-admin participant
                        const nonAdminParticipant = participants.find(([id, name]) => id !== 'admin');
                        if (nonAdminParticipant) {
                            participantName = nonAdminParticipant[1];
                            participantType = chat.participantTypes?.[nonAdminParticipant[0]] || 'unknown';
                        }
                        
                        // Get admin name if exists
                        const adminParticipant = participants.find(([id, name]) => id === 'admin');
                        if (adminParticipant) {
                            otherParticipantName = adminParticipant[1];
                        }
                    }
                    
                    // Create conversation item
                    const conversationItem = document.createElement('li');
                    conversationItem.className = 'conversation-item';
                    conversationItem.dataset.chatId = chat.id;
                    
                    const avatarClass = participantType === 'student' ? 'student' : 
                                       participantType === 'tutor' ? 'tutor' : 'support';
                    
                    const lastMessageTime = chat.lastUpdated?.toDate();
                    const timeAgo = lastMessageTime ? getTimeAgo(lastMessageTime) : 'N/A';
                    
                    // Calculate total unread count
                    const totalUnread = Object.values(chat.unreadCounts || {}).reduce((sum, count) => sum + (count || 0), 0);
                    
                    conversationItem.innerHTML = `
                        <div class="conversation-avatar ${avatarClass}">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">
                                ${participantName}
                                <span class="user-role ${avatarClass}">${participantType}</span>
                                <span style="font-size: 10px; color: var(--chat-admin-text-secondary); margin-left: 8px;">${displayType}</span>
                            </div>
                            <div class="conversation-meta">
                                <div class="conversation-preview">${chat.lastMessage || 'No messages yet'}</div>
                                <div class="conversation-badge">
                                    ${totalUnread > 0 ? `<div class="unread-count">${totalUnread}</div>` : ''}
                                    ${chat.flagged ? `<i class="fas fa-flag" style="color: var(--chat-admin-danger);"></i>` : ''}
                                    <div class="conversation-time">${timeAgo}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    conversationItem.addEventListener('click', () => openConversation(chat.id));
                    conversationsList.appendChild(conversationItem);
                }
                
                // Update conversation count
                document.getElementById('conversationCount').textContent = conversations.length;
                
                // Update stats
                updateStats();
                
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversationsList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading conversations</p></div>';
            }
        }

        // Open Conversation
        async function openConversation(chatId) {
            try {
                // Remove active class from all items
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to selected item
                const selectedItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                // Hide empty state, show chat
                document.getElementById('emptyChatState').style.display = 'none';
                document.getElementById('activeChat').style.display = 'flex';
                
                // Load chat details
                const chatDoc = await db.collection('chats').doc(chatId).get();
                if (!chatDoc.exists) {
                    alert('Conversation not found');
                    return;
                }
                
                currentChat = chatDoc.data();
                currentChat.id = chatId;
                
                // Update header
                updateChatHeader(currentChat);
                
                // Load messages
                loadMessages(chatId);
                
                // Load insights
                loadInsights(chatId);
                
            } catch (error) {
                console.error('Error opening conversation:', error);
                alert('Error opening conversation');
            }
        }

        // Update Chat Header - FIXED for your structure
        function updateChatHeader(chat) {
            let participantNames = [];
            let participantTypes = [];
            let chatType = 'Unknown';
            
            if (chat.participantNames) {
                participantNames = Object.values(chat.participantNames);
            }
            
            if (chat.participantTypes) {
                participantTypes = Object.values(chat.participantTypes);
            }
            
            // Determine chat type from ID
            const chatId = chat.id;
            if (chatId.startsWith('admin_student_')) chatType = 'Admin ↔ Student';
            else if (chatId.startsWith('admin_tutor_')) chatType = 'Admin ↔ Tutor';
            else if (chatId.startsWith('support_student_')) chatType = 'Support ↔ Student';
            else chatType = 'Tutor ↔ Student';
            
            document.getElementById('participantName').textContent = participantNames.join(', ') || 'Unknown';
            document.getElementById('participantDetails').textContent = `${chatType} • ${participantNames.length} participant${participantNames.length > 1 ? 's' : ''}`;
            
            // Set avatar based on first non-admin participant
            const avatar = document.getElementById('participantAvatar');
            avatar.className = 'chat-participant-avatar';
            
            const firstNonAdminType = participantTypes.find(type => type !== 'support') || participantTypes[0] || 'unknown';
            avatar.classList.add(firstNonAdminType === 'student' ? 'student' : 
                               firstNonAdminType === 'tutor' ? 'tutor' : 'support');
        }

        // Load Messages - FIXED for your structure
        function loadMessages(chatId) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading messages...</p></div>';
            
            // Remove previous listener if exists
            if (chatListeners[chatId]) {
                chatListeners[chatId]();
                delete chatListeners[chatId];
            }
            
            // Set up real-time listener - FIXED: Check correct path
            chatListeners[chatId] = db.collection('chats')
                .doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-comment-slash"></i><p>No messages yet</p></div>';
                        return;
                    }
                    
                    messagesContainer.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageElement = createMessageElement(message);
                        messagesContainer.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                }, (error) => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading messages</p></div>';
                });
        }

        // Create Message Element
        function createMessageElement(message) {
            const isAdmin = message.senderId === 'admin' || 
                          message.senderName?.includes('Admin') || 
                          message.senderName?.includes('Support');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isAdmin ? 'sent' : 'received'}`;
            
            const messageTime = message.timestamp?.toDate().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) || 'Unknown time';
            
            const isFlagged = flaggedMessages.has(message.id);
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender-name">${message.senderName || 'Unknown'}</span>
                    <span class="message-time">${messageTime}</span>
                </div>
                <div class="message-content ${isFlagged ? 'flagged' : ''}">
                    ${message.text || ''}
                    ${isFlagged ? '<span class="flag-indicator"><i class="fas fa-flag"></i> Flagged</span>' : ''}
                </div>
                <div class="message-actions">
                    <div class="message-action" onclick="flagMessage('${message.id}')">
                        <i class="fas fa-flag"></i> Flag
                    </div>
                    <div class="message-action" onclick="copyMessage('${message.text}')">
                        <i class="fas fa-copy"></i> Copy
                    </div>
                    <div class="message-action" onclick="deleteMessage('${message.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </div>
                </div>
            `;
            
            return messageDiv;
        }

        // Load Insights
        async function loadInsights(chatId) {
            const insightsContent = document.getElementById('insightsContent');
            insightsContent.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Analyzing conversation...</p></div>';
            
            try {
                // Show insights panel
                document.getElementById('insightsPanel').style.display = 'block';
                
                // Get message stats
                const messagesSnapshot = await db.collection('chats')
                    .doc(chatId)
                    .collection('messages')
                    .get();
                
                const messages = messagesSnapshot.docs.map(doc => doc.data());
                
                // Calculate insights
                const totalMessages = messages.length;
                const uniqueSenders = [...new Set(messages.map(m => m.senderId))].length;
                const avgResponseTime = calculateAvgResponseTime(messages);
                const flaggedCount = messages.filter(m => flaggedMessages.has(m.id)).length;
                
                // Sentiment analysis (simplified)
                const positiveWords = ['good', 'great', 'excellent', 'thanks', 'thank you', 'helpful', 'awesome'];
                const negativeWords = ['bad', 'poor', 'terrible', 'awful', 'hate', 'disappointed', 'angry'];
                
                let sentimentScore = 0;
                messages.forEach(message => {
                    const text = message.text?.toLowerCase() || '';
                    positiveWords.forEach(word => {
                        if (text.includes(word)) sentimentScore++;
                    });
                    negativeWords.forEach(word => {
                        if (text.includes(word)) sentimentScore--;
                    });
                });
                
                const sentiment = sentimentScore > 0 ? 'positive' : sentimentScore < 0 ? 'negative' : 'neutral';
                
                // Create insights HTML
                insightsContent.innerHTML = `
                    <div class="insight-item info">
                        <div class="insight-title">
                            <i class="fas fa-chart-bar"></i>
                            <span>Conversation Stats</span>
                        </div>
                        <div class="insight-desc">
                            ${totalMessages} total messages<br>
                            ${uniqueSenders} participants<br>
                            ${flaggedCount} flagged messages
                        </div>
                    </div>
                    
                    <div class="insight-item ${sentiment === 'positive' ? 'info' : sentiment === 'negative' ? 'danger' : 'warning'}">
                        <div class="insight-title">
                            <i class="fas fa-smile"></i>
                            <span>Sentiment: ${sentiment}</span>
                        </div>
                        <div class="insight-desc">
                            Overall conversation sentiment is ${sentiment}
                        </div>
                    </div>
                    
                    ${avgResponseTime > 0 ? `
                    <div class="insight-item warning">
                        <div class="insight-title">
                            <i class="fas fa-clock"></i>
                            <span>Response Time</span>
                        </div>
                        <div class="insight-desc">
                            Average response time: ${Math.round(avgResponseTime)} minutes
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="insight-item info">
                        <div class="insight-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Moderation Actions</span>
                        </div>
                        <div class="insight-desc">
                            Review flagged messages for policy violations
                        </div>
                        <div class="insight-meta">
                            <span>Last checked: Just now</span>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading insights:', error);
                insightsContent.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading insights</p></div>';
            }
        }

        // Calculate Average Response Time
        function calculateAvgResponseTime(messages) {
            let totalTime = 0;
            let responseCount = 0;
            
            for (let i = 1; i < messages.length; i++) {
                const prevTime = messages[i-1].timestamp?.toDate();
                const currTime = messages[i].timestamp?.toDate();
                
                if (prevTime && currTime && messages[i-1].senderId !== messages[i].senderId) {
                    totalTime += (currTime - prevTime) / (1000 * 60); // Convert to minutes
                    responseCount++;
                }
            }
            
            return responseCount > 0 ? totalTime / responseCount : 0;
        }

        // Get Time Ago String
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Flag Conversation
        async function flagConversation() {
            if (!currentChat?.id) return;
            
            try {
                await db.collection('chats').doc(currentChat.id).update({
                    flagged: true,
                    flaggedAt: new Date(),
                    flaggedBy: currentUser.uid
                });
                
                alert('Conversation flagged successfully');
                loadAllConversations();
            } catch (error) {
                console.error('Error flagging conversation:', error);
                alert('Error flagging conversation');
            }
        }

        // Archive Conversation
        async function archiveConversation() {
            if (!currentChat?.id) return;
            
            if (!confirm('Archive this conversation?')) return;
            
            try {
                await db.collection('chats').doc(currentChat.id).update({
                    archived: true,
                    archivedAt: new Date()
                });
                
                alert('Conversation archived');
                loadAllConversations();
            } catch (error) {
                console.error('Error archiving conversation:', error);
                alert('Error archiving conversation');
            }
        }

        // Delete Conversation
        async function deleteConversation() {
            if (!currentChat?.id) return;
            
            if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) return;
            
            try {
                // First delete all messages
                const messagesSnapshot = await db.collection('chats')
                    .doc(currentChat.id)
                    .collection('messages')
                    .get();
                
                const batch = db.batch();
                messagesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Then delete the chat
                await db.collection('chats').doc(currentChat.id).delete();
                
                alert('Conversation deleted successfully');
                resetChatView();
                loadAllConversations();
            } catch (error) {
                console.error('Error deleting conversation:', error);
                alert('Error deleting conversation');
            }
        }

        // Join Conversation
        function joinConversation() {
            if (!currentChat?.id) return;
            
            // Show input for admin message
            const adminMessageInput = document.getElementById('adminMessage');
            adminMessageInput.focus();
            
            // You could also send a system message
            sendSystemMessage('Admin has joined the conversation');
        }

        // Export Chat
        async function exportChat() {
            if (!currentChat?.id) return;
            
            try {
                const messagesSnapshot = await db.collection('chats')
                    .doc(currentChat.id)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .get();
                
                let exportText = `Chat Export - ${new Date().toLocaleString()}\n`;
                exportText += `Conversation ID: ${currentChat.id}\n`;
                exportText += `Participants: ${document.getElementById('participantName').textContent}\n`;
                exportText += `Exported by: ${currentUser.email}\n`;
                exportText += '='.repeat(50) + '\n\n';
                
                messagesSnapshot.forEach(doc => {
                    const message = doc.data();
                    const time = message.timestamp?.toDate().toLocaleString() || 'Unknown time';
                    exportText += `${time} - ${message.senderName || 'Unknown'}: ${message.text || ''}\n`;
                });
                
                // Create download link
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat-${currentChat.id}-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Chat exported successfully');
            } catch (error) {
                console.error('Error exporting chat:', error);
                alert('Error exporting chat');
            }
        }

        // Clear Chat
        async function clearChat() {
            if (!currentChat?.id) return;
            
            if (!confirm('Are you sure you want to clear all messages in this conversation? This cannot be undone.')) return;
            
            try {
                const messagesSnapshot = await db.collection('chats')
                    .doc(currentChat.id)
                    .collection('messages')
                    .get();
                
                const batch = db.batch();
                messagesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Update chat metadata
                await db.collection('chats').doc(currentChat.id).update({
                    lastMessage: 'Chat cleared by admin',
                    lastUpdated: new Date(),
                    messageCount: 0
                });
                
                alert('Chat cleared successfully');
                loadMessages(currentChat.id);
            } catch (error) {
                console.error('Error clearing chat:', error);
                alert('Error clearing chat');
            }
        }

        // Send Admin Message
        async function sendAdminMessage() {
            if (!currentChat?.id) return;
            
            const messageInput = document.getElementById('adminMessage');
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;
            
            try {
                const messageData = {
                    text: messageText,
                    senderId: 'admin',
                    senderName: 'Admin',
                    timestamp: new Date(),
                    read: false,
                    type: 'admin_message'
                };
                
                // Add to messages subcollection
                await db.collection('chats')
                    .doc(currentChat.id)
                    .collection('messages')
                    .add(messageData);
                
                // Update chat metadata
                await db.collection('chats').doc(currentChat.id).update({
                    lastMessage: messageText,
                    lastUpdated: new Date(),
                    lastMessageBy: 'admin'
                });
                
                // Clear input
                messageInput.value = '';
                
                // Show success
                console.log('Admin message sent');
                
            } catch (error) {
                console.error('Error sending admin message:', error);
                alert('Error sending message');
            }
        }

        // Send System Message
        async function sendSystemMessage(text) {
            if (!currentChat?.id) return;
            
            try {
                const messageData = {
                    text: text,
                    senderId: 'system',
                    senderName: 'System',
                    timestamp: new Date(),
                    read: true,
                    type: 'system_message'
                };
                
                await db.collection('chats')
                    .doc(currentChat.id)
                    .collection('messages')
                    .add(messageData);
                    
            } catch (error) {
                console.error('Error sending system message:', error);
            }
        }

        // Flag Message
        function flagMessage(messageId) {
            flaggedMessages.add(messageId);
            
            // Update UI
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.classList.add('flagged');
            }
            
            console.log('Message flagged:', messageId);
        }

        // Copy Message
        function copyMessage(text) {
            navigator.clipboard.writeText(text)
                .then(() => console.log('Message copied'))
                .catch(err => console.error('Copy failed:', err));
        }

        // Delete Message
        async function deleteMessage(messageId) {
            if (!currentChat?.id || !confirm('Delete this message?')) return;
            
            try {
                await db.collection('chats')
                    .doc(currentChat.id)
                    .collection('messages')
                    .doc(messageId)
                    .delete();
                    
                console.log('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message');
            }
        }

        // Export All Conversations
        async function exportAllConversations() {
            if (!confirm('Export all conversations? This may take a moment.')) return;
            
            try {
                const snapshot = await db.collection('chats')
                    .orderBy('lastUpdated', 'desc')
                    .limit(100)
                    .get();
                
                let exportText = `Chat Monitor Export - ${new Date().toLocaleString()}\n`;
                exportText += `Exported by: ${currentUser.email}\n`;
                exportText += `Total Conversations: ${snapshot.size}\n`;
                exportText += '='.repeat(50) + '\n\n';
                
                for (const doc of snapshot.docs) {
                    const chat = doc.data();
                    
                    exportText += `Conversation: ${doc.id}\n`;
                    exportText += `Participants: ${JSON.stringify(chat.participantNames || {})}\n`;
                    exportText += `Last Message: ${chat.lastMessage || 'None'}\n`;
                    exportText += `Last Updated: ${chat.lastUpdated?.toDate().toLocaleString() || 'Unknown'}\n`;
                    exportText += '-'.repeat(30) + '\n';
                    
                    // Get messages for this chat
                    const messagesSnapshot = await db.collection('chats')
                        .doc(doc.id)
                        .collection('messages')
                        .orderBy('timestamp', 'asc')
                        .limit(50)
                        .get();
                    
                    messagesSnapshot.forEach(msgDoc => {
                        const message = msgDoc.data();
                        const time = message.timestamp?.toDate().toLocaleString() || 'Unknown time';
                        exportText += `${time} - ${message.senderName || 'Unknown'}: ${message.text || ''}\n`;
                    });
                    
                    exportText += '\n' + '='.repeat(50) + '\n\n';
                }
                
                // Create download
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat-monitor-export-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('Export completed successfully');
            } catch (error) {
                console.error('Error exporting all conversations:', error);
                alert('Error exporting conversations');
            }
        }

        // Handle Search
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (!searchTerm) {
                // Show all conversations
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.style.display = 'flex';
                });
                return;
            }
            
            // Filter conversations
            document.querySelectorAll('.conversation-item').forEach(item => {
                const conversationName = item.querySelector('.conversation-name').textContent.toLowerCase();
                const conversationPreview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                
                if (conversationName.includes(searchTerm) || conversationPreview.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Setup Realtime Listeners
        function setupRealtimeListeners() {
            // Listen for new chats
            db.collection('chats')
                .orderBy('lastUpdated', 'desc')
                .limit(1)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            console.log('New conversation added');
                            loadAllConversations();
                        }
                    });
                });
        }

        // Update Stats
        function updateStats() {
            // Update active chats count
            const activeChats = conversations.filter(chat => !chat.archived).length;
            document.getElementById('activeChatsCount').querySelector('span').textContent = `${activeChats} Active`;
            
            // Update flagged chats count
            const flaggedChats = conversations.filter(chat => chat.flagged).length;
            document.getElementById('flaggedChatsCount').querySelector('span').textContent = `${flaggedChats} Flagged`;
        }

        // Reset Chat View
        function resetChatView() {
            currentChat = null;
            document.getElementById('emptyChatState').style.display = 'flex';
            document.getElementById('activeChat').style.display = 'none';
            document.getElementById('insightsPanel').style.display = 'none';
            
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            // Already initialized in auth state listener
        });

        // Make functions available globally
        window.logout = logout;
        window.flagMessage = flagMessage;
        window.copyMessage = copyMessage;
        window.deleteMessage = deleteMessage;

    </script>
</body>
</html>
